import{t as e}from"./index-CX5PxGol.js";var t=Object.defineProperty,n=(e,n,r)=>n in e?t(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,r=(e,t,r)=>(n(e,typeof t==`symbol`?t:t+``,r),r),i=class{constructor(e,t=!1,n,r){this.initialize(e,t,n,r)}initialize(e,t=!1,n,r){return this.mask=e,this.skipNextObservers=t,this.target=n,this.currentTarget=r,this}},a=class{constructor(e,t,n=null){this.callback=e,this.mask=t,this.scope=n,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}},o=class e{static FromPromise(t,n){let r=new e;return t.then(e=>{r.notifyObservers(e)}).catch(e=>{if(n)n.notifyObservers(e);else throw e}),r}get observers(){return this._observers}constructor(e,t=!1){this.notifyIfTriggered=t,this._observers=[],this._numObserversMarkedAsDeleted=0,this._hasNotified=!1,this._eventState=new i(0),e&&(this._onObserverAdded=e)}add(e,t=-1,n=!1,r=null,i=!1){if(!e)return null;let o=new a(e,t,r);return o.unregisterOnNextCall=i,n?this._observers.unshift(o):this._observers.push(o),this._onObserverAdded&&this._onObserverAdded(o),this._hasNotified&&this.notifyIfTriggered&&this._lastNotifiedValue!==void 0&&this.notifyObserver(o,this._lastNotifiedValue),o}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e&&this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1}removeCallback(e,t){for(let n=0;n<this._observers.length;n++){let r=this._observers[n];if(!r._willBeUnregistered&&r.callback===e&&(!t||t===r.scope))return this._deferUnregister(r),!0}return!1}_deferUnregister(e){e._willBeUnregistered||(this._numObserversMarkedAsDeleted++,e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0))}_remove(e,t=!0){if(!e)return!1;let n=this._observers.indexOf(e);return n===-1?!1:(t&&this._numObserversMarkedAsDeleted--,this._observers.splice(n,1),!0)}makeObserverTopPriority(e){this._remove(e,!1),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e,!1),this._observers.push(e)}notifyObservers(e,t=-1,n,r,i){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=e),!this._observers.length)return!0;let a=this._eventState;a.mask=t,a.target=n,a.currentTarget=r,a.skipNextObservers=!1,a.lastReturnValue=e,a.userInfo=i;for(let n of this._observers)if(!n._willBeUnregistered&&(n.mask&t&&(n.unregisterOnNextCall&&this._deferUnregister(n),n.scope?a.lastReturnValue=n.callback.apply(n.scope,[e,a]):a.lastReturnValue=n.callback(e,a)),a.skipNextObservers))return!1;return!0}notifyObserver(e,t,n=-1){if(this.notifyIfTriggered&&(this._hasNotified=!0,this._lastNotifiedValue=t),e._willBeUnregistered)return;let r=this._eventState;r.mask=n,r.skipNextObservers=!1,e.unregisterOnNextCall&&this._deferUnregister(e),e.callback(t,r)}hasObservers(){return this._observers.length-this._numObserversMarkedAsDeleted>0}clear(){this._observers.length=0,this._onObserverAdded=null,this._numObserversMarkedAsDeleted=0,this.cleanLastNotifiedState()}cleanLastNotifiedState(){this._hasNotified=!1,this._lastNotifiedValue=void 0}clone(){let t=new e;return t._observers=this._observers.slice(0),t}hasSpecificMask(e=-1){for(let t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}};function s(){return typeof window<`u`}function c(){return typeof navigator<`u`}function l(){return typeof document<`u`}function u(e){let t=``,n=e.firstChild;for(;n;)n.nodeType===3&&(t+=n.textContent),n=n.nextSibling;return t}var d={IsWindowObjectExist:s,IsNavigatorAvailable:c,IsDocumentAvailable:l,GetDOMTextContent:u},f=class e{static _CheckLimit(t,n){let r=e._LogLimitOutputs[t];return r?r.current++:(r={limit:n,current:1},e._LogLimitOutputs[t]=r),r.current<=r.limit}static _GenerateLimitMessage(t,n=1){let r=e._LogLimitOutputs[t];if(!r||!e.MessageLimitReached)return;let i=this._Levels[n];r.current===r.limit&&e[i.name](e.MessageLimitReached.replace(/%LIMIT%/g,``+r.limit).replace(/%TYPE%/g,i.name??``))}static _AddLogEntry(t){e._LogCache=t+e._LogCache,e.OnNewCacheEntry&&e.OnNewCacheEntry(t)}static _FormatMessage(e){let t=e=>e<10?`0`+e:``+e,n=new Date;return`[`+t(n.getHours())+`:`+t(n.getMinutes())+`:`+t(n.getSeconds())+`]: `+e}static _LogDisabled(e,t){}static _LogEnabled(t=1,n,r){if(r!==void 0&&!e._CheckLimit(n,r))return;let i=e._FormatMessage(n),a=this._Levels[t];a.logFunc&&a.logFunc(`BJS - `+i);let o=`<div style='color:${a.color}'>${i}</div><br>`;e._AddLogEntry(o),e._GenerateLimitMessage(n,t)}static get LogCache(){return e._LogCache}static ClearLogCache(){e._LogCache=``,e._LogLimitOutputs={},e.errorsCount=0}static set LogLevels(t){e.Log=e._LogDisabled,e.Warn=e._LogDisabled,e.Error=e._LogDisabled,[e.MessageLogLevel,e.WarningLogLevel,e.ErrorLogLevel].forEach(n=>{if((t&n)===n){let t=this._Levels[n];e[t.name]=e._LogEnabled.bind(e,n)}})}};f.NoneLogLevel=0,f.MessageLogLevel=1,f.WarningLogLevel=2,f.ErrorLogLevel=4,f.AllLogLevel=7,f.MessageLimitReached=`Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.`,f._LogCache=``,f._LogLimitOutputs={},f._Levels=[{},{color:`white`,logFunc:console.log,name:`Log`},{color:`orange`,logFunc:console.warn,name:`Warn`},{},{color:`red`,logFunc:console.error,name:`Error`}],f.errorsCount=0,f.Log=f._LogEnabled.bind(f,f.MessageLogLevel),f.Warn=f._LogEnabled.bind(f,f.WarningLogLevel),f.Error=f._LogEnabled.bind(f,f.ErrorLogLevel);var p=(e,t)=>!e||e.getClassName&&e.getClassName()===`Mesh`?null:e.getClassName&&e.getClassName()===`SubMesh`?e.clone(t):e.clone?e.clone():null;function m(e){let t=[];do Object.getOwnPropertyNames(e).forEach(function(e){t.indexOf(e)===-1&&t.push(e)});while(e=Object.getPrototypeOf(e));return t}var h=class{static DeepCopy(e,t,n,r){let i=m(e);for(let a of i){if(a[0]===`_`&&(!r||r.indexOf(a)===-1)||a.endsWith(`Observable`)||n&&n.indexOf(a)!==-1)continue;let i=e[a],o=typeof i;if(o!==`function`)try{if(o===`object`)if(i instanceof Array){if(t[a]=[],i.length>0)if(typeof i[0]==`object`)for(let e=0;e<i.length;e++){let n=p(i[e],t);t[a].indexOf(n)===-1&&t[a].push(n)}else t[a]=i.slice(0)}else t[a]=p(i,t);else t[a]=i}catch(e){f.Warn(e.message)}}}},g=class{static get Now(){return d.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}};function _(e){return`${e} needs to be imported before as it contains a side-effect required by your code.`}function v(){return typeof _native<`u`&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}var y=class e{constructor(){this._xhr=v(),this._requestURL=``}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(let t in e.CustomRequestHeaders){let n=e.CustomRequestHeaders[t];n&&this._xhr.setRequestHeader(t,n)}}_shouldSkipRequestModifications(t){return e.SkipRequestModificationForBabylonCDN&&(t.includes(`preview.babylonjs.com`)||t.includes(`cdn.babylonjs.com`))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,n){this._xhr.addEventListener(e,t,n)}removeEventListener(e,t,n){this._xhr.removeEventListener(e,t,n)}abort(){this._xhr.abort()}send(t){e.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(t)}open(t,n){for(let t of e.CustomRequestModifiers){if(this._shouldSkipRequestModifications(n))return;t(this._xhr,n)}return n=n.replace(`file:http:`,`http:`),n=n.replace(`file:https:`,`https:`),this._requestURL=n,this._xhr.open(t,n,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}};y.CustomRequestHeaders={},y.CustomRequestModifiers=[],y.SkipRequestModificationForBabylonCDN=!0;var b=class{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}};b.Instances=[],b.OnEnginesDisposedObservable=new o,b._LastCreatedScene=null,b.UseFallbackTexture=!0,b.FallbackTexture=``;var x=class{};x.FilesToLoad={};var S=class{static ExponentialBackoff(e=3,t=500){return(n,r,i)=>r.status!==0||i>=e||n.indexOf(`file:`)!==-1?-1:2**i*t}},C=class extends Error{};C._setPrototypeOf=Object.setPrototypeOf||((e,t)=>(e.__proto__=t,e));var w={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002},T=class e extends C{constructor(t,n,r){super(t),this.errorCode=n,this.innerError=r,this.name=`RuntimeError`,C._setPrototypeOf(this,e.prototype)}},E=e=>{let t=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=`,n=``,r,i,a,o,s,c,l,u=0,d=ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):new Uint8Array(e);for(;u<d.length;)r=d[u++],i=u<d.length?d[u++]:NaN,a=u<d.length?d[u++]:NaN,o=r>>2,s=(r&3)<<4|i>>4,c=(i&15)<<2|a>>6,l=a&63,isNaN(i)?c=l=64:isNaN(a)&&(l=64),n+=t.charAt(o)+t.charAt(s)+t.charAt(c)+t.charAt(l);return n},ee=e=>atob(e),te=e=>{let t=ee(e),n=t.length,r=new Uint8Array(new ArrayBuffer(n));for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);return r.buffer},D=`attribute`,O=`varying`,ne=class{constructor(){this.children=[]}isValid(e){return!0}process(e,t){var n,r;let i=``;if(this.line){let a=this.line,o=t.processor;if(o){o.lineProcessor&&(a=o.lineProcessor(a,t.isFragment,t.processingContext));let i=t.processor?.attributeKeywordName??D,s=t.isFragment&&(n=t.processor)!=null&&n.varyingFragmentKeywordName?t.processor?.varyingFragmentKeywordName:!t.isFragment&&(r=t.processor)!=null&&r.varyingVertexKeywordName?t.processor?.varyingVertexKeywordName:O;!t.isFragment&&o.attributeProcessor&&this.line.startsWith(i)?a=o.attributeProcessor(this.line,e,t.processingContext):o.varyingProcessor&&this.line.startsWith(s)?a=o.varyingProcessor(this.line,t.isFragment,e,t.processingContext):o.uniformProcessor&&o.uniformRegexp&&o.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(a=o.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):o.uniformBufferProcessor&&o.uniformBufferRegexp&&o.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||=(a=o.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),!0):o.textureProcessor&&o.textureRegexp&&o.textureRegexp.test(this.line)?a=o.textureProcessor(this.line,t.isFragment,e,t.processingContext):(o.uniformProcessor||o.uniformBufferProcessor)&&this.line.startsWith(`uniform`)&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?o.uniformProcessor&&(a=o.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):o.uniformBufferProcessor&&(a=o.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf(`}`)!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,o.endOfUniformBufferProcessor&&(a=o.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))}i+=a+`\r
`}return this.children.forEach(n=>{i+=n.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||`true`),i}},re=class{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(let t of e){if(t[0]===`#`){this._lines.push(t);continue}if(t.trim().startsWith(`//`)){this._lines.push(t);continue}let e=t.split(`;`);for(let t=0;t<e.length;t++){let n=e[t];n=n.trim(),n&&this._lines.push(n+(t===e.length-1?``:`;`))}}}},ie=class extends ne{process(e,t){for(let n=0;n<this.children.length;n++){let r=this.children[n];if(r.isValid(e))return r.process(e,t)}return``}},ae=class extends ne{isValid(e){return this.testExpression.isTrue(e)}},oe=class e{isTrue(e){return!0}static postfixToInfix(t){let n=[];for(let r of t)if(e._OperatorPriority[r]===void 0)n.push(r);else{let e=n[n.length-1],t=n[n.length-2];n.length-=2,n.push(`(${t}${r}${e})`)}return n[n.length-1]}static infixToPostfix(t){let n=[],r=-1,i=()=>{l=l.trim(),l!==``&&(n.push(l),l=``)},a=t=>{r<e._Stack.length-1&&(e._Stack[++r]=t)},o=()=>e._Stack[r],s=()=>r===-1?`!!INVALID EXPRESSION!!`:e._Stack[r--],c=0,l=``;for(;c<t.length;){let u=t.charAt(c),d=c<t.length-1?t.substr(c,2):``;if(u===`(`)l=``,a(u);else if(u===`)`){for(i();r!==-1&&o()!==`(`;)n.push(s());s()}else if(e._OperatorPriority[d]>1){for(i();r!==-1&&e._OperatorPriority[o()]>=e._OperatorPriority[d];)n.push(s());a(d),c++}else l+=u;c++}for(i();r!==-1;)o()===`(`?s():n.push(s());return n}};oe._OperatorPriority={")":0,"(":1,"||":2,"&&":3},oe._Stack=[``,``,``,``,``,``,``,``,``,``,``,``,``,``,``,``,``,``,``,``];var se=class extends oe{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}},ce=class extends oe{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}},le=class extends oe{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}},ue=class extends oe{constructor(e,t,n){super(),this.define=e,this.operand=t,this.testValue=n}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let n=!1,r=parseInt(t),i=parseInt(this.testValue);switch(this.operand){case`>`:n=r>i;break;case`<`:n=r<i;break;case`<=`:n=r<=i;break;case`>=`:n=r>=i;break;case`==`:n=r===i;break}return n}},de;(function(e){e[e.GLSL=0]=`GLSL`,e[e.WGSL=1]=`WGSL`})(de||={});var fe=/defined\s*?\((.+?)\)/g,pe=/defined\s*?\[(.+?)\]/g,me=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g,he=class e{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,n,r){var i;(i=t.processor)!=null&&i.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?`fragment`:`vertex`,e)),n(this._ProcessShaderConversion(e,t,r),e)})}static PreProcess(e,t,n,r){var i;(i=t.processor)!=null&&i.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,e=>{t.processCodeAfterIncludes&&(e=t.processCodeAfterIncludes(t.isFragment?`fragment`:`vertex`,e)),n(this._ApplyPreProcessing(e,t,r),e)})}static Finalize(e,t,n){return!n.processor||!n.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:n.processor.finalizeShaders(e,t,n.processingContext)}static _ProcessPrecision(e,t){var n;if((n=t.processor)!=null&&n.noPrecision)return e;let r=t.shouldUseHighPrecisionShader;return e.indexOf(`precision highp float`)===-1?e=r?`precision highp float;
`+e:`precision mediump float;
`+e:r||(e=e.replace(`precision highp float`,`precision mediump float`)),e}static _ExtractOperation(e){let t=/defined\((.+)\)/.exec(e);if(t&&t.length)return new se(t[1].trim(),e[0]===`!`);let n=[`==`,`>=`,`<=`,`<`,`>`],r=``,i=0;for(r of n)if(i=e.indexOf(r),i>-1)break;if(i===-1)return new se(e);let a=e.substring(0,i).trim(),o=e.substring(i+r.length).trim();return new ue(a,r,o)}static _BuildSubExpression(e){e=e.replace(fe,`defined[$1]`);let t=oe.infixToPostfix(e),n=[];for(let e of t)if(e!==`||`&&e!==`&&`)n.push(e);else if(n.length>=2){let t=n[n.length-1],r=n[n.length-2];n.length-=2;let i=e==`&&`?new le:new ce;typeof t==`string`&&(t=t.replace(pe,`defined($1)`)),typeof r==`string`&&(r=r.replace(pe,`defined($1)`)),i.leftOperand=typeof r==`string`?this._ExtractOperation(r):r,i.rightOperand=typeof t==`string`?this._ExtractOperation(t):t,n.push(i)}let r=n[n.length-1];return typeof r==`string`&&(r=r.replace(pe,`defined($1)`)),typeof r==`string`?this._ExtractOperation(r):r}static _BuildExpression(e,t){let n=new ae,r=e.substring(0,t),i=e.substring(t);return i=i.substring(0,(i.indexOf(`//`)+1||i.length+1)-1).trim(),r===`#ifdef`?n.testExpression=new se(i):r===`#ifndef`?n.testExpression=new se(i,!0):n.testExpression=this._BuildSubExpression(i),n}static _MoveCursorWithinIf(e,t,n){let r=e.currentLine;for(;this._MoveCursor(e,n);){r=e.currentLine;let i=r.substring(0,5).toLowerCase();if(i===`#else`){let n=new ne;t.children.push(n),this._MoveCursor(e,n);return}else if(i===`#elif`){let e=this._BuildExpression(r,5);t.children.push(e),n=e}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;let n=e.currentLine,r=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(n);if(r&&r.length)switch(r[0]){case`#ifdef`:{let r=new ie;t.children.push(r);let i=this._BuildExpression(n,6);r.children.push(i),this._MoveCursorWithinIf(e,r,i);break}case`#else`:case`#elif`:return!0;case`#endif`:return!1;case`#ifndef`:{let r=new ie;t.children.push(r);let i=this._BuildExpression(n,7);r.children.push(i),this._MoveCursorWithinIf(e,r,i);break}case`#if`:{let r=new ie,i=this._BuildExpression(n,3);t.children.push(r),r.children.push(i),this._MoveCursorWithinIf(e,r,i);break}}else{let e=new ne;if(e.line=n,t.children.push(e),n[0]===`#`&&n[1]===`d`){let t=n.replace(`;`,``).split(` `);e.additionalDefineKey=t[1],t.length===3&&(e.additionalDefineValue=t[2])}}}return!1}static _EvaluatePreProcessors(e,t,n){let r=new ne,i=new re;return i.lineIndex=-1,i.lines=e.split(`
`),this._MoveCursor(i,r),r.process(t,n)}static _PreparePreProcessors(e,t){let n=e.defines,r={};for(let e of n){let t=e.replace(`#define`,``).replace(`;`,``).trim().split(` `);r[t[0]]=t.length>1?t[1]:``}return e.processor?.shaderLanguage===de.GLSL&&(r.GL_ES=`true`),r.__VERSION__=e.version,r[e.platformName]=`true`,t._getGlobalDefines(r),r}static _ProcessShaderConversion(e,t,n){let r=this._ProcessPrecision(e,t);if(!t.processor||t.processor.shaderLanguage===de.GLSL&&r.indexOf(`#version 3`)!==-1&&(r=r.replace(`#version 300 es`,``),!t.processor.parseGLES3))return r;let i=t.defines,a=this._PreparePreProcessors(t,n);return t.processor.preProcessor&&(r=t.processor.preProcessor(r,i,t.isFragment,t.processingContext)),r=this._EvaluatePreProcessors(r,a,t),t.processor.postProcessor&&(r=t.processor.postProcessor(r,i,t.isFragment,t.processingContext,n)),n._features.needShaderCodeInlining&&(r=n.inlineShaderCode(r)),r}static _ApplyPreProcessing(e,t,n){var r,i;let a=e,o=t.defines,s=this._PreparePreProcessors(t,n);return(r=t.processor)!=null&&r.preProcessor&&(a=t.processor.preProcessor(a,o,t.isFragment,t.processingContext)),a=this._EvaluatePreProcessors(a,s,t),(i=t.processor)!=null&&i.postProcessor&&(a=t.processor.postProcessor(a,o,t.isFragment,t.processingContext,n)),n._features.needShaderCodeInlining&&(a=n.inlineShaderCode(a)),a}static _ProcessIncludes(t,n,r){let i=me.exec(t),a=new String(t),o=!1;for(;i!=null;){let s=i[1];if(s.indexOf(`__decl__`)!==-1&&(s=s.replace(/__decl__/,``),n.supportsUniformBuffers&&(s=s.replace(/Vertex/,`Ubo`),s=s.replace(/Fragment/,`Ubo`)),s+=`Declaration`),n.includesShadersStore[s]){let e=n.includesShadersStore[s];if(i[2]){let t=i[3].split(`,`);for(let n=0;n<t.length;n+=2){let r=new RegExp(t[n],`g`),i=t[n+1];e=e.replace(r,i)}}if(i[4]){let t=i[5];if(t.indexOf(`..`)!==-1){let r=t.split(`..`),i=parseInt(r[0]),a=parseInt(r[1]),o=e.slice(0);e=``,isNaN(a)&&(a=n.indexParameters[r[1]]);for(let t=i;t<a;t++)n.supportsUniformBuffers||(o=o.replace(/light\{X\}.(\w*)/g,(e,t)=>t+`{X}`)),e+=o.replace(/\{X\}/g,t.toString())+`
`}else n.supportsUniformBuffers||(e=e.replace(/light\{X\}.(\w*)/g,(e,t)=>t+`{X}`)),e=e.replace(/\{X\}/g,t)}a=a.replace(i[0],e),o=o||e.indexOf(`#include<`)>=0||e.indexOf(`#include <`)>=0}else{let t=n.shadersRepository+`ShadersInclude/`+s+`.fx`;e._FileToolsLoadFile(t,e=>{n.includesShadersStore[s]=e,this._ProcessIncludes(a,n,r)});return}i=me.exec(t)}o?this._ProcessIncludes(a.toString(),n,r):r(a)}static _FileToolsLoadFile(e,t,n,r,i,a){throw _(`FileTools`)}},ge=class e{static GetShadersRepository(t=de.GLSL){return t===de.GLSL?e.ShadersRepository:e.ShadersRepositoryWGSL}static GetShadersStore(t=de.GLSL){return t===de.GLSL?e.ShadersStore:e.ShadersStoreWGSL}static GetIncludesShadersStore(t=de.GLSL){return t===de.GLSL?e.IncludesShadersStore:e.IncludesShadersStoreWGSL}};ge.ShadersRepository=`src/Shaders/`,ge.ShadersStore={},ge.IncludesShadersStore={},ge.ShadersRepositoryWGSL=`src/ShadersWGSL/`,ge.ShadersStoreWGSL={},ge.IncludesShadersStoreWGSL={};var _e=class e{static get ShadersRepository(){return ge.ShadersRepository}static set ShadersRepository(e){ge.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||=new o,this._onBindObservable}constructor(t,n,r,i=null,a,c=null,l=null,u=null,d=null,f,p=``,m=de.GLSL){this.name=null,this.defines=``,this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new o,this.onErrorObservable=new o,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._forceRebindOnNextCall=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError=``,this._allFallbacksProcessed=!1,this._uniforms={},this._key=``,this._fallbacks=null,this._vertexSourceCodeOverride=``,this._fragmentSourceCodeOverride=``,this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode=``,this._fragmentSourceCode=``,this._vertexSourceCodeBeforeMigration=``,this._fragmentSourceCodeBeforeMigration=``,this._rawVertexSourceCode=``,this._rawFragmentSourceCode=``,this.name=t,this._key=p;let h,g=null;if(n.attributes){let e=n;if(this._engine=r,this._attributesNames=e.attributes,this._uniformsNames=e.uniformsNames.concat(e.samplers),this._samplerList=e.samplers.slice(),this.defines=e.defines,this.onError=e.onError,this.onCompiled=e.onCompiled,this._fallbacks=e.fallbacks,this._indexParameters=e.indexParameters,this._transformFeedbackVaryings=e.transformFeedbackVaryings||null,this._multiTarget=!!e.multiTarget,this._shaderLanguage=e.shaderLanguage??de.GLSL,e.uniformBuffersNames){this._uniformBuffersNamesList=e.uniformBuffersNames.slice();for(let t=0;t<e.uniformBuffersNames.length;t++)this._uniformBuffersNames[e.uniformBuffersNames[t]]=t}g=e.processFinalCode??null,h=e.processCodeAfterIncludes??void 0}else this._engine=a,this.defines=c??``,this._uniformsNames=r.concat(i),this._samplerList=i?i.slice():[],this._attributesNames=n,this._uniformBuffersNamesList=[],this._shaderLanguage=m,this.onError=d,this.onCompiled=u,this._indexParameters=f,this._fallbacks=l;this._attributeLocationByName={},this.uniqueId=e._UniqueIdSeed++;let _,v,y=s()?this._engine.getHostDocument():null;t.vertexSource?_=`source:`+t.vertexSource:t.vertexElement?(_=y?y.getElementById(t.vertexElement):null,_||=t.vertexElement):_=t.vertex||t,t.fragmentSource?v=`source:`+t.fragmentSource:t.fragmentElement?(v=y?y.getElementById(t.fragmentElement):null,v||=t.fragmentElement):v=t.fragment||t,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);let b={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:ge.GetShadersRepository(this._shaderLanguage),includesShadersStore:ge.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:h},x=[void 0,void 0],S=()=>{if(x[0]&&x[1]){b.isFragment=!0;let[e,n]=x;he.Process(n,b,(n,r)=>{this._fragmentSourceCodeBeforeMigration=r,g&&(n=g(`fragment`,n));let i=he.Finalize(e,n,b);b=null,this._useFinalCode(i.vertexCode,i.fragmentCode,t)},this._engine)}};this._loadShader(_,`Vertex`,``,e=>{he.Initialize(b),he.Process(e,b,(t,n)=>{this._rawVertexSourceCode=e,this._vertexSourceCodeBeforeMigration=n,g&&(t=g(`vertex`,t)),x[0]=t,S()},this._engine)}),this._loadShader(v,`Fragment`,`Pixel`,e=>{this._rawFragmentSourceCode=e,x[1]=e,S()})}_useFinalCode(e,t,n){if(n){let r=n.vertexElement||n.vertex||n.spectorName||n,i=n.fragmentElement||n.fragment||n.spectorName||n;this._vertexSourceCode=(this._shaderLanguage===de.WGSL?`//`:``)+`#define SHADER_NAME vertex:`+r+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===de.WGSL?`//`:``)+`#define SHADER_NAME fragment:`+i+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,n,r){if(typeof HTMLElement<`u`&&e instanceof HTMLElement){r(u(e));return}if(e.substr(0,7)===`source:`){r(e.substr(7));return}if(e.substr(0,7)===`base64:`){r(window.atob(e.substr(7)));return}let i=ge.GetShadersStore(this._shaderLanguage);if(i[e+t+`Shader`]){r(i[e+t+`Shader`]);return}if(n&&i[e+n+`Shader`]){r(i[e+n+`Shader`]);return}let a;a=e[0]===`.`||e[0]===`/`||e.indexOf(`http`)>-1?e:ge.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(a+`.`+t.toLowerCase()+`.fx`,r)}get vertexSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:this._pipelineContext?._getVertexShaderCode()??this._vertexSourceCode}get fragmentSourceCode(){return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:this._pipelineContext?._getFragmentShaderCode()??this._fragmentSourceCode}get vertexSourceCodeBeforeMigration(){return this._vertexSourceCodeBeforeMigration}get fragmentSourceCodeBeforeMigration(){return this._fragmentSourceCodeBeforeMigration}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,n,r){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(e,t)=>{r&&r(t)},this.onCompiled=()=>{let e=this.getEngine().scenes;if(e)for(let t=0;t<e.length;t++)e[t].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(n)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){let e=this._attributesNames,t=this.defines,n=this._pipelineContext;this._isReady=!1;try{let r=this._engine;this._pipelineContext=r.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;let i=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?r._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,i,null,this._transformFeedbackVaryings,this._key):r._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,i,t,this._transformFeedbackVaryings,this._key),r._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let t=0;t<e.length;t++){let n=e[t];this._attributeLocationByName[n]=this._attributes[t]}r.bindSamplers(this),this._compilationError=``,this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),n&&this.getEngine()._deletePipelineContext(n)}),this._pipelineContext.isAsync&&this._checkIsReady(n)}catch(e){this._processCompilationErrors(e,n)}}_getShaderCodeAndErrorLine(e,t,n){let r=n?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/,i=null;if(t&&e){let a=t.match(r);if(a&&a.length===2){let t=parseInt(a[1]),r=e.split(`
`,-1);r.length>=t&&(i=`Offending line [${t}] in ${n?`fragment`:`vertex`} code: ${r[t-1]}`)}}return[e,i]}_processCompilationErrors(t,n=null){var r,i;this._compilationError=t.message;let a=this._attributesNames,o=this._fallbacks;if(f.Error(`Unable to compile effect:`),f.Error(`Uniforms: `+this._uniformsNames.map(function(e){return` `+e})),f.Error(`Attributes: `+a.map(function(e){return` `+e})),f.Error(`Defines:\r
`+this.defines),e.LogShaderCodeOnCompilationError){let e=null,t=null,n=null;(r=this._pipelineContext)!=null&&r._getVertexShaderCode()&&([n,e]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),n&&(f.Error(`Vertex code:`),f.Error(n))),(i=this._pipelineContext)!=null&&i._getFragmentShaderCode()&&([n,t]=this._getShaderCodeAndErrorLine(this._pipelineContext?._getFragmentShaderCode(),this._compilationError,!0),n&&(f.Error(`Fragment code:`),f.Error(n))),e&&f.Error(e),t&&f.Error(t)}f.Error(`Error: `+this._compilationError);let s=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};n&&(this._pipelineContext=n,this._isReady=!0,s()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,f.Error(`Trying next fallback.`),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,s(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,n||s())}get isSupported(){return this._compilationError===``}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){let n=e+`Ex`;if(this._samplerList.indexOf(n+`0`)===-1){let r=this._samplerList.indexOf(e);for(let e=1;e<t.length;e++){let t=n+(e-1).toString();this._samplerList.splice(r+e,0,t)}let i=0;for(let e of this._samplerList)this._samplers[e]=i,i+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(t,n){let r=this._uniformBuffersNames[n];r===void 0||e._BaseCache[r]===t&&this._engine._features.useUBOBindingCache||(e._BaseCache[r]=t,this._engine.bindUniformBufferBase(t,r,n))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setInt(e,t){return this._pipelineContext.setInt(e,t),this}setInt2(e,t,n){return this._pipelineContext.setInt2(e,t,n),this}setInt3(e,t,n,r){return this._pipelineContext.setInt3(e,t,n,r),this}setInt4(e,t,n,r,i){return this._pipelineContext.setInt4(e,t,n,r,i),this}setIntArray(e,t){return this._pipelineContext.setIntArray(e,t),this}setIntArray2(e,t){return this._pipelineContext.setIntArray2(e,t),this}setIntArray3(e,t){return this._pipelineContext.setIntArray3(e,t),this}setIntArray4(e,t){return this._pipelineContext.setIntArray4(e,t),this}setUInt(e,t){return this._pipelineContext.setInt(e,t),this}setUInt2(e,t,n){return this._pipelineContext.setInt2(e,t,n),this}setUInt3(e,t,n,r){return this._pipelineContext.setInt3(e,t,n,r),this}setUInt4(e,t,n,r,i){return this._pipelineContext.setInt4(e,t,n,r,i),this}setUIntArray(e,t){return this._pipelineContext.setUIntArray(e,t),this}setUIntArray2(e,t){return this._pipelineContext.setUIntArray2(e,t),this}setUIntArray3(e,t){return this._pipelineContext.setUIntArray3(e,t),this}setUIntArray4(e,t){return this._pipelineContext.setUIntArray4(e,t),this}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setArray(e,t){return this._pipelineContext.setArray(e,t),this}setArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setMatrices(e,t){return this._pipelineContext.setMatrices(e,t),this}setMatrix(e,t){return this._pipelineContext.setMatrix(e,t),this}setMatrix3x3(e,t){return this._pipelineContext.setMatrix3x3(e,t),this}setMatrix2x2(e,t){return this._pipelineContext.setMatrix2x2(e,t),this}setFloat(e,t){return this._pipelineContext.setFloat(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}setVector2(e,t){return this._pipelineContext.setVector2(e,t),this}setFloat2(e,t,n){return this._pipelineContext.setFloat2(e,t,n),this}setVector3(e,t){return this._pipelineContext.setVector3(e,t),this}setFloat3(e,t,n,r){return this._pipelineContext.setFloat3(e,t,n,r),this}setVector4(e,t){return this._pipelineContext.setVector4(e,t),this}setQuaternion(e,t){return this._pipelineContext.setQuaternion(e,t),this}setFloat4(e,t,n,r,i){return this._pipelineContext.setFloat4(e,t,n,r,i),this}setColor3(e,t){return this._pipelineContext.setColor3(e,t),this}setColor4(e,t,n){return this._pipelineContext.setColor4(e,t,n),this}setDirectColor4(e,t){return this._pipelineContext.setDirectColor4(e,t),this}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,n,r=de.GLSL){t&&(ge.GetShadersStore(r)[`${e}PixelShader`]=t),n&&(ge.GetShadersStore(r)[`${e}VertexShader`]=n)}static ResetCache(){e._BaseCache={}}};_e.LogShaderCodeOnCompilationError=!0,_e._UniqueIdSeed=0,_e._BaseCache={},_e.ShadersStore=ge.ShadersStore,_e.IncludesShadersStore=ge.IncludesShadersStore;var ve=class{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){this.isDirty&&(this._isCullDirty&&=(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),!1),this._isCullFaceDirty&&=(e.cullFace(this.cullFace),!1),this._isDepthMaskDirty&&=(e.depthMask(this.depthMask),!1),this._isDepthTestDirty&&=(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),!1),this._isDepthFuncDirty&&=(e.depthFunc(this.depthFunc),!1),this._isZOffsetDirty&&=(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),!1),this._isFrontFaceDirty&&=(e.frontFace(this.frontFace),!1))}},ye=class e{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=e.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=e.KEEP,this.opDepthFail=e.KEEP,this.opStencilDepthPass=e.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}};ye.ALWAYS=519,ye.KEEP=7680,ye.REPLACE=7681;var be=class{constructor(){this._blendFunctionParameters=[,,,,],this._blendEquationParameters=[,,],this._blendConstants=[,,,,],this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,n,r){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===n&&this._blendConstants[3]===r||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=n,this._blendConstants[3]=r,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,n,r){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===n&&this._blendFunctionParameters[3]===r||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=n,this._blendFunctionParameters[3]=r,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){this.isDirty&&(this._isAlphaBlendDirty&&=(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),!1),this._isBlendFunctionParametersDirty&&=(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),!1),this._isBlendEquationParametersDirty&&=(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),!1),this._isBlendConstantsDirty&&=(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),!1))}},xe=class{get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}setParameters(e=1,t=1,n=1,r=1,i=2,a=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=n,this._cachedAnisotropicFilteringLevel=r,this.samplingMode=i,this._comparisonFunction=a,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}},Se;(function(e){e[e.Unknown=0]=`Unknown`,e[e.Url=1]=`Url`,e[e.Temp=2]=`Temp`,e[e.Raw=3]=`Raw`,e[e.Dynamic=4]=`Dynamic`,e[e.RenderTarget=5]=`RenderTarget`,e[e.MultiRenderTarget=6]=`MultiRenderTarget`,e[e.Cube=7]=`Cube`,e[e.CubeRaw=8]=`CubeRaw`,e[e.CubePrefiltered=9]=`CubePrefiltered`,e[e.Raw3D=10]=`Raw3D`,e[e.Raw2DArray=11]=`Raw2DArray`,e[e.DepthStencil=12]=`DepthStencil`,e[e.CubeRawRGBD=13]=`CubeRawRGBD`,e[e.Depth=14]=`Depth`})(Se||={});var Ce=class e extends xe{get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}_setUniqueId(e){this._uniqueId=e}getEngine(){return this._engine}get source(){return this._source}constructor(t,n,r=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url=``,this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new o,this.onErrorObservable=new o,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=Se.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension=``,this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=t,this._source=n,this._uniqueId=e._Counter++,r||(this._hardwareTexture=t._createHardwareTexture())}incrementReferences(){this._references++}updateSize(e,t,n=1){this._engine.updateTextureDimensions(this,e,t,n),this.width=e,this.height=t,this.depth=n,this.baseWidth=e,this.baseHeight=t,this.baseDepth=n,this._size=e*t*n}_rebuild(){if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){let e=this.onRebuildCallback(this),t=t=>{t._swapAndDie(this,!1),this.isReady=e.isReady};e.isAsync?e.proxy.then(t):t(e.proxy);return}let e;switch(this.source){case Se.Temp:break;case Se.Url:e=this._engine.createTexture(this._originalUrl??this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,e=>{e._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case Se.Raw:e=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),e._swapAndDie(this,!1),this.isReady=!0;break;case Se.Raw3D:e=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case Se.Raw2DArray:e=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),e._swapAndDie(this,!1),this.isReady=!0;break;case Se.Dynamic:e=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),e._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case Se.Cube:e=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case Se.CubeRaw:e=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),e._swapAndDie(this,!1),this.isReady=!0;break;case Se.CubeRawRGBD:return;case Se.CubePrefiltered:e=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,e=>{e&&e._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),e._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var n;(n=this._hardwareTexture)==null||n.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);let r=this._engine.getLoadedTexturesCache(),i=r.indexOf(this);i!==-1&&r.splice(i,1),i=r.indexOf(e),i===-1&&r.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}};Ce._Counter=0;var we=class{constructor(){this.shaderLanguage=de.GLSL}postProcessor(e,t,n,r,i){return i.getCaps().drawBuffersExtension||(e=e.replace(/#extension.+GL_EXT_draw_buffers.+(enable|require)/g,``)),e}},Te=class{constructor(){this.shaderLanguage=de.GLSL}attributeProcessor(e){return e.replace(`attribute`,`in`)}varyingProcessor(e,t){return e.replace(`varying`,t?`in`:`out`)}postProcessor(e,t,n){let r=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1;if(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,``),e=e.replace(/texture2D\s*\(/g,`texture(`),n)e=e.replace(/texture2DLodEXT\s*\(/g,`textureLod(`),e=e.replace(/textureCubeLodEXT\s*\(/g,`textureLod(`),e=e.replace(/textureCube\s*\(/g,`texture(`),e=e.replace(/gl_FragDepthEXT/g,`gl_FragDepth`),e=e.replace(/gl_FragColor/g,`glFragColor`),e=e.replace(/gl_FragData/g,`glFragData`),e=e.replace(/void\s+?main\s*\(/g,(r?``:`layout(location = 0) out vec4 glFragColor;
`)+`void main(`);else if(t.indexOf(`#define MULTIVIEW`)!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}},Ee=class e{get underlyingResource(){return null}constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=e._Counter++}};Ee._Counter=0;var De=class extends Ee{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}},Oe=class{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,n,r,i,a,o,s){let c=this.engine;if(c.supportsUniformBuffers)for(let n in t)e.bindUniformBlock(n,t[n]);this.engine.getUniforms(this,n).forEach((e,t)=>{r[n[t]]=e}),this._uniforms=r;let l;for(l=0;l<i.length;l++)e.getUniform(i[l])??(i.splice(l,1),l--);i.forEach((e,t)=>{a[e]=t});for(let e of c.getAttributes(this,o))s.push(e)}dispose(){this._uniforms={}}_cacheMatrix(e,t){let n=this._valueCache[e],r=t.updateFlag;return n!==void 0&&n===r?!1:(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,n){let r=this._valueCache[e];if(!r||r.length!==2)return r=[t,n],this._valueCache[e]=r,!0;let i=!1;return r[0]!==t&&(r[0]=t,i=!0),r[1]!==n&&(r[1]=n,i=!0),i}_cacheFloat3(e,t,n,r){let i=this._valueCache[e];if(!i||i.length!==3)return i=[t,n,r],this._valueCache[e]=i,!0;let a=!1;return i[0]!==t&&(i[0]=t,a=!0),i[1]!==n&&(i[1]=n,a=!0),i[2]!==r&&(i[2]=r,a=!0),a}_cacheFloat4(e,t,n,r,i){let a=this._valueCache[e];if(!a||a.length!==4)return a=[t,n,r,i],this._valueCache[e]=a,!0;let o=!1;return a[0]!==t&&(a[0]=t,o=!0),a[1]!==n&&(a[1]=n,o=!0),a[2]!==r&&(a[2]=r,o=!0),a[3]!==i&&(a[3]=i,o=!0),o}setInt(e,t){let n=this._valueCache[e];n!==void 0&&n===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,n){this._cacheFloat2(e,t,n)&&(this.engine.setInt2(this._uniforms[e],t,n)||(this._valueCache[e]=null))}setInt3(e,t,n,r){this._cacheFloat3(e,t,n,r)&&(this.engine.setInt3(this._uniforms[e],t,n,r)||(this._valueCache[e]=null))}setInt4(e,t,n,r,i){this._cacheFloat4(e,t,n,r,i)&&(this.engine.setInt4(this._uniforms[e],t,n,r,i)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let n=this._valueCache[e];n!==void 0&&n===t||this.engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,n){this._cacheFloat2(e,t,n)&&(this.engine.setUInt2(this._uniforms[e],t,n)||(this._valueCache[e]=null))}setUInt3(e,t,n,r){this._cacheFloat3(e,t,n,r)&&(this.engine.setUInt3(this._uniforms[e],t,n,r)||(this._valueCache[e]=null))}setUInt4(e,t,n,r,i){this._cacheFloat4(e,t,n,r,i)&&(this.engine.setUInt4(this._uniforms[e],t,n,r,i)||(this._valueCache[e]=null))}setUIntArray(e,t){this._valueCache[e]=null,this.engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this.engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this.engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this.engine.setUIntArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let n=this._valueCache[e];n!==void 0&&n===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,n){this._cacheFloat2(e,t,n)&&(this.engine.setFloat2(this._uniforms[e],t,n)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,n,r){this._cacheFloat3(e,t,n,r)&&(this.engine.setFloat3(this._uniforms[e],t,n,r)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,n,r,i){this._cacheFloat4(e,t,n,r,i)&&(this.engine.setFloat4(this._uniforms[e],t,n,r,i)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,n){this._cacheFloat4(e,t.r,t.g,t.b,n)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,n)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}},ke=class e{static SetMatrixPrecision(t){if(e.MatrixTrackPrecisionChange=!1,t&&!e.MatrixUse64Bits&&e.MatrixTrackedMatrices)for(let t=0;t<e.MatrixTrackedMatrices.length;++t){let n=e.MatrixTrackedMatrices[t],r=n._m;n._m=Array(16);for(let e=0;e<16;++e)n._m[e]=r[e]}e.MatrixUse64Bits=t,e.MatrixCurrentType=e.MatrixUse64Bits?Array:Float32Array,e.MatrixTrackedMatrices=null}};ke.MatrixUse64Bits=!1,ke.MatrixTrackPrecisionChange=!0,ke.MatrixCurrentType=Float32Array,ke.MatrixTrackedMatrices=[];var Ae=class{get underlyingResource(){return this._webGLTexture}constructor(e=null,t){if(this._MSAARenderBuffers=null,this._context=t,!e&&(e=t.createTexture(),!e))throw Error(`Unable to create webGL texture`);this.set(e)}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffers=null}addMSAARenderBuffer(e){this._MSAARenderBuffers||=[],this._MSAARenderBuffers.push(e)}releaseMSAARenderBuffers(){if(this._MSAARenderBuffers){for(let e of this._MSAARenderBuffers)this._context.deleteRenderbuffer(e);this._MSAARenderBuffers=null}}release(){this.releaseMSAARenderBuffers(),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}},je=class{static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}setEffect(e,t,n=!0){var r;this.effect=e,t!==void 0&&(this.defines=t),n&&((r=this.drawContext)==null||r.reset())}dispose(){var e;(e=this.drawContext)==null||e.dispose()}},Me=class{get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)==null||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;let n=!this.useStencilGlobalOnly&&!!((t=this.stencilMaterial)!=null&&t.enabled);this.enabled=n?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=n?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=n?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=n?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=n?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=n?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=n?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=n?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&=(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),!1),this._isStencilMaskDirty&&=(e.stencilMask(this.mask),!1),this._isStencilFuncDirty&&=(e.stencilFunc(this.func,this.funcRef,this.funcMask),!1),this._isStencilOpDirty&&=(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),!1))}},Ne=class{},k=class e{static get NpmPackage(){return`babylonjs@5.57.1`}static get Version(){return`5.57.1`}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=` - Parallel shader compilation`),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}get isDisposed(){return this._isDisposed}static get ShadersRepository(){return _e.ShadersRepository}static set ShadersRepository(e){_e.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){let e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document>`u`)return new OffscreenCanvas(e,t);let n=document.createElement(`canvas`);return n.width=e,n.height=t,n}createCanvas(t,n){return e._CreateCanvas(t,n)}createCanvasImage(){return document.createElement(`img`)}constructor(t,n,r,i){this._name=`WebGL`,this._isDisposed=!1,this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new o,this._frameId=0,this._uniformBuffers=[],this._storageBuffers=[],this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=[],this.onContextLostObservable=new o,this.onContextRestoredObservable=new o,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new ve,this._stencilStateComposer=new Me,this._stencilState=new ye,this._alphaState=new be,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=[],this._renderTargetWrapperCache=[],this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=[],this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=[],this._currentInstanceLocations=[],this._currentInstanceBuffers=[],this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=[],this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=[],this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new o,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={},this.startTime=g.Now;let a=null;r||={},this._creationOptions=r,this.adaptToDeviceRatio=i??!1,this._stencilStateComposer.stencilGlobal=this._stencilState,ke.SetMatrixPrecision(!!r.useHighPrecisionMatrix),r.antialias=n??r.antialias,r.deterministicLockstep=r.deterministicLockstep??!1,r.lockstepMaxSteps=r.lockstepMaxSteps??4,r.timeStep=r.timeStep??1/60,r.audioEngine=r.audioEngine??!0,r.stencil=r.stencil??!0,this._audioContext=r.audioEngineOptions?.audioContext??null,this._audioDestination=r.audioEngineOptions?.audioDestination??null,this.premultipliedAlpha=r.premultipliedAlpha??!0,this.useExactSrgbConversions=r.useExactSrgbConversions??!1,this._doNotHandleContextLost=!!r.doNotHandleContextLost,this._isStencilEnable=!!r.stencil,i=i||r.adaptToDeviceRatio||!1;let c=s()&&window.devicePixelRatio||1,l=r.limitDeviceRatio||c;if(this._hardwareScalingLevel=i?1/Math.min(l,c):1,this._lastDevicePixelRatio=c,!t)return;if(t.getContext){if(a=t,this._renderingCanvas=a,r.preserveDrawingBuffer===void 0&&(r.preserveDrawingBuffer=!1),r.xrCompatible===void 0&&(r.xrCompatible=!0),navigator&&navigator.userAgent){this._setupMobileChecks();let t=navigator.userAgent;for(let n of e.ExceptionList){let e=n.key,i=n.targets;if(new RegExp(e).test(t)){if(n.capture&&n.captureConstraint){let e=n.capture,r=n.captureConstraint,i=new RegExp(e).exec(t);if(i&&i.length>0&&parseInt(i[i.length-1])>=r)continue}for(let e of i)switch(e){case`uniformBuffer`:this.disableUniformBuffers=!0;break;case`vao`:this.disableVertexArrayObjects=!0;break;case`antialias`:r.antialias=!1;break;case`maxMSAASamples`:this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=e=>{e.preventDefault(),this._contextWasLost=!0,f.Warn(`WebGL context lost.`),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},a.addEventListener(`webglcontextlost`,this._onContextLost,!1),a.addEventListener(`webglcontextrestored`,this._onContextRestored,!1),r.powerPreference=r.powerPreference||`high-performance`),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(r.xrCompatible=!1),!r.disableWebGL2Support)try{this._gl=a.getContext(`webgl2`,r)||a.getContext(`experimental-webgl2`,r),this._gl&&(this._webGLVersion=2,this._shaderPlatformName=`WEBGL2`,this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName=`WEBGL1`))}catch{}if(!this._gl){if(!a)throw Error(`The provided canvas is null or undefined.`);try{this._gl=a.getContext(`webgl`,r)||a.getContext(`experimental-webgl`,r)}catch{throw Error(`WebGL not supported`)}}if(!this._gl)throw Error(`WebGL not supported`)}else{this._gl=t,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName=`WEBGL2`):this._shaderPlatformName=`WEBGL1`;let e=this._gl.getContextAttributes();e&&(r.stencil=e.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),r.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=r.useHighPrecisionFloats),this.resize(),this._initGLContext(),this._initFeatures();for(let e=0;e<this._caps.maxVertexAttribs;e++)this._currentBufferPointers[e]=new Ne;this._shaderProcessor=this.webGLVersion>1?new Te:new we,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);let u=`Babylon.js v${e.Version}`;console.log(u+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute(`data-engine`,u)}_setupMobileChecks(){navigator&&navigator.userAgent&&(this._checkForMobile=()=>{let e=navigator.userAgent;this.hostInformation.isMobile=e.indexOf(`Mobile`)!==-1||e.indexOf(`Mac`)!==-1&&l()&&`ontouchend`in document},this._checkForMobile(),s()&&window.addEventListener(`resize`,this._checkForMobile))}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var t;this._dummyFramebuffer=null;let n=this._depthCullingState.depthTest,r=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,a=this._stencilState.stencilTest;await e(),this.wipeCaches(!0),this._rebuildEffects(),(t=this._rebuildComputeEffects)==null||t.call(this),this._rebuildBuffers(),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this.wipeCaches(!0),this._depthCullingState.depthTest=n,this._depthCullingState.depthFunc=r,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=a,f.Warn(this.name+` context successfully restored.`),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){let e=this._internalTexturesCache.slice();for(let t of e)t._rebuild()}_rebuildRenderTargetWrappers(){let e=this._renderTargetWrapperCache.slice();for(let t of e)t._rebuild()}_rebuildEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}_e.ResetCache()}areAllEffectsReady(){for(let e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(let e of this._uniformBuffers)e._rebuild();for(let e of this._storageBuffers)e._rebuild()}_initGLContext(){this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension(`KHR_parallel_shader_compile`)||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension(`OES_standard_derivatives`)!==null,maxAnisotropy:1,astc:this._gl.getExtension(`WEBGL_compressed_texture_astc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_astc`),bptc:this._gl.getExtension(`EXT_texture_compression_bptc`)||this._gl.getExtension(`WEBKIT_EXT_texture_compression_bptc`),s3tc:this._gl.getExtension(`WEBGL_compressed_texture_s3tc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_s3tc`),s3tc_srgb:this._gl.getExtension(`WEBGL_compressed_texture_s3tc_srgb`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_s3tc_srgb`),pvrtc:this._gl.getExtension(`WEBGL_compressed_texture_pvrtc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_pvrtc`),etc1:this._gl.getExtension(`WEBGL_compressed_texture_etc1`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_etc1`),etc2:this._gl.getExtension(`WEBGL_compressed_texture_etc`)||this._gl.getExtension(`WEBKIT_WEBGL_compressed_texture_etc`)||this._gl.getExtension(`WEBGL_compressed_texture_es3_0`),textureAnisotropicFilterExtension:this._gl.getExtension(`EXT_texture_filter_anisotropic`)||this._gl.getExtension(`WEBKIT_EXT_texture_filter_anisotropic`)||this._gl.getExtension(`MOZ_EXT_texture_filter_anisotropic`),uintIndices:this._webGLVersion>1||this._gl.getExtension(`OES_element_index_uint`)!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension(`EXT_frag_depth`)!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension(`EXT_disjoint_timer_query_webgl2`)||this._gl.getExtension(`EXT_disjoint_timer_query`),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension(`EXT_color_buffer_float`)),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension(`OES_texture_float`)),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension(`OES_texture_half_float`)),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension(`EXT_shader_texture_lod`)),texelFetch:this._webGLVersion!==1,blendMinMax:!1,multiview:this._gl.getExtension(`OVR_multiview2`),oculusMultiview:this._gl.getExtension(`OCULUS_multiview`),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_ARRAY_TEXTURE_LAYERS):128,disableMorphTargetTexture:!1},this._glVersion=this._gl.getParameter(this._gl.VERSION);let e=this._gl.getExtension(`WEBGL_debug_renderer_info`);if(e!=null&&(this._glRenderer=this._gl.getParameter(e.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(e.UNMASKED_VENDOR_WEBGL)),this._glVendor||=this._gl.getParameter(this._gl.VENDOR)||`Unknown vendor`,this._glRenderer||=this._gl.getParameter(this._gl.RENDERER)||`Unknown renderer`,this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=(this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT)??0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension(`OES_texture_float_linear`)),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension(`OES_texture_half_float_linear`)),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride===null?this._gl.getParameter(this._gl.MAX_SAMPLES):this._maxMSAASamplesOverride;else{let e=this._gl.getExtension(`WEBGL_draw_buffers`);if(e!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=e.drawBuffersWEBGL.bind(e),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let t=0;t<16;t++)this._gl[`COLOR_ATTACHMENT`+t+`_WEBGL`]=e[`COLOR_ATTACHMENT`+t+`_WEBGL`]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{let e=this._gl.getExtension(`WEBGL_depth_texture`);e!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=e.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{let e=this._gl.getExtension(`OES_vertex_array_object`);e!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=e.createVertexArrayOES.bind(e),this._gl.bindVertexArray=e.bindVertexArrayOES.bind(e),this._gl.deleteVertexArray=e.deleteVertexArrayOES.bind(e))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{let e=this._gl.getExtension(`ANGLE_instanced_arrays`);e==null?this._caps.instancedArrays=!1:(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=e.drawArraysInstancedANGLE.bind(e),this._gl.drawElementsInstanced=e.drawElementsInstancedANGLE.bind(e),this._gl.vertexAttribDivisor=e.vertexAttribDivisorANGLE.bind(e))}if(this._gl.getShaderPrecisionFormat){let e=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),t=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);e&&t&&(this._caps.highPrecisionShaderSupported=e.precision!==0&&t.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{let e=this._gl.getExtension(`EXT_blend_minmax`);e!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=e.MAX_EXT,this._gl.MIN=e.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{let e=this._gl.getExtension(`EXT_sRGB`);e!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=e.SRGB_EXT,this._gl.SRGB8=e.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=e.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let e=0;e<this._maxSimultaneousTextures;e++)this._nextFreeTextureSlots.push(e);this._glRenderer===`Mali-G72`&&(this._caps.disableMorphTargetTexture=!0)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return`ThinEngine`}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);let e=this._workingCanvas.getContext(`2d`);e&&(this._workingContext=e)}resetTextureCache(){for(let e in this._boundTexturesCache)Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)&&(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops.length=0;return}let t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if((this._isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e){this.beginFrame();for(let e=0;e<this._activeRenderLoops.length;e++){let t=this._activeRenderLoops[e];t()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return s()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(t,n){return e.QueueNewFrame(t,n)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,n,r=!1){let i=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=i;let a=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a===void 0?1:e.a),a|=this._gl.COLOR_BUFFER_BIT),n&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),a|=this._gl.DEPTH_BUFFER_BIT),r&&(this._gl.clearStencil(0),a|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(a)}_viewport(e,t,n,r){(e!==this._viewportCached.x||t!==this._viewportCached.y||n!==this._viewportCached.z||r!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=n,this._viewportCached.w=r,this._gl.viewport(e,t,n,r))}setViewport(e,t,n){let r=t||this.getRenderWidth(),i=n||this.getRenderHeight(),a=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(a*r,o*i,r*e.width,i*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,n;if(this.adaptToDeviceRatio){let e=s()&&window.devicePixelRatio||1,t=this._lastDevicePixelRatio/e;this._lastDevicePixelRatio=e,this._hardwareScalingLevel*=t}s()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,n=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,n=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,n/this._hardwareScalingLevel,e)}setSize(e,t,n=!1){return!this._renderingCanvas||(e|=0,t|=0,!n&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,n,r,i,a=0,o=0){let s=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(s._MSAAFramebuffer?s._MSAAFramebuffer:s._framebuffer);let c=this._gl;e.isMulti||(e.is2DArray?c.framebufferTextureLayer(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,e.texture._hardwareTexture?.underlyingResource,a,o):e.isCube&&c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,e.texture._hardwareTexture?.underlyingResource,a));let l=e._depthStencilTexture;if(l){let n=e._depthStencilTextureWithStencil?c.DEPTH_STENCIL_ATTACHMENT:c.DEPTH_ATTACHMENT;e.is2DArray?c.framebufferTextureLayer(c.FRAMEBUFFER,n,l._hardwareTexture?.underlyingResource,a,o):e.isCube?c.framebufferTexture2D(c.FRAMEBUFFER,n,c.TEXTURE_CUBE_MAP_POSITIVE_X+t,l._hardwareTexture?.underlyingResource,a):c.framebufferTexture2D(c.FRAMEBUFFER,n,c.TEXTURE_2D,l._hardwareTexture?.underlyingResource,a)}this._cachedViewport&&!i?this.setViewport(this._cachedViewport,n,r):(n||(n=e.width,a&&(n/=2**a)),r||(r=e.height,a&&(r/=2**a)),this._viewport(0,0,n,r)),this.wipeCaches()}setState(e,t=0,n,r=!1,i,a,o=0){var s;(this._depthCullingState.cull!==e||n)&&(this._depthCullingState.cull=e);let c=(s=this.cullBackFaces??i)==null||s?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==c||n)&&(this._depthCullingState.cullFace=c),this.setZOffset(t),this.setZOffsetUnits(o);let l=r?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==l||n)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=a}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){let e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){let e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,n){var r;let i=e;this._currentRenderTarget=null;let a=this._gl;if(i._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,n);return}a.bindFramebuffer(a.READ_FRAMEBUFFER,i._MSAAFramebuffer),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,i._framebuffer),a.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,a.COLOR_BUFFER_BIT,a.NEAREST)}(r=e.texture)!=null&&r.generateMipMaps&&!t&&!e.isCube&&this.generateMipmaps(e.texture),n&&(i._MSAAFramebuffer&&this._bindUnboundFramebuffer(i._framebuffer),n()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){let n=this._gl.createBuffer();if(!n)throw Error(`Unable to create vertex buffer`);let r=new De(n);return this.bindArrayBuffer(r),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),r.references=1,r}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t){let n=this._gl.createBuffer(),r=new De(n);if(!n)throw Error(`Unable to create index buffer`);this.bindIndexBuffer(r);let i=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),r.references=1,r.is32Bits=i.BYTES_PER_ELEMENT===4,r}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let t=0;t<e.length;t++)if(e[t]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,n){let r=e.program,i=this._gl.getUniformBlockIndex(r,t);this._gl.uniformBlockBinding(r,i,n)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,n,r,i,a,o){let s=this._currentBufferPointers[t];if(!s)return;let c=!1;s.active?(s.buffer!==e&&(s.buffer=e,c=!0),s.size!==n&&(s.size=n,c=!0),s.type!==r&&(s.type=r,c=!0),s.normalized!==i&&(s.normalized=i,c=!0),s.stride!==a&&(s.stride=a,c=!0),s.offset!==o&&(s.offset=o,c=!0)):(c=!0,s.active=!0,s.index=t,s.size=n,s.type=r,s.normalized=i,s.stride=a,s.offset=o,s.buffer=e),(c||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),r===this._gl.UNSIGNED_INT||r===this._gl.INT?this._gl.vertexAttribIPointer(t,n,r,a,o):this._gl.vertexAttribPointer(t,n,r,i,a,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,n){let r=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let i=0;i<r.length;i++){let a=t.getAttributeLocation(i);if(a>=0){let t=r[i],o=null;if(n&&(o=n[t]),o||=e[t],!o)continue;this._gl.enableVertexAttribArray(a),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[a]=!0);let s=o.getBuffer();s&&(this._vertexAttribPointer(s,a,o.getSize(),o.type,o.normalized,o.byteStride,o.byteOffset),o.getIsInstanced()&&(this._gl.vertexAttribDivisor(a,o.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(a),this._currentInstanceBuffers.push(s))))}}}recordVertexArrayObject(e,t,n,r){let i=this._gl.createVertexArray();if(!i)throw Error(`Unable to create VAO`);return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(i),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,n,r),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),i}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,n,r,i){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i;let t=i.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let a=0;for(let o=0;o<t;o++)if(o<n.length){let t=i.getAttributeLocation(o);t>=0&&(this._gl.enableVertexAttribArray(t),this._vertexAttribArraysEnabled[t]=!0,this._vertexAttribPointer(e,t,n[o],this._gl.FLOAT,!1,r,a)),a+=n[o]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){this._cachedVertexArrayObject&&(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,n,r){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==n)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=n,this._bindVertexBuffersAttributes(e,n,r)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,n=this._currentInstanceLocations.length;t<n;t++){let n=this._currentInstanceBuffers[t];e!=n&&n.references&&(e=n,this.bindArrayBuffer(n));let r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,n){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),n[0].index!==void 0)this.bindInstancesBuffer(e,n,!0);else for(let t=0;t<4;t++){let r=n[t];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,t*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,n=!0){this.bindArrayBuffer(e);let r=0;if(n)for(let e=0;e<t.length;e++){let n=t[e];r+=n.attributeSize*4}for(let n=0;n<t.length;n++){let i=t[n];i.index===void 0&&(i.index=this._currentEffect.getAttributeLocationByName(i.attributeName)),!(i.index<0)&&(this._vertexAttribArraysEnabled[i.index]||(this._gl.enableVertexAttribArray(i.index),this._vertexAttribArraysEnabled[i.index]=!0),this._vertexAttribPointer(e,i.index,i.attributeSize,i.attributeType||this._gl.FLOAT,i.normalized||!1,r,i.offset),this._gl.vertexAttribDivisor(i.index,i.divisor===void 0?1:i.divisor),this._currentInstanceLocations.push(i.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;let t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,n;for(;(n=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(n,1),this._currentInstanceBuffers.splice(n,1),t=!0,n=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,n,r){this.drawElementsType(e?0:1,t,n,r)}drawPointClouds(e,t,n){this.drawArraysType(2,e,t,n)}drawUnIndexed(e,t,n,r){this.drawArraysType(e?0:1,t,n,r)}drawElementsType(e,t,n,r){this.applyStates(),this._reportDrawCall();let i=this._drawMode(e),a=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;r?this._gl.drawElementsInstanced(i,n,a,t*o,r):this._gl.drawElements(i,n,a,t*o)}drawArraysType(e,t,n,r){this.applyStates(),this._reportDrawCall();let i=this._drawMode(e);r?this._gl.drawArraysInstanced(i,t,n,r):this._gl.drawArrays(i,t,n)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];let t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){let t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE=``:delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER=``:delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS=``:delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let e=``;return this.isNDCHalfZRange&&(e+=`#define IS_NDC_HALF_ZRANGE`),this.useReverseDepthBuffer&&(e&&(e+=`
`),e+=`#define USE_REVERSE_DEPTHBUFFER`),this.useExactSrgbConversions&&(e&&(e+=`
`),e+=`#define USE_EXACT_SRGB_CONVERSIONS`),e}}createEffect(e,t,n,r,i,a,o,s,c,l=de.GLSL){let u=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,d=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,f=this._getGlobalDefines(),p=i??t.defines??``;f&&(p+=f);let m=u+`+`+d+`@`+p;if(this._compiledEffects[m]){let e=this._compiledEffects[m];return o&&e.isReady()&&o(e),e}let h=new _e(e,t,n,r,this,i,a,o,s,c,m,l);return this._compiledEffects[m]=h,h}static _ConcatenateShader(e,t,n=``){return n+(t?t+`
`:``)+e}_compileShader(t,n,r,i){return this._compileRawShader(e._ConcatenateShader(t,r,i),n)}_compileRawShader(e,t){let n=this._gl,r=n.createShader(t===`vertex`?n.VERTEX_SHADER:n.FRAGMENT_SHADER);if(!r){let e=n.NO_ERROR,r=n.NO_ERROR;for(;(r=n.getError())!==n.NO_ERROR;)e=r;throw Error(`Something went wrong while creating a gl ${t} shader object. gl error=${e}, gl isContextLost=${n.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return n.shaderSource(r,e),n.compileShader(r),r}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,n,r,i=null){r||=this._gl;let a=this._compileRawShader(t,`vertex`),o=this._compileRawShader(n,`fragment`);return this._createShaderProgram(e,a,o,r,i)}createShaderProgram(e,t,n,r,i,a=null){i||=this._gl;let o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:``,s=this._compileShader(t,`vertex`,r,o),c=this._compileShader(n,`fragment`,r,o);return this._createShaderProgram(e,s,c,i,a)}inlineShaderCode(e){return e}createPipelineContext(e){let t=new Oe;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,n,r,i=null){let a=r.createProgram();if(e.program=a,!a)throw Error(`Unable to create program`);return r.attachShader(a,t),r.attachShader(a,n),r.linkProgram(a),e.context=r,e.vertexShader=t,e.fragmentShader=n,e.isParallelCompiled||this._finalizePipelineContext(e),a}_finalizePipelineContext(e){let t=e.context,n=e.vertexShader,r=e.fragmentShader,i=e.program;if(!t.getProgramParameter(i,t.LINK_STATUS)){if(!this._gl.getShaderParameter(n,this._gl.COMPILE_STATUS)){let t=this._gl.getShaderInfoLog(n);if(t)throw e.vertexCompilationError=t,Error(`VERTEX SHADER `+t)}if(!this._gl.getShaderParameter(r,this._gl.COMPILE_STATUS)){let t=this._gl.getShaderInfoLog(r);if(t)throw e.fragmentCompilationError=t,Error(`FRAGMENT SHADER `+t)}let a=t.getProgramInfoLog(i);if(a)throw e.programLinkError=a,Error(a)}if(this.validateShaderPrograms&&(t.validateProgram(i),!t.getProgramParameter(i,t.VALIDATE_STATUS))){let n=t.getProgramInfoLog(i);if(n)throw e.programValidationError=n,Error(n)}t.deleteShader(n),t.deleteShader(r),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&=(e.onCompiled(),void 0)}_preparePipelineContext(e,t,n,r,i,a,o,s,c,l){let u=e;r?u.program=this.createRawShaderProgram(u,t,n,void 0,c):u.program=this.createShaderProgram(u,t,n,s,void 0,c),u.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){let t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){let n=e;if(!n.isParallelCompiled){t();return}let r=n.onCompiled;r?n.onCompiled=()=>{r(),t()}:n.onCompiled=t}getUniforms(e,t){let n=[],r=e;for(let e=0;e<t.length;e++)n.push(this._gl.getUniformLocation(r.program,t[e]));return n}getAttributes(e,t){let n=[],r=e;for(let e=0;e<t.length;e++)try{n.push(this._gl.getAttribLocation(r.program,t[e]))}catch{n.push(-1)}return n}enableEffect(e){e=e!==null&&je.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,n){return e?(this._gl.uniform2i(e,t,n),!0):!1}setInt3(e,t,n,r){return e?(this._gl.uniform3i(e,t,n,r),!0):!1}setInt4(e,t,n,r,i){return e?(this._gl.uniform4i(e,t,n,r,i),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4iv(e,t),!0)}setUInt(e,t){return e?(this._gl.uniform1ui(e,t),!0):!1}setUInt2(e,t,n){return e?(this._gl.uniform2ui(e,t,n),!0):!1}setUInt3(e,t,n,r){return e?(this._gl.uniform3ui(e,t,n,r),!0):!1}setUInt4(e,t,n,r,i){return e?(this._gl.uniform4ui(e,t,n,r,i),!0):!1}setUIntArray(e,t){return e?(this._gl.uniform1uiv(e,t),!0):!1}setUIntArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2uiv(e,t),!0)}setUIntArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3uiv(e,t),!0)}setUIntArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4uiv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!=0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!=0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!=0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,n){return e?(this._gl.uniform2f(e,t,n),!0):!1}setFloat3(e,t,n,r){return e?(this._gl.uniform3f(e,t,n,r),!0):!1}setFloat4(e,t,n,r,i){return e?(this._gl.uniform4f(e,t,n,r,i),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;let e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){let n=this._gl,r=n.NEAREST,i=n.NEAREST;switch(e){case 11:r=n.LINEAR,i=t?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 3:r=n.LINEAR,i=t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 8:r=n.NEAREST,i=t?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 4:r=n.NEAREST,i=t?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 5:r=n.NEAREST,i=t?n.LINEAR_MIPMAP_NEAREST:n.LINEAR;break;case 6:r=n.NEAREST,i=t?n.LINEAR_MIPMAP_LINEAR:n.LINEAR;break;case 7:r=n.NEAREST,i=n.LINEAR;break;case 1:r=n.NEAREST,i=n.NEAREST;break;case 9:r=n.LINEAR,i=t?n.NEAREST_MIPMAP_NEAREST:n.NEAREST;break;case 10:r=n.LINEAR,i=t?n.NEAREST_MIPMAP_LINEAR:n.NEAREST;break;case 2:r=n.LINEAR,i=n.LINEAR;break;case 12:r=n.LINEAR,i=n.NEAREST;break}return{min:i,mag:r}}_createTexture(){let e=this._gl.createTexture();if(!e)throw Error(`Unable to create texture`);return e}_createHardwareTexture(){return new Ae(this._createTexture(),this._gl)}_createInternalTexture(e,t,n=!0,r=Se.Unknown){let i=!1,a=0,o=3,s=5,c=!1,l=1,u;t!==void 0&&typeof t==`object`?(i=!!t.generateMipMaps,a=t.type===void 0?0:t.type,o=t.samplingMode===void 0?3:t.samplingMode,s=t.format===void 0?5:t.format,c=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer,l=t.samples??1,u=t.label):i=!!t,c&&=this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(a===1&&!this._caps.textureFloatLinearFiltering||a===2&&!this._caps.textureHalfFloatLinearFiltering)&&(o=1),a===1&&!this._caps.textureFloat&&(a=0,f.Warn(`Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE`));let d=this._gl,p=new Ce(this,r),m=e.width||e,h=e.height||e,g=e.layers||0,_=this._getSamplingParameters(o,i),v=g===0?d.TEXTURE_2D:d.TEXTURE_2D_ARRAY,y=this._getRGBABufferInternalSizedFormat(a,s,c),b=this._getInternalFormat(s),x=this._getWebGLTextureType(a);return this._bindTextureDirectly(v,p),g===0?d.texImage2D(v,0,y,m,h,0,b,x,null):(p.is2DArray=!0,d.texImage3D(v,0,y,m,h,g,0,b,x,null)),d.texParameteri(v,d.TEXTURE_MAG_FILTER,_.mag),d.texParameteri(v,d.TEXTURE_MIN_FILTER,_.min),d.texParameteri(v,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(v,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),i&&this._gl.generateMipmap(v),this._bindTextureDirectly(v,null),p._useSRGBBuffer=c,p.baseWidth=m,p.baseHeight=h,p.width=m,p.height=h,p.depth=g,p.isReady=!0,p.samples=l,p.generateMipMaps=i,p.samplingMode=o,p.type=a,p.format=s,p.label=u,this._internalTexturesCache.push(p),p}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(t,n,r,i,a=3,o=null,s=null,c,l,u=null,d=null,p=null,m=null,h,g,_){t||=``;let v=t.substr(0,5)===`data:`,y=t.substr(0,5)===`blob:`,x=v&&t.indexOf(`;base64,`)!==-1,S=d||new Ce(this,Se.Url);S!==d&&(S.label=t.substring(0,60));let C=t;this._transformTextureUrl&&!x&&!d&&!u&&(t=this._transformTextureUrl(t)),C!==t&&(S._originalUrl=C);let w=t.lastIndexOf(`.`),T=m||(w>-1?t.substring(w).toLowerCase():``),E=null;T.indexOf(`?`)>-1&&(T=T.split(`?`)[0]);for(let t of e._TextureLoaders)if(t.canLoad(T,h)){E=t;break}i&&i.addPendingData(S),S.url=t,S.generateMipMaps=!n,S.samplingMode=a,S.invertY=r,S._useSRGBBuffer=this._getUseSRGBBuffer(!!_,n),this._doNotHandleContextLost||(S._buffer=u);let ee=null;o&&!d&&(ee=S.onLoadedObservable.add(o)),d||this._internalTexturesCache.push(S);let te=(e,r)=>{i&&i.removePendingData(S),t===C?(ee&&S.onLoadedObservable.remove(ee),b.UseFallbackTexture&&this._createTextureBase(b.FallbackTexture,n,S.invertY,i,a,null,s,c,l,u,S),e=(e||`Unknown error`)+(b.UseFallbackTexture?` - Fallback texture was used`:``),S.onErrorObservable.notifyObservers({message:e,exception:r}),s&&s(e,r)):(f.Warn(`Failed to load ${t}, falling back to ${C}`),this._createTextureBase(C,n,S.invertY,i,a,o,s,c,l,u,S,p,m,h,g,_))};if(E){let e=e=>{E.loadData(e,S,(e,t,n,r,o,s)=>{s?te(`TextureLoader failed to load data`):c(S,T,i,{width:e,height:t},S.invertY,!n,r,()=>(o(),!1),a)},g)};u?u instanceof ArrayBuffer?e(new Uint8Array(u)):ArrayBuffer.isView(u)?e(u):s&&s(`Unable to load: only ArrayBuffer or ArrayBufferView is supported`,null):this._loadFile(t,t=>e(new Uint8Array(t)),void 0,i?i.offlineProvider:void 0,!0,(e,t)=>{te(`Unable to load `+(e&&e.responseURL,t))})}else{let r=e=>{y&&!this._doNotHandleContextLost&&(S._buffer=e),c(S,T,i,e,S.invertY,n,!1,l,a)};!v||x?u&&(typeof u.decoding==`string`||u.close)?r(u):e._FileToolsLoadImage(t,r,te,i?i.offlineProvider:null,h,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:`flipY`}:void 0):typeof u==`string`||u instanceof ArrayBuffer||ArrayBuffer.isView(u)||u instanceof Blob?e._FileToolsLoadImage(u,r,te,i?i.offlineProvider:null,h,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:`flipY`}:void 0):u&&r(u)}return S}createTexture(e,t,n,r,i=3,a=null,o=null,s=null,c=null,l=null,u=null,d,f,p,m){return this._createTextureBase(e,t,n,r,i,a,o,this._prepareWebGLTexture.bind(this),(e,t,n,i,a,o)=>{let s=this._gl,c=n.width===e&&n.height===t,u=l?this._getInternalFormat(l,a._useSRGBBuffer):i===`.jpg`&&!a._useSRGBBuffer?s.RGB:a._useSRGBBuffer?s.SRGB8_ALPHA8:s.RGBA,d=l?this._getInternalFormat(l):i===`.jpg`&&!a._useSRGBBuffer?s.RGB:s.RGBA;if(a._useSRGBBuffer&&this.webGLVersion===1&&(d=u),c)return s.texImage2D(s.TEXTURE_2D,0,u,d,s.UNSIGNED_BYTE,n),!1;let f=this._caps.maxTextureSize;if(n.width>f||n.height>f||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=e,this._workingCanvas.height=t,this._workingContext.drawImage(n,0,0,n.width,n.height,0,0,e,t),s.texImage2D(s.TEXTURE_2D,0,u,d,s.UNSIGNED_BYTE,this._workingCanvas),a.width=e,a.height=t),!1;{let e=new Ce(this,Se.Temp);this._bindTextureDirectly(s.TEXTURE_2D,e,!0),s.texImage2D(s.TEXTURE_2D,0,u,d,s.UNSIGNED_BYTE,n),this._rescaleTexture(e,a,r,u,()=>{this._releaseTexture(e),this._bindTextureDirectly(s.TEXTURE_2D,a,!0),o()})}return!0},s,c,l,u,d,f,m)}static _FileToolsLoadImage(e,t,n,r,i,a){throw _(`FileTools`)}_rescaleTexture(e,t,n,r,i){}createRawTexture(e,t,n,r,i,a,o,s=null,c=0,l=0,u=!1){throw _(`Engine.RawTexture`)}createRawCubeTexture(e,t,n,r,i,a,o,s=null){throw _(`Engine.RawTexture`)}createRawTexture3D(e,t,n,r,i,a,o,s,c=null,l=0){throw _(`Engine.RawTexture`)}createRawTexture2DArray(e,t,n,r,i,a,o,s,c=null,l=0){throw _(`Engine.RawTexture`)}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,n=!1){let r=this._getTextureTarget(t),i=this._getSamplingParameters(e,t.useMipMaps||n);this._setTextureParameterInteger(r,this._gl.TEXTURE_MAG_FILTER,i.mag,t),this._setTextureParameterInteger(r,this._gl.TEXTURE_MIN_FILTER,i.min),n&&(t.generateMipMaps=!0,this._gl.generateMipmap(r)),this._bindTextureDirectly(r,null),t.samplingMode=e}updateTextureDimensions(e,t,n,r=1){}updateTextureWrappingMode(e,t,n=null,r=null){let i=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),n!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(n),e),e._cachedWrapV=n),(e.is2DArray||e.is3D)&&r!==null&&(this._setTextureParameterInteger(i,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(r),e),e._cachedWrapR=r),this._bindTextureDirectly(i,null)}_setupDepthStencilTexture(e,t,n,r,i,a=1){let o=t.width||t,s=t.height||t,c=t.layers||0;e.baseWidth=o,e.baseHeight=s,e.width=o,e.height=s,e.is2DArray=c>0,e.depth=c,e.isReady=!0,e.samples=a,e.generateMipMaps=!1,e.samplingMode=r?2:1,e.type=0,e._comparisonFunction=i;let l=this._gl,u=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);l.texParameteri(u,l.TEXTURE_MAG_FILTER,d.mag),l.texParameteri(u,l.TEXTURE_MIN_FILTER,d.min),l.texParameteri(u,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(u,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this.webGLVersion>1&&(i===0?(l.texParameteri(u,l.TEXTURE_COMPARE_FUNC,515),l.texParameteri(u,l.TEXTURE_COMPARE_MODE,l.NONE)):(l.texParameteri(u,l.TEXTURE_COMPARE_FUNC,i),l.texParameteri(u,l.TEXTURE_COMPARE_MODE,l.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,n,r,i,a=0,o=0){let s=this._gl,c=s.TEXTURE_2D;if(e.isCube&&(c=s.TEXTURE_CUBE_MAP_POSITIVE_X+a),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=s.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(c,o,t,n,r,0,i)}_uploadDataToTextureDirectly(e,t,n=0,r=0,i,a=!1){let o=this._gl,s=this._getWebGLTextureType(e.type),c=this._getInternalFormat(e.format),l=i===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(i,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=o.TEXTURE_2D;e.isCube&&(u=o.TEXTURE_CUBE_MAP_POSITIVE_X+n);let d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=a?e.width:2**Math.max(d-r,0),m=a?e.height:2**Math.max(f-r,0);o.texImage2D(u,r,l,p,m,0,c,s,t)}updateTextureData(e,t,n,r,i,a,o=0,s=0,c=!1){let l=this._gl,u=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=l.TEXTURE_2D,p=l.TEXTURE_2D;e.isCube&&(p=l.TEXTURE_CUBE_MAP_POSITIVE_X+o,f=l.TEXTURE_CUBE_MAP),this._bindTextureDirectly(f,e,!0),l.texSubImage2D(p,s,n,r,i,a,d,u,t),c&&this._gl.generateMipmap(p),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,n=0,r=0){let i=this._gl,a=e.isCube?i.TEXTURE_CUBE_MAP:i.TEXTURE_2D;this._bindTextureDirectly(a,e,!0),this._uploadDataToTextureDirectly(e,t,n,r),this._bindTextureDirectly(a,null,!0)}_prepareWebGLTextureContinuation(e,t,n,r,i){let a=this._gl;if(!a)return;let o=this._getSamplingParameters(i,!n);a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,o.mag),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,o.min),!n&&!r&&a.generateMipmap(a.TEXTURE_2D),this._bindTextureDirectly(a.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(t,n,r,i,a,o,s,c,l=3){let u=this.getCaps().maxTextureSize,d=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(i.width,u):i.width),f=Math.min(u,this.needPOTTextures?e.GetExponentOfTwo(i.height,u):i.height),p=this._gl;if(p){if(!t._hardwareTexture){r&&r.removePendingData(t);return}this._bindTextureDirectly(p.TEXTURE_2D,t,!0),this._unpackFlipY(a===void 0?!0:!!a),t.baseWidth=i.width,t.baseHeight=i.height,t.width=d,t.height=f,t.isReady=!0,!c(d,f,i,n,t,()=>{this._prepareWebGLTextureContinuation(t,r,o,s,l)})&&this._prepareWebGLTextureContinuation(t,r,o,s,l)}}_setupFramebufferDepthAttachments(e,t,n,r,i=1){let a=this._gl;if(e&&t)return this._createRenderBuffer(n,r,i,a.DEPTH_STENCIL,a.DEPTH24_STENCIL8,a.DEPTH_STENCIL_ATTACHMENT);if(t){let e=a.DEPTH_COMPONENT16;return this._webGLVersion>1&&(e=a.DEPTH_COMPONENT32F),this._createRenderBuffer(n,r,i,e,e,a.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(n,r,i,a.STENCIL_INDEX8,a.STENCIL_INDEX8,a.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,n,r,i,a,o=!0){let s=this._gl.createRenderbuffer();return this._updateRenderBuffer(s,e,t,n,r,i,a,o)}_updateRenderBuffer(e,t,n,r,i,a,o,s=!0){let c=this._gl;return c.bindRenderbuffer(c.RENDERBUFFER,e),r>1&&c.renderbufferStorageMultisample?c.renderbufferStorageMultisample(c.RENDERBUFFER,r,a,t,n):c.renderbufferStorage(c.RENDERBUFFER,i,t,n),c.framebufferRenderbuffer(c.FRAMEBUFFER,o,c.RENDERBUFFER,e),s&&c.bindRenderbuffer(c.RENDERBUFFER,null),e}_releaseTexture(e){this._deleteTexture(e._hardwareTexture?.underlyingResource),this.unbindAllTextures();let t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){let t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){let t=e.getPipelineContext();this._setProgram(t.program);let n=e.getSamplers();for(let t=0;t<n.length;t++){let r=e.getUniform(n[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,n=!1,r=!1){let i=!1,a=t&&t._associatedChannel>-1;if(n&&a&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||r){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),`_bindTextureDirectly called with a multiview texture!`;this._gl.bindTexture(e,t?._hardwareTexture?.underlyingResource??null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else n&&(i=!0,this._activateCurrentTexture());return a&&!n&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),i}_bindTexture(e,t,n){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;let r=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(r,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,n,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,n))}_bindSamplerUniformToChannel(e,t){let n=this._boundUniforms[e];!n||n._currentState===t||(this._gl.uniform1i(n,t),n._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,n=!1,r=!1,i=``){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let a;a=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,!n&&a&&(a._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===a&&(n||this._bindSamplerUniformToChannel(a._associatedChannel,e),o=!1),this._activeChannel=e;let s=this._getTextureTarget(a);if(o&&this._bindTextureDirectly(s,a,n),a&&!a.isMultiview){if(a.isCube&&a._cachedCoordinatesMode!==t.coordinatesMode){a._cachedCoordinatesMode=t.coordinatesMode;let e=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=e,t.wrapV=e}a._cachedWrapU!==t.wrapU&&(a._cachedWrapU=t.wrapU,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),a)),a._cachedWrapV!==t.wrapV&&(a._cachedWrapV=t.wrapV,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),a)),a.is3D&&a._cachedWrapR!==t.wrapR&&(a._cachedWrapR=t.wrapR,this._setTextureParameterInteger(s,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),a)),this._setAnisotropicLevel(s,a,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,n,r){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==n.length)&&(this._textureUnits=new Int32Array(n.length));for(let t=0;t<n.length;t++){let r=n[t].getInternalTexture();r?(this._textureUnits[t]=e+t,r._associatedChannel=e+t):this._textureUnits[t]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let e=0;e<n.length;e++)this._setTexture(this._textureUnits[e],n[e],!0)}}_setAnisotropicLevel(e,t,n){let r=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(n=1),r&&t._cachedAnisotropicFilteringLevel!==n&&(this._setTextureParameterFloat(e,r.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=n)}_setTextureParameterFloat(e,t,n,r){this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameterf(e,t,n)}_setTextureParameterInteger(e,t,n,r){r&&this._bindTextureDirectly(e,r,!0,!0),this._gl.texParameteri(e,t,n)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e;this._isDisposed=!0,this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&=(this._releaseTexture(this._emptyTexture),null),this._emptyCubeTexture&&=(this._releaseTexture(this._emptyCubeTexture),null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)==null||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},s()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener(`webglcontextlost`,this._onContextLost),this._renderingCanvas.removeEventListener(`webglcontextrestored`,this._onContextRestored)),window.removeEventListener(`resize`,this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,_e.ResetCache();for(let e of this._activeRequests)e.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener(`webglcontextlost`,e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener(`webglcontextrestored`,e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){let t=this._gl;for(;t.getError()!==t.NO_ERROR;);let n=!0,r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);let i=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,i),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0);let a=t.checkFramebufferStatus(t.FRAMEBUFFER);if(n&&=a===t.FRAMEBUFFER_COMPLETE,n&&=t.getError()===t.NO_ERROR,n&&(t.clear(t.COLOR_BUFFER_BIT),n&&=t.getError()===t.NO_ERROR),n){t.bindFramebuffer(t.FRAMEBUFFER,null);let e=t.RGBA,r=t.UNSIGNED_BYTE,i=new Uint8Array(4);t.readPixels(0,0,1,1,e,r,i),n&&=t.getError()===t.NO_ERROR}for(t.deleteTexture(r),t.deleteFramebuffer(i),t.bindFramebuffer(t.FRAMEBUFFER,null);!n&&t.getError()!==t.NO_ERROR;);return n}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let n=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:n=this._gl.ALPHA;break;case 1:n=this._gl.LUMINANCE;break;case 2:n=this._gl.LUMINANCE_ALPHA;break;case 6:n=this._gl.RED;break;case 7:n=this._gl.RG;break;case 4:n=t?this._gl.SRGB:this._gl.RGB;break;case 5:n=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:n=this._gl.RED_INTEGER;break;case 9:n=this._gl.RG_INTEGER;break;case 10:n=this._gl.RGB_INTEGER;break;case 11:n=this._gl.RGBA_INTEGER;break}return n}_getRGBABufferInternalSizedFormat(e,t,n=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return n?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return n?this._gl.SRGB8:this._gl.RGB8;case 5:return n?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return n?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(t,n,r,i,a,o){let s=e._FileToolsLoadFile(t,n,r,i,a,o);return this._activeRequests.push(s),s.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),s}static _FileToolsLoadFile(e,t,n,r,i,a){throw _(`FileTools`)}readPixels(e,t,n,r,i=!0,a=!0){let o=i?4:3,s=i?this._gl.RGBA:this._gl.RGB,c=new Uint8Array(r*n*o);return a&&this.flushFramebuffer(),this._gl.readPixels(e,t,n,r,s,this._gl.UNSIGNED_BYTE,c),Promise.resolve(c)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{let e=this._CreateCanvas(1,1);this._IsSupported=(e.getContext(`webgl`)||e.getContext(`experimental-webgl`))!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{let e=this._CreateCanvas(1,1);this._HasMajorPerformanceCaveat=!(e.getContext(`webgl`,{failIfMajorPerformanceCaveat:!0})||e.getContext(`experimental-webgl`,{failIfMajorPerformanceCaveat:!0}))}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e-(e>>1)}static NearestPOT(t){let n=e.CeilingPOT(t),r=e.FloorPOT(t);return n-t>t-r?r:n}static GetExponentOfTwo(t,n,r=2){let i;switch(r){case 1:i=e.FloorPOT(t);break;case 2:i=e.NearestPOT(t);break;case 3:default:i=e.CeilingPOT(t);break}return Math.min(i,n)}static QueueNewFrame(e,t){if(s()){let{requestPostAnimationFrame:n,requestAnimationFrame:r}=t||window;if(typeof n==`function`)return n(e);if(typeof r==`function`)return r(e)}else if(typeof requestAnimationFrame==`function`)return requestAnimationFrame(e);return setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:l()?document:null}};k.ExceptionList=[{key:`Chrome/63.0`,capture:`63\\.0\\.3239\\.(\\d+)`,captureConstraint:108,targets:[`uniformBuffer`]},{key:`Firefox/58`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`Firefox/59`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`Chrome/72.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Chrome/73.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Chrome/74.+?Mobile`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome/71`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome/72`,capture:null,captureConstraint:null,targets:[`vao`]},{key:`Mac OS.+Chrome`,capture:null,captureConstraint:null,targets:[`uniformBuffer`]},{key:`.*AppleWebKit.*(15.4).*Safari`,capture:null,captureConstraint:null,targets:[`antialias`,`maxMSAASamples`]},{key:`.*(15.4).*AppleWebKit.*Safari`,capture:null,captureConstraint:null,targets:[`antialias`,`maxMSAASamples`]}],k._TextureLoaders=[],k.CollisionsEpsilon=.001,k._IsSupported=null,k._HasMajorPerformanceCaveat=null;var Pe=class{static SetImmediate(e){s()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}},Fe=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i),Ie=class e extends T{constructor(t,n){super(t,w.LoadFileError),this.name=`LoadFileError`,C._setPrototypeOf(this,e.prototype),n instanceof y?this.request=n:this.file=n}},Le=class e extends T{constructor(t,n){super(t,w.RequestFileError),this.request=n,this.name=`RequestFileError`,C._setPrototypeOf(this,e.prototype)}},Re=class e extends T{constructor(t,n){super(t,w.ReadFileError),this.file=n,this.name=`ReadFileError`,C._setPrototypeOf(this,e.prototype)}},ze={DefaultRetryStrategy:S.ExponentialBackoff(),BaseUrl:``,CorsBehavior:`anonymous`,PreprocessUrl:e=>e},Be=e=>(e=e.replace(/#/gm,`%23`),e),Ve=(e,t)=>{if(!(e&&e.indexOf(`data:`)===0)&&ze.CorsBehavior)if(typeof ze.CorsBehavior==`string`||ze.CorsBehavior instanceof String)t.crossOrigin=ze.CorsBehavior;else{let n=ze.CorsBehavior(e);n&&(t.crossOrigin=n)}},He=(e,t,n,r,i=``,a)=>{var o;let s,c=!1;e instanceof ArrayBuffer||ArrayBuffer.isView(e)?typeof Blob<`u`&&typeof URL<`u`?(s=URL.createObjectURL(new Blob([e],{type:i})),c=!0):s=`data:${i};base64,`+E(e):e instanceof Blob?(s=URL.createObjectURL(e),c=!0):(s=Be(e),s=ze.PreprocessUrl(e));let l=b.LastCreatedEngine,u=t=>{if(n){let r=s||e.toString();n(`Error while trying to load image: ${r.indexOf(`http`)===0||r.length<=128?r:r.slice(0,128)+`...`}`,t)}};if(typeof Image>`u`||(o=l?._features.forceBitmapOverHTMLImageElement)!=null&&o)return We(s,r=>{l.createImageBitmap(new Blob([r],{type:i}),{premultiplyAlpha:`none`,...a}).then(e=>{t(e),c&&URL.revokeObjectURL(s)}).catch(t=>{n&&n(`Error while trying to load image: `+e,t)})},void 0,r||void 0,!0,(e,t)=>{u(t)}),null;let d=new Image;Ve(s,d);let f=[],p=()=>{f.forEach(e=>{e.target.addEventListener(e.name,e.handler)})},m=()=>{f.forEach(e=>{e.target.removeEventListener(e.name,e.handler)}),f.length=0};f.push({target:d,name:`load`,handler:()=>{m(),t(d),c&&d.src&&URL.revokeObjectURL(d.src)}}),f.push({target:d,name:`error`,handler:e=>{m(),u(e),c&&d.src&&URL.revokeObjectURL(d.src)}}),f.push({target:document,name:`securitypolicyviolation`,handler:e=>{if(e.blockedURI!==d.src)return;m();let t=Error(`CSP violation of policy ${e.effectiveDirective} ${e.blockedURI}. Current policy is ${e.originalPolicy}`);b.UseFallbackTexture=!1,u(t),c&&d.src&&URL.revokeObjectURL(d.src),d.src=``}}),p();let h=s.substring(0,5)===`blob:`,g=s.substring(0,5)===`data:`,_=()=>{h||g?d.src=s:We(s,(e,t,n)=>{let r=!i&&n?n:i,a=new Blob([e],{type:r}),o=URL.createObjectURL(a);c=!0,d.src=o},void 0,r||void 0,!0,(e,t)=>{u(t)})},v=()=>{r&&r.loadImage(s,d)};if(!h&&!g&&r&&r.enableTexturesOffline)r.open(v,_);else{if(s.indexOf(`file:`)!==-1){let e=decodeURIComponent(s.substring(5).toLowerCase());if(x.FilesToLoad[e]&&typeof URL<`u`){try{let t;try{t=URL.createObjectURL(x.FilesToLoad[e])}catch{t=URL.createObjectURL(x.FilesToLoad[e])}d.src=t,c=!0}catch{d.src=``}return d}}_()}return d},Ue=(e,t,n,r,i)=>{let a=new FileReader,s={onCompleteObservable:new o,abort:()=>a.abort()};return a.onloadend=()=>s.onCompleteObservable.notifyObservers(s),i&&(a.onerror=()=>{i(new Re(`Unable to read ${e.name}`,e))}),a.onload=e=>{t(e.target.result)},n&&(a.onprogress=n),r?a.readAsArrayBuffer(e):a.readAsText(e),s},We=(e,t,n,r,i,a,s)=>{if(e.name)return Ue(e,t,n,i,a?e=>{a(void 0,e)}:void 0);let c=e;if(c.indexOf(`file:`)!==-1){let e=decodeURIComponent(c.substring(5).toLowerCase());e.indexOf(`./`)===0&&(e=e.substring(2));let r=x.FilesToLoad[e];if(r)return Ue(r,t,n,i,a?e=>a(void 0,new Ie(e.message,e.file)):void 0)}let{match:l,type:u}=Je(c);if(l){let e={onCompleteObservable:new o,abort:()=>()=>{}};try{t(i?Ye(c):Xe(c),void 0,u)}catch(e){a?a(void 0,e):f.Error(e.message||`Failed to parse the Data URL`)}return Pe.SetImmediate(()=>{e.onCompleteObservable.notifyObservers(e)}),e}return Ge(c,(e,n)=>{t(e,n?.responseURL,n?.getResponseHeader(`content-type`))},n,r,i,a?e=>{a(e.request,new Ie(e.message,e.request))}:void 0,s)},Ge=(e,t,n,r,i,a,c)=>{e=Be(e),e=ze.PreprocessUrl(e);let l=ze.BaseUrl+e,u=!1,d={onCompleteObservable:new o,abort:()=>u=!0},p=()=>{let e=new y,r=null,o,p=()=>{e&&(n&&e.removeEventListener(`progress`,n),o&&e.removeEventListener(`readystatechange`,o),e.removeEventListener(`loadend`,m))},m=()=>{p(),d.onCompleteObservable.notifyObservers(d),d.onCompleteObservable.clear(),n=void 0,o=null,m=null,a=void 0,c=void 0,t=void 0};d.abort=()=>{u=!0,m&&m(),e&&e.readyState!==(XMLHttpRequest.DONE||4)&&e.abort(),r!==null&&(clearTimeout(r),r=null),e=null};let h=t=>{let n=t.message||`Unknown error`;a&&e?a(new Le(n,e)):f.Error(n)},g=d=>{if(e){if(e.open(`GET`,l),c)try{c(e)}catch(e){h(e);return}i&&(e.responseType=`arraybuffer`),n&&e.addEventListener(`progress`,n),m&&e.addEventListener(`loadend`,m),o=()=>{if(!(u||!e)&&e.readyState===(XMLHttpRequest.DONE||4)){if(o&&e.removeEventListener(`readystatechange`,o),e.status>=200&&e.status<300||e.status===0&&(!s()||Ke())){try{t&&t(i?e.response:e.responseText,e)}catch(e){h(e)}return}let n=ze.DefaultRetryStrategy;if(n){let t=n(l,e,d);if(t!==-1){p(),e=new y,r=setTimeout(()=>g(d+1),t);return}}let c=new Le(`Error status: `+e.status+` `+e.statusText+` - Unable to load `+l,e);a&&a(c)}},e.addEventListener(`readystatechange`,o),e.send()}};g(0)};if(r&&r.enableSceneOffline){let o=e=>{e&&e.status>400?a&&a(e):p()};r.open(()=>{r&&r.loadFile(ze.BaseUrl+e,e=>{!u&&t&&t(e),d.onCompleteObservable.notifyObservers(d)},n?e=>{!u&&n&&n(e)}:void 0,o,i)},o)}else p();return d},Ke=()=>typeof location<`u`&&location.protocol===`file:`,qe=e=>Fe.test(e),Je=e=>{let t=Fe.exec(e);return t===null||t.length===0?{match:!1,type:``}:{match:!0,type:t[0].replace(`data:`,``).replace(`base64,`,``)}};function Ye(e){return te(e.split(`,`)[1])}var Xe=e=>ee(e.split(`,`)[1]);k._FileToolsLoadImage=He,k._FileToolsLoadFile=We,he._FileToolsLoadFile=We;var Ze;((e,t,n,r,i,a,o,s,c,l)=>{Ze={DecodeBase64UrlToBinary:e,DecodeBase64UrlToString:t,DefaultRetryStrategy:n.DefaultRetryStrategy,BaseUrl:n.BaseUrl,CorsBehavior:n.CorsBehavior,PreprocessUrl:n.PreprocessUrl,IsBase64DataUrl:r,IsFileURL:i,LoadFile:a,LoadImage:o,ReadFile:s,RequestFile:c,SetCorsBehavior:l},Object.defineProperty(Ze,`DefaultRetryStrategy`,{get:function(){return n.DefaultRetryStrategy},set:function(e){n.DefaultRetryStrategy=e}}),Object.defineProperty(Ze,`BaseUrl`,{get:function(){return n.BaseUrl},set:function(e){n.BaseUrl=e}}),Object.defineProperty(Ze,`PreprocessUrl`,{get:function(){return n.PreprocessUrl},set:function(e){n.PreprocessUrl=e}}),Object.defineProperty(Ze,`CorsBehavior`,{get:function(){return n.CorsBehavior},set:function(e){n.CorsBehavior=e}})})(Ye,Xe,ze,qe,Ke,We,He,Ue,Ge,Ve);var Qe={};function $e(e,t){Qe[e]=t}function et(e){return Qe[e]}var tt=class{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];let t=et(e);if(t)return t;f.Warn(e+` not found, you may have missed an import.`);let n=e.split(`.`),r=window||this;for(let e=0,t=n.length;e<t;e++)r=r[n[e]];return typeof r==`function`?r:null}};tt.RegisteredExternalClasses={};function nt(){return`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e===`x`?t:t&3|8).toString(16)})}var A=class e{static get BaseUrl(){return ze.BaseUrl}static set BaseUrl(e){ze.BaseUrl=e}static get DefaultRetryStrategy(){return ze.DefaultRetryStrategy}static set DefaultRetryStrategy(e){ze.DefaultRetryStrategy=e}static get CorsBehavior(){return ze.CorsBehavior}static set CorsBehavior(e){ze.CorsBehavior=e}static get UseFallbackTexture(){return b.UseFallbackTexture}static set UseFallbackTexture(e){b.UseFallbackTexture=e}static get RegisteredExternalClasses(){return tt.RegisteredExternalClasses}static set RegisteredExternalClasses(e){tt.RegisteredExternalClasses=e}static get fallbackTexture(){return b.FallbackTexture}static set fallbackTexture(e){b.FallbackTexture=e}static FetchToRef(e,t,n,r,i,a){let o=((Math.abs(e)*n%n|0)+(Math.abs(t)*r%r|0)*n)*4;a.r=i[o]/255,a.g=i[o+1]/255,a.b=i[o+2]/255,a.a=i[o+3]/255}static Mix(e,t,n){return e*(1-n)+t*n}static Instantiate(e){return tt.Instantiate(e)}static SetImmediate(e){Pe.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(t){return Math.fround?Math.fround(t):(e._TmpFloatArray[0]=t,e._TmpFloatArray[0])}static GetFilename(e){let t=e.lastIndexOf(`/`);return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){let n=e.lastIndexOf(`/`);return n<0?t?e:``:e.substring(0,n+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,n=.9){let r=this.ToRadians(e),i=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-n)*Math.sin(i)+n*Math.sin(r),(1-n)*Math.cos(i)+n*Math.cos(r)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t=`pointer`;return s()&&!window.PointerEvent&&(t=`mouse`),e._badDesktopOS&&!e._badOS&&!(document&&`ontouchend`in document)&&(t=`mouse`),t}static SetCorsBehavior(e,t){Ve(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,`%23`),e}static get PreprocessUrl(){return ze.PreprocessUrl}static set PreprocessUrl(e){ze.PreprocessUrl=e}static LoadImage(e,t,n,r,i,a){return He(e,t,n,r,i,a)}static LoadFile(e,t,n,r,i,a){return We(e,t,n,r,i,a)}static LoadFileAsync(e,t=!0){return new Promise((n,r)=>{We(e,e=>{n(e)},void 0,void 0,t,(e,t)=>{r(t)})})}static LoadScript(e,t,n,r){if(typeof importScripts==`function`){try{importScripts(e),t()}catch(t){n?.(`Unable to load script '${e}' in worker`,t)}return}else if(!s()){n?.(`Cannot load script '${e}' outside of a window or a worker`);return}let i=document.getElementsByTagName(`head`)[0],a=document.createElement(`script`);a.setAttribute(`type`,`text/javascript`),a.setAttribute(`src`,e),r&&(a.id=r),a.onload=()=>{t&&t()},a.onerror=t=>{n&&n(`Unable to load script '${e}'`,t)},i.appendChild(a)}static LoadScriptAsync(e){return new Promise((t,n)=>{this.LoadScript(e,()=>{t()},(e,t)=>{n(t||Error(e))})})}static ReadFileAsDataURL(e,t,n){let r=new FileReader,i={onCompleteObservable:new o,abort:()=>r.abort()};return r.onloadend=()=>{i.onCompleteObservable.notifyObservers(i)},r.onload=e=>{t(e.target.result)},r.onprogress=n,r.readAsDataURL(e),i}static ReadFile(e,t,n,r,i){return Ue(e,t,n,r,i)}static FileAsURL(e){let t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,n,r){h.DeepCopy(e,t,n,r)}static IsEmpty(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let n=0;n<t.length;n++){let r=t[n];e.addEventListener(r.name,r.handler,!1);try{window.parent&&window.parent.addEventListener(r.name,r.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let n=0;n<t.length;n++){let r=t[n];e.removeEventListener(r.name,r.handler);try{e.parent&&e.parent.removeEventListener(r.name,r.handler)}catch{}}}static async DumpFramebuffer(e,t,n,r,i=`image/png`,a){throw _(`DumpTools`)}static DumpData(e,t,n,r,i=`image/png`,a,o=!1,s=!1,c){throw _(`DumpTools`)}static DumpDataAsync(e,t,n,r=`image/png`,i,a=!1,o=!1,s){throw _(`DumpTools`)}static ToBlob(e,t,n=`image/png`,r){e.toBlob||=function(e,t,n){setTimeout(()=>{let r=atob(this.toDataURL(t,n).split(`,`)[1]),i=r.length,a=new Uint8Array(i);for(let e=0;e<i;e++)a[e]=r.charCodeAt(e);e(new Blob([a]))})},e.toBlob(function(e){t(e)},n,r)}static DownloadBlob(t,n){if(`download`in document.createElement(`a`)){if(!n){let e=new Date;n=`screenshot_`+((e.getFullYear()+`-`+(e.getMonth()+1)).slice(2)+`-`+e.getDate()+`_`+e.getHours()+`-`+(`0`+e.getMinutes()).slice(-2))+`.png`}e.Download(t,n)}else if(t&&typeof URL<`u`){let e=URL.createObjectURL(t),n=window.open(``);if(!n)return;let r=n.document.createElement(`img`);r.onload=function(){URL.revokeObjectURL(e)},r.src=e,n.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(t,n,r=`image/png`,i,a){n?n(t.toDataURL(r,a)):this.ToBlob(t,function(t){t&&e.DownloadBlob(t,i)},r,a)}static Download(e,t){if(typeof URL>`u`)return;let n=window.URL.createObjectURL(e),r=document.createElement(`a`);document.body.appendChild(r),r.style.display=`none`,r.href=n,r.download=t,r.addEventListener(`click`,()=>{r.parentElement&&r.parentElement.removeChild(r)}),r.click(),window.URL.revokeObjectURL(n)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]==`boolean`?e[0]:typeof e[1]==`boolean`?e[1]:!1}static CreateScreenshot(e,t,n,r,i=`image/png`){throw _(`ScreenshotTools`)}static CreateScreenshotAsync(e,t,n,r=`image/png`){throw _(`ScreenshotTools`)}static CreateScreenshotUsingRenderTarget(e,t,n,r,i=`image/png`,a=1,o=!1,s){throw _(`ScreenshotTools`)}static CreateScreenshotUsingRenderTargetAsync(e,t,n,r=`image/png`,i=1,a=!1,o){throw _(`ScreenshotTools`)}static RandomId(){return nt()}static IsBase64(e){return qe(e)}static DecodeBase64(e){return Ye(e)}static get errorsCount(){return f.errorsCount}static Log(e){f.Log(e)}static Warn(e){f.Warn(e)}static Error(e){f.Error(e)}static get LogCache(){return f.LogCache}static ClearLogCache(){f.ClearLogCache()}static set LogLevels(e){f.LogLevels=e}static set PerformanceLogLevel(t){if((t&e.PerformanceUserMarkLogLevel)===e.PerformanceUserMarkLogLevel){e.StartPerformanceCounter=e._StartUserMark,e.EndPerformanceCounter=e._EndUserMark;return}if((t&e.PerformanceConsoleLogLevel)===e.PerformanceConsoleLogLevel){e.StartPerformanceCounter=e._StartPerformanceConsole,e.EndPerformanceCounter=e._EndPerformanceConsole;return}e.StartPerformanceCounter=e._StartPerformanceCounterDisabled,e.EndPerformanceCounter=e._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(t,n=!0){if(!e._Performance){if(!s())return;e._Performance=window.performance}!n||!e._Performance.mark||e._Performance.mark(t+`-Begin`)}static _EndUserMark(t,n=!0){!n||!e._Performance.mark||(e._Performance.mark(t+`-End`),e._Performance.measure(t,t+`-Begin`,t+`-End`))}static _StartPerformanceConsole(t,n=!0){n&&(e._StartUserMark(t,n),console.time&&console.time(t))}static _EndPerformanceConsole(t,n=!0){n&&(e._EndUserMark(t,n),console.timeEnd(t))}static get Now(){return g.Now}static GetClassName(e,t=!1){let n=null;return!t&&e.getClassName?n=e.getClassName():(e instanceof Object&&(n=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),n||=typeof e),n}static First(e,t){for(let n of e)if(t(n))return n;return null}static getFullClassName(e,t=!1){let n=null,r=null;if(!t&&e.getClassName)n=e.getClassName();else{if(e instanceof Object){let i=t?e:Object.getPrototypeOf(e);n=i.constructor.__bjsclassName__,r=i.constructor.__bjsmoduleName__}n||=typeof e}return n?(r==null?``:r+`.`)+n:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return c()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}};A.UseCustomRequestHeaders=!1,A.CustomRequestHeaders=y.CustomRequestHeaders,A._TmpFloatArray=new Float32Array(1),A.GetDOMTextContent=u,A.GetAbsoluteUrl=typeof document==`object`?e=>{let t=document.createElement(`a`);return t.href=e,t.href}:typeof URL==`function`&&typeof location==`object`?e=>new URL(e,location.origin).href:()=>{throw Error(`Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.`)},A.NoneLogLevel=f.NoneLogLevel,A.MessageLogLevel=f.MessageLogLevel,A.WarningLogLevel=f.WarningLogLevel,A.ErrorLogLevel=f.ErrorLogLevel,A.AllLogLevel=f.AllLogLevel,A.IsWindowObjectExist=s,A.PerformanceNoneLogLevel=0,A.PerformanceUserMarkLogLevel=1,A.PerformanceConsoleLogLevel=2,A.StartPerformanceCounter=A._StartPerformanceCounterDisabled,A.EndPerformanceCounter=A._EndPerformanceCounterDisabled;var rt=class e{constructor(e,t,n,r=0){this.iterations=e,this.index=r-1,this._done=!1,this._fn=t,this._successCallback=n}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(t,n,r,i=0){let a=new e(t,n,r,i);return a.executeNext(),a}static SyncAsyncForLoop(t,n,r,i,a,o=0){return e.Run(Math.ceil(t/n),e=>{a&&a()?e.breakLoop():setTimeout(()=>{for(let i=0;i<n;++i){let o=e.index*n+i;if(o>=t)break;if(r(o),a&&a()){e.breakLoop();break}}e.executeNext()},o)},i)}};b.FallbackTexture=`data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z`;var it=class e{constructor(t){this.length=0,this.data=Array(t),this._id=e._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){let t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}};it._GlobalId=0;var at=class extends it{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||={},e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){let n=(e.data||e)[t];this.pushNoDuplicate(n)}}}},ot=class{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((e,t)=>this.add(e,t))}get(e){let t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let n=this.get(e);return n!==void 0||(n=t(e),n&&this.add(e,n)),n}getOrAdd(e,t){let n=this.get(e);return n===void 0?(this.add(e,t),t):n}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]===void 0?(this._data[e]=t,++this._count,!0):!1}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){let t=this.get(e);return t===void 0?null:(delete this._data[e],--this._count,t)}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(let t in this._data){let n=this._data[t];e(t,n)}}first(e){for(let t in this._data){let n=this._data[t],r=e(t,n);if(r)return r}return null}},st=class e{static Eval(t,n){return t=t.match(/\([^()]*\)/g)?t.replace(/\([^()]*\)/g,t=>(t=t.slice(1,t.length-1),e._HandleParenthesisContent(t,n))):e._HandleParenthesisContent(t,n),t===`true`?!0:t===`false`?!1:e.Eval(t,n)}static _HandleParenthesisContent(t,n){n||=(e=>e===`true`);let r,i=t.split(`||`);for(let t in i)if(Object.prototype.hasOwnProperty.call(i,t)){let a=e._SimplifyNegation(i[t].trim()),o=a.split(`&&`);if(o.length>1)for(let t=0;t<o.length;++t){let i=e._SimplifyNegation(o[t].trim());if(r=i!==`true`&&i!==`false`?i[0]===`!`?!n(i.substring(1)):n(i):i===`true`,!r){a=`false`;break}}if(r||a===`true`){r=!0;break}r=a!==`true`&&a!==`false`?a[0]===`!`?!n(a.substring(1)):n(a):a===`true`}return r?`true`:`false`}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,e=>(e=e.replace(/[\s]/g,()=>``),e.length%2?`!`:``)),e=e.trim(),e===`!true`?e=`false`:e===`!false`&&(e=`true`),e}},j=class e{static EnableFor(t){t._tags=t._tags||{},t.hasTags=()=>e.HasTags(t),t.addTags=n=>e.AddTagsTo(t,n),t.removeTags=n=>e.RemoveTagsFrom(t,n),t.matchesTagsQuery=n=>e.MatchesQuery(t,n)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;let t=e._tags;for(let e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){let t=[];for(let n in e._tags)Object.prototype.hasOwnProperty.call(e._tags,n)&&e._tags[n]===!0&&t.push(n);return t.join(` `)}else return e._tags}static AddTagsTo(t,n){!n||typeof n!=`string`||n.split(` `).forEach(function(n){e._AddTagTo(t,n)})}static _AddTagTo(t,n){n=n.trim(),!(n===``||n===`true`||n===`false`)&&(n.match(/[\s]/)||n.match(/^([!]|([|]|[&]){2})/)||(e.EnableFor(t),t._tags[n]=!0))}static RemoveTagsFrom(t,n){if(!e.HasTags(t))return;let r=n.split(` `);for(let n in r)e._RemoveTagFrom(t,r[n])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(t,n){return n===void 0?!0:n===``?e.HasTags(t):st.Eval(n,n=>e.HasTags(t)&&t._tags[n])}},M=class e{static WithinEpsilon(e,t,n=1401298e-51){return Math.abs(e-t)<=n}static ToHex(e){let t=e.toString(16);return e<=15?(`0`+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,n=1){return Math.min(n,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e*=2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,n){return(e-t)/(n-t)}static Denormalize(e,t,n){return e*(n-t)+t}static DeltaAngle(t,n){let r=e.Repeat(n-t,360);return r>180&&(r-=360),r}static PingPong(t,n){let r=e.Repeat(t,n*2);return n-Math.abs(r-n)}static SmoothStep(t,n,r){let i=e.Clamp(r);return i=-2*i*i*i+3*i*i,n*i+t*(1-i)}static MoveTowards(t,n,r){let i=0;return i=Math.abs(n-t)<=r?n:t+e.Sign(n-t)*r,i}static MoveTowardsAngle(t,n,r){let i=e.DeltaAngle(t,n),a=0;return-r<i&&i<r?a=n:(n=t+i,a=e.MoveTowards(t,n,r)),a}static Lerp(e,t,n){return e+(t-e)*n}static LerpAngle(t,n,r){let i=e.Repeat(n-t,360);return i>180&&(i-=360),t+i*e.Clamp(r)}static InverseLerp(t,n,r){let i=0;return i=t==n?0:e.Clamp((r-t)/(n-t)),i}static Hermite(e,t,n,r,i){let a=i*i,o=i*a,s=2*o-3*a+1,c=-2*o+3*a,l=o-2*a+i,u=o-a;return e*s+n*c+t*l+r*u}static Hermite1stDerivative(e,t,n,r,i){let a=i*i;return(a-i)*6*e+(3*a-4*i+1)*t+(-a+i)*6*n+(3*a-2*i)*r}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,n){return(e-t)/(n-t)}static PercentToRange(e,t,n){return(n-t)*e+t}static NormalizeRadians(t){return t-=e.TwoPi*Math.floor((t+Math.PI)/e.TwoPi),t}static HCF(t,n){let r=t%n;return r===0?n:e.HCF(n,r)}};M.TwoPi=Math.PI*2;var ct=1/2.2,lt=2.2,ut=.001,dt=class e{static BuildArray(e,t){let n=[];for(let r=0;r<e;++r)n.push(t());return n}static BuildTuple(t,n){return e.BuildArray(t,n)}};function ft(e,t,n){let r=e[t];if(typeof r!=`function`)return null;let i=function(){let r=e.length,a=i.previous.apply(e,arguments);return n(t,r),a};return r.next=i,i.previous=r,e[t]=i,()=>{let n=i.previous;if(!n)return;let r=i.next;r?(n.next=r,r.previous=n):(n.next=void 0,e[t]=n),i.next=void 0,i.previous=void 0}}var pt=[`push`,`splice`,`pop`,`shift`,`unshift`];function mt(e,t){let n=pt.map(n=>ft(e,n,t));return()=>{n.forEach(e=>{e?.()})}}var ht=e=>parseInt(e.toString().replace(/\W/g,``)),gt=class e{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return`Vector2`}getHashCode(){let e=ht(this.x),t=ht(this.y),n=e;return n=n*397^t,n}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(t,n=0){return e.FromArrayToRef(t,n,this),this}asArray(){let e=[];return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new this.constructor(this.x+e.x,this.y+e.y)}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t}multiplyByFloats(e,t){return new this.constructor(this.x*e,this.y*t)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new this.constructor(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){let t=new this.constructor(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=ut){return e&&M.WithinEpsilon(this.x,e.x,t)&&M.WithinEpsilon(this.y,e.y,t)}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){let n=Math.cos(e),r=Math.sin(e),i=n*this.x-r*this.y,a=r*this.x+n*this.y;return t.x=i,t.y=a,t}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return e.NormalizeToRef(this,this),this}clone(){return new this.constructor(this.x,this.y)}static Zero(){return new e(0,0)}static One(){return new e(1,1)}static Random(t=0,n=1){return new e(M.RandomRange(t,n),M.RandomRange(t,n))}static get ZeroReadOnly(){return e._ZeroReadOnly}static FromArray(t,n=0){return new e(t[n],t[n+1])}static FromArrayToRef(e,t,n){return n.x=e[t],n.y=e[t+1],n}static CatmullRom(e,t,n,r,i){let a=i*i,o=i*a,s=.5*(2*t.x+(-e.x+n.x)*i+(2*e.x-5*t.x+4*n.x-r.x)*a+(-e.x+3*t.x-3*n.x+r.x)*o),c=.5*(2*t.y+(-e.y+n.y)*i+(2*e.y-5*t.y+4*n.y-r.y)*a+(-e.y+3*t.y-3*n.y+r.y)*o);return new e.constructor(s,c)}static Clamp(e,t,n){let r=e.x;r=r>n.x?n.x:r,r=r<t.x?t.x:r;let i=e.y;return i=i>n.y?n.y:i,i=i<t.y?t.y:i,new e.constructor(r,i)}static Hermite(e,t,n,r,i){let a=i*i,o=i*a,s=2*o-3*a+1,c=-2*o+3*a,l=o-2*a+i,u=o-a,d=e.x*s+n.x*c+t.x*l+r.x*u,f=e.y*s+n.y*c+t.y*l+r.y*u;return new e.constructor(d,f)}static Hermite1stDerivative(e,t,n,r,i){let a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,n,r,i,a),a}static Hermite1stDerivativeToRef(e,t,n,r,i,a){let o=i*i;return a.x=(o-i)*6*e.x+(3*o-4*i+1)*t.x+(-o+i)*6*n.x+(3*o-2*i)*r.x,a.y=(o-i)*6*e.y+(3*o-4*i+1)*t.y+(-o+i)*6*n.y+(3*o-2*i)*r.y,a}static Lerp(e,t,n){let r=e.x+(t.x-e.x)*n,i=e.y+(t.y-e.y)*n;return new e.constructor(r,i)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){let t=new e.constructor;return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){let n=e.length();return n===0||(t.x=e.x/n,t.y=e.y/n),t}static Minimize(e,t){let n=e.x<t.x?e.x:t.x,r=e.y<t.y?e.y:t.y;return new e.constructor(n,r)}static Maximize(e,t){let n=e.x>t.x?e.x:t.x,r=e.y>t.y?e.y:t.y;return new e.constructor(n,r)}static Transform(t,n){let r=new t.constructor;return e.TransformToRef(t,n,r),r}static TransformToRef(e,t,n){let r=t.m,i=e.x*r[0]+e.y*r[4]+r[12],a=e.x*r[1]+e.y*r[5]+r[13];return n.x=i,n.y=a,n}static PointInTriangle(e,t,n,r){let i=.5*(-n.y*r.x+t.y*(-n.x+r.x)+t.x*(n.y-r.y)+n.x*r.y),a=i<0?-1:1,o=(t.y*r.x-t.x*r.y+(r.y-t.y)*e.x+(t.x-r.x)*e.y)*a,s=(t.x*n.y-t.y*n.x+(t.y-n.y)*e.x+(n.x-t.x)*e.y)*a;return o>0&&s>0&&o+s<2*i*a}static Distance(t,n){return Math.sqrt(e.DistanceSquared(t,n))}static DistanceSquared(e,t){let n=e.x-t.x,r=e.y-t.y;return n*n+r*r}static Center(t,n){let r=new t.constructor;return e.CenterToRef(t,n,r)}static CenterToRef(e,t,n){return n.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(t,n,r){let i=e.DistanceSquared(n,r);if(i===0)return e.Distance(t,n);let a=r.subtract(n),o=Math.max(0,Math.min(1,e.Dot(t.subtract(n),a)/i)),s=n.add(a.multiplyByFloats(o,o));return e.Distance(t,s)}};gt._ZeroReadOnly=gt.Zero();var N=class e{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}constructor(e=0,t=0,n=0){this._isDirty=!0,this._x=e,this._y=t,this._z=n}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return`Vector3`}getHashCode(){let e=ht(this._x),t=ht(this._y),n=ht(this._z),r=e;return r=r*397^t,r=r*397^n,r}asArray(){let e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(t,n=0){return e.FromArrayToRef(t,n,this),this}toQuaternion(){return P.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,n){return this._x+=e,this._y+=t,this._z+=n,this._isDirty=!0,this}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,n){return new this.constructor(this._x-e,this._y-t,this._z-n)}subtractFromFloatsToRef(e,t,n,r){return r.copyFromFloats(this._x-e,this._y-t,this._z-n)}negate(){return new this.constructor(-this._x,-this._y,-this._z)}negateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}getNormalToRef(e){let t=this.length(),n=Math.acos(this.y/t),r=Math.atan2(this.z,this.x);n>Math.PI/2?n-=Math.PI/2:n+=Math.PI/2;let i=t*Math.sin(n)*Math.cos(r),a=t*Math.cos(n),o=t*Math.sin(n)*Math.sin(r);return e.set(i,a,o),e}applyRotationQuaternionToRef(e,t){let n=e._w*this._x+e._y*this._z-e._z*this._y,r=e._w*this._y+e._z*this._x-e._x*this._z,i=e._w*this._z+e._x*this._y-e._y*this._x,a=-e._x*this._x-e._y*this._y-e._z*this._z;return t._x=n*e._w+a*-e._x+r*-e._z-i*-e._y,t._y=r*e._w+a*-e._y+i*-e._x-n*-e._z,t._z=i*e._w+a*-e._z+n*-e._y-r*-e._x,t._isDirty=!0,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,new this.constructor)}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){let n=new this.constructor;return this.projectOnPlaneToRef(e,t,n),n}projectOnPlaneToRef(t,n,r){let i=t.normal,a=t.d,o=I.Vector3[0];this.subtractToRef(n,o),o.normalize();let s=e.Dot(o,i);if(Math.abs(s)<10**-10)r.setAll(1/0);else{let t=-(e.Dot(n,i)+a)/s,c=o.scaleInPlace(t);n.addToRef(c,r)}return r}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=ut){return e&&M.WithinEpsilon(this._x,e._x,t)&&M.WithinEpsilon(this._y,e._y,t)&&M.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,n){return this._x===e&&this._y===t&&this._z===n}multiplyInPlace(e){return this._x*=e._x,this._y*=e._y,this._z*=e._z,this._isDirty=!0,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,n){return new this.constructor(this._x*e,this._y*t,this._z*n)}divide(e){return new this.constructor(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,n){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),n<this._z&&(this.z=n),this}maximizeInPlaceFromFloats(e,t,n){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),n>this._z&&(this.z=n),this}isNonUniformWithinEpsilon(e){let t=Math.abs(this._x),n=Math.abs(this._y);if(!M.WithinEpsilon(t,n,e))return!0;let r=Math.abs(this._z);return!M.WithinEpsilon(t,r,e)||!M.WithinEpsilon(n,r,e)}get isNonUniform(){let e=Math.abs(this._x);return e===Math.abs(this._y)?e!==Math.abs(this._z):!0}floor(){return new this.constructor(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new this.constructor(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e===`xyz`?this:(I.Vector3[0].copyFrom(this),[`x`,`y`,`z`].forEach((t,n)=>{this[t]=I.Vector3[0][e[n]]}),this)}rotateByQuaternionToRef(t,n){return t.toRotationMatrix(I.Matrix[0]),e.TransformCoordinatesToRef(this,I.Matrix[0],n),n}rotateByQuaternionAroundPointToRef(e,t,n){return this.subtractToRef(t,I.Vector3[0]),I.Vector3[0].rotateByQuaternionToRef(e,I.Vector3[0]),t.addToRef(I.Vector3[0],n),n}cross(t){let n=new this.constructor;return e.CrossToRef(this,t,n)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){let e=new this.constructor(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){let t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new this.constructor(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,n){return this._x=e,this._y=t,this._z=n,this._isDirty=!0,this}set(e,t,n){return this.copyFromFloats(e,t,n)}setAll(e){return this._x=this._y=this._z=e,this._isDirty=!0,this}static GetClipFactor(t,n,r,i){let a=e.Dot(t,r)-i;return a/(a-(e.Dot(n,r)-i))}static GetAngleBetweenVectors(t,n,r){let i=t.normalizeToRef(I.Vector3[1]),a=n.normalizeToRef(I.Vector3[2]),o=e.Dot(i,a);o=M.Clamp(o,-1,1);let s=Math.acos(o),c=I.Vector3[3];return e.CrossToRef(i,a,c),e.Dot(c,r)>0?isNaN(s)?0:s:isNaN(s)?-Math.PI:-Math.acos(o)}static GetAngleBetweenVectorsOnPlane(t,n,r){I.Vector3[0].copyFrom(t);let i=I.Vector3[0];I.Vector3[1].copyFrom(n);let a=I.Vector3[1];I.Vector3[2].copyFrom(r);let o=I.Vector3[2],s=I.Vector3[3],c=I.Vector3[4];i.normalize(),a.normalize(),o.normalize(),e.CrossToRef(o,i,s),e.CrossToRef(s,o,c);let l=Math.atan2(e.Dot(a,s),e.Dot(a,c));return M.NormalizeRadians(l)}static PitchYawRollToMoveBetweenPointsToRef(e,t,n){let r=L.Vector3[0];return t.subtractToRef(e,r),n._y=Math.atan2(r.x,r.z)||0,n._x=Math.atan2(Math.sqrt(r.x**2+r.z**2),r.y)||0,n._z=0,n._isDirty=!0,n}static PitchYawRollToMoveBetweenPoints(t,n){let r=e.Zero();return e.PitchYawRollToMoveBetweenPointsToRef(t,n,r)}static SlerpToRef(t,n,r,i){r=M.Clamp(r,0,1);let a=I.Vector3[0],o=I.Vector3[1];a.copyFrom(t);let s=a.length();a.normalizeFromLength(s),o.copyFrom(n);let c=o.length();o.normalizeFromLength(c);let l=e.Dot(a,o),u,d;if(l<.999){let e=Math.acos(l),t=1/Math.sin(e);u=Math.sin((1-r)*e)*t,d=Math.sin(r*e)*t}else u=1-r,d=r;return a.scaleInPlace(u),o.scaleInPlace(d),i.copyFrom(a).addInPlace(o),i.scaleInPlace(M.Lerp(s,c,r)),i}static SmoothToRef(t,n,r,i,a){return e.SlerpToRef(t,n,i===0?1:r/i,a),a}static FromArray(t,n=0){return new e(t[n],t[n+1],t[n+2])}static FromFloatArray(t,n){return e.FromArray(t,n)}static FromArrayToRef(e,t,n){return n._x=e[t],n._y=e[t+1],n._z=e[t+2],n._isDirty=!0,n}static FromFloatArrayToRef(t,n,r){return e.FromArrayToRef(t,n,r)}static FromFloatsToRef(e,t,n,r){return r.copyFromFloats(e,t,n),r}static Zero(){return new e(0,0,0)}static One(){return new e(1,1,1)}static Up(){return new e(0,1,0)}static get UpReadOnly(){return e._UpReadOnly}static get DownReadOnly(){return e._DownReadOnly}static get RightReadOnly(){return e._RightReadOnly}static get LeftReadOnly(){return e._LeftReadOnly}static get LeftHandedForwardReadOnly(){return e._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return e._RightHandedForwardReadOnly}static get LeftHandedBackwardReadOnly(){return e._LeftHandedBackwardReadOnly}static get RightHandedBackwardReadOnly(){return e._RightHandedBackwardReadOnly}static get ZeroReadOnly(){return e._ZeroReadOnly}static Down(){return new e(0,-1,0)}static Forward(t=!1){return new e(0,0,t?-1:1)}static Backward(t=!1){return new e(0,0,t?1:-1)}static Right(){return new e(1,0,0)}static Left(){return new e(-1,0,0)}static Random(t=0,n=1){return new e(M.RandomRange(t,n),M.RandomRange(t,n),M.RandomRange(t,n))}static TransformCoordinates(t,n){let r=e.Zero();return e.TransformCoordinatesToRef(t,n,r),r}static TransformCoordinatesToRef(t,n,r){return e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,n,r),r}static TransformCoordinatesFromFloatsToRef(e,t,n,r,i){let a=r.m,o=e*a[0]+t*a[4]+n*a[8]+a[12],s=e*a[1]+t*a[5]+n*a[9]+a[13],c=e*a[2]+t*a[6]+n*a[10]+a[14],l=1/(e*a[3]+t*a[7]+n*a[11]+a[15]);return i._x=o*l,i._y=s*l,i._z=c*l,i._isDirty=!0,i}static TransformNormal(t,n){let r=e.Zero();return e.TransformNormalToRef(t,n,r),r}static TransformNormalToRef(e,t,n){return this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,n),n}static TransformNormalFromFloatsToRef(e,t,n,r,i){let a=r.m;return i._x=e*a[0]+t*a[4]+n*a[8],i._y=e*a[1]+t*a[5]+n*a[9],i._z=e*a[2]+t*a[6]+n*a[10],i._isDirty=!0,i}static CatmullRom(e,t,n,r,i){let a=i*i,o=i*a,s=.5*(2*t._x+(-e._x+n._x)*i+(2*e._x-5*t._x+4*n._x-r._x)*a+(-e._x+3*t._x-3*n._x+r._x)*o),c=.5*(2*t._y+(-e._y+n._y)*i+(2*e._y-5*t._y+4*n._y-r._y)*a+(-e._y+3*t._y-3*n._y+r._y)*o),l=.5*(2*t._z+(-e._z+n._z)*i+(2*e._z-5*t._z+4*n._z-r._z)*a+(-e._z+3*t._z-3*n._z+r._z)*o);return new e.constructor(s,c,l)}static Clamp(t,n,r){let i=new t.constructor;return e.ClampToRef(t,n,r,i),i}static ClampToRef(e,t,n,r){let i=e._x;i=i>n._x?n._x:i,i=i<t._x?t._x:i;let a=e._y;a=a>n._y?n._y:a,a=a<t._y?t._y:a;let o=e._z;return o=o>n._z?n._z:o,o=o<t._z?t._z:o,r.copyFromFloats(i,a,o),r}static CheckExtends(e,t,n){t.minimizeInPlace(e),n.maximizeInPlace(e)}static Hermite(e,t,n,r,i){let a=i*i,o=i*a,s=2*o-3*a+1,c=-2*o+3*a,l=o-2*a+i,u=o-a,d=e._x*s+n._x*c+t._x*l+r._x*u,f=e._y*s+n._y*c+t._y*l+r._y*u,p=e._z*s+n._z*c+t._z*l+r._z*u;return new e.constructor(d,f,p)}static Hermite1stDerivative(e,t,n,r,i){let a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,n,r,i,a),a}static Hermite1stDerivativeToRef(e,t,n,r,i,a){let o=i*i;return a._x=(o-i)*6*e._x+(3*o-4*i+1)*t._x+(-o+i)*6*n._x+(3*o-2*i)*r._x,a._y=(o-i)*6*e._y+(3*o-4*i+1)*t._y+(-o+i)*6*n._y+(3*o-2*i)*r._y,a._z=(o-i)*6*e._z+(3*o-4*i+1)*t._z+(-o+i)*6*n._z+(3*o-2*i)*r._z,a._isDirty=!0,a}static Lerp(t,n,r){let i=new t.constructor(0,0,0);return e.LerpToRef(t,n,r,i),i}static LerpToRef(e,t,n,r){return r._x=e._x+(t._x-e._x)*n,r._y=e._y+(t._y-e._y)*n,r._z=e._z+(t._z-e._z)*n,r._isDirty=!0,r}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(t,n){let r=new t.constructor;return e.CrossToRef(t,n,r),r}static CrossToRef(e,t,n){let r=e._y*t._z-e._z*t._y,i=e._z*t._x-e._x*t._z,a=e._x*t._y-e._y*t._x;return n.copyFromFloats(r,i,a),n}static Normalize(t){let n=e.Zero();return e.NormalizeToRef(t,n),n}static NormalizeToRef(e,t){return e.normalizeToRef(t),t}static Project(t,n,r,i){let a=new t.constructor;return e.ProjectToRef(t,n,r,i,a),a}static ProjectToRef(t,n,r,i,a){let o=i.width,s=i.height,c=i.x,l=i.y,u=I.Matrix[1];F.FromValuesToRef(o/2,0,0,0,0,-s/2,0,0,0,0,.5,0,c+o/2,s/2+l,.5,1,u);let d=I.Matrix[0];return n.multiplyToRef(r,d),d.multiplyToRef(u,d),e.TransformCoordinatesToRef(t,d,a),a}static Reflect(t,n){return this.ReflectToRef(t,n,new e)}static ReflectToRef(t,n,r){let i=L.Vector3[0];return i.copyFrom(n).scaleInPlace(2*e.Dot(t,n)),r.copyFrom(t).subtractInPlace(i)}static _UnprojectFromInvertedMatrixToRef(t,n,r){e.TransformCoordinatesToRef(t,n,r);let i=n.m,a=t._x*i[3]+t._y*i[7]+t._z*i[11]+i[15];return M.WithinEpsilon(a,1)&&r.scaleInPlace(1/a),r}static UnprojectFromTransform(e,t,n,r,i){return this.Unproject(e,t,n,r,i,F.IdentityReadOnly)}static Unproject(t,n,r,i,a,o){let s=new t.constructor;return e.UnprojectToRef(t,n,r,i,a,o,s),s}static UnprojectToRef(t,n,r,i,a,o,s){return e.UnprojectFloatsToRef(t._x,t._y,t._z,n,r,i,a,o,s),s}static UnprojectFloatsToRef(t,n,r,i,a,o,s,c,l){var u;let d=I.Matrix[0];o.multiplyToRef(s,d),d.multiplyToRef(c,d),d.invert();let f=I.Vector3[0];return f.x=t/i*2-1,f.y=-(n/a*2-1),(u=b.LastCreatedEngine)!=null&&u.isNDCHalfZRange?f.z=r:f.z=2*r-1,e._UnprojectFromInvertedMatrixToRef(f,d,l),l}static Minimize(e,t){let n=new e.constructor;return n.copyFrom(e),n.minimizeInPlace(t),n}static Maximize(e,t){let n=new e.constructor;return n.copyFrom(e),n.maximizeInPlace(t),n}static Distance(t,n){return Math.sqrt(e.DistanceSquared(t,n))}static DistanceSquared(e,t){let n=e._x-t._x,r=e._y-t._y,i=e._z-t._z;return n*n+r*r+i*i}static ProjectOnTriangleToRef(t,n,r,i,a){let o=I.Vector3[0],s=I.Vector3[1],c=I.Vector3[2],l=I.Vector3[3],u=I.Vector3[4];r.subtractToRef(n,o),i.subtractToRef(n,s),i.subtractToRef(r,c);let d=o.length(),f=s.length(),p=c.length();if(d<.001||f<.001||p<.001)return a.copyFrom(n),e.Distance(t,n);t.subtractToRef(n,u),e.CrossToRef(o,s,l);let m=l.length();if(m<.001)return a.copyFrom(n),e.Distance(t,n);l.normalizeFromLength(m);let h=u.length();if(h<.001)return a.copyFrom(n),0;u.normalizeFromLength(h);let g=e.Dot(l,u),_=I.Vector3[5],v=I.Vector3[6];_.copyFrom(l).scaleInPlace(-h*g),v.copyFrom(t).addInPlace(_);let y=I.Vector3[4],b=I.Vector3[5],x=I.Vector3[7],S=I.Vector3[8];y.copyFrom(o).scaleInPlace(1/d),S.copyFrom(s).scaleInPlace(1/f),y.addInPlace(S).scaleInPlace(-1),b.copyFrom(o).scaleInPlace(-1/d),S.copyFrom(c).scaleInPlace(1/p),b.addInPlace(S).scaleInPlace(-1),x.copyFrom(c).scaleInPlace(-1/p),S.copyFrom(s).scaleInPlace(-1/f),x.addInPlace(S).scaleInPlace(-1);let C=I.Vector3[9],w;C.copyFrom(v).subtractInPlace(n),e.CrossToRef(y,C,S),w=e.Dot(S,l);let T=w;C.copyFrom(v).subtractInPlace(r),e.CrossToRef(b,C,S),w=e.Dot(S,l);let E=w;C.copyFrom(v).subtractInPlace(i),e.CrossToRef(x,C,S),w=e.Dot(S,l);let ee=w,te=I.Vector3[10],D,O;T>0&&E<0?(te.copyFrom(o),D=n,O=r):E>0&&ee<0?(te.copyFrom(c),D=r,O=i):(te.copyFrom(s).scaleInPlace(-1),D=i,O=n);let ne=I.Vector3[9],re=I.Vector3[4];if(D.subtractToRef(v,S),O.subtractToRef(v,ne),e.CrossToRef(S,ne,re),!(e.Dot(re,l)<0))return a.copyFrom(v),Math.abs(h*g);let ie=I.Vector3[5];e.CrossToRef(te,re,ie),ie.normalize();let ae=I.Vector3[9];ae.copyFrom(D).subtractInPlace(v);let oe=ae.length();if(oe<.001)return a.copyFrom(D),e.Distance(t,D);ae.normalizeFromLength(oe);let se=e.Dot(ie,ae),ce=I.Vector3[7];ce.copyFrom(v).addInPlace(ie.scaleInPlace(oe*se)),S.copyFrom(ce).subtractInPlace(D),h=te.length(),te.normalizeFromLength(h);let le=e.Dot(S,te)/Math.max(h,ut);return le=M.Clamp(le,0,1),ce.copyFrom(D).addInPlace(te.scaleInPlace(le*h)),a.copyFrom(ce),e.Distance(t,ce)}static Center(t,n){return e.CenterToRef(t,n,e.Zero())}static CenterToRef(e,t,n){return n.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(t,n,r){let i=new t.constructor;return e.RotationFromAxisToRef(t,n,r,i),i}static RotationFromAxisToRef(e,t,n,r){let i=I.Quaternion[0];return P.RotationQuaternionFromAxisToRef(e,t,n,i),i.toEulerAnglesToRef(r),r}};N._UpReadOnly=N.Up(),N._DownReadOnly=N.Down(),N._LeftHandedForwardReadOnly=N.Forward(!1),N._RightHandedForwardReadOnly=N.Forward(!0),N._LeftHandedBackwardReadOnly=N.Backward(!1),N._RightHandedBackwardReadOnly=N.Backward(!0),N._RightReadOnly=N.Right(),N._LeftReadOnly=N.Left(),N._ZeroReadOnly=N.Zero();var _t=class e{constructor(e=0,t=0,n=0,r=0){this.x=e,this.y=t,this.z=n,this.w=r}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return`Vector4`}getHashCode(){let e=ht(this.x),t=ht(this.y),n=ht(this.z),r=ht(this.w),i=e;return i=i*397^t,i=i*397^n,i=i*397^r,i}asArray(){let e=[];return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(t,n=0){return e.FromArrayToRef(t,n,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new this.constructor(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,t}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new this.constructor(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,t}subtractFromFloats(e,t,n,r){return new this.constructor(this.x-e,this.y-t,this.z-n,this.w-r)}subtractFromFloatsToRef(e,t,n,r,i){return i.x=this.x-e,i.y=this.y-t,i.z=this.z-n,i.w=this.w-r,i}negate(){return new this.constructor(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new this.constructor(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,t}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,t}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=ut){return e&&M.WithinEpsilon(this.x,e.x,t)&&M.WithinEpsilon(this.y,e.y,t)&&M.WithinEpsilon(this.z,e.z,t)&&M.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,n,r){return this.x===e&&this.y===t&&this.z===n&&this.w===r}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new this.constructor(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,t}multiplyByFloats(e,t,n,r){return new this.constructor(this.x*e,this.y*t,this.z*n,this.w*r)}divide(e){return new this.constructor(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,t}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new this.constructor(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new this.constructor(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){let e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new N(this.x,this.y,this.z)}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this}set(e,t,n,r){return this.copyFromFloats(e,t,n,r)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(t,n){return n||=0,new e(t[n],t[n+1],t[n+2],t[n+3])}static FromArrayToRef(e,t,n){return n.x=e[t],n.y=e[t+1],n.z=e[t+2],n.w=e[t+3],n}static FromFloatArrayToRef(t,n,r){return e.FromArrayToRef(t,n,r),r}static FromFloatsToRef(e,t,n,r,i){return i.x=e,i.y=t,i.z=n,i.w=r,i}static Zero(){return new e(0,0,0,0)}static One(){return new e(1,1,1,1)}static Random(t=0,n=1){return new e(M.RandomRange(t,n),M.RandomRange(t,n),M.RandomRange(t,n),M.RandomRange(t,n))}static get ZeroReadOnly(){return e._ZeroReadOnly}static Normalize(t){let n=e.Zero();return e.NormalizeToRef(t,n),n}static NormalizeToRef(e,t){return t.copyFrom(e),t.normalize(),t}static Minimize(e,t){let n=new e.constructor;return n.copyFrom(e),n.minimizeInPlace(t),n}static Maximize(e,t){let n=new e.constructor;return n.copyFrom(e),n.maximizeInPlace(t),n}static Distance(t,n){return Math.sqrt(e.DistanceSquared(t,n))}static DistanceSquared(e,t){let n=e.x-t.x,r=e.y-t.y,i=e.z-t.z,a=e.w-t.w;return n*n+r*r+i*i+a*a}static Center(t,n){return e.CenterToRef(t,n,e.Zero())}static CenterToRef(e,t,n){return n.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(t,n){let r=e.Zero();return e.TransformCoordinatesToRef(t,n,r),r}static TransformCoordinatesToRef(t,n,r){return e.TransformCoordinatesFromFloatsToRef(t._x,t._y,t._z,n,r),r}static TransformCoordinatesFromFloatsToRef(e,t,n,r,i){let a=r.m,o=e*a[0]+t*a[4]+n*a[8]+a[12],s=e*a[1]+t*a[5]+n*a[9]+a[13],c=e*a[2]+t*a[6]+n*a[10]+a[14],l=e*a[3]+t*a[7]+n*a[11]+a[15];return i.x=o,i.y=s,i.z=c,i.w=l,i}static TransformNormal(t,n){let r=new t.constructor;return e.TransformNormalToRef(t,n,r),r}static TransformNormalToRef(e,t,n){let r=t.m,i=e.x*r[0]+e.y*r[4]+e.z*r[8],a=e.x*r[1]+e.y*r[5]+e.z*r[9],o=e.x*r[2]+e.y*r[6]+e.z*r[10];return n.x=i,n.y=a,n.z=o,n.w=e.w,n}static TransformNormalFromFloatsToRef(e,t,n,r,i,a){let o=i.m;return a.x=e*o[0]+t*o[4]+n*o[8],a.y=e*o[1]+t*o[5]+n*o[9],a.z=e*o[2]+t*o[6]+n*o[10],a.w=r,a}static FromVector3(t,n=0){return new e(t._x,t._y,t._z,n)}};_t._ZeroReadOnly=_t.Zero();var P=class e{get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}constructor(e=0,t=0,n=0,r=1){this._isDirty=!0,this._x=e,this._y=t,this._z=n,this._w=r}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return`Quaternion`}getHashCode(){let e=ht(this._x),t=ht(this._y),n=ht(this._z),r=ht(this._w),i=e;return i=i*397^t,i=i*397^n,i=i*397^r,i}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=ut){return e&&M.WithinEpsilon(this._x,e._x,t)&&M.WithinEpsilon(this._y,e._y,t)&&M.WithinEpsilon(this._z,e._z,t)&&M.WithinEpsilon(this._w,e._w,t)}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copyFrom(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._w=e._w,this._isDirty=!0,this}copyFromFloats(e,t,n,r){return this._x=e,this._y=t,this._z=n,this._w=r,this._isDirty=!0,this}set(e,t,n,r){return this.copyFromFloats(e,t,n,r)}add(e){return new this.constructor(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this._isDirty=!0,this}subtract(e){return new this.constructor(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this._isDirty=!0,this}scale(e){return new this.constructor(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t._x=this._x*e,t._y=this._y*e,t._z=this._z*e,t._w=this._w*e,t._isDirty=!0,t}scaleInPlace(e){return this._x*=e,this._y*=e,this._z*=e,this._w*=e,this._isDirty=!0,this}scaleAndAddToRef(e,t){return t._x+=this._x*e,t._y+=this._y*e,t._z+=this._z*e,t._w+=this._w*e,t._isDirty=!0,t}multiply(e){let t=new this.constructor(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){let n=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,r=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,i=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,a=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(n,r,i,a),t}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),e}conjugateInPlace(){return this._x*=-1,this._y*=-1,this._z*=-1,this._isDirty=!0,this}conjugate(){return new this.constructor(-this._x,-this._y,-this._z,this._w)}invert(){let e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();let e=this.lengthSquared();return e==0||e==1||this.scaleInPlace(1/e),this}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){let e=this.length();if(e===0)return this;let t=1/e;return this.scaleInPlace(t),this}normalizeToNew(){let e=this.length();if(e===0)return this.clone();let t=1/e;return this.scale(t)}toEulerAngles(){let e=N.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){let t=this._z,n=this._x,r=this._y,i=this._w,a=r*t-n*i,o=.4999999;if(a<-o)e._y=2*Math.atan2(r,i),e._x=Math.PI/2,e._z=0,e._isDirty=!0;else if(a>o)e._y=2*Math.atan2(r,i),e._x=-Math.PI/2,e._z=0,e._isDirty=!0;else{let o=i*i,s=t*t,c=n*n,l=r*r;e._z=Math.atan2(2*(n*r+t*i),-s-c+l+o),e._x=Math.asin(-2*a),e._y=Math.atan2(2*(t*n+r*i),s-c-l+o),e._isDirty=!0}return e}toRotationMatrix(e){return F.FromQuaternionToRef(this,e),e}fromRotationMatrix(t){return e.FromRotationMatrixToRef(t,this),this}static FromRotationMatrix(t){let n=new e;return e.FromRotationMatrixToRef(t,n),n}static FromRotationMatrixToRef(e,t){let n=e.m,r=n[0],i=n[4],a=n[8],o=n[1],s=n[5],c=n[9],l=n[2],u=n[6],d=n[10],f=r+s+d,p;return f>0?(p=.5/Math.sqrt(f+1),t._w=.25/p,t._x=(u-c)*p,t._y=(a-l)*p,t._z=(o-i)*p,t._isDirty=!0):r>s&&r>d?(p=2*Math.sqrt(1+r-s-d),t._w=(u-c)/p,t._x=.25*p,t._y=(i+o)/p,t._z=(a+l)/p,t._isDirty=!0):s>d?(p=2*Math.sqrt(1+s-r-d),t._w=(a-l)/p,t._x=(i+o)/p,t._y=.25*p,t._z=(c+u)/p,t._isDirty=!0):(p=2*Math.sqrt(1+d-r-s),t._w=(o-i)/p,t._x=(a+l)/p,t._y=(c+u)/p,t._z=.25*p,t._isDirty=!0),t}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(t,n,r=.1){let i=e.Dot(t,n);return 1-i*i<=r}static SmoothToRef(t,n,r,i,a){let o=i===0?1:r/i;return o=M.Clamp(o,0,1),e.SlerpToRef(t,n,o,a),a}static Zero(){return new e(0,0,0,0)}static Inverse(e){return new e.constructor(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new e(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(t,n){return e.RotationAxisToRef(t,n,new e)}static RotationAxisToRef(e,t,n){let r=Math.sin(t/2);return e.normalize(),n._w=Math.cos(t/2),n._x=e._x*r,n._y=e._y*r,n._z=e._z*r,n._isDirty=!0,n}static FromArray(t,n){return n||=0,new e(t[n],t[n+1],t[n+2],t[n+3])}static FromArrayToRef(e,t,n){return n._x=e[t],n._y=e[t+1],n._z=e[t+2],n._w=e[t+3],n._isDirty=!0,n}static FromEulerAngles(t,n,r){let i=new e;return e.RotationYawPitchRollToRef(n,t,r,i),i}static FromEulerAnglesToRef(t,n,r,i){return e.RotationYawPitchRollToRef(n,t,r,i),i}static FromEulerVector(t){let n=new e;return e.RotationYawPitchRollToRef(t._y,t._x,t._z,n),n}static FromEulerVectorToRef(t,n){return e.RotationYawPitchRollToRef(t._y,t._x,t._z,n),n}static FromUnitVectorsToRef(e,t,n){let r=N.Dot(e,t)+1;return r<.001?Math.abs(e.x)>Math.abs(e.z)?n.set(-e.y,e.x,0,0):n.set(0,-e.z,e.y,0):(N.CrossToRef(e,t,L.Vector3[0]),n.set(L.Vector3[0].x,L.Vector3[0].y,L.Vector3[0].z,r)),n.normalize()}static RotationYawPitchRoll(t,n,r){let i=new e;return e.RotationYawPitchRollToRef(t,n,r,i),i}static RotationYawPitchRollToRef(e,t,n,r){let i=n*.5,a=t*.5,o=e*.5,s=Math.sin(i),c=Math.cos(i),l=Math.sin(a),u=Math.cos(a),d=Math.sin(o),f=Math.cos(o);return r._x=f*l*c+d*u*s,r._y=d*u*c-f*l*s,r._z=f*u*s-d*l*c,r._w=f*u*c+d*l*s,r._isDirty=!0,r}static RotationAlphaBetaGamma(t,n,r){let i=new e;return e.RotationAlphaBetaGammaToRef(t,n,r,i),i}static RotationAlphaBetaGammaToRef(e,t,n,r){let i=(n+e)*.5,a=(n-e)*.5,o=t*.5;return r._x=Math.cos(a)*Math.sin(o),r._y=Math.sin(a)*Math.sin(o),r._z=Math.sin(i)*Math.cos(o),r._w=Math.cos(i)*Math.cos(o),r._isDirty=!0,r}static RotationQuaternionFromAxis(t,n,r){let i=new e(0,0,0,0);return e.RotationQuaternionFromAxisToRef(t,n,r,i),i}static RotationQuaternionFromAxisToRef(t,n,r,i){let a=I.Matrix[0];return F.FromXYZAxesToRef(t.normalize(),n.normalize(),r.normalize(),a),e.FromRotationMatrixToRef(a,i),i}static FromLookDirectionLH(t,n){let r=new e;return e.FromLookDirectionLHToRef(t,n,r),r}static FromLookDirectionLHToRef(t,n,r){let i=I.Matrix[0];return F.LookDirectionLHToRef(t,n,i),e.FromRotationMatrixToRef(i,r),r}static FromLookDirectionRH(t,n){let r=new e;return e.FromLookDirectionRHToRef(t,n,r),r}static FromLookDirectionRHToRef(t,n,r){let i=I.Matrix[0];return F.LookDirectionRHToRef(t,n,i),e.FromRotationMatrixToRef(i,r)}static Slerp(t,n,r){let i=e.Identity();return e.SlerpToRef(t,n,r,i),i}static SlerpToRef(e,t,n,r){let i,a,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,s=!1;if(o<0&&(s=!0,o=-o),o>.999999)a=1-n,i=s?-n:n;else{let e=Math.acos(o),t=1/Math.sin(e);a=Math.sin((1-n)*e)*t,i=s?-Math.sin(n*e)*t:Math.sin(n*e)*t}return r._x=a*e._x+i*t._x,r._y=a*e._y+i*t._y,r._z=a*e._z+i*t._z,r._w=a*e._w+i*t._w,r._isDirty=!0,r}static Hermite(e,t,n,r,i){let a=i*i,o=i*a,s=2*o-3*a+1,c=-2*o+3*a,l=o-2*a+i,u=o-a,d=e._x*s+n._x*c+t._x*l+r._x*u,f=e._y*s+n._y*c+t._y*l+r._y*u,p=e._z*s+n._z*c+t._z*l+r._z*u,m=e._w*s+n._w*c+t._w*l+r._w*u;return new e.constructor(d,f,p,m)}static Hermite1stDerivative(e,t,n,r,i){let a=new e.constructor;return this.Hermite1stDerivativeToRef(e,t,n,r,i,a),a}static Hermite1stDerivativeToRef(e,t,n,r,i,a){let o=i*i;return a._x=(o-i)*6*e._x+(3*o-4*i+1)*t._x+(-o+i)*6*n._x+(3*o-2*i)*r._x,a._y=(o-i)*6*e._y+(3*o-4*i+1)*t._y+(-o+i)*6*n._y+(3*o-2*i)*r._y,a._z=(o-i)*6*e._z+(3*o-4*i+1)*t._z+(-o+i)*6*n._z+(3*o-2*i)*r._z,a._w=(o-i)*6*e._w+(3*o-4*i+1)*t._w+(-o+i)*6*n._w+(3*o-2*i)*r._w,a._isDirty=!0,a}},F=class e{static get Use64Bits(){return ke.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=e._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,n=!1,r=!0){this._isIdentity=e,this._isIdentity3x2=e||n,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:r}constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,ke.MatrixTrackPrecisionChange&&ke.MatrixTrackedMatrices.push(this),this._m=new ke.MatrixCurrentType(16),this.markAsUpdated()}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;let e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1||this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;let e=this._m,t=e[0],n=e[1],r=e[2],i=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8],u=e[9],d=e[10],f=e[11],p=e[12],m=e[13],h=e[14],g=e[15],_=d*g-h*f,v=u*g-m*f,y=u*h-m*d,b=l*g-p*f,x=l*h-d*p,S=l*m-p*u,C=+(o*_-s*v+c*y),w=-(a*_-s*b+c*x),T=+(a*v-o*b+c*S),E=-(a*y-o*x+s*S);return t*C+n*w+r*T+i*E}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return e.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){let t=new this.constructor;return this.addToRef(e,t),t}addToRef(e,t){let n=this._m,r=t._m,i=e.m;for(let e=0;e<16;e++)r[e]=n[e]+i[e];return t.markAsUpdated(),t}addToSelf(e){let t=this._m,n=e.m;for(let e=0;e<16;e++)t[e]+=n[e];return this.markAsUpdated(),this}invertToRef(t){if(this._isIdentity===!0)return e.IdentityToRef(t),t;let n=this._m,r=n[0],i=n[1],a=n[2],o=n[3],s=n[4],c=n[5],l=n[6],u=n[7],d=n[8],f=n[9],p=n[10],m=n[11],h=n[12],g=n[13],_=n[14],v=n[15],y=p*v-_*m,b=f*v-g*m,x=f*_-g*p,S=d*v-h*m,C=d*_-p*h,w=d*g-h*f,T=+(c*y-l*b+u*x),E=-(s*y-l*S+u*C),ee=+(s*b-c*S+u*w),te=-(s*x-c*C+l*w),D=r*T+i*E+a*ee+o*te;if(D===0)return t.copyFrom(this),t;let O=1/D,ne=l*v-_*u,re=c*v-g*u,ie=c*_-g*l,ae=s*v-h*u,oe=s*_-h*l,se=s*g-h*c,ce=l*m-p*u,le=c*m-f*u,ue=c*p-f*l,de=s*m-d*u,fe=s*p-d*l,pe=s*f-d*c,me=-(i*y-a*b+o*x),he=+(r*y-a*S+o*C),ge=-(r*b-i*S+o*w),_e=+(r*x-i*C+a*w),ve=+(i*ne-a*re+o*ie),ye=-(r*ne-a*ae+o*oe),be=+(r*re-i*ae+o*se),xe=-(r*ie-i*oe+a*se),Se=-(i*ce-a*le+o*ue),Ce=+(r*ce-a*de+o*fe),we=-(r*le-i*de+o*pe),Te=+(r*ue-i*fe+a*pe);return e.FromValuesToRef(T*O,me*O,ve*O,Se*O,E*O,he*O,ye*O,Ce*O,ee*O,ge*O,be*O,we*O,te*O,_e*O,xe*O,Te*O,t),t}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,n){return this._m[12]=e,this._m[13]=t,this._m[14]=n,this.markAsUpdated(),this}addTranslationFromFloats(e,t,n){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=n,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new N(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],e}removeRotationAndScaling(){let t=this.m;return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t[12],t[13],t[14],t[15],this),this._updateIdentityStatus(t[12]===0&&t[13]===0&&t[14]===0&&t[15]===1),this}multiply(e){let t=new this.constructor;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);let t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){let n=this._m;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),t):e._isIdentity?(t.copyFrom(this),t):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),t)}multiplyToArray(e,t,n){let r=this._m,i=e.m,a=r[0],o=r[1],s=r[2],c=r[3],l=r[4],u=r[5],d=r[6],f=r[7],p=r[8],m=r[9],h=r[10],g=r[11],_=r[12],v=r[13],y=r[14],b=r[15],x=i[0],S=i[1],C=i[2],w=i[3],T=i[4],E=i[5],ee=i[6],te=i[7],D=i[8],O=i[9],ne=i[10],re=i[11],ie=i[12],ae=i[13],oe=i[14],se=i[15];return t[n]=a*x+o*T+s*D+c*ie,t[n+1]=a*S+o*E+s*O+c*ae,t[n+2]=a*C+o*ee+s*ne+c*oe,t[n+3]=a*w+o*te+s*re+c*se,t[n+4]=l*x+u*T+d*D+f*ie,t[n+5]=l*S+u*E+d*O+f*ae,t[n+6]=l*C+u*ee+d*ne+f*oe,t[n+7]=l*w+u*te+d*re+f*se,t[n+8]=p*x+m*T+h*D+g*ie,t[n+9]=p*S+m*E+h*O+g*ae,t[n+10]=p*C+m*ee+h*ne+g*oe,t[n+11]=p*w+m*te+h*re+g*se,t[n+12]=_*x+v*T+y*D+b*ie,t[n+13]=_*S+v*E+y*O+b*ae,t[n+14]=_*C+v*ee+y*ne+b*oe,t[n+15]=_*w+v*te+y*re+b*se,this}equals(e){let t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;let n=this.m,r=t.m;return n[0]===r[0]&&n[1]===r[1]&&n[2]===r[2]&&n[3]===r[3]&&n[4]===r[4]&&n[5]===r[5]&&n[6]===r[6]&&n[7]===r[7]&&n[8]===r[8]&&n[9]===r[9]&&n[10]===r[10]&&n[11]===r[11]&&n[12]===r[12]&&n[13]===r[13]&&n[14]===r[14]&&n[15]===r[15]}clone(){let e=new this.constructor;return e.copyFrom(this),e}getClassName(){return`Matrix`}getHashCode(){let e=ht(this._m[0]);for(let t=1;t<16;t++)e=e*397^ht(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new P,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(t,n,r,i){if(this._isIdentity)return r&&r.setAll(0),t&&t.setAll(1),n&&n.copyFromFloats(0,0,0,1),!0;let a=this._m;if(r&&r.copyFromFloats(a[12],a[13],a[14]),t||=I.Vector3[0],t.x=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),t.y=Math.sqrt(a[4]*a[4]+a[5]*a[5]+a[6]*a[6]),t.z=Math.sqrt(a[8]*a[8]+a[9]*a[9]+a[10]*a[10]),i){let e=i.scaling.x<0?-1:1,n=i.scaling.y<0?-1:1,r=i.scaling.z<0?-1:1;t.x*=e,t.y*=n,t.z*=r}else this.determinant()<=0&&(t.y*=-1);if(t._x===0||t._y===0||t._z===0)return n&&n.copyFromFloats(0,0,0,1),!1;if(n){let r=1/t._x,i=1/t._y,o=1/t._z;e.FromValuesToRef(a[0]*r,a[1]*r,a[2]*r,0,a[4]*i,a[5]*i,a[6]*i,0,a[8]*o,a[9]*o,a[10]*o,0,0,0,0,1,I.Matrix[0]),P.FromRotationMatrixToRef(I.Matrix[0],n)}return!0}getRow(e){if(e<0||e>3)return null;let t=e*4;return new _t(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){let n=e*4;t.x=this._m[n+0],t.y=this._m[n+1],t.z=this._m[n+2],t.w=this._m[n+3]}return t}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){let t=new this.constructor;return e.TransposeToRef(this,t),t}transposeToRef(t){return e.TransposeToRef(this,t),t}setRowFromFloats(e,t,n,r,i){if(e<0||e>3)return this;let a=e*4;return this._m[a+0]=t,this._m[a+1]=n,this._m[a+2]=r,this._m[a+3]=i,this.markAsUpdated(),this}scale(e){let t=new this.constructor;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let n=0;n<16;n++)t._m[n]=this._m[n]*e;return t.markAsUpdated(),t}scaleAndAddToRef(e,t){for(let n=0;n<16;n++)t._m[n]+=this._m[n]*e;return t.markAsUpdated(),t}toNormalMatrix(t){let n=I.Matrix[0];this.invertToRef(n),n.transposeToRef(t);let r=t._m;return e.FromValuesToRef(r[0],r[1],r[2],0,r[4],r[5],r[6],0,r[8],r[9],r[10],0,0,0,0,1,t),t}getRotationMatrix(){let e=new this.constructor;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(t){let n=I.Vector3[0];if(!this.decompose(n))return e.IdentityToRef(t),t;let r=this._m,i=1/n._x,a=1/n._y,o=1/n._z;return e.FromValuesToRef(r[0]*i,r[1]*i,r[2]*i,0,r[4]*a,r[5]*a,r[6]*a,0,r[8]*o,r[9]*o,r[10]*o,0,0,0,0,1,t),t}toggleModelMatrixHandInPlace(){let e=this._m;return e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated(),this}toggleProjectionMatrixHandInPlace(){let e=this._m;return e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated(),this}static FromArray(t,n=0){let r=new e;return e.FromArrayToRef(t,n,r),r}static FromArrayToRef(e,t,n){for(let r=0;r<16;r++)n._m[r]=e[r+t];return n.markAsUpdated(),n}static FromFloat32ArrayToRefScaled(e,t,n,r){for(let i=0;i<16;i++)r._m[i]=e[i+t]*n;return r.markAsUpdated(),r}static get IdentityReadOnly(){return e._IdentityReadOnly}static FromValuesToRef(e,t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){let _=g._m;_[0]=e,_[1]=t,_[2]=n,_[3]=r,_[4]=i,_[5]=a,_[6]=o,_[7]=s,_[8]=c,_[9]=l,_[10]=u,_[11]=d,_[12]=f,_[13]=p,_[14]=m,_[15]=h,g.markAsUpdated()}static FromValues(t,n,r,i,a,o,s,c,l,u,d,f,p,m,h,g){let _=new e,v=_._m;return v[0]=t,v[1]=n,v[2]=r,v[3]=i,v[4]=a,v[5]=o,v[6]=s,v[7]=c,v[8]=l,v[9]=u,v[10]=d,v[11]=f,v[12]=p,v[13]=m,v[14]=h,v[15]=g,_.markAsUpdated(),_}static Compose(t,n,r){let i=new e;return e.ComposeToRef(t,n,r,i),i}static ComposeToRef(e,t,n,r){let i=r._m,a=t._x,o=t._y,s=t._z,c=t._w,l=a+a,u=o+o,d=s+s,f=a*l,p=a*u,m=a*d,h=o*u,g=o*d,_=s*d,v=c*l,y=c*u,b=c*d,x=e._x,S=e._y,C=e._z;return i[0]=(1-(h+_))*x,i[1]=(p+b)*x,i[2]=(m-y)*x,i[3]=0,i[4]=(p-b)*S,i[5]=(1-(f+_))*S,i[6]=(g+v)*S,i[7]=0,i[8]=(m+y)*C,i[9]=(g-v)*C,i[10]=(1-(f+h))*C,i[11]=0,i[12]=n._x,i[13]=n._y,i[14]=n._z,i[15]=1,r.markAsUpdated(),r}static Identity(){let t=e.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return t._updateIdentityStatus(!0),t}static IdentityToRef(t){return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(!0),t}static Zero(){let t=e.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return t._updateIdentityStatus(!1),t}static RotationX(t){let n=new e;return e.RotationXToRef(t,n),n}static Invert(e){let t=new e.constructor;return e.invertToRef(t),t}static RotationXToRef(t,n){let r=Math.sin(t),i=Math.cos(t);return e.FromValuesToRef(1,0,0,0,0,i,r,0,0,-r,i,0,0,0,0,1,n),n._updateIdentityStatus(i===1&&r===0),n}static RotationY(t){let n=new e;return e.RotationYToRef(t,n),n}static RotationYToRef(t,n){let r=Math.sin(t),i=Math.cos(t);return e.FromValuesToRef(i,0,-r,0,0,1,0,0,r,0,i,0,0,0,0,1,n),n._updateIdentityStatus(i===1&&r===0),n}static RotationZ(t){let n=new e;return e.RotationZToRef(t,n),n}static RotationZToRef(t,n){let r=Math.sin(t),i=Math.cos(t);return e.FromValuesToRef(i,r,0,0,-r,i,0,0,0,0,1,0,0,0,0,1,n),n._updateIdentityStatus(i===1&&r===0),n}static RotationAxis(t,n){let r=new e;return e.RotationAxisToRef(t,n,r),r}static RotationAxisToRef(e,t,n){let r=Math.sin(-t),i=Math.cos(-t),a=1-i;e.normalize();let o=n._m;return o[0]=e._x*e._x*a+i,o[1]=e._x*e._y*a-e._z*r,o[2]=e._x*e._z*a+e._y*r,o[3]=0,o[4]=e._y*e._x*a+e._z*r,o[5]=e._y*e._y*a+i,o[6]=e._y*e._z*a-e._x*r,o[7]=0,o[8]=e._z*e._x*a-e._y*r,o[9]=e._z*e._y*a+e._x*r,o[10]=e._z*e._z*a+i,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,n.markAsUpdated(),n}static RotationAlignToRef(e,t,n){let r=N.Dot(t,e),i=n._m;if(r<-.999)i[0]=-1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=-1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0;else{let n=N.Cross(t,e),a=1/(1+r);i[0]=n._x*n._x*a+r,i[1]=n._y*n._x*a-n._z,i[2]=n._z*n._x*a+n._y,i[3]=0,i[4]=n._x*n._y*a+n._z,i[5]=n._y*n._y*a+r,i[6]=n._z*n._y*a-n._x,i[7]=0,i[8]=n._x*n._z*a-n._y,i[9]=n._y*n._z*a+n._x,i[10]=n._z*n._z*a+r,i[11]=0}return i[12]=0,i[13]=0,i[14]=0,i[15]=1,n.markAsUpdated(),n}static RotationYawPitchRoll(t,n,r){let i=new e;return e.RotationYawPitchRollToRef(t,n,r,i),i}static RotationYawPitchRollToRef(e,t,n,r){return P.RotationYawPitchRollToRef(e,t,n,I.Quaternion[0]),I.Quaternion[0].toRotationMatrix(r),r}static Scaling(t,n,r){let i=new e;return e.ScalingToRef(t,n,r,i),i}static ScalingToRef(t,n,r,i){return e.FromValuesToRef(t,0,0,0,0,n,0,0,0,0,r,0,0,0,0,1,i),i._updateIdentityStatus(t===1&&n===1&&r===1),i}static Translation(t,n,r){let i=new e;return e.TranslationToRef(t,n,r,i),i}static TranslationToRef(t,n,r,i){return e.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,t,n,r,1,i),i._updateIdentityStatus(t===0&&n===0&&r===0),i}static Lerp(t,n,r){let i=new t.constructor;return e.LerpToRef(t,n,r,i),i}static LerpToRef(e,t,n,r){let i=r._m,a=e.m,o=t.m;for(let e=0;e<16;e++)i[e]=a[e]*(1-n)+o[e]*n;return r.markAsUpdated(),r}static DecomposeLerp(t,n,r){let i=new t.constructor;return e.DecomposeLerpToRef(t,n,r,i),i}static DecomposeLerpToRef(t,n,r,i){let a=I.Vector3[0],o=I.Quaternion[0],s=I.Vector3[1];t.decompose(a,o,s);let c=I.Vector3[2],l=I.Quaternion[1],u=I.Vector3[3];n.decompose(c,l,u);let d=I.Vector3[4];N.LerpToRef(a,c,r,d);let f=I.Quaternion[2];P.SlerpToRef(o,l,r,f);let p=I.Vector3[5];return N.LerpToRef(s,u,r,p),e.ComposeToRef(d,f,p,i),i}static LookAtLH(t,n,r){let i=new e;return e.LookAtLHToRef(t,n,r,i),i}static LookAtLHToRef(t,n,r,i){let a=I.Vector3[0],o=I.Vector3[1],s=I.Vector3[2];n.subtractToRef(t,s),s.normalize(),N.CrossToRef(r,s,a);let c=a.lengthSquared();c===0?a.x=1:a.normalizeFromLength(Math.sqrt(c)),N.CrossToRef(s,a,o),o.normalize();let l=-N.Dot(a,t),u=-N.Dot(o,t),d=-N.Dot(s,t);e.FromValuesToRef(a._x,o._x,s._x,0,a._y,o._y,s._y,0,a._z,o._z,s._z,0,l,u,d,1,i)}static LookAtRH(t,n,r){let i=new e;return e.LookAtRHToRef(t,n,r,i),i}static LookAtRHToRef(t,n,r,i){let a=I.Vector3[0],o=I.Vector3[1],s=I.Vector3[2];t.subtractToRef(n,s),s.normalize(),N.CrossToRef(r,s,a);let c=a.lengthSquared();c===0?a.x=1:a.normalizeFromLength(Math.sqrt(c)),N.CrossToRef(s,a,o),o.normalize();let l=-N.Dot(a,t),u=-N.Dot(o,t),d=-N.Dot(s,t);return e.FromValuesToRef(a._x,o._x,s._x,0,a._y,o._y,s._y,0,a._z,o._z,s._z,0,l,u,d,1,i),i}static LookDirectionLH(t,n){let r=new e;return e.LookDirectionLHToRef(t,n,r),r}static LookDirectionLHToRef(t,n,r){let i=I.Vector3[0];i.copyFrom(t),i.scaleInPlace(-1);let a=I.Vector3[1];return N.CrossToRef(n,i,a),e.FromValuesToRef(a._x,a._y,a._z,0,n._x,n._y,n._z,0,i._x,i._y,i._z,0,0,0,0,1,r),r}static LookDirectionRH(t,n){let r=new e;return e.LookDirectionRHToRef(t,n,r),r}static LookDirectionRHToRef(t,n,r){let i=I.Vector3[2];return N.CrossToRef(n,t,i),e.FromValuesToRef(i._x,i._y,i._z,0,n._x,n._y,n._z,0,t._x,t._y,t._z,0,0,0,0,1,r),r}static OrthoLH(t,n,r,i,a){let o=new e;return e.OrthoLHToRef(t,n,r,i,o,a),o}static OrthoLHToRef(t,n,r,i,a,o){let s=r,c=i,l=2/t,u=2/n,d=2/(c-s),f=-(c+s)/(c-s);return e.FromValuesToRef(l,0,0,0,0,u,0,0,0,0,d,0,0,0,f,1,a),o&&a.multiplyToRef(vt,a),a._updateIdentityStatus(l===1&&u===1&&d===1&&f===0),a}static OrthoOffCenterLH(t,n,r,i,a,o,s){let c=new e;return e.OrthoOffCenterLHToRef(t,n,r,i,a,o,c,s),c}static OrthoOffCenterLHToRef(t,n,r,i,a,o,s,c){let l=a,u=o,d=2/(n-t),f=2/(i-r),p=2/(u-l),m=-(u+l)/(u-l),h=(t+n)/(t-n),g=(i+r)/(r-i);return e.FromValuesToRef(d,0,0,0,0,f,0,0,0,0,p,0,h,g,m,1,s),c&&s.multiplyToRef(vt,s),s.markAsUpdated(),s}static OrthoOffCenterRH(t,n,r,i,a,o,s){let c=new e;return e.OrthoOffCenterRHToRef(t,n,r,i,a,o,c,s),c}static OrthoOffCenterRHToRef(t,n,r,i,a,o,s,c){return e.OrthoOffCenterLHToRef(t,n,r,i,a,o,s,c),s._m[10]*=-1,s}static PerspectiveLH(t,n,r,i,a,o=0){let s=new e,c=r,l=i,u=2*c/t,d=2*c/n,f=(l+c)/(l-c),p=-2*l*c/(l-c),m=Math.tan(o);return e.FromValuesToRef(u,0,0,0,0,d,0,m,0,0,f,1,0,0,p,0,s),a&&s.multiplyToRef(vt,s),s._updateIdentityStatus(!1),s}static PerspectiveFovLH(t,n,r,i,a,o=0,s=!1){let c=new e;return e.PerspectiveFovLHToRef(t,n,r,i,c,!0,a,o,s),c}static PerspectiveFovLHToRef(t,n,r,i,a,o=!0,s,c=0,l=!1){let u=r,d=i,f=1/Math.tan(t*.5),p=o?f/n:f,m=o?f:f*n,h=l&&u===0?-1:d===0?1:(d+u)/(d-u),g=l&&u===0?2*d:d===0?-2*u:-2*d*u/(d-u),_=Math.tan(c);return e.FromValuesToRef(p,0,0,0,0,m,0,_,0,0,h,1,0,0,g,0,a),s&&a.multiplyToRef(vt,a),a._updateIdentityStatus(!1),a}static PerspectiveFovReverseLHToRef(t,n,r,i,a,o=!0,s,c=0){let l=1/Math.tan(t*.5),u=o?l/n:l,d=o?l:l*n,f=Math.tan(c);return e.FromValuesToRef(u,0,0,0,0,d,0,f,0,0,-r,1,0,0,1,0,a),s&&a.multiplyToRef(vt,a),a._updateIdentityStatus(!1),a}static PerspectiveFovRH(t,n,r,i,a,o=0,s=!1){let c=new e;return e.PerspectiveFovRHToRef(t,n,r,i,c,!0,a,o,s),c}static PerspectiveFovRHToRef(t,n,r,i,a,o=!0,s,c=0,l=!1){let u=r,d=i,f=1/Math.tan(t*.5),p=o?f/n:f,m=o?f:f*n,h=l&&u===0?1:d===0?-1:-(d+u)/(d-u),g=l&&u===0?2*d:d===0?-2*u:-2*d*u/(d-u),_=Math.tan(c);return e.FromValuesToRef(p,0,0,0,0,m,0,_,0,0,h,-1,0,0,g,0,a),s&&a.multiplyToRef(vt,a),a._updateIdentityStatus(!1),a}static PerspectiveFovReverseRHToRef(t,n,r,i,a,o=!0,s,c=0){let l=1/Math.tan(t*.5),u=o?l/n:l,d=o?l:l*n,f=Math.tan(c);return e.FromValuesToRef(u,0,0,0,0,d,0,f,0,0,-r,-1,0,0,-1,0,a),s&&a.multiplyToRef(vt,a),a._updateIdentityStatus(!1),a}static PerspectiveFovWebVRToRef(e,t,n,r,i=!1,a,o=0){let s=i?-1:1,c=Math.tan(e.upDegrees*Math.PI/180),l=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(u+d),p=2/(c+l),m=Math.tan(o),h=r._m;return h[0]=f,h[1]=h[2]=h[3]=h[4]=0,h[5]=p,h[6]=0,h[7]=m,h[8]=(u-d)*f*.5,h[9]=-((c-l)*p*.5),h[10]=-n/(t-n),h[11]=1*s,h[12]=h[13]=h[15]=0,h[14]=-(2*n*t)/(n-t),a&&r.multiplyToRef(vt,r),r.markAsUpdated(),r}static GetFinalMatrix(t,n,r,i,a,o){let s=t.width,c=t.height,l=t.x,u=t.y,d=e.FromValues(s/2,0,0,0,0,-c/2,0,0,0,0,o-a,0,l+s/2,c/2+u,a,1),f=new n.constructor;return n.multiplyToRef(r,f),f.multiplyToRef(i,f),f.multiplyToRef(d,f)}static GetAsMatrix2x2(e){let t=e.m,n=[t[0],t[1],t[4],t[5]];return ke.MatrixUse64Bits?n:new Float32Array(n)}static GetAsMatrix3x3(e){let t=e.m,n=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return ke.MatrixUse64Bits?n:new Float32Array(n)}static Transpose(t){let n=new t.constructor;return e.TransposeToRef(t,n),n}static TransposeToRef(e,t){let n=t._m,r=e.m;return n[0]=r[0],n[1]=r[4],n[2]=r[8],n[3]=r[12],n[4]=r[1],n[5]=r[5],n[6]=r[9],n[7]=r[13],n[8]=r[2],n[9]=r[6],n[10]=r[10],n[11]=r[14],n[12]=r[3],n[13]=r[7],n[14]=r[11],n[15]=r[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty),t}static Reflection(t){let n=new e;return e.ReflectionToRef(t,n),n}static ReflectionToRef(t,n){t.normalize();let r=t.normal.x,i=t.normal.y,a=t.normal.z,o=-2*r,s=-2*i,c=-2*a;return e.FromValuesToRef(o*r+1,s*r,c*r,0,o*i,s*i+1,c*i,0,o*a,s*a,c*a+1,0,o*t.d,s*t.d,c*t.d,1,n),n}static FromXYZAxesToRef(t,n,r,i){return e.FromValuesToRef(t._x,t._y,t._z,0,n._x,n._y,n._z,0,r._x,r._y,r._z,0,0,0,0,1,i),i}static FromQuaternionToRef(e,t){let n=e._x*e._x,r=e._y*e._y,i=e._z*e._z,a=e._x*e._y,o=e._z*e._w,s=e._z*e._x,c=e._y*e._w,l=e._y*e._z,u=e._x*e._w;return t._m[0]=1-2*(r+i),t._m[1]=2*(a+o),t._m[2]=2*(s-c),t._m[3]=0,t._m[4]=2*(a-o),t._m[5]=1-2*(i+n),t._m[6]=2*(l+u),t._m[7]=0,t._m[8]=2*(s+c),t._m[9]=2*(l-u),t._m[10]=1-2*(r+n),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated(),t}};F._UpdateFlagSeed=0,F._IdentityReadOnly=F.Identity();var I=class{};I.Vector3=dt.BuildTuple(11,N.Zero),I.Matrix=dt.BuildTuple(2,F.Identity),I.Quaternion=dt.BuildTuple(3,P.Zero);var L=class{};L.Vector2=dt.BuildTuple(3,gt.Zero),L.Vector3=dt.BuildTuple(13,N.Zero),L.Vector4=dt.BuildTuple(3,_t.Zero),L.Quaternion=dt.BuildTuple(2,P.Zero),L.Matrix=dt.BuildTuple(8,F.Identity),$e(`BABYLON.Vector2`,gt),$e(`BABYLON.Vector3`,N),$e(`BABYLON.Vector4`,_t),$e(`BABYLON.Matrix`,F);var vt=F.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1),yt=class{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[]}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,n,r){for(let i in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,i)&&this._BabylonFileParsers[i](e,t,n,r)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}};yt._BabylonFileParsers={},yt._IndividualBabylonFileParsers={};function R(e,t,n,r){var i=arguments.length,a=i<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,n):r,o;if(typeof Reflect==`object`&&typeof Reflect.decorate==`function`)a=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(o=e[s])&&(a=(i<3?o(a):i>3?o(t,n,a):o(t,n))||a);return i>3&&a&&Object.defineProperty(t,n,a),a}function bt(e){return e**+lt}function xt(e){return e<=.04045?.0773993808*e:(.947867299*(e+.055))**2.4}function St(e){return e**+ct}function Ct(e){return e<=.0031308?12.92*e:1.055*e**.41666-.055}var wt=class e{constructor(e=0,t=0,n=0){this.r=e,this.g=t,this.b=n}toString(){return`{R: `+this.r+` G:`+this.g+` B:`+this.b+`}`}getClassName(){return`Color3`}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(t,n=0){return e.FromArrayToRef(t,n,this),this}toColor4(e=1){return new Tt(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,n){return this.r===e&&this.g===t&&this.b===n}scale(t){return new e(this.r*t,this.g*t,this.b*t)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,n){return n.r=M.Clamp(this.r,e,t),n.g=M.Clamp(this.g,e,t),n.b=M.Clamp(this.b,e,t),this}add(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new e(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,n){return this.r=e,this.g=t,this.b=n,this}set(e,t,n){return this.copyFromFloats(e,t,n)}toHexString(){let e=Math.round(this.r*255),t=Math.round(this.g*255),n=Math.round(this.b*255);return`#`+M.ToHex(e)+M.ToHex(t)+M.ToHex(n)}toHSV(){let t=new e;return this.toHSVToRef(t),t}toHSVToRef(e){let t=this.r,n=this.g,r=this.b,i=Math.max(t,n,r),a=Math.min(t,n,r),o=0,s=0,c=i,l=i-a;i!==0&&(s=l/i),i!=a&&(i==t?(o=(n-r)/l,n<r&&(o+=6)):i==n?o=(r-t)/l+2:i==r&&(o=(t-n)/l+4),o*=60),e.r=o,e.g=s,e.b=c}toLinearSpace(t=!1){let n=new e;return this.toLinearSpaceToRef(n,t),n}toLinearSpaceToRef(e,t=!1){return t?(e.r=xt(this.r),e.g=xt(this.g),e.b=xt(this.b)):(e.r=bt(this.r),e.g=bt(this.g),e.b=bt(this.b)),this}toGammaSpace(t=!1){let n=new e;return this.toGammaSpaceToRef(n,t),n}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ct(this.r),e.g=Ct(this.g),e.b=Ct(this.b)):(e.r=St(this.r),e.g=St(this.g),e.b=St(this.b)),this}static HSVtoRGBToRef(e,t,n,r){let i=n*t,a=e/60,o=i*(1-Math.abs(a%2-1)),s=0,c=0,l=0;a>=0&&a<=1?(s=i,c=o):a>=1&&a<=2?(s=o,c=i):a>=2&&a<=3?(c=i,l=o):a>=3&&a<=4?(c=o,l=i):a>=4&&a<=5?(s=o,l=i):a>=5&&a<=6&&(s=i,l=o);let u=n-i;r.set(s+u,c+u,l+u)}static FromHSV(t,n,r){let i=new e(0,0,0);return e.HSVtoRGBToRef(t,n,r,i),i}static FromHexString(t){if(t.substring(0,1)!==`#`||t.length!==7)return new e(0,0,0);let n=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),i=parseInt(t.substring(5,7),16);return e.FromInts(n,r,i)}static FromArray(t,n=0){return new e(t[n],t[n+1],t[n+2])}static FromArrayToRef(e,t=0,n){n.r=e[t],n.g=e[t+1],n.b=e[t+2]}static FromInts(t,n,r){return new e(t/255,n/255,r/255)}static Lerp(t,n,r){let i=new e(0,0,0);return e.LerpToRef(t,n,r,i),i}static LerpToRef(e,t,n,r){r.r=e.r+(t.r-e.r)*n,r.g=e.g+(t.g-e.g)*n,r.b=e.b+(t.b-e.b)*n}static Hermite(t,n,r,i,a){let o=a*a,s=a*o,c=2*s-3*o+1,l=-2*s+3*o,u=s-2*o+a,d=s-o;return new e(t.r*c+r.r*l+n.r*u+i.r*d,t.g*c+r.g*l+n.g*u+i.g*d,t.b*c+r.b*l+n.b*u+i.b*d)}static Hermite1stDerivative(t,n,r,i,a){let o=e.Black();return this.Hermite1stDerivativeToRef(t,n,r,i,a,o),o}static Hermite1stDerivativeToRef(e,t,n,r,i,a){let o=i*i;a.r=(o-i)*6*e.r+(3*o-4*i+1)*t.r+(-o+i)*6*n.r+(3*o-2*i)*r.r,a.g=(o-i)*6*e.g+(3*o-4*i+1)*t.g+(-o+i)*6*n.g+(3*o-2*i)*r.g,a.b=(o-i)*6*e.b+(3*o-4*i+1)*t.b+(-o+i)*6*n.b+(3*o-2*i)*r.b}static Red(){return new e(1,0,0)}static Green(){return new e(0,1,0)}static Blue(){return new e(0,0,1)}static Black(){return new e(0,0,0)}static get BlackReadOnly(){return e._BlackReadOnly}static White(){return new e(1,1,1)}static Purple(){return new e(.5,0,.5)}static Magenta(){return new e(1,0,1)}static Yellow(){return new e(1,1,0)}static Gray(){return new e(.5,.5,.5)}static Teal(){return new e(0,1,1)}static Random(){return new e(Math.random(),Math.random(),Math.random())}};wt._BlackReadOnly=wt.Black();var Tt=class e{constructor(e=0,t=0,n=0,r=1){this.r=e,this.g=t,this.b=n,this.a=r}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(t,n=0){return e.FromArrayToRef(t,n,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(t){return new e(this.r+t.r,this.g+t.g,this.b+t.b,this.a+t.a)}subtract(t){return new e(this.r-t.r,this.g-t.g,this.b-t.b,this.a-t.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(t){return new e(this.r*t,this.g*t,this.b*t,this.a*t)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,n){return n.r=M.Clamp(this.r,e,t),n.g=M.Clamp(this.g,e,t),n.b=M.Clamp(this.b,e,t),n.a=M.Clamp(this.a,e,t),this}multiply(t){return new e(this.r*t.r,this.g*t.g,this.b*t.b,this.a*t.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return`{R: `+this.r+` G:`+this.g+` B:`+this.b+` A:`+this.a+`}`}getClassName(){return`Color4`}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new e(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,n,r){return this.r=e,this.g=t,this.b=n,this.a=r,this}set(e,t,n,r){return this.copyFromFloats(e,t,n,r)}toHexString(e=!1){let t=Math.round(this.r*255),n=Math.round(this.g*255),r=Math.round(this.b*255);if(e)return`#`+M.ToHex(t)+M.ToHex(n)+M.ToHex(r);let i=Math.round(this.a*255);return`#`+M.ToHex(t)+M.ToHex(n)+M.ToHex(r)+M.ToHex(i)}toLinearSpace(t=!1){let n=new e;return this.toLinearSpaceToRef(n,t),n}toLinearSpaceToRef(e,t=!1){return t?(e.r=xt(this.r),e.g=xt(this.g),e.b=xt(this.b)):(e.r=bt(this.r),e.g=bt(this.g),e.b=bt(this.b)),e.a=this.a,this}toGammaSpace(t=!1){let n=new e;return this.toGammaSpaceToRef(n,t),n}toGammaSpaceToRef(e,t=!1){return t?(e.r=Ct(this.r),e.g=Ct(this.g),e.b=Ct(this.b)):(e.r=St(this.r),e.g=St(this.g),e.b=St(this.b)),e.a=this.a,this}static FromHexString(t){if(t.substring(0,1)!==`#`||t.length!==9&&t.length!==7)return new e(0,0,0,0);let n=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),i=parseInt(t.substring(5,7),16),a=t.length===9?parseInt(t.substring(7,9),16):255;return e.FromInts(n,r,i,a)}static Lerp(t,n,r){let i=new e(0,0,0,0);return e.LerpToRef(t,n,r,i),i}static LerpToRef(e,t,n,r){r.r=e.r+(t.r-e.r)*n,r.g=e.g+(t.g-e.g)*n,r.b=e.b+(t.b-e.b)*n,r.a=e.a+(t.a-e.a)*n}static Hermite(t,n,r,i,a){let o=a*a,s=a*o,c=2*s-3*o+1,l=-2*s+3*o,u=s-2*o+a,d=s-o;return new e(t.r*c+r.r*l+n.r*u+i.r*d,t.g*c+r.g*l+n.g*u+i.g*d,t.b*c+r.b*l+n.b*u+i.b*d,t.a*c+r.a*l+n.a*u+i.a*d)}static Hermite1stDerivative(t,n,r,i,a){let o=new e;return this.Hermite1stDerivativeToRef(t,n,r,i,a,o),o}static Hermite1stDerivativeToRef(e,t,n,r,i,a){let o=i*i;a.r=(o-i)*6*e.r+(3*o-4*i+1)*t.r+(-o+i)*6*n.r+(3*o-2*i)*r.r,a.g=(o-i)*6*e.g+(3*o-4*i+1)*t.g+(-o+i)*6*n.g+(3*o-2*i)*r.g,a.b=(o-i)*6*e.b+(3*o-4*i+1)*t.b+(-o+i)*6*n.b+(3*o-2*i)*r.b,a.a=(o-i)*6*e.a+(3*o-4*i+1)*t.a+(-o+i)*6*n.a+(3*o-2*i)*r.a}static FromColor3(t,n=1){return new e(t.r,t.g,t.b,n)}static FromArray(t,n=0){return new e(t[n],t[n+1],t[n+2],t[n+3])}static FromArrayToRef(e,t=0,n){n.r=e[t],n.g=e[t+1],n.b=e[t+2],n.a=e[t+3]}static FromInts(t,n,r,i){return new e(t/255,n/255,r/255,i/255)}static CheckColors4(e,t){if(e.length===t*3){let t=[];for(let n=0;n<e.length;n+=3){let r=n/3*4;t[r]=e[n],t[r+1]=e[n+1],t[r+2]=e[n+2],t[r+3]=1}return t}return e}},Et=class{};Et.Color3=dt.BuildArray(3,wt.Black),Et.Color4=dt.BuildArray(3,()=>new Tt(0,0,0,0)),$e(`BABYLON.Color3`,wt),$e(`BABYLON.Color4`,Tt);var Dt={},Ot={},kt=function(e,t,n){let r=e();j&&j.HasTags(t)&&j.AddTagsTo(r,j.GetTags(t,!0));let i=jt(r);for(let e in i){let a=i[e],o=t[e],s=a.type;if(o!=null&&(e!==`uniqueId`||B.AllowLoadingUniqueId))switch(s){case 0:case 6:case 11:r[e]=o;break;case 1:r[e]=n||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:r[e]=n?o:o.clone();break}}return r};function At(e){let t=e.getClassName();return Dt[t]||(Dt[t]={}),Dt[t]}function jt(e){let t=e.getClassName();if(Ot[t])return Ot[t];Ot[t]={};let n=Ot[t],r=e,i=t;for(;i;){let e=Dt[i];for(let t in e)n[t]=e[t];let t,a=!1;do{if(t=Object.getPrototypeOf(r),!t.getClassName){a=!0;break}if(t.getClassName()!==i)break;r=t}while(t);if(a)break;i=t.getClassName(),r=t}return n}function Mt(e,t){return(n,r)=>{let i=At(n);i[r]||(i[r]={type:e,sourceName:t})}}function Nt(e,t=null){return(n,r)=>{let i=t||`_`+r;Object.defineProperty(n,r,{get:function(){return this[i]},set:function(t){typeof this.equals==`function`&&this.equals(t)||this[i]!==t&&(this[i]=t,n[e].apply(this))},enumerable:!0,configurable:!0})}}function Pt(e,t=null){return Nt(e,t)}function z(e){return Mt(0,e)}function Ft(e){return Mt(1,e)}function It(e){return Mt(2,e)}function Lt(e){return Mt(3,e)}function Rt(e){return Mt(4,e)}function zt(e){return Mt(5,e)}function Bt(e){return Mt(6,e)}function Vt(e){return Mt(7,e)}function Ht(e){return Mt(8,e)}function Ut(e){return Mt(10,e)}var B=class e{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let n=0;n<e.animations.length;n++){let r=e.animations[n];t.animations.push(r.serialize())}}}static Serialize(t,n){n||={},j&&(n.tags=j.GetTags(t));let r=jt(t);for(let i in r){let a=r[i],o=a.sourceName||i,s=a.type,c=t[i];if(c!=null&&(i!==`uniqueId`||e.AllowLoadingUniqueId))switch(s){case 0:n[o]=c;break;case 1:n[o]=c.serialize();break;case 2:n[o]=c.asArray();break;case 3:n[o]=c.serialize();break;case 4:n[o]=c.asArray();break;case 5:n[o]=c.asArray();break;case 6:n[o]=c.id;break;case 7:n[o]=c.serialize();break;case 8:n[o]=c.asArray();break;case 9:n[o]=c.serialize();break;case 10:n[o]=c.asArray();break;case 11:n[o]=c.id;break;case 12:n[o]=c.asArray();break}}return n}static ParseProperties(t,n,r,i){i||=``;let a=jt(n);for(let o in a){let s=a[o],c=t[s.sourceName||o],l=s.type;if(c!=null&&(o!==`uniqueId`||e.AllowLoadingUniqueId)){let t=n;switch(l){case 0:t[o]=c;break;case 1:r&&(t[o]=e._TextureParser(c,r,i));break;case 2:t[o]=wt.FromArray(c);break;case 3:t[o]=e._FresnelParametersParser(c);break;case 4:t[o]=gt.FromArray(c);break;case 5:t[o]=N.FromArray(c);break;case 6:r&&(t[o]=r.getLastMeshById(c));break;case 7:t[o]=e._ColorCurvesParser(c);break;case 8:t[o]=Tt.FromArray(c);break;case 9:t[o]=e._ImageProcessingConfigurationParser(c);break;case 10:t[o]=P.FromArray(c);break;case 11:r&&(t[o]=r.getCameraById(c));break;case 12:t[o]=F.FromArray(c);break}}}}static Parse(t,n,r,i=null){let a=t();return j&&j.AddTagsTo(a,n.tags),e.ParseProperties(n,a,r,i),a}static Clone(e,t){return kt(e,t,!1)}static Instanciate(e,t){return kt(e,t,!0)}};B.AllowLoadingUniqueId=!1,B._ImageProcessingConfigurationParser=e=>{throw _(`ImageProcessingConfiguration`)},B._FresnelParametersParser=e=>{throw _(`FresnelParameters`)},B._ColorCurvesParser=e=>{throw _(`ColorCurves`)},B._TextureParser=(e,t,n)=>{throw _(`Texture`)};function Wt(e,t,n,r){let i=n.value;n.value=(...n)=>{let a=i;if(typeof _native<`u`&&_native[t]){let e=_native[t];a=r?(...t)=>r(...t)?e(...t):i(...t):e}return e[t]=a,a(...n)}}Wt.filter=function(e){return(t,n,r)=>Wt(t,n,r,e)};var Gt=class e{constructor(){this._dirty=!0,this._tempColor=new Tt(0,0,0,0),this._globalCurve=new Tt(0,0,0,0),this._highlightsCurve=new Tt(0,0,0,0),this._midtonesCurve=new Tt(0,0,0,0),this._shadowsCurve=new Tt(0,0,0,0),this._positiveCurve=new Tt(0,0,0,0),this._negativeCurve=new Tt(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return`ColorCurves`}static Bind(e,t,n=`vCameraColorCurvePositive`,r=`vCameraColorCurveNeutral`,i=`vCameraColorCurveNegative`){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(n,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(r,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(i,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push(`vCameraColorCurveNeutral`,`vCameraColorCurvePositive`,`vCameraColorCurveNegative`)}_getColorGradingDataToRef(t,n,r,i,a){t!=null&&(t=e._Clamp(t,0,360),n=e._Clamp(n,-100,100),r=e._Clamp(r,-100,100),i=e._Clamp(i,-100,100),n=e._ApplyColorGradingSliderNonlinear(n),n*=.5,i=e._ApplyColorGradingSliderNonlinear(i),n<0&&(n*=-1,t=(t+180)%360),e._FromHSBToRef(t,n,50+.25*i,a),a.scaleToRef(2,a),a.a=1+.01*r)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t**=2,e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(t,n,r,i){let a=e._Clamp(t,0,360),o=e._Clamp(n/100,0,1),s=e._Clamp(r/100,0,1);if(o===0)i.r=s,i.g=s,i.b=s;else{a/=60;let e=Math.floor(a),t=a-e,n=s*(1-o),r=s*(1-o*t),c=s*(1-o*(1-t));switch(e){case 0:i.r=s,i.g=c,i.b=n;break;case 1:i.r=r,i.g=s,i.b=n;break;case 2:i.r=n,i.g=s,i.b=c;break;case 3:i.r=n,i.g=r,i.b=s;break;case 4:i.r=c,i.g=n,i.b=s;break;default:i.r=s,i.g=n,i.b=r;break}}i.a=1}static _Clamp(e,t,n){return Math.min(Math.max(e,t),n)}clone(){return B.Clone(()=>new e,this)}serialize(){return B.Serialize(this)}static Parse(t){return B.Parse(()=>new e,t,null,null)}};R([z()],Gt.prototype,`_globalHue`,void 0),R([z()],Gt.prototype,`_globalDensity`,void 0),R([z()],Gt.prototype,`_globalSaturation`,void 0),R([z()],Gt.prototype,`_globalExposure`,void 0),R([z()],Gt.prototype,`_highlightsHue`,void 0),R([z()],Gt.prototype,`_highlightsDensity`,void 0),R([z()],Gt.prototype,`_highlightsSaturation`,void 0),R([z()],Gt.prototype,`_highlightsExposure`,void 0),R([z()],Gt.prototype,`_midtonesHue`,void 0),R([z()],Gt.prototype,`_midtonesDensity`,void 0),R([z()],Gt.prototype,`_midtonesSaturation`,void 0),R([z()],Gt.prototype,`_midtonesExposure`,void 0),B._ColorCurvesParser=Gt.Parse;var V=class e{constructor(){this.colorCurves=new Gt,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=e.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCenterX=0,this.vignetteCenterY=0,this.vignetteWeight=1.5,this.vignetteColor=new Tt(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=e.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new o}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteCentreY(){return this.vignetteCenterY}set vignetteCentreY(e){this.vignetteCenterY=e}get vignetteCentreX(){return this.vignetteCenterX}set vignetteCentreX(e){this.vignetteCenterX=e}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return`ImageProcessingConfiguration`}static PrepareUniforms(e,t){t.EXPOSURE&&e.push(`exposureLinear`),t.CONTRAST&&e.push(`contrast`),t.COLORGRADING&&e.push(`colorTransformSettings`),(t.VIGNETTE||t.DITHER)&&e.push(`vInverseScreenSize`),t.VIGNETTE&&(e.push(`vignetteSettings1`),e.push(`vignetteSettings2`)),t.COLORCURVES&&Gt.PrepareUniforms(e),t.DITHER&&e.push(`ditherIntensity`)}static PrepareSamplers(e,t){t.COLORGRADING&&e.push(`txColorTransform`)}prepareDefines(t,n=!1){if(n!==this.applyByPostProcess||!this._isEnabled){t.VIGNETTE=!1,t.TONEMAPPING=!1,t.TONEMAPPING_ACES=!1,t.CONTRAST=!1,t.EXPOSURE=!1,t.COLORCURVES=!1,t.COLORGRADING=!1,t.COLORGRADING3D=!1,t.DITHER=!1,t.IMAGEPROCESSING=!1,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(t.VIGNETTE=this.vignetteEnabled,t.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===e._VIGNETTEMODE_MULTIPLY,t.VIGNETTEBLENDMODEOPAQUE=!t.VIGNETTEBLENDMODEMULTIPLY,t.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case e.TONEMAPPING_ACES:t.TONEMAPPING_ACES=!0;break;default:t.TONEMAPPING_ACES=!1;break}t.CONTRAST=this.contrast!==1,t.EXPOSURE=this.exposure!==1,t.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,t.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,t.COLORGRADING?t.COLORGRADING3D=this.colorGradingTexture.is3D:t.COLORGRADING3D=!1,t.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,t.SAMPLER3DBGRMAP=this.colorGradingBGR,t.DITHER=this._ditheringEnabled,t.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,t.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,t.IMAGEPROCESSING=t.VIGNETTE||t.TONEMAPPING||t.CONTRAST||t.EXPOSURE||t.COLORCURVES||t.COLORGRADING||t.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Gt.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){let n=1/e.getEngine().getRenderWidth(),r=1/e.getEngine().getRenderHeight();if(e.setFloat2(`vInverseScreenSize`,n,r),this._ditheringEnabled&&e.setFloat(`ditherIntensity`,.5*this._ditheringIntensity),this._vignetteEnabled){let i=t??r/n,a=Math.tan(this.vignetteCameraFov*.5),o=a*i,s=Math.sqrt(o*a);o=A.Mix(o,s,this.vignetteStretch),a=A.Mix(a,s,this.vignetteStretch),e.setFloat4(`vignetteSettings1`,o,a,-o*this.vignetteCenterX,-a*this.vignetteCenterY);let c=-2*this.vignetteWeight;e.setFloat4(`vignetteSettings2`,this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,c)}}if(e.setFloat(`exposureLinear`,this.exposure),e.setFloat(`contrast`,this.contrast),this.colorGradingTexture){e.setTexture(`txColorTransform`,this.colorGradingTexture);let t=this.colorGradingTexture.getSize().height;e.setFloat4(`colorTransformSettings`,(t-1)/t,.5/t,t,this.colorGradingTexture.level)}}clone(){return B.Clone(()=>new e,this)}serialize(){return B.Serialize(this)}static Parse(t){let n=B.Parse(()=>new e,t,null,null);return t.vignetteCentreX!==void 0&&(n.vignetteCenterX=t.vignetteCentreX),t.vignetteCentreY!==void 0&&(n.vignetteCenterY=t.vignetteCentreY),n}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}};V.TONEMAPPING_STANDARD=0,V.TONEMAPPING_ACES=1,V._VIGNETTEMODE_MULTIPLY=0,V._VIGNETTEMODE_OPAQUE=1,R([Vt()],V.prototype,`colorCurves`,void 0),R([z()],V.prototype,`_colorCurvesEnabled`,void 0),R([Ft(`colorGradingTexture`)],V.prototype,`_colorGradingTexture`,void 0),R([z()],V.prototype,`_colorGradingEnabled`,void 0),R([z()],V.prototype,`_colorGradingWithGreenDepth`,void 0),R([z()],V.prototype,`_colorGradingBGR`,void 0),R([z()],V.prototype,`_exposure`,void 0),R([z()],V.prototype,`_toneMappingEnabled`,void 0),R([z()],V.prototype,`_toneMappingType`,void 0),R([z()],V.prototype,`_contrast`,void 0),R([z()],V.prototype,`vignetteStretch`,void 0),R([z()],V.prototype,`vignetteCenterX`,void 0),R([z()],V.prototype,`vignetteCenterY`,void 0),R([z()],V.prototype,`vignetteWeight`,void 0),R([Ht()],V.prototype,`vignetteColor`,void 0),R([z()],V.prototype,`vignetteCameraFov`,void 0),R([z()],V.prototype,`_vignetteBlendMode`,void 0),R([z()],V.prototype,`_vignetteEnabled`,void 0),R([z()],V.prototype,`_ditheringEnabled`,void 0),R([z()],V.prototype,`_ditheringIntensity`,void 0),R([z()],V.prototype,`_skipFinalColorClamp`,void 0),R([z()],V.prototype,`_applyByPostProcess`,void 0),R([z()],V.prototype,`_isEnabled`,void 0),B._ImageProcessingConfigurationParser=V.Parse,k.prototype.createUniformBuffer=function(e){let t=this._gl.createBuffer();if(!t)throw Error(`Unable to create uniform buffer`);let n=new De(t);return this.bindUniformBuffer(n),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),n.references=1,n},k.prototype.createDynamicUniformBuffer=function(e){let t=this._gl.createBuffer();if(!t)throw Error(`Unable to create dynamic uniform buffer`);let n=new De(t);return this.bindUniformBuffer(n),e instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,e,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(e),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),n.references=1,n},k.prototype.updateUniformBuffer=function(e,t,n,r){this.bindUniformBuffer(e),n===void 0&&(n=0),r===void 0?t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,n,t):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,n,new Float32Array(t)):t instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,t.subarray(n,n+r)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(t).subarray(n,n+r)),this.bindUniformBuffer(null)},k.prototype.bindUniformBuffer=function(e){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,e?e.underlyingResource:null)},k.prototype.bindUniformBufferBase=function(e,t,n){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,t,e?e.underlyingResource:null)},k.prototype.bindUniformBlock=function(e,t,n){let r=e.program,i=this._gl.getUniformBlockIndex(r,t);i!==4294967295&&this._gl.uniformBlockBinding(r,i,n)};var Kt=class e{constructor(e,t,n,r,i=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||i,this._dynamic=n,this._name=r??`no-name`,this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateUIntArray=this._updateUIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect,this.updateUInt=this._updateUIntForEffect,this.updateUInt2=this._updateUInt2ForEffect,this.updateUInt3=this._updateUInt3ForEffect,this.updateUInt4=this._updateUInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateUIntArray=this._updateUIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform,this.updateUInt=this._updateUIntForUniform,this.updateUInt2=this._updateUInt2ForUniform,this.updateUInt3=this._updateUInt3ForUniform,this.updateUInt4=this._updateUInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(t=e<=2?e:4,this._uniformLocationPointer%t!==0){let e=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;let n=this._uniformLocationPointer-e;for(let e=0;e<n;e++)this._data.push(0)}}addUniform(e,t,n=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let r;if(n>0){if(t instanceof Array)throw`addUniform should not be use with Array in UBO: `+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:n},t==16)t*=n;else{let e=(4-t)*n;t=t*n+e}r=[];for(let e=0;e<t;e++)r.push(0)}else{if(t instanceof Array)r=t,t=r.length;else{t=t,r=[];for(let e=0;e<t;e++)r.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let e=0;e<t;e++)this._data.push(r[e]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,n){let r=[t,n];this.addUniform(e,r)}addFloat3(e,t,n,r){let i=[t,n,r];this.addUniform(e,i)}addColor3(e,t){let n=[t.r,t.g,t.b];this.addUniform(e,n)}addColor4(e,t,n){let r=[t.r,t.g,t.b,n];this.addUniform(e,r)}addVector3(e,t){let n=[t.x,t.y,t.z];this.addUniform(e,n)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}get currentEffect(){return this._currentEffect}_buffersEqual(e,t){for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}_copyBuffer(e,t){for(let n=0;n<e.length;++n)t[n]=e[n]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(e._UpdatedUbosInFrame[this._name]||(e._UpdatedUbosInFrame[this._name]=0),e._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,n){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){if(this._buffer){f.Error(`Cannot add an uniform after UBO has been created.`);return}this.addUniform(e,n),r=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let e=0;e<n;e++)this._bufferData[r+e]=t[e];else{let e=!1;for(let i=0;i<n;i++)(n===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[r+i]!==A.FloatRound(t[i]))&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+i]=t[i]);this._needSync=this._needSync||e}}updateUniformArray(e,t,n){this._checkNewFrame();let r=this._uniformLocations[e];if(r===void 0){f.Error(`Cannot add an uniform Array dynamically. Please, add it using addUniform and make sure that uniform buffers are supported by the current engine.`);return}this._buffer||this.create();let i=this._uniformArraySizes[e];if(this._dynamic)for(let e=0;e<n;e++)this._bufferData[r+e]=t[e];else{let e=!1,a=0,o=0;for(let s=0;s<n;s++)if(this._bufferData[r+o*4+a]!==A.FloatRound(t[s])&&(e=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[r+o*4+a]=t[s]),a++,a===i.strideSize){for(;a<4;a++)this._bufferData[r+o*4+a]=0;a=0,o++}this._needSync=this._needSync||e}}_cacheMatrix(e,t){this._checkNewFrame();let n=this._valueCache[e],r=t.updateFlag;return n!==void 0&&n===r?!1:(this._valueCache[e]=r,!0)}_updateMatrix3x3ForUniform(t,n){for(let t=0;t<3;t++)e._TempBuffer[t*4]=n[t*3],e._TempBuffer[t*4+1]=n[t*3+1],e._TempBuffer[t*4+2]=n[t*3+2],e._TempBuffer[t*4+3]=0;this.updateUniform(t,e._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(t,n){for(let t=0;t<2;t++)e._TempBuffer[t*4]=n[t*2],e._TempBuffer[t*4+1]=n[t*2+1],e._TempBuffer[t*4+2]=0,e._TempBuffer[t*4+3]=0;this.updateUniform(t,e._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(t,n){e._TempBuffer[0]=n,this.updateUniform(t,e._TempBuffer,1)}_updateFloat2ForEffect(e,t,n,r=``){this._currentEffect.setFloat2(e+r,t,n)}_updateFloat2ForUniform(t,n,r){e._TempBuffer[0]=n,e._TempBuffer[1]=r,this.updateUniform(t,e._TempBuffer,2)}_updateFloat3ForEffect(e,t,n,r,i=``){this._currentEffect.setFloat3(e+i,t,n,r)}_updateFloat3ForUniform(t,n,r,i){e._TempBuffer[0]=n,e._TempBuffer[1]=r,e._TempBuffer[2]=i,this.updateUniform(t,e._TempBuffer,3)}_updateFloat4ForEffect(e,t,n,r,i,a=``){this._currentEffect.setFloat4(e+a,t,n,r,i)}_updateFloat4ForUniform(t,n,r,i,a){e._TempBuffer[0]=n,e._TempBuffer[1]=r,e._TempBuffer[2]=i,e._TempBuffer[3]=a,this.updateUniform(t,e._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(t,n){e._TempBufferInt32View.set(n),this.updateUniformArray(t,e._TempBuffer,n.length)}_updateUIntArrayForEffect(e,t){this._currentEffect.setUIntArray(e,t)}_updateUIntArrayForUniform(t,n){e._TempBufferUInt32View.set(n),this.updateUniformArray(t,e._TempBuffer,n.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(t,n){e._TempBuffer[0]=n.x,e._TempBuffer[1]=n.y,e._TempBuffer[2]=n.z,this.updateUniform(t,e._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(t,n){e._TempBuffer[0]=n.x,e._TempBuffer[1]=n.y,e._TempBuffer[2]=n.z,e._TempBuffer[3]=n.w,this.updateUniform(t,e._TempBuffer,4)}_updateColor3ForEffect(e,t,n=``){this._currentEffect.setColor3(e+n,t)}_updateColor3ForUniform(t,n){e._TempBuffer[0]=n.r,e._TempBuffer[1]=n.g,e._TempBuffer[2]=n.b,this.updateUniform(t,e._TempBuffer,3)}_updateColor4ForEffect(e,t,n,r=``){this._currentEffect.setColor4(e+r,t,n)}_updateDirectColor4ForEffect(e,t,n=``){this._currentEffect.setDirectColor4(e+n,t)}_updateColor4ForUniform(t,n,r){e._TempBuffer[0]=n.r,e._TempBuffer[1]=n.g,e._TempBuffer[2]=n.b,e._TempBuffer[3]=r,this.updateUniform(t,e._TempBuffer,4)}_updateDirectColor4ForUniform(t,n){e._TempBuffer[0]=n.r,e._TempBuffer[1]=n.g,e._TempBuffer[2]=n.b,e._TempBuffer[3]=n.a,this.updateUniform(t,e._TempBuffer,4)}_updateIntForEffect(e,t,n=``){this._currentEffect.setInt(e+n,t)}_updateIntForUniform(t,n){e._TempBufferInt32View[0]=n,this.updateUniform(t,e._TempBuffer,1)}_updateInt2ForEffect(e,t,n,r=``){this._currentEffect.setInt2(e+r,t,n)}_updateInt2ForUniform(t,n,r){e._TempBufferInt32View[0]=n,e._TempBufferInt32View[1]=r,this.updateUniform(t,e._TempBuffer,2)}_updateInt3ForEffect(e,t,n,r,i=``){this._currentEffect.setInt3(e+i,t,n,r)}_updateInt3ForUniform(t,n,r,i){e._TempBufferInt32View[0]=n,e._TempBufferInt32View[1]=r,e._TempBufferInt32View[2]=i,this.updateUniform(t,e._TempBuffer,3)}_updateInt4ForEffect(e,t,n,r,i,a=``){this._currentEffect.setInt4(e+a,t,n,r,i)}_updateInt4ForUniform(t,n,r,i,a){e._TempBufferInt32View[0]=n,e._TempBufferInt32View[1]=r,e._TempBufferInt32View[2]=i,e._TempBufferInt32View[3]=a,this.updateUniform(t,e._TempBuffer,4)}_updateUIntForEffect(e,t,n=``){this._currentEffect.setUInt(e+n,t)}_updateUIntForUniform(t,n){e._TempBufferUInt32View[0]=n,this.updateUniform(t,e._TempBuffer,1)}_updateUInt2ForEffect(e,t,n,r=``){this._currentEffect.setUInt2(e+r,t,n)}_updateUInt2ForUniform(t,n,r){e._TempBufferUInt32View[0]=n,e._TempBufferUInt32View[1]=r,this.updateUniform(t,e._TempBuffer,2)}_updateUInt3ForEffect(e,t,n,r,i=``){this._currentEffect.setUInt3(e+i,t,n,r)}_updateUInt3ForUniform(t,n,r,i){e._TempBufferUInt32View[0]=n,e._TempBufferUInt32View[1]=r,e._TempBufferUInt32View[2]=i,this.updateUniform(t,e._TempBuffer,3)}_updateUInt4ForEffect(e,t,n,r,i,a=``){this._currentEffect.setUInt4(e+a,t,n,r,i)}_updateUInt4ForUniform(t,n,r,i,a){e._TempBufferUInt32View[0]=n,e._TempBufferUInt32View[1]=r,e._TempBufferUInt32View[2]=i,e._TempBufferUInt32View[3]=a,this.updateUniform(t,e._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;let e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let e=0;e<this._buffers.length;++e){let t=this._buffers[e][0];this._engine._releaseBuffer(t)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}};Kt._UpdatedUbosInFrame={},Kt._MAX_UNIFORM_SIZE=256,Kt._TempBuffer=new Float32Array(Kt._MAX_UNIFORM_SIZE),Kt._TempBufferInt32View=new Int32Array(Kt._TempBuffer.buffer),Kt._TempBufferUInt32View=new Uint32Array(Kt._TempBuffer.buffer);var qt=class{constructor(e,t,n,r=0,i=!1,a=!1,o=!1,s){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=n,this._instanced=a,this._divisor=s||1,t instanceof Ee?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?r:r*Float32Array.BYTES_PER_ELEMENT,i||this.create()}createVertexBuffer(e,t,n,r,i,a=!1,o){let s=a?t:t*Float32Array.BYTES_PER_ELEMENT,c=r?a?r:r*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new H(this._engine,this,e,this._updatable,!0,c,i===void 0?this._instanced:i,s,n,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e||=this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,n,r=!1){this._buffer&&this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,r?t:t*Float32Array.BYTES_PER_ELEMENT,n?n*this.byteStride:void 0),t===0&&n===void 0?this._data=e:this._data=null)}_increaseReferences(){if(this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}},H=class e{get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){let t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}constructor(t,n,r,i,a,o,s,c,l,u,d=!1,f=!1,p=1,m=!1){if(n instanceof qt?(this._buffer=n,this._ownsBuffer=m):(this._buffer=new qt(t,n,i,o,a,s,f),this._ownsBuffer=!0),this.uniqueId=e._Counter++,this._kind=r,u==null){let t=this.getData();this.type=e.FLOAT,t instanceof Int8Array?this.type=e.BYTE:t instanceof Uint8Array?this.type=e.UNSIGNED_BYTE:t instanceof Int16Array?this.type=e.SHORT:t instanceof Uint16Array?this.type=e.UNSIGNED_SHORT:t instanceof Int32Array?this.type=e.INT:t instanceof Uint32Array&&(this.type=e.UNSIGNED_INT)}else this.type=u;let h=e.GetTypeByteLength(this.type);f?(this._size=l||(o?o/h:e.DeduceStride(r)),this.byteStride=o||this._buffer.byteStride||this._size*h,this.byteOffset=c||0):(this._size=l||o||e.DeduceStride(r),this.byteStride=o?o*h:this._buffer.byteStride||this._size*h,this.byteOffset=(c||0)*h),this.normalized=d,this._instanced=s===void 0?!1:s,this._instanceDivisor=s?p:0,this._computeHashCode()}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){this._buffer&&this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(t,n){let r=this.getData();if(!r)return null;let i=this.getSize()*e.GetTypeByteLength(this.type),a=t*this.getSize();if(this.type!==e.FLOAT||this.byteStride!==i){let e=new Float32Array(a);return this.forEach(a,(t,n)=>e[n]=t),e}if(!(r instanceof Array||r instanceof Float32Array)||this.byteOffset!==0||r.length!==a)if(r instanceof Array){let e=this.byteOffset/4;return r.slice(e,e+a)}else{if(r instanceof ArrayBuffer)return new Float32Array(r,this.byteOffset,a);{let e=r.byteOffset+this.byteOffset;if(n){let t=new Float32Array(a),n=new Float32Array(r.buffer,e,a);return t.set(n),t}let t=e%4;return t&&(e=Math.max(0,e-t)),new Float32Array(r.buffer,e,a)}}return n?r.slice():r}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/e.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/e.GetTypeByteLength(this.type)}getSize(t=!1){return t?this._size*e.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,t,n=!1){this._buffer.updateDirectly(e,t,void 0,n)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(t,n){e.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,t,this.normalized,n)}static DeduceStride(t){switch(t){case e.UVKind:case e.UV2Kind:case e.UV3Kind:case e.UV4Kind:case e.UV5Kind:case e.UV6Kind:return 2;case e.NormalKind:case e.PositionKind:return 3;case e.ColorKind:case e.MatricesIndicesKind:case e.MatricesIndicesExtraKind:case e.MatricesWeightsKind:case e.MatricesWeightsExtraKind:case e.TangentKind:return 4;default:throw Error(`Invalid kind '`+t+`'`)}}static GetTypeByteLength(t){switch(t){case e.BYTE:case e.UNSIGNED_BYTE:return 1;case e.SHORT:case e.UNSIGNED_SHORT:return 2;case e.INT:case e.UNSIGNED_INT:case e.FLOAT:return 4;default:throw Error(`Invalid type '${t}'`)}}static ForEach(t,n,r,i,a,o,s,c){if(t instanceof Array){let e=n/4,a=r/4;for(let n=0;n<o;n+=i){for(let r=0;r<i;r++)c(t[e+r],n+r);e+=a}}else{let l=t instanceof ArrayBuffer?new DataView(t):new DataView(t.buffer,t.byteOffset,t.byteLength),u=e.GetTypeByteLength(a);for(let t=0;t<o;t+=i){let o=n;for(let n=0;n<i;n++)c(e._GetFloatValue(l,a,o,s),t+n),o+=u;n+=r}}}static _GetFloatValue(t,n,r,i){switch(n){case e.BYTE:{let e=t.getInt8(r);return i&&(e=Math.max(e/127,-1)),e}case e.UNSIGNED_BYTE:{let e=t.getUint8(r);return i&&(e/=255),e}case e.SHORT:{let e=t.getInt16(r,!0);return i&&(e=Math.max(e/32767,-1)),e}case e.UNSIGNED_SHORT:{let e=t.getUint16(r,!0);return i&&(e/=65535),e}case e.INT:return t.getInt32(r,!0);case e.UNSIGNED_INT:return t.getUint32(r,!0);case e.FLOAT:return t.getFloat32(r,!0);default:throw Error(`Invalid component type ${n}`)}}};H._Counter=0,H.BYTE=5120,H.UNSIGNED_BYTE=5121,H.SHORT=5122,H.UNSIGNED_SHORT=5123,H.INT=5124,H.UNSIGNED_INT=5125,H.FLOAT=5126,H.PositionKind=`position`,H.NormalKind=`normal`,H.TangentKind=`tangent`,H.UVKind=`uv`,H.UV2Kind=`uv2`,H.UV3Kind=`uv3`,H.UV4Kind=`uv4`,H.UV5Kind=`uv5`,H.UV6Kind=`uv6`,H.ColorKind=`color`,H.ColorInstanceKind=`instanceColor`,H.MatricesIndicesKind=`matricesIndices`,H.MatricesWeightsKind=`matricesWeights`,H.MatricesIndicesExtraKind=`matricesIndicesExtra`,H.MatricesWeightsExtraKind=`matricesWeightsExtra`;var Jt=class{constructor(){this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||t&&!this.pickedMesh.isVerticesDataPresent(H.NormalKind))return null;let n=this.pickedMesh.getIndices();if(!n)return null;let r;if(t){let e=this.pickedMesh.getVerticesData(H.NormalKind),t=N.FromArray(e,n[this.faceId*3]*3),i=N.FromArray(e,n[this.faceId*3+1]*3),a=N.FromArray(e,n[this.faceId*3+2]*3);t=t.scale(this.bu),i=i.scale(this.bv),a=a.scale(1-this.bu-this.bv),r=new N(t.x+i.x+a.x,t.y+i.y+a.y,t.z+i.z+a.z)}else{let e=this.pickedMesh.getVerticesData(H.PositionKind),t=N.FromArray(e,n[this.faceId*3]*3),i=N.FromArray(e,n[this.faceId*3+1]*3),a=N.FromArray(e,n[this.faceId*3+2]*3),o=t.subtract(i),s=a.subtract(i);r=N.Cross(o,s)}let i=(e,t)=>{let n=e.getWorldMatrix();e.nonUniformScaling&&(L.Matrix[0].copyFrom(n),n=L.Matrix[0],n.setTranslationFromFloats(0,0,0),n.invert(),n.transposeToRef(L.Matrix[1]),n=L.Matrix[1]),N.TransformNormalToRef(t,n,t)};if(e&&i(this.pickedMesh,r),this.ray){let t=L.Vector3[0].copyFrom(r);e||i(this.pickedMesh,t),N.Dot(t,this.ray.direction)>0&&r.negateInPlace()}return r.normalize(),r}getTextureCoordinates(e=H.UVKind){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(e))return null;let t=this.pickedMesh.getIndices();if(!t)return null;let n=this.pickedMesh.getVerticesData(e);if(!n)return null;let r=gt.FromArray(n,t[this.faceId*3]*2),i=gt.FromArray(n,t[this.faceId*3+1]*2),a=gt.FromArray(n,t[this.faceId*3+2]*2);return r=r.scale(this.bu),i=i.scale(this.bv),a=a.scale(1-this.bu-this.bv),new gt(r.x+i.x+a.x,r.y+i.y+a.y)}},Yt=class e{constructor(e,t,n,r,i,a){this.source=e,this.pointerX=t,this.pointerY=n,this.meshUnderPointer=r,this.sourceEvent=i,this.additionalData=a}static CreateNew(t,n,r){let i=t.getScene();return new e(t,i.pointerX,i.pointerY,i.meshUnderPointer||t,n,r)}static CreateNewFromSprite(t,n,r,i){return new e(t,n.pointerX,n.pointerY,n.meshUnderPointer,r,i)}static CreateNewFromScene(t,n){return new e(null,t.pointerX,t.pointerY,t.meshUnderPointer,n)}static CreateNewFromPrimitive(t,n,r,i){return new e(t,n.x,n.y,null,r,i)}},Xt=class{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[H.PositionKind])return;let e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[H.PositionKind]=new H(this._scene.getEngine(),e,H.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){let e=this._vertexBuffers[H.PositionKind];e&&(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){let n=this._scene.activeCamera;return!n||(t||=n._postProcesses.filter(e=>e!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(n,e,t!=null),!0)}directRender(e,t=null,n=!1,r=0,i=0,a=!1){var o;let s=this._scene.getEngine();for(let c=0;c<e.length;c++){c<e.length-1?e[c+1].activate(this._scene.activeCamera,t?.texture):(t?s.bindFramebuffer(t,r,void 0,void 0,n,i):a||s.restoreDefaultFramebuffer(),(o=s._debugInsertMarker)==null||o.call(s,`post process ${e[c].name} output`));let l=e[c],u=l.apply();u&&(l.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),s.bindBuffers(this._vertexBuffers,this._indexBuffer,u),s.drawElementsType(0,0,6),l.onAfterRenderObservable.notifyObservers(u))}s.setDepthBuffer(!0),s.setDepthWrite(!0)}_finalizeFrame(e,t,n,r,i=!1){var a;let o=this._scene.activeCamera;if(!o||(r||=o._postProcesses.filter(e=>e!=null),r.length===0||!this._scene.postProcessesEnabled))return;let s=this._scene.getEngine();for(let c=0,l=r.length;c<l;c++){let u=r[c];if(c<l-1?u._outputTexture=r[c+1].activate(o,t?.texture):(t?(s.bindFramebuffer(t,n,void 0,void 0,i),u._outputTexture=t):(s.restoreDefaultFramebuffer(),u._outputTexture=null),(a=s._debugInsertMarker)==null||a.call(s,`post process ${r[c].name} output`)),e)break;let d=u.apply();d&&(u.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),s.bindBuffers(this._vertexBuffers,this._indexBuffer,d),s.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(d))}s.setDepthBuffer(!0),s.setDepthWrite(!0),s.setAlphaMode(0)}dispose(){let e=this._vertexBuffers[H.PositionKind];e&&(e.dispose(),this._vertexBuffers[H.PositionKind]=null),this._indexBuffer&&=(this._scene.getEngine()._releaseBuffer(this._indexBuffer),null)}},Zt=class e{set opaqueSortCompareFn(t){t?this._opaqueSortCompareFn=t:this._opaqueSortCompareFn=e.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(t){t?this._alphaTestSortCompareFn=t:this._alphaTestSortCompareFn=e.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(t){t?this._transparentSortCompareFn=t:this._transparentSortCompareFn=e.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}constructor(e,t,n=null,r=null,i=null){this.index=e,this._opaqueSubMeshes=new it(256),this._transparentSubMeshes=new it(256),this._alphaTestSubMeshes=new it(256),this._depthOnlySubMeshes=new it(256),this._particleSystems=new it(256),this._spriteManagers=new it(256),this._empty=!0,this._edgesRenderers=new at(16),this._scene=t,this.opaqueSortCompareFn=n,this.alphaTestSortCompareFn=r,this.transparentSortCompareFn=i}render(e,t,n,r){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}let i=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(i.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),i.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);let a=i.getStencilBuffer();if(i.setStencilBuffer(!1),t&&this._renderSprites(),n&&this._renderParticles(r),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(i.setStencilBuffer(a),this._scene.useOrderIndependentTransparency){let e=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);e.length&&this._renderTransparent(e)}else this._renderTransparent(this._transparentSubMeshes);i.setAlphaMode(0)}if(i.setStencilBuffer(!1),this._edgesRenderers.length){for(let e=0;e<this._edgesRenderers.length;e++)this._edgesRenderers.data[e].render();i.setAlphaMode(0)}i.setStencilBuffer(a)}_renderOpaqueSorted(t){return e._RenderSorted(t,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(t){return e._RenderSorted(t,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(t){return e._RenderSorted(t,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(t,n,r,i){let a=0,o,s=r?r.globalPosition:e._ZeroVector;if(i)for(;a<t.length;a++)o=t.data[a],o._alphaIndex=o.getMesh().alphaIndex,o._distanceToCamera=N.Distance(o.getBoundingInfo().boundingSphere.centerWorld,s);let c=t.length===t.data.length?t.data:t.data.slice(0,t.length);n&&c.sort(n);let l=c[0].getMesh().getScene();for(a=0;a<c.length;a++)if(o=c[a],!(l._activeMeshesFrozenButKeepClipping&&!o.isInFrustum(l._frustumPlanes))){if(i){let e=o.getMaterial();if(e&&e.needDepthPrePass){let t=e.getScene().getEngine();t.setColorWrite(!1),t.setAlphaMode(0),o.render(!1),t.setColorWrite(!0)}}o.render(i)}}static defaultTransparentSortCompare(t,n){return t._alphaIndex>n._alphaIndex?1:t._alphaIndex<n._alphaIndex?-1:e.backToFrontSortCompare(t,n)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){let n=e.getMesh(),r=t.getMesh();return n.material&&r.material?n.material.uniqueId-r.material.uniqueId:n.uniqueId-r.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this.prepareSprites(),this._edgesRenderers.reset(),this._empty=!0}prepareSprites(){this._spriteManagers.reset()}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,n){t===void 0&&(t=e.getMesh()),n===void 0&&(n=e.getMaterial()),n!=null&&(n.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):n.needAlphaTesting()?(n.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(n.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;let t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let n=0;n<this._particleSystems.length;n++){let r=this._particleSystems.data[n];if((t&&t.layerMask&r.layerMask)===0)continue;let i=r.emitter;(!i.position||!e||e.indexOf(i)!==-1)&&this._scene._activeParticles.addCount(r.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;let e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){let n=this._spriteManagers.data[t];(e&&e.layerMask&n.layerMask)!==0&&n.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}};Zt._ZeroVector=N.Zero();var Qt=class{},$t=class e{get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(let e of this._scene.meshes)if(e.subMeshes)for(let t of e.subMeshes)t._wasDispatched=!1;if(this._scene.spriteManagers)for(let e of this._scene.spriteManagers)e._wasDispatched=!1;for(let e of this._scene.particleSystems)e._wasDispatched=!1}}constructor(t){this._useSceneAutoClearSetup=!1,this._renderingGroups=[],this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new Qt,this._maintainStateBetweenFrames=!1,this._scene=t;for(let t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}getRenderingGroup(e){let t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||=(this._scene.getEngine().clear(null,!1,e,t),!0)}render(t,n,r,i){let a=this._renderingGroupInfo;if(a.scene=this._scene,a.camera=this._scene.activeCamera,this._scene.spriteManagers&&i)for(let e=0;e<this._scene.spriteManagers.length;e++){let t=this._scene.spriteManagers[e];this.dispatchSprites(t)}for(let o=e.MIN_RENDERINGGROUPS;o<e.MAX_RENDERINGGROUPS;o++){this._depthStencilBufferAlreadyCleaned=o===e.MIN_RENDERINGGROUPS;let s=this._renderingGroups[o];if(!s||s._empty)continue;let c=2**o;if(a.renderingGroupId=o,this._scene.onBeforeRenderingGroupObservable.notifyObservers(a,c),e.AUTOCLEAR){let e=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(o):this._autoClearDepthStencil[o];e&&e.autoClear&&this._clearDepthStencilBuffer(e.depth,e.stencil)}for(let e of this._scene._beforeRenderingGroupDrawStage)e.action(o);s.render(t,i,r,n);for(let e of this._scene._afterRenderingGroupDrawStage)e.action(o);this._scene.onAfterRenderingGroupObservable.notifyObservers(a,c)}}reset(){if(!this.maintainStateBetweenFrames)for(let t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){let e=this._renderingGroups[t];e&&e.prepare()}}resetSprites(){if(!this.maintainStateBetweenFrames)for(let t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){let e=this._renderingGroups[t];e&&e.prepareSprites()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let t=e.MIN_RENDERINGGROUPS;t<e.MAX_RENDERINGGROUPS;t++){let e=this._renderingGroups[t];e&&e.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Zt(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,n){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,n))}setRenderingOrder(e,t=null,n=null,r=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=n,this._customTransparentSortCompareFn[e]=r,this._renderingGroups[e]){let t=this._renderingGroups[e];t.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],t.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],t.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,n=!0,r=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:n,stencil:r}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}};$t.MAX_RENDERINGGROUPS=4,$t.MIN_RENDERINGGROUPS=0,$t.AUTOCLEAR=!0;var U=class{};U.NAME_EFFECTLAYER=`EffectLayer`,U.NAME_LAYER=`Layer`,U.NAME_LENSFLARESYSTEM=`LensFlareSystem`,U.NAME_BOUNDINGBOXRENDERER=`BoundingBoxRenderer`,U.NAME_PARTICLESYSTEM=`ParticleSystem`,U.NAME_GAMEPAD=`Gamepad`,U.NAME_SIMPLIFICATIONQUEUE=`SimplificationQueue`,U.NAME_GEOMETRYBUFFERRENDERER=`GeometryBufferRenderer`,U.NAME_PREPASSRENDERER=`PrePassRenderer`,U.NAME_DEPTHRENDERER=`DepthRenderer`,U.NAME_DEPTHPEELINGRENDERER=`DepthPeelingRenderer`,U.NAME_POSTPROCESSRENDERPIPELINEMANAGER=`PostProcessRenderPipelineManager`,U.NAME_SPRITE=`Sprite`,U.NAME_SUBSURFACE=`SubSurface`,U.NAME_OUTLINERENDERER=`Outline`,U.NAME_PROCEDURALTEXTURE=`ProceduralTexture`,U.NAME_SHADOWGENERATOR=`ShadowGenerator`,U.NAME_OCTREE=`Octree`,U.NAME_PHYSICSENGINE=`PhysicsEngine`,U.NAME_AUDIO=`Audio`,U.NAME_FLUIDRENDERER=`FluidRenderer`,U.STEP_ISREADYFORMESH_EFFECTLAYER=0,U.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0,U.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0,U.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0,U.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1,U.STEP_BEFORECAMERADRAW_PREPASS=0,U.STEP_BEFORECAMERADRAW_EFFECTLAYER=1,U.STEP_BEFORECAMERADRAW_LAYER=2,U.STEP_BEFORERENDERTARGETDRAW_PREPASS=0,U.STEP_BEFORERENDERTARGETDRAW_LAYER=1,U.STEP_BEFORERENDERINGMESH_PREPASS=0,U.STEP_BEFORERENDERINGMESH_OUTLINE=1,U.STEP_AFTERRENDERINGMESH_PREPASS=0,U.STEP_AFTERRENDERINGMESH_OUTLINE=1,U.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0,U.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1,U.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0,U.STEP_BEFORECAMERAUPDATE_GAMEPAD=1,U.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0,U.STEP_BEFORECLEAR_PREPASS=1,U.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0,U.STEP_AFTERRENDERTARGETDRAW_PREPASS=0,U.STEP_AFTERRENDERTARGETDRAW_LAYER=1,U.STEP_AFTERCAMERADRAW_PREPASS=0,U.STEP_AFTERCAMERADRAW_EFFECTLAYER=1,U.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2,U.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3,U.STEP_AFTERCAMERADRAW_LAYER=4,U.STEP_AFTERCAMERADRAW_FLUIDRENDERER=5,U.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0,U.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0,U.STEP_AFTERRENDER_AUDIO=0,U.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0,U.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1,U.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2,U.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3,U.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0,U.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER=1,U.STEP_POINTERMOVE_SPRITE=0,U.STEP_POINTERDOWN_SPRITE=0,U.STEP_POINTERUP_SPRITE=0;var en=class e extends Array{constructor(e){super(...e)}static Create(){return Object.create(e.prototype)}registerStep(e,t,n){let r=0,i=Number.MAX_VALUE;for(;r<this.length&&(i=this[r].index,!(e<i));r++);this.splice(r,0,{index:e,component:t,action:n.bind(t)})}clear(){this.length=0}},W=class{};W.POINTERDOWN=1,W.POINTERUP=2,W.POINTERMOVE=4,W.POINTERWHEEL=8,W.POINTERPICK=16,W.POINTERTAP=32,W.POINTERDOUBLETAP=64;var tn=class{constructor(e,t){this.type=e,this.event=t}},nn=class extends tn{constructor(e,t,n,r){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new gt(n,r)}},rn=class extends tn{get pickInfo(){return this._pickInfo||this._generatePickInfo(),this._pickInfo}constructor(e,t,n,r=null){super(e,t),this._pickInfo=n,this._inputManager=r}_generatePickInfo(){this._inputManager&&=(this._pickInfo=this._inputManager._pickMove(this.event),this._inputManager._setRayOnPointerInfo(this._pickInfo,this.event),null)}},an=class e{constructor(){this.hoverCursor=``,this.actions=[],this.isRecursive=!1}static get HasTriggers(){for(let t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t))return!0;return!1}static get HasPickTriggers(){for(let t in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,t)){let e=parseInt(t);if(e>=1&&e<=7)return!0}return!1}static HasSpecificTrigger(t){for(let n in e.Triggers)if(Object.prototype.hasOwnProperty.call(e.Triggers,n)&&parseInt(n)===t)return!0;return!1}};an.Triggers={};var on=class{};on.KEYDOWN=1,on.KEYUP=2;var sn=class{constructor(e,t){this.type=e,this.event=t}},cn=class extends sn{get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}},G;(function(e){e[e.Generic=0]=`Generic`,e[e.Keyboard=1]=`Keyboard`,e[e.Mouse=2]=`Mouse`,e[e.Touch=3]=`Touch`,e[e.DualShock=4]=`DualShock`,e[e.Xbox=5]=`Xbox`,e[e.Switch=6]=`Switch`,e[e.DualSense=7]=`DualSense`})(G||={});var K;(function(e){e[e.Horizontal=0]=`Horizontal`,e[e.Vertical=1]=`Vertical`,e[e.LeftClick=2]=`LeftClick`,e[e.MiddleClick=3]=`MiddleClick`,e[e.RightClick=4]=`RightClick`,e[e.BrowserBack=5]=`BrowserBack`,e[e.BrowserForward=6]=`BrowserForward`,e[e.MouseWheelX=7]=`MouseWheelX`,e[e.MouseWheelY=8]=`MouseWheelY`,e[e.MouseWheelZ=9]=`MouseWheelZ`,e[e.Move=12]=`Move`})(K||={});var ln;(function(e){e[e.Horizontal=0]=`Horizontal`,e[e.Vertical=1]=`Vertical`,e[e.LeftClick=2]=`LeftClick`,e[e.MiddleClick=3]=`MiddleClick`,e[e.RightClick=4]=`RightClick`,e[e.BrowserBack=5]=`BrowserBack`,e[e.BrowserForward=6]=`BrowserForward`,e[e.MouseWheelX=7]=`MouseWheelX`,e[e.MouseWheelY=8]=`MouseWheelY`,e[e.MouseWheelZ=9]=`MouseWheelZ`,e[e.DeltaHorizontal=10]=`DeltaHorizontal`,e[e.DeltaVertical=11]=`DeltaVertical`})(ln||={});var un;(function(e){e[e.Cross=0]=`Cross`,e[e.Circle=1]=`Circle`,e[e.Square=2]=`Square`,e[e.Triangle=3]=`Triangle`,e[e.L1=4]=`L1`,e[e.R1=5]=`R1`,e[e.L2=6]=`L2`,e[e.R2=7]=`R2`,e[e.Share=8]=`Share`,e[e.Options=9]=`Options`,e[e.L3=10]=`L3`,e[e.R3=11]=`R3`,e[e.DPadUp=12]=`DPadUp`,e[e.DPadDown=13]=`DPadDown`,e[e.DPadLeft=14]=`DPadLeft`,e[e.DPadRight=15]=`DPadRight`,e[e.Home=16]=`Home`,e[e.TouchPad=17]=`TouchPad`,e[e.LStickXAxis=18]=`LStickXAxis`,e[e.LStickYAxis=19]=`LStickYAxis`,e[e.RStickXAxis=20]=`RStickXAxis`,e[e.RStickYAxis=21]=`RStickYAxis`})(un||={});var dn;(function(e){e[e.Cross=0]=`Cross`,e[e.Circle=1]=`Circle`,e[e.Square=2]=`Square`,e[e.Triangle=3]=`Triangle`,e[e.L1=4]=`L1`,e[e.R1=5]=`R1`,e[e.L2=6]=`L2`,e[e.R2=7]=`R2`,e[e.Create=8]=`Create`,e[e.Options=9]=`Options`,e[e.L3=10]=`L3`,e[e.R3=11]=`R3`,e[e.DPadUp=12]=`DPadUp`,e[e.DPadDown=13]=`DPadDown`,e[e.DPadLeft=14]=`DPadLeft`,e[e.DPadRight=15]=`DPadRight`,e[e.Home=16]=`Home`,e[e.TouchPad=17]=`TouchPad`,e[e.LStickXAxis=18]=`LStickXAxis`,e[e.LStickYAxis=19]=`LStickYAxis`,e[e.RStickXAxis=20]=`RStickXAxis`,e[e.RStickYAxis=21]=`RStickYAxis`})(dn||={});var fn;(function(e){e[e.A=0]=`A`,e[e.B=1]=`B`,e[e.X=2]=`X`,e[e.Y=3]=`Y`,e[e.LB=4]=`LB`,e[e.RB=5]=`RB`,e[e.LT=6]=`LT`,e[e.RT=7]=`RT`,e[e.Back=8]=`Back`,e[e.Start=9]=`Start`,e[e.LS=10]=`LS`,e[e.RS=11]=`RS`,e[e.DPadUp=12]=`DPadUp`,e[e.DPadDown=13]=`DPadDown`,e[e.DPadLeft=14]=`DPadLeft`,e[e.DPadRight=15]=`DPadRight`,e[e.Home=16]=`Home`,e[e.LStickXAxis=17]=`LStickXAxis`,e[e.LStickYAxis=18]=`LStickYAxis`,e[e.RStickXAxis=19]=`RStickXAxis`,e[e.RStickYAxis=20]=`RStickYAxis`})(fn||={});var pn;(function(e){e[e.B=0]=`B`,e[e.A=1]=`A`,e[e.Y=2]=`Y`,e[e.X=3]=`X`,e[e.L=4]=`L`,e[e.R=5]=`R`,e[e.ZL=6]=`ZL`,e[e.ZR=7]=`ZR`,e[e.Minus=8]=`Minus`,e[e.Plus=9]=`Plus`,e[e.LS=10]=`LS`,e[e.RS=11]=`RS`,e[e.DPadUp=12]=`DPadUp`,e[e.DPadDown=13]=`DPadDown`,e[e.DPadLeft=14]=`DPadLeft`,e[e.DPadRight=15]=`DPadRight`,e[e.Home=16]=`Home`,e[e.Capture=17]=`Capture`,e[e.LStickXAxis=18]=`LStickXAxis`,e[e.LStickYAxis=19]=`LStickYAxis`,e[e.RStickXAxis=20]=`RStickXAxis`,e[e.RStickYAxis=21]=`RStickYAxis`})(pn||={});var mn;(function(e){e[e.PointerMove=0]=`PointerMove`,e[e.PointerDown=1]=`PointerDown`,e[e.PointerUp=2]=`PointerUp`})(mn||={});var hn=class{};hn.DOM_DELTA_PIXEL=0,hn.DOM_DELTA_LINE=1,hn.DOM_DELTA_PAGE=2;var gn=class{static CreateDeviceEvent(e,t,n,r,i,a,o){switch(e){case G.Keyboard:return this._CreateKeyboardEvent(n,r,i,a);case G.Mouse:if(n===K.MouseWheelX||n===K.MouseWheelY||n===K.MouseWheelZ)return this._CreateWheelEvent(e,t,n,r,i,a);case G.Touch:return this._CreatePointerEvent(e,t,n,r,i,a,o);default:throw`Unable to generate event for device ${G[e]}`}}static _CreatePointerEvent(e,t,n,r,i,a,o){let s=this._CreateMouseEvent(e,t,n,r,i,a);return e===G.Mouse?(s.deviceType=G.Mouse,s.pointerId=1,s.pointerType=`mouse`):(s.deviceType=G.Touch,s.pointerId=o??t,s.pointerType=`touch`),n===K.Move?s.type=`pointermove`:n>=K.LeftClick&&n<=K.RightClick&&(s.type=r===1?`pointerdown`:`pointerup`,s.button=n-2),s}static _CreateWheelEvent(e,t,n,r,i,a){let o=this._CreateMouseEvent(e,t,n,r,i,a);switch(o.pointerId=1,o.type=`wheel`,o.deltaMode=hn.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,n){case K.MouseWheelX:o.deltaX=r;break;case K.MouseWheelY:o.deltaY=r;break;case K.MouseWheelZ:o.deltaZ=r;break}return o}static _CreateMouseEvent(e,t,n,r,i,a){let o=this._CreateEvent(a),s=i.pollInput(e,t,K.Horizontal),c=i.pollInput(e,t,K.Vertical);return a?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-a.getBoundingClientRect().x,o.offsetY=o.movementY-a.getBoundingClientRect().y):(o.movementX=i.pollInput(e,t,ln.DeltaHorizontal),o.movementY=i.pollInput(e,t,ln.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,i),o.clientX=s,o.clientY=c,o.x=s,o.y=c,o.deviceType=e,o.deviceSlot=t,o.inputIndex=n,o}static _CreateKeyboardEvent(e,t,n,r){let i=this._CreateEvent(r);return this._CheckNonCharacterKeys(i,n),i.deviceType=G.Keyboard,i.deviceSlot=0,i.inputIndex=e,i.type=t===1?`keydown`:`keyup`,i.key=String.fromCharCode(e),i.keyCode=e,i}static _CheckNonCharacterKeys(e,t){let n=t.isDeviceAvailable(G.Keyboard),r=n&&t.pollInput(G.Keyboard,0,18)===1,i=n&&t.pollInput(G.Keyboard,0,17)===1,a=n&&(t.pollInput(G.Keyboard,0,91)===1||t.pollInput(G.Keyboard,0,92)===1||t.pollInput(G.Keyboard,0,93)===1),o=n&&t.pollInput(G.Keyboard,0,16)===1;e.altKey=r,e.ctrlKey=i,e.metaKey=a,e.shiftKey=o}static _CreateEvent(e){let t={};return t.preventDefault=()=>{},t.target=e,t}},_n=class{constructor(e,t,n){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(e,t,r,i)=>{n(e,t,gn.CreateDeviceEvent(e,t,r,i,this))}):this._createDummyNativeInput()}pollInput(e,t,n){return this._nativeInput.pollInput(e,t,n)}isDeviceAvailable(e){return e===G.Mouse||e===G.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}},vn=255,yn=Object.keys(K).length/2,bn=class{constructor(e,t,n,r){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=A.IsSafari(),this._usingMacOS=c()&&/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=e=>{},this._keyboardUpEvent=e=>{},this._keyboardBlurEvent=e=>{},this._pointerMoveEvent=e=>{},this._pointerDownEvent=e=>{},this._pointerUpEvent=e=>{},this._pointerCancelEvent=e=>{},this._pointerWheelEvent=e=>{},this._pointerBlurEvent=e=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=d.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf(`Firefox`)!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=e=>{},this._gamepadDisconnectedEvent=e=>{},this._eventPrefix=A.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=n,this._onInputChanged=r,this._mouseId=this._isUsingFirefox?0:1,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,n){let r=this._inputs[e][t];if(!r)throw`Unable to find device ${G[e]}`;e>=G.DualShock&&e<=G.DualSense&&this._updateDevice(e,t,n);let i=r[n];if(i===void 0)throw`Unable to find input ${n} for device ${G[e]} in slot ${t}`;return n===K.Move&&A.Warn(`Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data.`),i}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){let e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(let e of this._inputs)if(e)for(let t in e){let n=e[+t];if(n)for(let e=0;e<n.length;e++)n[e]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex===-1?this._engine.canvasTabIndex:this._elementToAttachTo.tabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener(`blur`,this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener(`blur`,this._pointerBlurEvent),this._elementToAttachTo.removeEventListener(`keydown`,this._keyboardDownEvent),this._elementToAttachTo.removeEventListener(`keyup`,this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+`move`,this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+`down`,this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+`up`,this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+`cancel`,this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener(`gamepadconnected`,this._gamepadConnectedEvent),window.removeEventListener(`gamepaddisconnected`,this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){let e=navigator.getGamepads();for(let t of e)t&&this._addGamePad(t)}typeof matchMedia==`function`&&matchMedia(`(pointer:fine)`).matches&&this._addPointerDevice(G.Mouse,0,0,0)}_addGamePad(e){let t=this._getGamepadDeviceType(e.id),n=e.index;this._gamepads=this._gamepads||Array(e.index+1),this._registerDevice(t,n,e.buttons.length+e.axes.length),this._gamepads[n]=t}_addPointerDevice(e,t,n,r){this._pointerActive||=!0,this._registerDevice(e,t,yn);let i=this._inputs[e][t];i[0]=n,i[1]=r}_registerDevice(e,t,n){if(t===void 0)throw`Unable to register device ${G[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){let r=Array(n);r.fill(0),this._inputs[e][t]=r,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(G.Keyboard,0,vn));let t=this._inputs[G.Keyboard][0];if(t){t[e.keyCode]=1;let n=e;n.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!==`Meta`&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(G.Keyboard,0,n)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(G.Keyboard,0,vn));let t=this._inputs[G.Keyboard][0];if(t){t[e.keyCode]=0;let n=e;if(n.inputIndex=e.keyCode,this._usingMacOS&&e.key===`Meta`&&this._metaKeys.length>0){for(let e of this._metaKeys){let n=gn.CreateDeviceEvent(G.Keyboard,0,e,0,this,this._elementToAttachTo);t[e]=0,this._onInputChanged(G.Keyboard,0,n)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(G.Keyboard,0,n)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){let e=this._inputs[G.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;let n=gn.CreateDeviceEvent(G.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(G.Keyboard,0,n)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener(`keydown`,this._keyboardDownEvent),this._elementToAttachTo.addEventListener(`keyup`,this._keyboardUpEvent),this._elementToAttachTo.addEventListener(`blur`,this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=d.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||=Array(this._maxTouchPoints);for(let e=0;e<this._maxTouchPoints;e++)this._activeTouchIds[e]=-1;this._pointerMoveEvent=e=>{let t=this._getPointerType(e),n=t===G.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);this._inputs[t]||(this._inputs[t]={}),this._inputs[t][n]||this._addPointerDevice(t,n,e.clientX,e.clientY);let r=this._inputs[t][n];if(r){let i=e;i.inputIndex=K.Move,r[K.Horizontal]=e.clientX,r[K.Vertical]=e.clientY,e.pointerId===void 0&&(e.pointerId=this._mouseId),this._onInputChanged(t,n,i),!this._usingSafari&&e.button!==-1&&(i.inputIndex=e.button+2,r[e.button+2]=r[e.button+2]?0:1,this._onInputChanged(t,n,i))}},this._pointerDownEvent=e=>{let t=this._getPointerType(e),n=t===G.Mouse?0:e.pointerId;if(t===G.Touch){let t=this._activeTouchIds.indexOf(-1);if(t>=0)n=t,this._activeTouchIds[t]=e.pointerId;else{A.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[t]||(this._inputs[t]={}),this._inputs[t][n]?t===G.Touch&&this._onDeviceConnected(t,n):this._addPointerDevice(t,n,e.clientX,e.clientY);let r=this._inputs[t][n];if(r){let i=r[K.Horizontal],a=r[K.Vertical];if(t===G.Mouse){if(e.pointerId===void 0&&(e.pointerId=this._mouseId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(e.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(e.pointerId)}catch{}r[K.Horizontal]=e.clientX,r[K.Vertical]=e.clientY,r[e.button+2]=1;let o=e;o.inputIndex=e.button+2,this._onInputChanged(t,n,o),(i!==e.clientX||a!==e.clientY)&&(o.inputIndex=K.Move,this._onInputChanged(t,n,o))}},this._pointerUpEvent=e=>{var t,n,r,i;let a=this._getPointerType(e),o=a===G.Mouse?0:this._activeTouchIds.indexOf(e.pointerId);if(a===G.Touch){if(o===-1)return;this._activeTouchIds[o]=-1}let s=this._inputs[a]?.[o];if(s&&s[e.button+2]!==0){let c=s[K.Horizontal],l=s[K.Vertical];s[K.Horizontal]=e.clientX,s[K.Vertical]=e.clientY,s[e.button+2]=0;let u=e;e.pointerId===void 0&&(e.pointerId=this._mouseId),(c!==e.clientX||l!==e.clientY)&&(u.inputIndex=K.Move,this._onInputChanged(a,o,u)),u.inputIndex=e.button+2,a===G.Mouse&&this._mouseId>=0&&(n=(t=this._elementToAttachTo).hasPointerCapture)!=null&&n.call(t,this._mouseId)?this._elementToAttachTo.releasePointerCapture(this._mouseId):e.pointerId&&(i=(r=this._elementToAttachTo).hasPointerCapture)!=null&&i.call(r,e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._onInputChanged(a,o,u),a===G.Touch&&this._onDeviceDisconnected(a,o)}},this._pointerCancelEvent=e=>{var t,n,r,i;if(e.pointerType===`mouse`){let e=this._inputs[G.Mouse][0];this._mouseId>=0&&(n=(t=this._elementToAttachTo).hasPointerCapture)!=null&&n.call(t,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let t=K.LeftClick;t<=K.BrowserForward;t++)if(e[t]===1){e[t]=0;let n=gn.CreateDeviceEvent(G.Mouse,0,t,0,this,this._elementToAttachTo);this._onInputChanged(G.Mouse,0,n)}}else{let t=this._activeTouchIds.indexOf(e.pointerId);(i=(r=this._elementToAttachTo).hasPointerCapture)!=null&&i.call(r,e.pointerId)&&this._elementToAttachTo.releasePointerCapture(e.pointerId),this._inputs[G.Touch][t][K.LeftClick]=0;let n=gn.CreateDeviceEvent(G.Touch,t,K.LeftClick,0,this,this._elementToAttachTo,e.pointerId);this._onInputChanged(G.Touch,t,n),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(G.Touch,t)}},this._wheelEventName=`onwheel`in document.createElement(`div`)?`wheel`:document.onmousewheel===void 0?`DOMMouseScroll`:`mousewheel`;let e=!1,t=function(){};try{let n=Object.defineProperty({},`passive`,{get:function(){e=!0}});this._elementToAttachTo.addEventListener(`test`,t,n),this._elementToAttachTo.removeEventListener(`test`,t,n)}catch{}this._pointerBlurEvent=()=>{var e,t,n,r;if(this.isDeviceAvailable(G.Mouse)){let n=this._inputs[G.Mouse][0];this._mouseId>=0&&(t=(e=this._elementToAttachTo).hasPointerCapture)!=null&&t.call(e,this._mouseId)&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let e=K.LeftClick;e<=K.BrowserForward;e++)if(n[e]===1){n[e]=0;let t=gn.CreateDeviceEvent(G.Mouse,0,e,0,this,this._elementToAttachTo);this._onInputChanged(G.Mouse,0,t)}}if(this.isDeviceAvailable(G.Touch)){let e=this._inputs[G.Touch];for(let t=0;t<this._activeTouchIds.length;t++){let i=this._activeTouchIds[t];if((r=(n=this._elementToAttachTo).hasPointerCapture)!=null&&r.call(n,i)&&this._elementToAttachTo.releasePointerCapture(i),i!==-1&&e[t]?.[K.LeftClick]===1){e[t][K.LeftClick]=0;let n=gn.CreateDeviceEvent(G.Touch,t,K.LeftClick,0,this,this._elementToAttachTo,i);this._onInputChanged(G.Touch,t,n),this._activeTouchIds[t]=-1,this._onDeviceDisconnected(G.Touch,t)}}}},this._pointerWheelEvent=e=>{let t=G.Mouse;this._inputs[t]||(this._inputs[t]=[]),this._inputs[t][0]||(this._pointerActive=!0,this._registerDevice(t,0,yn));let n=this._inputs[t][0];if(n){n[K.MouseWheelX]=e.deltaX||0,n[K.MouseWheelY]=e.deltaY||e.wheelDelta||0,n[K.MouseWheelZ]=e.deltaZ||0;let r=e;e.pointerId===void 0&&(e.pointerId=this._mouseId),n[K.MouseWheelX]!==0&&(r.inputIndex=K.MouseWheelX,this._onInputChanged(t,0,r)),n[K.MouseWheelY]!==0&&(r.inputIndex=K.MouseWheelY,this._onInputChanged(t,0,r)),n[K.MouseWheelZ]!==0&&(r.inputIndex=K.MouseWheelZ,this._onInputChanged(t,0,r))}},this._elementToAttachTo.addEventListener(this._eventPrefix+`move`,this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+`down`,this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+`up`,this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+`cancel`,this._pointerCancelEvent),this._elementToAttachTo.addEventListener(`blur`,this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(G.Mouse)){let e=this._inputs[G.Mouse][0];e[K.MouseWheelX]=0,e[K.MouseWheelY]=0,e[K.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){let t=this._getGamepadDeviceType(e.gamepad.id),n=e.gamepad.index;this._unregisterDevice(t,n),delete this._gamepads[n]}},window.addEventListener(`gamepadconnected`,this._gamepadConnectedEvent),window.addEventListener(`gamepaddisconnected`,this._gamepadDisconnectedEvent)}_updateDevice(e,t,n){let r=navigator.getGamepads()[t];if(r&&e===this._gamepads[t]){let i=this._inputs[e][t];n>=r.buttons.length?i[n]=r.axes[n-r.buttons.length].valueOf():i[n]=r.buttons[n].value}}_getGamepadDeviceType(e){return e.indexOf(`054c`)===-1?e.indexOf(`Xbox One`)!==-1||e.search(`Xbox 360`)!==-1||e.search(`xinput`)!==-1?G.Xbox:e.indexOf(`057e`)===-1?G.Generic:G.Switch:e.indexOf(`0ce6`)===-1?G.DualShock:G.DualSense}_getPointerType(e){let t=G.Mouse;return(e.pointerType===`touch`||e.pointerType===`pen`||e.touches)&&(t=G.Touch),t}},xn=class{constructor(e,t,n=0){this.deviceType=t,this.deviceSlot=n,this.onInputChangedObservable=new o,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}},Sn=class{constructor(e){this._registeredManagers=[],this._refCount=0,this.registerManager=e=>{for(let t=0;t<this._devices.length;t++){let n=this._devices[t];for(let r in n){let n=+r;e._addDevice(new xn(this._deviceInputSystem,t,n))}}this._registeredManagers.push(e)},this.unregisterManager=e=>{let t=this._registeredManagers.indexOf(e);t>-1&&this._registeredManagers.splice(t,1)};let t=Object.keys(G).length/2;this._devices=Array(t);let n=(e,t)=>{this._devices[e]||(this._devices[e]=[]),this._devices[e][t]||(this._devices[e][t]=t);for(let n of this._registeredManagers){let r=new xn(this._deviceInputSystem,e,t);n._addDevice(r)}},r=(e,t)=>{var n;(n=this._devices[e])!=null&&n[t]&&delete this._devices[e][t];for(let n of this._registeredManagers)n._removeDevice(e,t)},i=(e,t,n)=>{if(n)for(let r of this._registeredManagers)r._onInputChanged(e,t,n)};typeof _native<`u`?this._deviceInputSystem=new _n(n,r,i):this._deviceInputSystem=new bn(e,n,r,i)}dispose(){this._deviceInputSystem.dispose()}},Cn=class{getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(e=>!!e):[]}constructor(e){let t=Object.keys(G).length/2;this._devices=Array(t),this._firstDevice=Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Sn(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new o(e=>{for(let t of this._devices)if(t)for(let n of t)n&&this.onDeviceConnectedObservable.notifyObserver(e,n)}),this.onDeviceDisconnectedObservable=new o,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=[]),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var n;let r=this._devices[e]?.[t];this.onDeviceDisconnectedObservable.notifyObservers(r),(n=this._devices[e])!=null&&n[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,n){var r;(r=this._devices[e]?.[t])==null||r.onInputChangedObservable.notifyObservers(n)}_updateFirstDevices(e){switch(e){case G.Keyboard:case G.Mouse:this._firstDevice[e]=0;break;case G.Touch:case G.DualSense:case G.DualShock:case G.Xbox:case G.Switch:case G.Generic:{delete this._firstDevice[e];let t=this._devices[e];if(t){for(let n=0;n<t.length;n++)if(t[n]){this._firstDevice[e]=n;break}}break}}}},wn=class{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}},Tn=class e{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._isSwiping=!1,this._swipeButtonPressed=-1,this._skipPointerTap=!1,this._isMultiTouchGesture=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new gt(0,0),this._previousStartingPointerPosition=new gt(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._movePointerInfo=null,this._cameraObserverCount=0,this._delayedClicks=[null,null,null,null,null],this._deviceSourceManager=null,this._scene=e||b.LastCreatedScene,this._scene}get meshUnderPointer(){return this._movePointerInfo&&=(this._movePointerInfo._generatePickInfo(),null),this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new gt(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){let t=this._scene.getEngine().getInputElementClientRect();t&&(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){let n=this._scene,r=n.getEngine(),i=r.getInputElement();i&&(i.tabIndex=r.canvasTabIndex,n.doNotHandleCursors||(i.style.cursor=n.defaultCursor)),this._setCursorAndPointerOverMesh(e,t,n);for(let t of n._pointerMoveStage){let n=!!(e!=null&&e.pickedMesh);e=t.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,n,i)}let a=t.inputIndex>=K.MouseWheelX&&t.inputIndex<=K.MouseWheelZ?W.POINTERWHEEL:W.POINTERMOVE;n.onPointerMove&&(e||=this._pickMove(t),n.onPointerMove(t,e,a));let o;e?(o=new rn(a,t,e),this._setRayOnPointerInfo(e,t)):(o=new rn(a,t,null,this),this._movePointerInfo=o),n.onPointerObservable.hasObservers()&&n.onPointerObservable.notifyObservers(o,a)}_setRayOnPointerInfo(e,t){let n=this._scene;e&&n._pickingAvailable&&(e.ray||=n.createPickingRay(t.offsetX,t.offsetY,F.Identity(),n.activeCamera))}_addCameraPointerObserver(e,t){return this._cameraObserverCount++,this._scene.onPointerObservable.add(e,t)}_removeCameraPointerObserver(e){return this._cameraObserverCount--,this._scene.onPointerObservable.remove(e)}_checkForPicking(){return!!(this._scene.onPointerObservable.observers.length>this._cameraObserverCount||this._scene.onPointerPick)}_checkPrePointerObservable(e,t,n){let r=this._scene,i=new nn(n,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(i.originalPickingInfo=e,i.ray=e.ray,e.originMesh&&(i.nearInteractionPickingInfo=e)),r.onPrePointerObservable.notifyObservers(i,n),!!i.skipOnPointerObservable}_pickMove(e){let t=this._scene,n=t.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,t.pointerMovePredicate,!1,t.cameraToUseForPointers,t.pointerMoveTrianglePredicate);return this._setCursorAndPointerOverMesh(n,e,t),n}_setCursorAndPointerOverMesh(e,t,n){let r=n.getEngine().getInputElement();if(e!=null&&e.pickedMesh){if(this.setPointerOverMesh(e.pickedMesh,t.pointerId,e,t),!n.doNotHandleCursors&&r&&this._pointerOverMesh){let e=this._pointerOverMesh._getActionManagerForTrigger();e&&e.hasPointerTriggers&&(r.style.cursor=e.hoverCursor||n.hoverCursor)}}else this.setPointerOverMesh(null,t.pointerId,e,t)}simulatePointerMove(e,t){let n=new PointerEvent(`pointermove`,t);n.inputIndex=K.Move,!this._checkPrePointerObservable(e,n,W.POINTERMOVE)&&this._processPointerMove(e,n)}simulatePointerDown(e,t){let n=new PointerEvent(`pointerdown`,t);n.inputIndex=n.button+2,!this._checkPrePointerObservable(e,n,W.POINTERDOWN)&&this._processPointerDown(e,n)}_processPointerDown(t,n){let r=this._scene;if(t!=null&&t.pickedMesh){this._pickedDownMesh=t.pickedMesh;let i=t.pickedMesh._getActionManagerForTrigger();if(i){if(i.hasPickTriggers)switch(i.processTrigger(5,Yt.CreateNew(t.pickedMesh,n)),n.button){case 0:i.processTrigger(2,Yt.CreateNew(t.pickedMesh,n));break;case 1:i.processTrigger(4,Yt.CreateNew(t.pickedMesh,n));break;case 2:i.processTrigger(3,Yt.CreateNew(t.pickedMesh,n));break}i.hasSpecificTrigger(8)&&window.setTimeout(()=>{let t=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,e=>e.isPickable&&e.isVisible&&e.isReady()&&e.actionManager&&e.actionManager.hasSpecificTrigger(8)&&e===this._pickedDownMesh,!1,r.cameraToUseForPointers);t!=null&&t.pickedMesh&&i&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>e.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,i.processTrigger(8,Yt.CreateNew(t.pickedMesh,n)))},e.LongPressDelay)}}else for(let e of r._pointerDownStage)t=e.action(this._unTranslatedPointerX,this._unTranslatedPointerY,t,n,!1);let i,a=W.POINTERDOWN;t?(r.onPointerDown&&r.onPointerDown(n,t,a),i=new rn(a,n,t),this._setRayOnPointerInfo(t,n)):i=new rn(a,n,null,this),r.onPointerObservable.hasObservers()&&r.onPointerObservable.notifyObservers(i,a)}_isPointerSwiping(){return this._isSwiping}simulatePointerUp(e,t,n){let r=new PointerEvent(`pointerup`,t);r.inputIndex=K.Move;let i=new wn;n?i.doubleClick=!0:i.singleClick=!0,!this._checkPrePointerObservable(e,r,W.POINTERUP)&&this._processPointerUp(e,r,i)}_processPointerUp(e,t,n){let r=this._scene;if(e!=null&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(r.onPointerPick&&r.onPointerPick(t,e),n.singleClick&&!n.ignore&&r.onPointerObservable.observers.length>this._cameraObserverCount)){let n=W.POINTERPICK,i=new rn(n,t,e);this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(i,n)}let i=e.pickedMesh._getActionManagerForTrigger();if(i&&!n.ignore){i.processTrigger(7,Yt.CreateNew(e.pickedMesh,t,e)),!n.hasSwiped&&n.singleClick&&i.processTrigger(1,Yt.CreateNew(e.pickedMesh,t,e));let r=e.pickedMesh._getActionManagerForTrigger(6);n.doubleClick&&r&&r.processTrigger(6,Yt.CreateNew(e.pickedMesh,t,e))}}else if(!n.ignore)for(let i of r._pointerUpStage)e=i.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,n.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){let e=this._pickedDownMesh._getActionManagerForTrigger(16);e&&e.processTrigger(16,Yt.CreateNew(this._pickedDownMesh,t))}if(!n.ignore){let i=new rn(W.POINTERUP,t,e);if(this._setRayOnPointerInfo(e,t),r.onPointerObservable.notifyObservers(i,W.POINTERUP),r.onPointerUp&&r.onPointerUp(t,e,W.POINTERUP),!n.hasSwiped&&!this._skipPointerTap&&!this._isMultiTouchGesture){let i=0;if(n.singleClick?i=W.POINTERTAP:n.doubleClick&&(i=W.POINTERDOUBLETAP),i){let n=new rn(i,t,e);r.onPointerObservable.hasObservers()&&r.onPointerObservable.hasSpecificMask(i)&&r.onPointerObservable.notifyObservers(n,i)}}}}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(t=!0,n=!0,r=!0,i=null){let a=this._scene,o=a.getEngine();i||=o.getInputElement(),this._alreadyAttached&&this.detachControl(),i&&(this._alreadyAttachedTo=i),this._deviceSourceManager=new Cn(o),this._initActionManager=e=>{if(!this._meshPickProceed){let t=a.skipPointerUpPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerUp?null:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerUpPredicate,!1,a.cameraToUseForPointers);this._currentPickResult=t,t&&(e=t.hit&&t.pickedMesh?t.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return e},this._delayedSimpleClick=(t,n,r)=>{if((Date.now()-this._previousStartingPointerTime>e.DoubleClickDelay&&!this._doubleClickOccured||t!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,n.singleClick=!0,n.ignore=!1,this._delayedClicks[t])){let e=this._delayedClicks[t].evt,n=W.POINTERTAP,r=new rn(n,e,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(n)&&a.onPointerObservable.notifyObservers(r,n),this._delayedClicks[t]=null}},this._initClickEvent=(t,n,r,i)=>{let a=new wn;this._currentPickResult=null;let o=null,s=t.hasSpecificMask(W.POINTERPICK)||n.hasSpecificMask(W.POINTERPICK)||t.hasSpecificMask(W.POINTERTAP)||n.hasSpecificMask(W.POINTERTAP)||t.hasSpecificMask(W.POINTERDOUBLETAP)||n.hasSpecificMask(W.POINTERDOUBLETAP);!s&&an&&(o=this._initActionManager(o,a),o&&(s=o.hasPickTriggers));let c=!1;if(s){let s=r.button;if(a.hasSwiped=this._isPointerSwiping(),!a.hasSwiped){let l=!e.ExclusiveDoubleClickMode;if(l||(l=!t.hasSpecificMask(W.POINTERDOUBLETAP)&&!n.hasSpecificMask(W.POINTERDOUBLETAP),l&&!an.HasSpecificTrigger(6)&&(o=this._initActionManager(o,a),o&&(l=!o.hasSpecificTrigger(6)))),l)(Date.now()-this._previousStartingPointerTime>e.DoubleClickDelay||s!==this._previousButtonPressed)&&(a.singleClick=!0,i(a,this._currentPickResult),c=!0);else{let t={evt:r,clickInfo:a,timeoutId:window.setTimeout(this._delayedSimpleClick.bind(this,s,a,i),e.DoubleClickDelay)};this._delayedClicks[s]=t}let u=t.hasSpecificMask(W.POINTERDOUBLETAP)||n.hasSpecificMask(W.POINTERDOUBLETAP);!u&&an.HasSpecificTrigger(6)&&(o=this._initActionManager(o,a),o&&(u=o.hasSpecificTrigger(6))),u&&(s===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<e.DoubleClickDelay&&!this._doubleClickOccured?(!a.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,a.doubleClick=!0,a.ignore=!1,e.ExclusiveDoubleClickMode&&this._delayedClicks[s]&&(clearTimeout(this._delayedClicks[s]?.timeoutId),this._delayedClicks[s]=null),i(a,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=s,e.ExclusiveDoubleClickMode?(this._delayedClicks[s]&&(clearTimeout(this._delayedClicks[s]?.timeoutId),this._delayedClicks[s]=null),i(a,this._previousPickResult)):i(a,this._currentPickResult)),c=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=s))}}c||i(a,this._currentPickResult)},this._onPointerMove=t=>{if(this._updatePointerPosition(t),!this._isSwiping&&this._swipeButtonPressed!==-1&&(this._isSwiping=Math.abs(this._startingPointerPosition.x-this._pointerX)>e.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>e.DragMovementThreshold),o.isPointerLock&&o._verifyPointerLock(),this._checkPrePointerObservable(null,t,t.inputIndex>=K.MouseWheelX&&t.inputIndex<=K.MouseWheelZ?W.POINTERWHEEL:W.POINTERMOVE)||!a.cameraToUseForPointers&&!a.activeCamera)return;if(a.skipPointerMovePicking){this._processPointerMove(new Jt,t);return}a.pointerMovePredicate||=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(e.enablePointerMoveEvents||a.constantlyUpdateMeshUnderPointer||e._getActionManagerForTrigger()!==null)&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&e.layerMask)!==0);let n=a._registeredActions>0?this._pickMove(t):null;this._processPointerMove(n,t)},this._onPointerDown=t=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,e.ExclusiveDoubleClickMode){for(let e=0;e<this._delayedClicks.length;e++)if(this._delayedClicks[e])if(t.button===e)clearTimeout(this._delayedClicks[e]?.timeoutId);else{let t=this._delayedClicks[e].clickInfo;this._doubleClickOccured=!1,t.singleClick=!0,t.ignore=!1;let n=this._delayedClicks[e].evt,r=W.POINTERTAP,i=new rn(r,n,this._currentPickResult);a.onPointerObservable.hasObservers()&&a.onPointerObservable.hasSpecificMask(r)&&a.onPointerObservable.notifyObservers(i,r),this._delayedClicks[e]=null}}if(this._updatePointerPosition(t),this._swipeButtonPressed===-1&&(this._swipeButtonPressed=t.button),a.preventDefaultOnPointerDown&&i&&(t.preventDefault(),i.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,t,W.POINTERDOWN)||!a.cameraToUseForPointers&&!a.activeCamera)return;this._pointerCaptures[t.pointerId]=!0,a.pointerDownPredicate||=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&e.layerMask)!==0),this._pickedDownMesh=null;let n;n=a.skipPointerDownPicking||a._registeredActions===0&&!this._checkForPicking()&&!a.onPointerDown?new Jt:a.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,a.pointerDownPredicate,!1,a.cameraToUseForPointers),this._processPointerDown(n,t)},this._onPointerUp=e=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,this._updatePointerPosition(e),a.preventDefaultOnPointerUp&&i&&(e.preventDefault(),i.focus()),this._initClickEvent(a.onPrePointerObservable,a.onPointerObservable,e,(t,n)=>{if(a.onPrePointerObservable.hasObservers()&&(this._skipPointerTap=!1,!t.ignore)){if(this._checkPrePointerObservable(null,e,W.POINTERUP)){this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}t.hasSwiped||(t.singleClick&&a.onPrePointerObservable.hasSpecificMask(W.POINTERTAP)&&this._checkPrePointerObservable(null,e,W.POINTERTAP)&&(this._skipPointerTap=!0),t.doubleClick&&a.onPrePointerObservable.hasSpecificMask(W.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,e,W.POINTERDOUBLETAP)&&(this._skipPointerTap=!0))}if(!this._pointerCaptures[e.pointerId]){this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1);return}e.buttons===0&&(this._pointerCaptures[e.pointerId]=!1),!(!a.cameraToUseForPointers&&!a.activeCamera)&&(a.pointerUpPredicate||=e=>e.isPickable&&e.isVisible&&e.isReady()&&e.isEnabled()&&(!a.cameraToUseForPointers||(a.cameraToUseForPointers.layerMask&e.layerMask)!==0),!this._meshPickProceed&&(an&&an.HasTriggers||this._checkForPicking()||a.onPointerUp)&&this._initActionManager(null,t),n||=this._currentPickResult,this._processPointerUp(n,e,t),this._previousPickResult=this._currentPickResult,this._swipeButtonPressed===e.button&&(this._isSwiping=!1,this._swipeButtonPressed=-1))}))},this._onKeyDown=e=>{let t=on.KEYDOWN;if(a.onPreKeyboardObservable.hasObservers()){let n=new cn(t,e);if(a.onPreKeyboardObservable.notifyObservers(n,t),n.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){let n=new sn(t,e);a.onKeyboardObservable.notifyObservers(n,t)}a.actionManager&&a.actionManager.processTrigger(14,Yt.CreateNewFromScene(a,e))},this._onKeyUp=e=>{let t=on.KEYUP;if(a.onPreKeyboardObservable.hasObservers()){let n=new cn(t,e);if(a.onPreKeyboardObservable.notifyObservers(n,t),n.skipOnKeyboardObservable)return}if(a.onKeyboardObservable.hasObservers()){let n=new sn(t,e);a.onKeyboardObservable.notifyObservers(n,t)}a.actionManager&&a.actionManager.processTrigger(15,Yt.CreateNewFromScene(a,e))},this._deviceSourceManager.onDeviceConnectedObservable.add(e=>{e.deviceType===G.Mouse?e.onInputChangedObservable.add(i=>{i.inputIndex===K.LeftClick||i.inputIndex===K.MiddleClick||i.inputIndex===K.RightClick||i.inputIndex===K.BrowserBack||i.inputIndex===K.BrowserForward?n&&e.getInput(i.inputIndex)===1?this._onPointerDown(i):t&&e.getInput(i.inputIndex)===0&&this._onPointerUp(i):r&&(i.inputIndex===K.Move||i.inputIndex===K.MouseWheelX||i.inputIndex===K.MouseWheelY||i.inputIndex===K.MouseWheelZ)&&this._onPointerMove(i)}):e.deviceType===G.Touch?e.onInputChangedObservable.add(i=>{i.inputIndex===K.LeftClick&&(n&&e.getInput(i.inputIndex)===1?(this._onPointerDown(i),this._totalPointersPressed>1&&(this._isMultiTouchGesture=!0)):t&&e.getInput(i.inputIndex)===0&&(this._onPointerUp(i),this._totalPointersPressed===0&&(this._isMultiTouchGesture=!1))),r&&i.inputIndex===K.Move&&this._onPointerMove(i)}):e.deviceType===G.Keyboard&&e.onInputChangedObservable.add(e=>{e.type===`keydown`?this._onKeyDown(e):e.type===`keyup`&&this._onKeyUp(e)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,n,r){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;let i=this._meshUnderPointerId[t],a;i&&(a=i._getActionManagerForTrigger(10),a&&a.processTrigger(10,Yt.CreateNew(i,r,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,a=e._getActionManagerForTrigger(9),a&&a.processTrigger(9,Yt.CreateNew(e,r,{pointerId:t,pickResult:n}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this.meshUnderPointer}_invalidateMesh(e){for(let t in this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null),this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}};Tn.DragMovementThreshold=10,Tn.LongPressDelay=500,Tn.DoubleClickDelay=300,Tn.ExclusiveDoubleClickMode=!1;var En=class e{get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(t,n){e.Enabled&&(this._current+=t,n&&this._fetchResult())}beginMonitoring(){e.Enabled&&(this._startMonitoringTime=g.Now)}endMonitoring(t=!0){e.Enabled&&(t&&this.fetchNewFrame(),this._current=g.Now-this._startMonitoringTime,t&&this._fetchResult())}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;let e=g.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}};En.Enabled=!0;var Dn=class e{constructor(e,t,n,r){this.normal=new N(e,t,n),this.d=r}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new e(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return`Plane`}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){let e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z),t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(t){let n=e._TmpMatrix;t.invertToRef(n);let r=n.m,i=this.normal.x,a=this.normal.y,o=this.normal.z,s=this.d;return new e(i*r[0]+a*r[1]+o*r[2]+s*r[3],i*r[4]+a*r[5]+o*r[6]+s*r[7],i*r[8]+a*r[9]+o*r[10]+s*r[11],i*r[12]+a*r[13]+o*r[14]+s*r[15])}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,n){let r=t.x-e.x,i=t.y-e.y,a=t.z-e.z,o=n.x-e.x,s=n.y-e.y,c=n.z-e.z,l=i*c-a*s,u=a*o-r*c,d=r*s-i*o,f=Math.sqrt(l*l+u*u+d*d),p;return p=f===0?0:1/f,this.normal.x=l*p,this.normal.y=u*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return N.Dot(this.normal,e)<=t}signedDistanceTo(e){return N.Dot(e,this.normal)+this.d}static FromArray(t){return new e(t[0],t[1],t[2],t[3])}static FromPoints(t,n,r){let i=new e(0,0,0,0);return i.copyFromPoints(t,n,r),i}static FromPositionAndNormal(t,n){let r=new e(0,0,0,0);return n.normalize(),r.normal=n,r.d=-(n.x*t.x+n.y*t.y+n.z*t.z),r}static SignedDistanceToPlaneFromPositionAndNormal(e,t,n){let r=-(t.x*e.x+t.y*e.y+t.z*e.z);return N.Dot(n,t)+r}};Dn._TmpMatrix=F.Identity();var On=class e{static GetPlanes(t){let n=[];for(let e=0;e<6;e++)n.push(new Dn(0,0,0,0));return e.GetPlanesToRef(t,n),n}static GetNearPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]+n[2],t.normal.y=n[7]+n[6],t.normal.z=n[11]+n[10],t.d=n[15]+n[14],t.normalize()}static GetFarPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]-n[2],t.normal.y=n[7]-n[6],t.normal.z=n[11]-n[10],t.d=n[15]-n[14],t.normalize()}static GetLeftPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]+n[0],t.normal.y=n[7]+n[4],t.normal.z=n[11]+n[8],t.d=n[15]+n[12],t.normalize()}static GetRightPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]-n[0],t.normal.y=n[7]-n[4],t.normal.z=n[11]-n[8],t.d=n[15]-n[12],t.normalize()}static GetTopPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]-n[1],t.normal.y=n[7]-n[5],t.normal.z=n[11]-n[9],t.d=n[15]-n[13],t.normalize()}static GetBottomPlaneToRef(e,t){let n=e.m;t.normal.x=n[3]+n[1],t.normal.y=n[7]+n[5],t.normal.z=n[11]+n[9],t.d=n[15]+n[13],t.normalize()}static GetPlanesToRef(t,n){e.GetNearPlaneToRef(t,n[0]),e.GetFarPlaneToRef(t,n[1]),e.GetLeftPlaneToRef(t,n[2]),e.GetRightPlaneToRef(t,n[3]),e.GetTopPlaneToRef(t,n[4]),e.GetBottomPlaneToRef(t,n[5])}static IsPointInFrustum(e,t){for(let n=0;n<6;n++)if(t[n].dotCoordinate(e)<0)return!1;return!0}},kn=class{static get UniqueId(){let e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}};kn._UniqueIdCounter=1;var An=class{static CompareLightsPriority(e,t){return e.shadowEnabled===t.shadowEnabled?t.renderPriority-e.renderPriority:(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0)}};An.FALLOFF_DEFAULT=0,An.FALLOFF_PHYSICAL=1,An.FALLOFF_GLTF=2,An.FALLOFF_STANDARD=3,An.LIGHTMAP_DEFAULT=0,An.LIGHTMAP_SPECULAR=1,An.LIGHTMAP_SHADOWSONLY=2,An.INTENSITYMODE_AUTOMATIC=0,An.INTENSITYMODE_LUMINOUSPOWER=1,An.INTENSITYMODE_LUMINOUSINTENSITY=2,An.INTENSITYMODE_ILLUMINANCE=3,An.INTENSITYMODE_LUMINANCE=4,An.LIGHTTYPEID_POINTLIGHT=0,An.LIGHTTYPEID_DIRECTIONALLIGHT=1,An.LIGHTTYPEID_SPOTLIGHT=2,An.LIGHTTYPEID_HEMISPHERICLIGHT=3;var jn;(function(e){e[e.BackwardCompatible=0]=`BackwardCompatible`,e[e.Intermediate=1]=`Intermediate`,e[e.Aggressive=2]=`Aggressive`})(jn||={});var q=class e extends yt{static DefaultMaterialFactory(e){throw _(`StandardMaterial`)}static CollisionCoordinatorFactory(){throw _(`DefaultCollisionCoordinator`)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority){switch(this._performancePriority=e,e){case jn.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case jn.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case jn.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}this.onScenePerformancePriorityChangedObservable.notifyObservers(e)}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return Tn.DragMovementThreshold}static set DragMovementThreshold(e){Tn.DragMovementThreshold=e}static get LongPressDelay(){return Tn.LongPressDelay}static set LongPressDelay(e){Tn.LongPressDelay=e}static get DoubleClickDelay(){return Tn.DoubleClickDelay}static set DoubleClickDelay(e){Tn.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return Tn.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){Tn.ExclusiveDoubleClickMode=e}bindEyePosition(e,t=`vEyePosition`,n=!1){let r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:this.activeCamera.globalPosition??this.activeCamera.devicePosition,i=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return L.Vector4[0].set(r.x,r.y,r.z,i?-1:1),e&&(n?e.setFloat3(t,L.Vector4[0].x,L.Vector4[0].y,L.Vector4[0].z):e.setVector4(t,L.Vector4[0])),L.Vector4[0]}finalizeSceneUbo(){let e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4(`vEyePosition`,t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&=(this._unObserveActiveCameras(),null),e&&(this._unObserveActiveCameras=mt(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||=e.DefaultMaterialFactory(this),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=e.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(let e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);let t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(let t of this._components)if(t.name===e)return t;return null}constructor(t,n){super(),this._inputManager=new Tn(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new Tt(.2,.2,.3,1),this.ambientColor=new wt(0,0,0),this.environmentIntensity=1,this._performancePriority=jn.BackwardCompatible,this.onScenePerformancePriorityChangedObservable=new o,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor=`pointer`,this.defaultCursor=``,this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=[],this.onDisposeObservable=new o,this._onDisposeObserver=null,this.onBeforeRenderObservable=new o,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new o,this.onAfterRenderCameraObservable=new o,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new o,this.onAfterAnimationsObservable=new o,this.onBeforeDrawPhaseObservable=new o,this.onAfterDrawPhaseObservable=new o,this.onReadyObservable=new o,this.onBeforeCameraRenderObservable=new o,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new o,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new o,this.onAfterActiveMeshesEvaluationObservable=new o,this.onBeforeParticlesRenderingObservable=new o,this.onAfterParticlesRenderingObservable=new o,this.onDataLoadedObservable=new o,this.onNewCameraAddedObservable=new o,this.onCameraRemovedObservable=new o,this.onNewLightAddedObservable=new o,this.onLightRemovedObservable=new o,this.onNewGeometryAddedObservable=new o,this.onGeometryRemovedObservable=new o,this.onNewTransformNodeAddedObservable=new o,this.onTransformNodeRemovedObservable=new o,this.onNewMeshAddedObservable=new o,this.onMeshRemovedObservable=new o,this.onNewSkeletonAddedObservable=new o,this.onSkeletonRemovedObservable=new o,this.onNewMaterialAddedObservable=new o,this.onNewMultiMaterialAddedObservable=new o,this.onMaterialRemovedObservable=new o,this.onMultiMaterialRemovedObservable=new o,this.onNewTextureAddedObservable=new o,this.onTextureRemovedObservable=new o,this.onBeforeRenderTargetsRenderObservable=new o,this.onAfterRenderTargetsRenderObservable=new o,this.onBeforeStepObservable=new o,this.onAfterStepObservable=new o,this.onActiveCameraChanged=new o,this.onActiveCamerasChanged=new o,this.onBeforeRenderingGroupObservable=new o,this.onAfterRenderingGroupObservable=new o,this.onMeshImportedObservable=new o,this.onAnimationFileImportedObservable=new o,this._registeredForLateAnimationBindings=new at(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new o,this.onPointerObservable=new o,this.onPreKeyboardObservable=new o,this.onKeyboardObservable=new o,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=e.FOGMODE_NONE,this.fogColor=new wt(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new N(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=[],this.importedMeshesFiles=[],this.probesEnabled=!0,this._meshesForIntersections=new at(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new En,this._activeIndices=new En,this._activeParticles=new En,this._activeBones=new En,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=Array(256),this._activeRequests=[],this._pendingData=[],this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new it(256),this._processedMaterials=new it(256),this._renderTargets=new at(256),this._materialsRenderTargets=new at(256),this._activeParticleSystems=new it(256),this._activeSkeletons=new at(32),this._softwareSkinnedMeshes=new at(32),this._activeAnimatables=[],this._transformMatrix=F.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=en.Create(),this._beforeClearStage=en.Create(),this._beforeRenderTargetClearStage=en.Create(),this._gatherRenderTargetsStage=en.Create(),this._gatherActiveCameraRenderTargetsStage=en.Create(),this._isReadyForMeshStage=en.Create(),this._beforeEvaluateActiveMeshStage=en.Create(),this._evaluateSubMeshStage=en.Create(),this._preActiveMeshStage=en.Create(),this._cameraDrawRenderTargetStage=en.Create(),this._beforeCameraDrawStage=en.Create(),this._beforeRenderTargetDrawStage=en.Create(),this._beforeRenderingGroupDrawStage=en.Create(),this._beforeRenderingMeshStage=en.Create(),this._afterRenderingMeshStage=en.Create(),this._afterRenderingGroupDrawStage=en.Create(),this._afterCameraDrawStage=en.Create(),this._afterCameraPostProcessStage=en.Create(),this._afterRenderTargetDrawStage=en.Create(),this._afterRenderTargetPostProcessStage=en.Create(),this._afterRenderStage=en.Create(),this._pointerMoveStage=en.Create(),this._pointerDownStage=en.Create(),this._pointerUpStage=en.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._registeredActions=0,this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.activeCameras=[];let r={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...n};this._engine=t||b.LastCreatedEngine,r.virtual?this._engine._virtualScenes.push(this):(b._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new $t(this),Xt&&(this.postProcessManager=new Xt(this)),s()&&this.attachControl(),this._createUbo(),V&&(this._imageProcessingConfiguration=new V),this.setDefaultCandidateProviders(),r.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=r.useMaterialMeshMap,this.useClonedMeshMap=r.useClonedMeshMap,(!n||!n.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this)}getClassName(){return`Scene`}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,n=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==n}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio===void 0?1:this._animationRatio}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,n){return this._inputManager.simulatePointerUp(e,t,n),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,n=!0){this._inputManager.attachControl(e,t,n)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t,n=this.getEngine(),r=!0;for(this._pendingData.length>0&&(r=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){let i=this.meshes[t];if(!i.subMeshes||i.subMeshes.length===0)continue;if(!i.isReady(!0)){r=!1;continue}let a=i.hasThinInstances||i.getClassName()===`InstancedMesh`||i.getClassName()===`InstancedLinesMesh`||n.getCaps().instancedArrays&&i.instances.length>0;for(let e of this._isReadyForMeshStage)e.action(i,a)||(r=!1);if(!e)continue;let o=i.material||this.defaultMaterial;if(o)if(o._storeEffectOnSubMeshes)for(let e of i.subMeshes){let t=e.getMaterial();t&&t.hasRenderTargetTextures&&t.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(t)===-1&&(this._processedMaterials.push(t),this._materialsRenderTargets.concatWithNoDuplicate(t.getRenderTargetTextures()))}else o.hasRenderTargetTextures&&o.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(o)===-1&&(this._processedMaterials.push(o),this._materialsRenderTargets.concatWithNoDuplicate(o.getRenderTargetTextures()))}if(!r||!n.areAllEffectsReady())return!1;if(e){for(t=0;t<this._materialsRenderTargets.length;++t)if(!this._materialsRenderTargets.data[t].isReadyForRendering())return!1}for(t=0;t<this.geometries.length;t++)if(this.geometries[t].delayLoadState===2)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(let e of this.activeCameras)if(!e.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(let e of this.particleSystems)if(!e.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){let t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t===void 0?this._executeOnceBeforeRender(e):setTimeout(()=>{this._executeOnceBeforeRender(e)},t)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){let t=this.isLoading,n=this._pendingData.indexOf(e);n!==-1&&this._pendingData.splice(n,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.addOnce(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=g.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,n,r){!n&&!r&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?On.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=On.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(n,r):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix(`viewProjection`,this._transformMatrix),this._sceneUbo.updateMatrix(`view`,this._viewMatrix),this._sceneUbo.updateMatrix(`projection`,this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){let t=new Kt(this._engine,void 0,!1,e??`scene`);return t.addUniform(`viewProjection`,16),t.addUniform(`view`,16),t.addUniform(`projection`,16),t.addUniform(`vEyePosition`,4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return kn.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(e=>{this.addMesh(e)}))}removeMesh(e,t=!1){let n=this.meshes.indexOf(e);return n!==-1&&(this.meshes[n]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(e=>{this.removeMesh(e)}),n}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){let t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){let e=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=e,e._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){let t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){let t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){let t=this.lights.indexOf(e);if(t!==-1){for(let t of this.meshes)t._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){let t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){let t=this.activeCameras.indexOf(e);t!==-1&&this.activeCameras.splice(t,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){let t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){let t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,n){}removeAnimationGroup(e){let t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){let t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){let t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){let e=this.materials[this.materials.length-1];this.materials[t]=e,e._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){let t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){let t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(let t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(An.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){this._engine.getInputElement()&&(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){let t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){let t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}_getMaterial(e,t){for(let e=0;e<this.materials.length;e++){let n=this.materials[e];if(t(n))return n}if(e)for(let e=0;e<this.multiMaterials.length;e++){let n=this.multiMaterials[e];if(t(n))return n}return null}getMaterialByUniqueID(e,t=!1){return this._getMaterial(t,t=>t.uniqueId===e)}getMaterialById(e,t=!1){return this._getMaterial(t,t=>t.id===e)}getMaterialByName(e,t=!1){return this._getMaterial(t,t=>t.name===e)}getLastMaterialById(e,t=!1){for(let t=this.materials.length-1;t>=0;t--)if(this.materials[t].id===e)return this.materials[t];if(t){for(let t=this.multiMaterials.length-1;t>=0;t--)if(this.multiMaterials[t].id===e)return this.multiMaterials[t]}return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){let n=this.skeletons[t];for(let t=0;t<n.bones.length;t++)if(n.bones[t].id===e)return n.bones[t]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){let n=this.skeletons[t];for(let t=0;t<n.bones.length;t++)if(n.bones[t].name===e)return n.bones[t]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){let t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){let e=this.geometries[this.geometries.length-1];e&&(this.geometries[t]=e,this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){return this.getMeshById(e)||this.getTransformNodeById(e)||this.getLightById(e)||this.getCameraById(e)||this.getBoneById(e)||null}getNodeByName(e){return this.getMeshByName(e)||this.getTransformNodeByName(e)||this.getLightByName(e)||this.getCameraByName(e)||this.getBoneByName(e)||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){let n=this.morphTargetManagers[t];for(let t=0;t<n.numTargets;++t){let r=n.getTarget(t);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){let n=this.morphTargetManagers[t];for(let t=0;t<n.numTargets;++t){let r=n.getTarget(t);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){let n=this.postProcesses[t];if(n.name===e)return n}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||=A.RandomId(),this._uid}addExternalData(e,t){return this._externalData||=new ot,this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||=new ot,this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,n,r){if(r||e.isInFrustum(this._frustumPlanes)){for(let n of this._evaluateSubMeshStage)n.action(t,e);let n=e.getMaterial();n!=null&&(n.hasRenderTargetTextures&&n.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(n)===-1&&(this._processedMaterials.push(n),this._materialsRenderTargets.concatWithNoDuplicate(n.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,n))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){let t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,n,r=!0,i=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){n&&n(`No active camera found`);return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=i,this._skipEvaluateActiveMeshesCompletely=e,r)for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)==null||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){let e=this._activeMeshes.length;for(let t=0;t<e;t++)this._activeMeshes.data[t].computeWorldMatrix()}if(this._activeParticleSystems){let e=this._activeParticleSystems.length;for(let t=0;t<e;t++)this._activeParticleSystems.data[t].animate()}this._renderingManager.resetSprites();return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(let e of this._beforeEvaluateActiveMeshStage)e.action();let t=this.getActiveMeshCandidates(),n=t.length;for(let e=0;e<n;e++){let n=t.data[e];if(n._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,n.isBlocked||(this._totalVertices.addCount(n.getTotalVertices(),!1),!n.isReady()||!n.isEnabled()||n.scaling.hasAZeroComponent))continue;n.computeWorldMatrix(),n.actionManager&&n.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(n);let r=this.customLODSelector?this.customLODSelector(n,this.activeCamera):n.getLOD(this.activeCamera);if(n._internalAbstractMeshDataInfo._currentLOD=r,n._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,r!=null&&(r!==n&&r.billboardMode!==0&&r.computeWorldMatrix(),n._preActivate(),n.isVisible&&n.visibility>0&&n.layerMask&this.activeCamera.layerMask&&(this._skipFrustumClipping||n.alwaysSelectAsActiveMesh||n.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(n),this.activeCamera._activeMeshes.push(n),r!==n&&r._activate(this._renderId,!1);for(let e of this._preActiveMeshStage)e.action(n);n._activate(this._renderId,!1)&&(n.isAnInstance?n._internalAbstractMeshDataInfo._actAsRegularMesh&&(r=n):r._internalAbstractMeshDataInfo._onlyForInstances=!1,r._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(n,r)),n._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let e=0;e<this.particleSystems.length;e++){let t=this.particleSystems[e];if(!t.isStarted()||!t.emitter)continue;let n=t.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(t),t.animate(),this._renderingManager.dispatchParticles(t))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let n=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){let r=this.getActiveSubMeshCandidates(t),i=r.length;n||=i===1;for(let a=0;a<i;a++){let i=r.data[a];this._evaluateSubMesh(i,t,e,n)}}}updateTransformMatrix(e){if(this.activeCamera)if(this.activeCamera._renderingMultiview){let t=this.activeCamera._rigCameras[0],n=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),n.getViewMatrix(),n.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget&&!e._renderingMultiview){let t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,n=!0){if(e&&e._skipRendering)return;let r=this._engine;if(this._activeCamera=e,!this.activeCamera)throw Error(`Active camera not set`);if(r.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&n){let t=!0;e._renderingMultiview&&e.outputRenderTarget&&(t=e.outputRenderTarget.skipInitialClear,this.autoClear&&(this._defaultFrameBufferCleared=!1,e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=t)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let e=0;e<this._softwareSkinnedMeshes.length;e++){let t=this._softwareSkinnedMeshes.data[e];t.applySkeleton(t.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(let e of this._gatherActiveCameraRenderTargetsStage)e.action(this._renderTargets);let i=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){A.StartPerformanceCounter(`Render targets`,this._renderTargets.length>0);for(let e=0;e<this._renderTargets.length;e++){let t=this._renderTargets.data[e];if(t._shouldRender()){this._renderId++;let e=t.activeCamera&&t.activeCamera!==this.activeCamera;t.render(e,this.dumpNextRenderTargets),i=!0}}A.EndPerformanceCounter(`Render targets`,this._renderTargets.length>0),this._renderId++}for(let e of this._cameraDrawRenderTargetStage)i=e.action(this.activeCamera)||i;this._intermediateRendering=!1}this._engine.currentRenderPassId=e.outputRenderTarget?.renderPassId??e.renderPassId??0,i&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(let e of this._beforeCameraDrawStage)e.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),r.snapshotRendering&&r.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(let e of this._afterCameraDrawStage)e.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){let t=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,t)}for(let e of this._afterCameraPostProcessStage)e.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let t=0;t<e._rigCameras.length;t++)this._renderForCamera(e._rigCameras[t],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){let t=this._meshesForIntersections.data[e];if(t.actionManager)for(let e=0;t.actionManager&&e<t.actionManager.actions.length;e++){let n=t.actionManager.actions[e];if(n.trigger===12||n.trigger===13){let e=n.getTriggerParameter(),r=e.mesh?e.mesh:e,i=r.intersectsMesh(t,e.usePreciseIntersection),a=t._intersectionsInProgress.indexOf(r);i&&a===-1?n.trigger===12?(n._executeCurrent(Yt.CreateNew(t,void 0,r)),t._intersectionsInProgress.push(r)):n.trigger===13&&t._intersectionsInProgress.push(r):!i&&a>-1&&(n.trigger===13&&n._executeCurrent(Yt.CreateNew(t,void 0,r)),(!t.actionManager.hasSpecificTrigger(13,e=>r===(e.mesh?e.mesh:e))||n.trigger===13)&&t._intersectionsInProgress.splice(a,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let t=Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime))+this._timeAccumulator,n=this._engine.getTimeStep(),r=1e3/n/1e3,i=0,a=this._engine.getLockstepMaxSteps(),o=Math.floor(t/n);for(o=Math.min(o,a);t>0&&i<o;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=n*r,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(n),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,i++,t-=n;this._timeAccumulator=t<0?0:t}else{let t=this.useConstantAnimationDeltaTime?16:Math.max(e.MinDeltaTime,Math.min(this._engine.getDeltaTime(),e.MaxDeltaTime));this._animationRatio=t*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if(e!=null&&e.outputRenderTarget&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),(t=e?.rigCameras)!=null&&t.length)for(let t=0;t<e.rigCameras.length;++t){let n=e.rigCameras[t].outputRenderTarget;n&&(n._cleared=!1)}}resetDrawCache(e){if(this.meshes)for(let t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var n,r;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),(n=this.activeCameras)!=null&&n.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(let e of this._beforeCameraUpdateStage)e.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++){let t=this.activeCameras[e];if(t.update(),t.cameraRigMode!==0)for(let e=0;e<t._rigCameras.length;e++)t._rigCameras[e].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let e=0;e<this.activeCamera._rigCameras.length;e++)this.activeCamera._rigCameras[e].update()}this.onBeforeRenderObservable.notifyObservers(this);let i=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);let a=(r=this.activeCameras)!=null&&r.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){A.StartPerformanceCounter(`Custom render targets`,this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let e=0;e<this.customRenderTargets.length;e++){let t=this.customRenderTargets[e];if(t._shouldRender()){if(this._renderId++,this.activeCamera=t.activeCamera||this.activeCamera,!this.activeCamera)throw Error(`Active camera not set`);i.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),t.render(a!==this.activeCamera,this.dumpNextRenderTargets)}}A.EndPerformanceCounter(`Custom render targets`,this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=a?.renderPassId??0,this.activeCamera=a,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(let e of this._beforeClearStage)e.action();this._clearFrameBuffer(this.activeCamera);for(let e of this._gatherRenderTargetsStage)e.action(this._renderTargets);if(this.activeCameras&&this.activeCameras.length>0)for(let e=0;e<this.activeCameras.length;e++)this._processSubCameras(this.activeCameras[e],e>0);else{if(!this.activeCamera)throw Error(`No camera defined`);this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._checkIntersections();for(let e of this._afterRenderStage)e.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let e=0;e<this._toBeDisposed.length;e++){let t=this._toBeDisposed[e];t&&t.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&=!1,this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=[],this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&=(this.activeCamera._activeMeshes.dispose(),null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;let e=this._activeRequests.slice();for(let t of e)t.abort();this._activeRequests.length=0;try{this.onDisposeObservable.notifyObservers(this)}catch(e){console.error(`An error occurred while calling onDisposeObservable!`,e)}if(this.detachControl(),this._engine.getInputElement())for(let e=0;e<this.cameras.length;e++)this.cameras[e].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,e=>e.dispose(!0)),this._disposeList(this.transformNodes,e=>e.dispose(!0));let t=this.cameras;this._disposeList(t),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let n=this._engine.scenes.indexOf(this);n>-1&&this._engine.scenes.splice(n,1),b._LastCreatedScene===this&&(this._engine.scenes.length>0?b._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:b._LastCreatedScene=null),n=this._engine._virtualScenes.indexOf(this),n>-1&&this._engine._virtualScenes.splice(n,1),this._engine.wipeCaches(!0),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onAfterRenderCameraObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onScenePerformancePriorityChangedObservable.clear(),this._isDisposed=!0}_disposeList(e,t){let n=e.slice(0);t??=(e=>e.dispose());for(let e of n)t(e);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){let t=this.meshes[e].geometry;t&&t.clearCachedData()}}cleanCachedTextureBuffer(){for(let e of this.textures)e._buffer&&=null}getWorldExtends(e){let t=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new N(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e||=(()=>!0),this.meshes.filter(e).forEach(e=>{if(e.computeWorldMatrix(!0),!e.subMeshes||e.subMeshes.length===0||e.infiniteDistance)return;let r=e.getBoundingInfo(),i=r.boundingBox.minimumWorld,a=r.boundingBox.maximumWorld;N.CheckExtends(i,t,n),N.CheckExtends(a,t,n)}),{min:t,max:n}}createPickingRay(e,t,n,r,i=!1){throw _(`Ray`)}createPickingRayToRef(e,t,n,r,i,a=!1,o=!1){throw _(`Ray`)}createPickingRayInCameraSpace(e,t,n){throw _(`Ray`)}createPickingRayInCameraSpaceToRef(e,t,n,r){throw _(`Ray`)}get _pickingAvailable(){return!1}pick(e,t,n,r,i,a){return new Jt}pickWithBoundingInfo(e,t,n,r,i){return new Jt}pickWithRay(e,t,n,r){throw _(`Ray`)}multiPick(e,t,n,r,i){throw _(`Ray`)}multiPickWithRay(e,t,n){throw _(`Ray`)}setPointerOverMesh(e,t,n){this._inputManager.setPointerOverMesh(e,t,n)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(let e of this._components)e.rebuild();for(let e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(let e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(let e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,n){if(t===void 0)return e;let r=[];for(let i in n||=(e=>{}),e){let a=e[i];j&&j.MatchesQuery(a,t)&&(r.push(a),n(a))}return r}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,n=null,r=null){this._renderingManager.setRenderingOrder(e,t,n,r)}setRenderingAutoClearDepthStencil(e,t,n=!0,r=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,n,r)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(let n of this.materials)t&&!t(n)||n.markAsDirty(e)}_loadFile(e,t,n,r,i,a,o){let s=We(e,t,n,r?this.offlineProvider:void 0,i,a,o);return this._activeRequests.push(s),s.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),s}_loadFileAsync(e,t,n,r,i){return new Promise((a,o)=>{this._loadFile(e,e=>{a(e)},t,n,r,(e,t)=>{o(t)},i)})}_requestFile(e,t,n,r,i,a,o){let s=Ge(e,t,n,r?this.offlineProvider:void 0,i,a,o);return this._activeRequests.push(s),s.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),s}_requestFileAsync(e,t,n,r,i){return new Promise((a,o)=>{this._requestFile(e,e=>{a(e)},t,n,r,e=>{o(e)},i)})}_readFile(e,t,n,r,i){let a=Ue(e,t,n,r,i);return this._activeRequests.push(a),a.onCompleteObservable.add(e=>{this._activeRequests.splice(this._activeRequests.indexOf(e),1)}),a}_readFileAsync(e,t,n){return new Promise((r,i)=>{this._readFile(e,e=>{r(e)},t,n,e=>{i(e)})})}getPerfCollector(){throw _(`performanceViewerSceneExtension`)}};q.FOGMODE_NONE=0,q.FOGMODE_EXP=1,q.FOGMODE_EXP2=2,q.FOGMODE_LINEAR=3,q.MinDeltaTime=1,q.MaxDeltaTime=1e3,q.prototype.setActiveCameraByID=function(e){return this.setActiveCameraById(e)},q.prototype.getLastMaterialByID=function(e){return this.getLastMaterialById(e)},q.prototype.getMaterialByID=function(e){return this.getMaterialById(e)},q.prototype.getTextureByUniqueID=function(e){return this.getTextureByUniqueId(e)},q.prototype.getCameraByID=function(e){return this.getCameraById(e)},q.prototype.getCameraByUniqueID=function(e){return this.getCameraByUniqueId(e)},q.prototype.getBoneByID=function(e){return this.getBoneById(e)},q.prototype.getLightByID=function(e){return this.getLightById(e)},q.prototype.getLightByUniqueID=function(e){return this.getLightByUniqueId(e)},q.prototype.getParticleSystemByID=function(e){return this.getParticleSystemById(e)},q.prototype.getGeometryByID=function(e){return this.getGeometryById(e)},q.prototype.getMeshByID=function(e){return this.getMeshById(e)},q.prototype.getMeshesByID=function(e){return this.getMeshesById(e)},q.prototype.getTransformNodeByID=function(e){return this.getTransformNodeById(e)},q.prototype.getTransformNodeByUniqueID=function(e){return this.getTransformNodeByUniqueId(e)},q.prototype.getTransformNodesByID=function(e){return this.getTransformNodesById(e)},q.prototype.getMeshByUniqueID=function(e){return this.getMeshByUniqueId(e)},q.prototype.getLastMeshByID=function(e){return this.getLastMeshById(e)},q.prototype.getLastEntryByID=function(e){return this.getLastEntryById(e)},q.prototype.getNodeByID=function(e){return this.getNodeById(e)},q.prototype.getLastSkeletonByID=function(e){return this.getLastSkeletonById(e)};var Mn=class{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new Nn(e)}sampleFrame(e=g.Now){if(this._enabled){if(this._lastFrameTimeMs!=null){let t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){let e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}},Nn=class{constructor(e){this._samples=Array(e),this.reset()}add(e){let t;if(this.isSaturated()){let e=this._samples[this._pos];t=e-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(e-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;let t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){let t=this._samples.length;return(e%t+t)%t}};k.prototype.setAlphaConstants=function(e,t,n,r){this._alphaState.setAlphaBlendConstants(e,t,n,r)},k.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode===e){if(!t){let t=e===0;this.depthCullingState.depthMask!==t&&(this.depthCullingState.depthMask=t)}return}switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}t||(this.depthCullingState.depthMask=e===0),this._alphaMode=e},k.prototype.getAlphaMode=function(){return this._alphaMode},k.prototype.setAlphaEquation=function(e){if(this._alphaEquation!==e){switch(e){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=e}},k.prototype.getAlphaEquation=function(){return this._alphaEquation};function Pn(e,t,n=!1,r){switch(e){case 3:{let e=(t instanceof ArrayBuffer,new Int8Array(t));return r&&e.set(new Int8Array(r)),e}case 0:{let e=(t instanceof ArrayBuffer,new Uint8Array(t));return r&&e.set(new Uint8Array(r)),e}case 4:{let e=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(n?t/2:t);return r&&e.set(new Int16Array(r)),e}case 5:case 8:case 9:case 10:case 2:{let e=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(n?t/2:t);return r&&e.set(new Uint16Array(r)),e}case 6:{let e=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(n?t/4:t);return r&&e.set(new Int32Array(r)),e}case 7:case 11:case 12:case 13:case 14:case 15:{let e=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(n?t/4:t);return r&&e.set(new Uint32Array(r)),e}case 1:{let e=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(n?t/4:t);return r&&e.set(new Float32Array(r)),e}}let i=(t instanceof ArrayBuffer,new Uint8Array(t));return r&&i.set(new Uint8Array(r)),i}k.prototype._readTexturePixelsSync=function(e,t,n,r=-1,i=0,a=null,o=!0,s=!1,c=0,l=0){let u=this._gl;if(!u)throw Error(`Engine does not have gl rendering context.`);if(!this._dummyFramebuffer){let e=u.createFramebuffer();if(!e)throw Error(`Unable to create dummy framebuffer`);this._dummyFramebuffer=e}u.bindFramebuffer(u.FRAMEBUFFER,this._dummyFramebuffer),r>-1?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+r,e._hardwareTexture?.underlyingResource,i):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,e._hardwareTexture?.underlyingResource,i);let d=e.type===void 0?u.UNSIGNED_BYTE:this._getWebGLTextureType(e.type);if(s)a||=Pn(e.type,4*t*n);else switch(d){case u.UNSIGNED_BYTE:a||=new Uint8Array(4*t*n),d=u.UNSIGNED_BYTE;break;default:a||=new Float32Array(4*t*n),d=u.FLOAT;break}return o&&this.flushFramebuffer(),u.readPixels(c,l,t,n,u.RGBA,d,a),u.bindFramebuffer(u.FRAMEBUFFER,this._currentFramebuffer),a},k.prototype._readTexturePixels=function(e,t,n,r=-1,i=0,a=null,o=!0,s=!1,c=0,l=0){return Promise.resolve(this._readTexturePixelsSync(e,t,n,r,i,a,o,s,c,l))},k.prototype.updateDynamicIndexBuffer=function(e,t,n=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(e);let r;r=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()},k.prototype.updateDynamicVertexBuffer=function(e,t,n,r){this.bindArrayBuffer(e),n===void 0&&(n=0);let i=t.byteLength||t.length;r===void 0||r>=i&&n===0?t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,n,new Float32Array(t)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,n,t):t instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(t).subarray(n,n+r)):(t=t instanceof ArrayBuffer?new Uint8Array(t,n,r):new Uint8Array(t.buffer,t.byteOffset+n,r),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t)),this._resetVertexBufferBinding()};var J=class e extends k{static get NpmPackage(){return k.NpmPackage}static get Version(){return k.Version}static get Instances(){return b.Instances}static get LastCreatedEngine(){return b.LastCreatedEngine}static get LastCreatedScene(){return b.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((n,r)=>{let i=new Image;i.onload=()=>{i.decode().then(()=>{this.createImageBitmap(i,t).then(e=>{n(e)})})},i.onerror=()=>{r(`Error loading image ${i.src}`)},i.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,n){let r=this.createCanvas(t,n).getContext(`2d`);if(!r)throw Error(`Unable to get 2d context for resizeImageBitmap`);return r.drawImage(e,0,0),r.getImageData(0,0,t,n).data}static MarkAllMaterialsAsDirty(t,n){for(let r=0;r<e.Instances.length;r++){let i=e.Instances[r];for(let e=0;e<i.scenes.length;e++)i.scenes[e].markAllMaterialsAsDirty(t,n)}}static DefaultLoadingScreenFactory(e){throw _(`LoadingScreen`)}get _supportsHardwareTextureRescaling(){return!!e._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}constructor(t,n,r,i=!1){if(super(t,n,r,i),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=[],this._virtualScenes=[],this.onNewSceneAddedObservable=new o,this.postProcesses=[],this.isPointerLock=!1,this.onResizeObservable=new o,this.onCanvasBlurObservable=new o,this.onCanvasFocusObservable=new o,this.onCanvasPointerOutObservable=new o,this.onBeginFrameObservable=new o,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new o,this.onBeforeShaderCompilationObservable=new o,this.onAfterShaderCompilationObservable=new o,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new En,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new Mn,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=[`main`],e.Instances.push(this),t){if(this._features.supportRenderPasses=!0,r=this._creationOptions,t.getContext){let e=t;this._sharedInit(e),this._connectVREvents()}this._prepareVRComponent(),r.autoEnableWebVR&&this.initWebVR()}}_initGLContext(){super._initGLContext(),this._rescalePostProcess=null}_sharedInit(t){super._sharedInit(t),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=e=>{this.disableContextMenu&&e.preventDefault()},t.addEventListener(`focus`,this._onCanvasFocus),t.addEventListener(`blur`,this._onCanvasBlur),t.addEventListener(`contextmenu`,this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=e=>{document.elementFromPoint(e.clientX,e.clientY)!==t&&this.onCanvasPointerOutObservable.notifyObservers(e)};let n=this.getHostWindow();n&&typeof n.addEventListener==`function`&&(n.addEventListener(`blur`,this._onBlur),n.addEventListener(`focus`,this._onFocus)),t.addEventListener(`pointerout`,this._onCanvasPointerOut),this._creationOptions.doNotHandleTouchAction||this._disableTouchAction(),!e.audioEngine&&this._creationOptions.audioEngine&&e.AudioEngineFactory&&(e.audioEngine=e.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination())),l()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&t&&e._RequestPointerlock(t)},document.addEventListener(`fullscreenchange`,this._onFullscreenChange,!1),document.addEventListener(`webkitfullscreenchange`,this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===t},document.addEventListener(`pointerlockchange`,this._onPointerLockChange,!1),document.addEventListener(`webkitpointerlockchange`,this._onPointerLockChange,!1)),this.enableOfflineSupport=e.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!this._creationOptions.deterministicLockstep,this._lockstepMaxSteps=this._creationOptions.lockstepMaxSteps||0,this._timeStep=this._creationOptions.timeStep||1/60}_verifyPointerLock(){var e;(e=this._onPointerLockChange)==null||e.call(this)}getAspectRatio(e,t=!1){let n=e.viewport;return this.getRenderWidth(t)*n.width/(this.getRenderHeight(t)*n.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){let n=this._gl;this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,e,!0),n.generateMipmap(n.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(n.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,n,r){let i=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,n,r),i}scissorClear(e,t,n,r,i){this.enableScissor(e,t,n,r),this.clear(i,!0,!0,!0),this.disableScissor()}enableScissor(e,t,n,r){let i=this._gl;i.enable(i.SCISSOR_TEST),i.scissor(e,t,n,r)}disableScissor(){let e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw _(`WebVRCamera`)}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,n){return new Promise((r,i)=>{this._loadFile(e,e=>{r(e)},void 0,t,n,(e,t)=>{i(t)})})}getVertexShaderSource(e){let t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){let t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,n,r){e!==void 0&&(t&&(this._boundUniforms[e]=t),!n||!n.depthStencilTexture?this._setTexture(e,null,void 0,void 0,r):this._setTexture(e,n,!1,!0,r))}setTextureFromPostProcess(e,t,n){let r=null;t&&(t._textures.data[t._currentRenderTextureInd]?r=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(r=t._forcedOutputTexture)),this._bindTexture(e,r?.texture??null,n)}setTextureFromPostProcessOutput(e,t,n){this._bindTexture(e,t?._outputTexture?.texture??null,n)}_rebuildBuffers(){for(let e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(let e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){let t=this._activeRenderLoops[e];t()}}_renderLoop(){if(!this._contextWasLost){let e=!0;(this.isDisposed||!this.renderEvenInBackground&&this._windowIsBackground)&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(t){this.isFullscreen||(this._pointerLockRequested=t,this._renderingCanvas&&e._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&e._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&e._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){e._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,n=!1){if(!this._renderingCanvas||!super.setSize(e,t,n))return!1;if(this.scenes){for(let e=0;e<this.scenes.length;e++){let t=this.scenes[e];for(let e=0;e<t.cameras.length;e++){let n=t.cameras[e];n._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){let t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,n,r,i,a=null){i||=this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);let o=super.createShaderProgram(e,t,n,r,i,a);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,n,r,i=null){let a=r.createProgram();if(e.program=a,!a)throw Error(`Unable to create program`);if(r.attachShader(a,t),r.attachShader(a,n),this.webGLVersion>1&&i){let t=this.createTransformFeedback();this.bindTransformFeedback(t),this.setTranformFeedbackVaryings(a,i),e.transformFeedback=t}return r.linkProgram(a),this.webGLVersion>1&&i&&this.bindTransformFeedback(null),e.context=r,e.vertexShader=t,e.fragmentShader=n,e.isParallelCompiled||this._finalizePipelineContext(e),a}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(t=>{t._outputTexture===e&&(t._outputTexture=null)}),t.cameras.forEach(t=>{t._postProcesses.forEach(t=>{t&&t._outputTexture===e&&(t._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(t){let n=++e._RenderPassIdCounter;return this._renderPassNames[n]=t??`NONAME`,n}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){let n=this.scenes[t];for(let t=0;t<n.meshes.length;++t){let r=n.meshes[t];if(r.subMeshes)for(let t=0;t<r.subMeshes.length;++t)r.subMeshes[t]._removeDrawWrapper(e)}}}_rescaleTexture(t,n,r,i,a){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);let o=this.createRenderTargetTexture({width:n.width,height:n.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&e._RescalePostProcessFactory&&(this._rescalePostProcess=e._RescalePostProcessFactory(this)),this._rescalePostProcess&&(this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(e){e._bindTexture(`textureSampler`,t)};let e=r;e||=this.scenes[this.scenes.length-1],e.postProcessManager.directRender([this._rescalePostProcess],o,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,n,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,i,0,0,n.width,n.height,0),this.unBindFramebuffer(o),o.dispose(),a&&a()}))}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e,t=!1,n=3){let r=new Ae(e,this._gl),i=new Ce(this,Se.Unknown,!0);return i._hardwareTexture=r,i.isReady=!0,i.useMipMaps=t,this.updateTextureSamplingMode(n,i),i}_uploadImageToTexture(e,t,n=0,r=0){let i=this._gl,a=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),s=this._getRGBABufferInternalSizedFormat(e.type,o),c=e.isCube?i.TEXTURE_CUBE_MAP:i.TEXTURE_2D;this._bindTextureDirectly(c,e,!0),this._unpackFlipY(e.invertY);let l=i.TEXTURE_2D;e.isCube&&(l=i.TEXTURE_CUBE_MAP_POSITIVE_X+n),i.texImage2D(l,r,s,o,a,t),this._bindTextureDirectly(c,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){f.Error(`WebGL 1 does not support texture comparison.`);return}let n=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_FUNC,t),n.texParameteri(n.TEXTURE_CUBE_MAP,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,515),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.NONE)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_FUNC,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_COMPARE_MODE,n.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){let t=this._gl.createBuffer();if(!t)throw Error(`Unable to create instance buffer`);let n=new De(t);return n.capacity=e,this.bindArrayBuffer(n),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),n.references=1,n}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,n=10){let r=this._gl;return new Promise((i,a)=>{let o=()=>{let s=r.clientWaitSync(e,t,0);if(s==r.WAIT_FAILED){a();return}if(s==r.TIMEOUT_EXPIRED){setTimeout(o,n);return}i()};o()})}_readPixelsAsync(e,t,n,r,i,a,o){if(this._webGLVersion<2)throw Error(`_readPixelsAsync only work on WebGL2+`);let s=this._gl,c=s.createBuffer();s.bindBuffer(s.PIXEL_PACK_BUFFER,c),s.bufferData(s.PIXEL_PACK_BUFFER,o.byteLength,s.STREAM_READ),s.readPixels(e,t,n,r,i,a,0),s.bindBuffer(s.PIXEL_PACK_BUFFER,null);let l=s.fenceSync(s.SYNC_GPU_COMMANDS_COMPLETE,0);return l?(s.flush(),this._clientWaitAsync(l,0,10).then(()=>(s.deleteSync(l),s.bindBuffer(s.PIXEL_PACK_BUFFER,c),s.getBufferSubData(s.PIXEL_PACK_BUFFER,0,o),s.bindBuffer(s.PIXEL_PACK_BUFFER,null),s.deleteBuffer(c),o))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();b.Instances.length===1&&e.audioEngine&&(e.audioEngine.dispose(),e.audioEngine=null),this.disableVR();let t=this.getHostWindow();t&&typeof t.removeEventListener==`function`&&(t.removeEventListener(`blur`,this._onBlur),t.removeEventListener(`focus`,this._onFocus)),this._renderingCanvas&&(this._renderingCanvas.removeEventListener(`focus`,this._onCanvasFocus),this._renderingCanvas.removeEventListener(`blur`,this._onCanvasBlur),this._renderingCanvas.removeEventListener(`pointerout`,this._onCanvasPointerOut),this._renderingCanvas.removeEventListener(`contextmenu`,this._onCanvasContextMenu)),l()&&(document.removeEventListener(`fullscreenchange`,this._onFullscreenChange),document.removeEventListener(`mozfullscreenchange`,this._onFullscreenChange),document.removeEventListener(`webkitfullscreenchange`,this._onFullscreenChange),document.removeEventListener(`msfullscreenchange`,this._onFullscreenChange),document.removeEventListener(`pointerlockchange`,this._onPointerLockChange),document.removeEventListener(`mspointerlockchange`,this._onPointerLockChange),document.removeEventListener(`mozpointerlockchange`,this._onPointerLockChange),document.removeEventListener(`webkitpointerlockchange`,this._onPointerLockChange)),super.dispose();let n=b.Instances.indexOf(this);n>=0&&b.Instances.splice(n,1),e.Instances.length||(b.OnEnginesDisposedObservable.notifyObservers(this),b.OnEnginesDisposedObservable.clear()),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute(`touch-action`,`none`),this._renderingCanvas.style.touchAction=`none`,this._renderingCanvas.style.webkitTapHighlightColor=`transparent`)}displayLoadingUI(){if(!s())return;let e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!s())return;let e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=e.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement(`video`)}static _RequestPointerlock(e){if(e.requestPointerLock){let t=e.requestPointerLock();t instanceof Promise?t.then(()=>{e.focus()}).catch(()=>{}):e.focus()}}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){let t=e.requestFullscreen||e.webkitRequestFullscreen;t&&t.call(e)}static _ExitFullscreen(){let e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){let t=document.createElement(`span`);t.innerHTML=`Hg`,t.setAttribute(`style`,`font: ${e} !important`);let n=document.createElement(`div`);n.style.display=`inline-block`,n.style.width=`1px`,n.style.height=`0px`,n.style.verticalAlign=`bottom`;let r=document.createElement(`div`);r.style.whiteSpace=`nowrap`,r.appendChild(t),r.appendChild(n),document.body.appendChild(r);let i=0,a=0;try{a=n.getBoundingClientRect().top-t.getBoundingClientRect().top,n.style.verticalAlign=`baseline`,i=n.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(r)}return{ascent:i,height:a,descent:a-i}}};J.ALPHA_DISABLE=0,J.ALPHA_ADD=1,J.ALPHA_COMBINE=2,J.ALPHA_SUBTRACT=3,J.ALPHA_MULTIPLY=4,J.ALPHA_MAXIMIZED=5,J.ALPHA_ONEONE=6,J.ALPHA_PREMULTIPLIED=7,J.ALPHA_PREMULTIPLIED_PORTERDUFF=8,J.ALPHA_INTERPOLATE=9,J.ALPHA_SCREENMODE=10,J.DELAYLOADSTATE_NONE=0,J.DELAYLOADSTATE_LOADED=1,J.DELAYLOADSTATE_LOADING=2,J.DELAYLOADSTATE_NOTLOADED=4,J.NEVER=512,J.ALWAYS=519,J.LESS=513,J.EQUAL=514,J.LEQUAL=515,J.GREATER=516,J.GEQUAL=518,J.NOTEQUAL=517,J.KEEP=7680,J.REPLACE=7681,J.INCR=7682,J.DECR=7683,J.INVERT=5386,J.INCR_WRAP=34055,J.DECR_WRAP=34056,J.TEXTURE_CLAMP_ADDRESSMODE=0,J.TEXTURE_WRAP_ADDRESSMODE=1,J.TEXTURE_MIRROR_ADDRESSMODE=2,J.TEXTUREFORMAT_ALPHA=0,J.TEXTUREFORMAT_LUMINANCE=1,J.TEXTUREFORMAT_LUMINANCE_ALPHA=2,J.TEXTUREFORMAT_RGB=4,J.TEXTUREFORMAT_RGBA=5,J.TEXTUREFORMAT_RED=6,J.TEXTUREFORMAT_R=6,J.TEXTUREFORMAT_RG=7,J.TEXTUREFORMAT_RED_INTEGER=8,J.TEXTUREFORMAT_R_INTEGER=8,J.TEXTUREFORMAT_RG_INTEGER=9,J.TEXTUREFORMAT_RGB_INTEGER=10,J.TEXTUREFORMAT_RGBA_INTEGER=11,J.TEXTURETYPE_UNSIGNED_BYTE=0,J.TEXTURETYPE_UNSIGNED_INT=0,J.TEXTURETYPE_FLOAT=1,J.TEXTURETYPE_HALF_FLOAT=2,J.TEXTURETYPE_BYTE=3,J.TEXTURETYPE_SHORT=4,J.TEXTURETYPE_UNSIGNED_SHORT=5,J.TEXTURETYPE_INT=6,J.TEXTURETYPE_UNSIGNED_INTEGER=7,J.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,J.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,J.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,J.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,J.TEXTURETYPE_UNSIGNED_INT_24_8=12,J.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,J.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,J.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,J.TEXTURE_NEAREST_SAMPLINGMODE=1,J.TEXTURE_BILINEAR_SAMPLINGMODE=2,J.TEXTURE_TRILINEAR_SAMPLINGMODE=3,J.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,J.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,J.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,J.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,J.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,J.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,J.TEXTURE_NEAREST_LINEAR=7,J.TEXTURE_NEAREST_NEAREST=1,J.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,J.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,J.TEXTURE_LINEAR_LINEAR=2,J.TEXTURE_LINEAR_NEAREST=12,J.TEXTURE_EXPLICIT_MODE=0,J.TEXTURE_SPHERICAL_MODE=1,J.TEXTURE_PLANAR_MODE=2,J.TEXTURE_CUBIC_MODE=3,J.TEXTURE_PROJECTION_MODE=4,J.TEXTURE_SKYBOX_MODE=5,J.TEXTURE_INVCUBIC_MODE=6,J.TEXTURE_EQUIRECTANGULAR_MODE=7,J.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,J.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,J.SCALEMODE_FLOOR=1,J.SCALEMODE_NEAREST=2,J.SCALEMODE_CEILING=3,J._RescalePostProcessFactory=null,J._RenderPassIdCounter=0;var Fn=class e{static get ForceFullSceneLoadingForIncremental(){return e._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(t){e._ForceFullSceneLoadingForIncremental=t}static get ShowLoadingScreen(){return e._ShowLoadingScreen}static set ShowLoadingScreen(t){e._ShowLoadingScreen=t}static get loggingLevel(){return e._LoggingLevel}static set loggingLevel(t){e._LoggingLevel=t}static get CleanBoneMatrixWeights(){return e._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(t){e._CleanBoneMatrixWeights=t}};Fn._ForceFullSceneLoadingForIncremental=!1,Fn._ShowLoadingScreen=!0,Fn._CleanBoneMatrixWeights=!1,Fn._LoggingLevel=0;var In;(function(e){e[e.Clean=0]=`Clean`,e[e.Stop=1]=`Stop`,e[e.Sync=2]=`Sync`,e[e.NoSync=3]=`NoSync`})(In||={});var Ln=class e{static get ForceFullSceneLoadingForIncremental(){return Fn.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){Fn.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return Fn.ShowLoadingScreen}static set ShowLoadingScreen(e){Fn.ShowLoadingScreen=e}static get loggingLevel(){return Fn.loggingLevel}static set loggingLevel(e){Fn.loggingLevel=e}static get CleanBoneMatrixWeights(){return Fn.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){Fn.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return e._RegisteredPlugins[`.babylon`]}static _GetPluginForExtension(t){return e._RegisteredPlugins[t]||(f.Warn(`Unable to find a plugin to load `+t+` files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes`),e.GetDefaultPlugin())}static _GetPluginForDirectLoad(t){for(let n in e._RegisteredPlugins){let r=e._RegisteredPlugins[n].plugin;if(r.canDirectLoad&&r.canDirectLoad(t))return e._RegisteredPlugins[n]}return e.GetDefaultPlugin()}static _GetPluginForFilename(t){let n=t.indexOf(`?`);n!==-1&&(t=t.substring(0,n));let r=t.lastIndexOf(`.`),i=t.substring(r,t.length).toLowerCase();return e._GetPluginForExtension(i)}static _GetDirectLoad(e){return e.substr(0,5)===`data:`?e.substr(5):null}static _FormatErrorMessage(e,t,n){let r=`Unable to load from `+e.url;return t?r+=`: ${t}`:n&&(r+=`: ${n}`),r}static _LoadData(t,n,r,i,a,o,s){let c=e._GetDirectLoad(t.url),l=s?e._GetPluginForExtension(s):c?e._GetPluginForDirectLoad(t.url):e._GetPluginForFilename(t.url),u;if(u=l.plugin.createPlugin===void 0?l.plugin:l.plugin.createPlugin(),!u)throw`The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.`;if(e.OnPluginActivatedObservable.notifyObservers(u),c&&(u.canDirectLoad&&u.canDirectLoad(t.url)||!qe(t.url))){if(u.directLoad){let e=u.directLoad(n,c);e.then?e.then(e=>{r(u,e)}).catch(e=>{a(`Error in directLoad of _loadData: `+e,e)}):r(u,e)}else r(u,c);return u}let d=l.isBinary,f=(e,t)=>{if(n.isDisposed){a(`Scene has been disposed`);return}r(u,e,t)},p=null,m=!1,h=u.onDisposeObservable;h&&h.add(()=>{m=!0,p&&=(p.abort(),null),o()});let g=()=>{if(m)return;let e=(e,t)=>{a(e?.statusText,t)},r=t.file||t.url;p=u.loadFile?u.loadFile(n,r,f,i,d,e):n._loadFile(r,f,i,!0,d,e)},_=n.getEngine(),v=_.enableOfflineSupport;if(v){let e=!1;for(let r of n.disableOfflineSupportExceptionRules)if(r.test(t.url)){e=!0;break}v=!e}return v&&J.OfflineProviderFactory?n.offlineProvider=J.OfflineProviderFactory(t.url,g,_.disableManifestCheck):g(),u}static _GetFileInfo(e,t){let n,r,i=null;if(!t)n=e,r=A.GetFilename(e),e=A.GetFolderPath(e);else if(t.name){let e=t;n=`file:${e.name}`,r=e.name,i=e}else if(typeof t==`string`&&t.startsWith(`data:`))n=t,r=``;else{let i=t;if(i.substr(0,1)===`/`)return A.Error(`Wrong sceneFilename parameter`),null;n=e+i,r=i}return{url:n,rootUrl:e,name:r,file:i}}static GetPluginForExtension(t){return e._GetPluginForExtension(t).plugin}static IsPluginForExtensionAvailable(t){return!!e._RegisteredPlugins[t]}static RegisterPlugin(t){if(typeof t.extensions==`string`){let n=t.extensions;e._RegisteredPlugins[n.toLowerCase()]={plugin:t,isBinary:!1}}else{let n=t.extensions;Object.keys(n).forEach(r=>{e._RegisteredPlugins[r.toLowerCase()]={plugin:t,isBinary:n[r].isBinary}})}}static ImportMesh(t,n,r=``,i=b.LastCreatedScene,a=null,o=null,s=null,c=null){if(!i)return f.Error(`No scene available to import mesh to`),null;let l=e._GetFileInfo(n,r);if(!l)return null;let u={};i.addPendingData(u);let d=()=>{i.removePendingData(u)},p=(t,n)=>{let r=e._FormatErrorMessage(l,t,n);s?s(i,r,new T(r,w.SceneLoaderError,n)):f.Error(r),d()},m=o?e=>{try{o(e)}catch(e){p(`Error in onProgress callback: `+e,e)}}:void 0,h=(e,t,n,r,o,s,c)=>{if(i.importedMeshesFiles.push(l.url),a)try{a(e,t,n,r,o,s,c)}catch(e){p(`Error in onSuccess callback: `+e,e)}i.removePendingData(u)};return e._LoadData(l,i,(e,n,r)=>{if(e.rewriteRootURL&&(l.rootUrl=e.rewriteRootURL(l.rootUrl,r)),e.importMesh){let r=e,a=[],o=[],s=[];if(!r.importMesh(t,i,n,l.rootUrl,a,o,s,p))return;i.loadingPluginName=e.name,h(a,o,s,[],[],[],[])}else e.importMeshAsync(t,i,n,l.rootUrl,m,l.name).then(t=>{i.loadingPluginName=e.name,h(t.meshes,t.particleSystems,t.skeletons,t.animationGroups,t.transformNodes,t.geometries,t.lights)}).catch(e=>{p(e.message,e)})},m,p,d,c)}static ImportMeshAsync(t,n,r=``,i=b.LastCreatedScene,a=null,o=null){return new Promise((s,c)=>{e.ImportMesh(t,n,r,i,(e,t,n,r,i,a,o)=>{s({meshes:e,particleSystems:t,skeletons:n,animationGroups:r,transformNodes:i,geometries:a,lights:o})},a,(e,t,n)=>{c(n||Error(t))},o)})}static Load(t,n=``,r=b.LastCreatedEngine,i=null,a=null,o=null,s=null){return r?e.Append(t,n,new q(r),i,a,o,s):(A.Error(`No engine available`),null)}static LoadAsync(t,n=``,r=b.LastCreatedEngine,i=null,a=null){return new Promise((o,s)=>{e.Load(t,n,r,e=>{o(e)},i,(e,t,n)=>{s(n||Error(t))},a)})}static Append(t,n=``,r=b.LastCreatedScene,i=null,a=null,o=null,s=null){if(!r)return f.Error(`No scene available to append to`),null;let c=e._GetFileInfo(t,n);if(!c)return null;let l={};r.addPendingData(l);let u=()=>{r.removePendingData(l)};e.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,r.getEngine().displayLoadingUI(),r.executeWhenReady(()=>{r.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));let d=(t,n)=>{let i=e._FormatErrorMessage(c,t,n);o?o(r,i,new T(i,w.SceneLoaderError,n)):f.Error(i),u()},p=a?e=>{try{a(e)}catch(e){d(`Error in onProgress callback`,e)}}:void 0,m=()=>{if(i)try{i(r)}catch(e){d(`Error in onSuccess callback`,e)}r.removePendingData(l)};return e._LoadData(c,r,(e,t)=>{if(e.load){if(!e.load(r,t,c.rootUrl,d))return;r.loadingPluginName=e.name,m()}else e.loadAsync(r,t,c.rootUrl,p,c.name).then(()=>{r.loadingPluginName=e.name,m()}).catch(e=>{d(e.message,e)})},p,d,u,s)}static AppendAsync(t,n=``,r=b.LastCreatedScene,i=null,a=null){return new Promise((o,s)=>{e.Append(t,n,r,e=>{o(e)},i,(e,t,n)=>{s(n||Error(t))},a)})}static LoadAssetContainer(t,n=``,r=b.LastCreatedScene,i=null,a=null,o=null,s=null){if(!r)return f.Error(`No scene available to load asset container to`),null;let c=e._GetFileInfo(t,n);if(!c)return null;let l={};r.addPendingData(l);let u=()=>{r.removePendingData(l)},d=(t,n)=>{let i=e._FormatErrorMessage(c,t,n);o?o(r,i,new T(i,w.SceneLoaderError,n)):f.Error(i),u()},p=a?e=>{try{a(e)}catch(e){d(`Error in onProgress callback`,e)}}:void 0,m=e=>{if(i)try{i(e)}catch(e){d(`Error in onSuccess callback`,e)}r.removePendingData(l)};return e._LoadData(c,r,(e,t)=>{if(e.loadAssetContainer){let n=e.loadAssetContainer(r,t,c.rootUrl,d);if(!n)return;r.loadingPluginName=e.name,m(n)}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(r,t,c.rootUrl,p,c.name).then(t=>{r.loadingPluginName=e.name,m(t)}).catch(e=>{d(e.message,e)}):d(`LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.`)},p,d,u,s)}static LoadAssetContainerAsync(t,n=``,r=b.LastCreatedScene,i=null,a=null){return new Promise((o,s)=>{e.LoadAssetContainer(t,n,r,e=>{o(e)},i,(e,t,n)=>{s(n||Error(t))},a)})}static ImportAnimations(e,t=``,n=b.LastCreatedScene,r=!0,i=In.Clean,a=null,o=null,s=null,c=null,l=null){if(!n){f.Error(`No scene available to load animations to`);return}if(r){for(let e of n.animatables)e.reset();n.stopAllAnimations(),n.animationGroups.slice().forEach(e=>{e.dispose()}),n.getNodes().forEach(e=>{e.animations&&=[]})}else switch(i){case In.Clean:n.animationGroups.slice().forEach(e=>{e.dispose()});break;case In.Stop:n.animationGroups.forEach(e=>{e.stop()});break;case In.Sync:n.animationGroups.forEach(e=>{e.reset(),e.restart()});break;case In.NoSync:break;default:f.Error(`Unknown animation group loading mode value '`+i+`'`);return}let u=n.animatables.length;this.LoadAssetContainer(e,t,n,e=>{e.mergeAnimationsTo(n,n.animatables.slice(u),a),e.dispose(),n.onAnimationFileImportedObservable.notifyObservers(n),o&&o(n)},s,c,l)}static ImportAnimationsAsync(t,n=``,r=b.LastCreatedScene,i=!0,a=In.Clean,o=null,s=null,c=null,l=null,u=null){return new Promise((s,l)=>{e.ImportAnimations(t,n,r,i,a,o,e=>{s(e)},c,(e,t,n)=>{l(n||Error(t))},u)})}};Ln.NO_LOGGING=0,Ln.MINIMAL_LOGGING=1,Ln.SUMMARY_LOGGING=2,Ln.DETAILED_LOGGING=3,Ln.OnPluginActivatedObservable=new o,Ln._RegisteredPlugins={},Ln._ShowingLoadingScreen=!1;var Rn=class{constructor(e,t,n){this.bu=e,this.bv=t,this.distance=n,this.faceId=0,this.subMeshId=0}},zn=class{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new o,this._onClonedObservable=new o}},Bn=class e{static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,n,r){let i=this._NodeConstructors[e];return i?i(t,n,r):null}set accessibilityTag(e){this._accessibilityTag=e,this.onAccessibilityTagChangedObservable.notifyObservers(e)}get accessibilityTag(){return this._accessibilityTag}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;let t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){let t=this._parentNode._children.indexOf(this);t!==-1&&this._parentNode._children.splice(t,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=[]),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){let e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return`Node`}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new zn,this.state=``,this.metadata=null,this.reservedDataStore=null,this._accessibilityTag=null,this.onAccessibilityTagChangedObservable=new o,this._parentContainer=null,this.animations=[],this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=F.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new o,this._onDisposeObserver=null,this._behaviors=[],this.name=e,this.id=e,this._scene=t||b.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)===-1?(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this):this}removeBehavior(e){let t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(let t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent===this._parentNode?this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized():(this._cache.parent=this._parentNode,!1)}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._syncParentEnabledState(),this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e))}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,n){if(this._children)for(let r=0;r<this._children.length;r++){let i=this._children[r];(!n||n(i))&&e.push(i),t||i._getDescendants(e,!1,n)}}getDescendants(e,t){let n=[];return this._getDescendants(n,e,t),n}getChildMeshes(e,t){let n=[];return this._getDescendants(n,e,e=>(!t||t(e))&&e.cullingStrategy!==void 0),n}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){let n=this.animations[t];if(n.name===e)return n}return null}createAnimationRange(t,n,r){if(!this._ranges[t]){this._ranges[t]=e._AnimationRangeFactory(t,n,r);for(let e=0,i=this.animations.length;e<i;e++)this.animations[e]&&this.animations[e].createRange(t,n,r)}}deleteAnimationRange(e,t=!0){for(let n=0,r=this.animations.length;n<r;n++)this.animations[n]&&this.animations[n].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e=[],t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,n,r){let i=this.getAnimationRange(e);return i?this._scene.beginAnimation(this,i.from,i.to,t,n,r):null}serializeAnimationRanges(){let e=[];for(let t in this._ranges){let n=this._ranges[t];if(!n)continue;let r={};r.name=t,r.from=n.from,r.to=n.to,e.push(r)}return e}computeWorldMatrix(e){return this._worldMatrix||=F.Identity(),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){let n=this.getDescendants(!0);for(let r of n)r.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(let e of this._behaviors)e.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,n){if(t.ranges)for(let n=0;n<t.ranges.length;n++){let r=t.ranges[n];e.createAnimationRange(r.name,r.from,r.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let n,r,i=this;if(i.getBoundingInfo&&i.subMeshes){let e=i.getBoundingInfo();n=e.boundingBox.minimumWorld.clone(),r=e.boundingBox.maximumWorld.clone()}else n=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new N(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){let e=this.getDescendants(!1);for(let i of e){let e=i;if(e.computeWorldMatrix(!0),t&&!t(e)||!e.getBoundingInfo||e.getTotalVertices()===0)continue;let a=e.getBoundingInfo().boundingBox,o=a.minimumWorld,s=a.maximumWorld;N.CheckExtends(o,n,r),N.CheckExtends(s,n,r)}}return{min:n,max:r}}};Bn._AnimationRangeFactory=(e,t,n)=>{throw _(`AnimationRange`)},Bn._NodeConstructors={},R([z()],Bn.prototype,`name`,void 0),R([z()],Bn.prototype,`id`,void 0),R([z()],Bn.prototype,`uniqueId`,void 0),R([z()],Bn.prototype,`state`,void 0),R([z()],Bn.prototype,`metadata`,void 0);var Vn=class e{constructor(e,t,n,r){this.x=e,this.y=t,this.width=n,this.height=r}toGlobal(t,n){return new e(this.x*t,this.y*n,this.width*t,this.height*n)}toGlobalToRef(e,t,n){return n.x=this.x*e,n.y=this.y*t,n.width=this.width*e,n.height=this.height*t,this}clone(){return new e(this.x,this.y,this.width,this.height)}},Y=class e extends Bn{get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){let t=0,n=0;if(this.mode===e.PERSPECTIVE_CAMERA)this.fovMode===e.FOVMODE_VERTICAL_FIXED?(n=this.minZ*2*Math.tan(this.fov/2),t=this.getEngine().getAspectRatio(this)*n):(t=this.minZ*2*Math.tan(this.fov/2),n=t/this.getEngine().getAspectRatio(this));else{let e=this.getEngine().getRenderWidth()/2,r=this.getEngine().getRenderHeight()/2;t=(this.orthoRight??e)-(this.orthoLeft??-e),n=(this.orthoTop??r)-(this.orthoBottom??-r)}return t*n}set orthoLeft(e){this._orthoLeft=e;for(let t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(let t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(let t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(let t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(let t of this._rigCameras)t.mode=e}get mode(){return this._mode}constructor(t,n,r,i=!0){super(t,r),this._position=N.Zero(),this._upVector=N.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=e.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Vn(0,0,1,1),this.layerMask=268435455,this.fovMode=e.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=e.RIG_MODE_NONE,this.customRenderTargets=[],this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new o,this.onProjectionMatrixChangedObservable=new o,this.onAfterCheckInputsObservable=new o,this.onRestoreStateObservable=new o,this.isRigCamera=!1,this._rigCameras=[],this._webvrViewMatrix=F.Identity(),this._skipRendering=!1,this._projectionMatrix=new F,this._postProcesses=[],this._activeMeshes=new it(256),this._globalPosition=N.Zero(),this._computedViewMatrix=F.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=F.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=P.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),i&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=n,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${t}`)}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return`Camera`}toString(e){let t=`Name: `+this.name;if(t+=`, type: `+this.getClassName(),this.animations)for(let n=0;n<this.animations.length;n++)t+=`, animation[0]: `+this.animations[n].toString(e);return t}applyVerticalCorrection(){let e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(let e of this._postProcesses)if(e&&!e.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let t=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!t)return!1;let n=this.getEngine();return t=this.mode===e.PERSPECTIVE_CAMERA?this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===n.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===n.getRenderWidth()&&this._cache.renderHeight===n.getRenderHeight(),t}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==e.RIG_MODE_NONE&&this._updateRigCameras(),this.getViewMatrix(),this.getProjectionMatrix()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){let e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let e=0,t=this._rigCameras.length;e<t;e++){let t=this._rigCameras[e],n=t._rigPostProcess;n?(n.getEffectName()===`pass`&&(t.isIntermediate=this._postProcesses.length===0),t._postProcesses=this._postProcesses.slice(0).concat(n),n.markTextureDirty()):t._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(f.Error(`You're trying to reuse a post process not defined as reusable.`),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){let t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()||this.getViewMatrix(),this._worldMatrix}_getViewMatrix(){return F.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(t){if(this._doNotComputeProjectionMatrix||!t&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;let n=this.getEngine(),r=this.getScene(),i=n.useReverseDepthBuffer;if(this.mode===e.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=n.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);let t;t=r.useRightHandedSystem?F.PerspectiveFovRHToRef:F.PerspectiveFovLHToRef,t(this.fov,n.getAspectRatio(this),i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===e.FOVMODE_VERTICAL_FIXED,n.isNDCHalfZRange,this.projectionPlaneTilt,i)}else{let e=n.getRenderWidth()/2,t=n.getRenderHeight()/2;r.useRightHandedSystem?F.OrthoOffCenterRHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-t,this.orthoTop??t,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,n.isNDCHalfZRange):F.OrthoOffCenterLHToRef(this.orthoLeft??-e,this.orthoRight??e,this.orthoBottom??-t,this.orthoTop??t,i?this.maxZ:this.minZ,i?this.minZ:this.maxZ,this._projectionMatrix,n.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=n.getRenderWidth(),this._cache.renderHeight=n.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){this._refreshFrustumPlanes&&=(this.getTransformationMatrix(),this._frustumPlanes?On.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=On.GetPlanes(this._transformMatrix),!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let t=!1;return this.rigCameras.forEach(n=>{n._updateFrustumPlanes(),t||=e.isInFrustum(n._frustumPlanes)}),t}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,n){throw _(`Ray`)}getForwardRayToRef(e,t=100,n,r){throw _(`Ray`)}dispose(t,n=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){let e=this._rigCameras.pop();e&&e.dispose()}if(this._parentContainer){let e=this._parentContainer.cameras.indexOf(this);e>-1&&this._parentContainer.cameras.splice(e,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==e.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let e=this._postProcesses.length;for(;--e>=0;){let t=this._postProcesses[e];t&&t.dispose(this)}}let r=this.customRenderTargets.length;for(;--r>=0;)this.customRenderTargets[r].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(t,n)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(t,n){if(this.cameraRigMode!==t){for(;this._rigCameras.length>0;){let e=this._rigCameras.pop();e&&e.dispose()}if(this.cameraRigMode=t,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=n.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=A.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==e.RIG_MODE_NONE){let e=this.createRigCamera(this.name+`_L`,0);e&&(e._isLeftCamera=!0);let t=this.createRigCamera(this.name+`_R`,1);t&&(t._isRightCamera=!0),e&&t&&(this._rigCameras.push(e),this._rigCameras.push(t))}this._setRigMode(n),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return F.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return F.Identity()}_getWebVRViewMatrix(){return F.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||={},this._cameraRigParams[e]=t,e===`interaxialDistance`&&(this._cameraRigParams.stereoHalfAngle=A.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===e.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){let e=B.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),B.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(t,n=null){let r=B.Clone(e.GetConstructorFromName(this.getClassName(),t,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return r.name=t,r.parent=n,this.onClonedObservable.notifyObservers(r),r}getDirection(e){let t=N.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){N.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(t,n,r,i=0,a=!0){return Bn.Construct(t,n,r,{interaxial_distance:i,isStereoscopicSideBySide:a})||(()=>e._CreateDefaultParsedCamera(n,r))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(t,n){let r=t.type,i=e.GetConstructorFromName(r,t.name,n,t.interaxial_distance,t.isStereoscopicSideBySide),a=B.Parse(i,t,n);if(t.parentId!==void 0&&(a._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(a._waitingParentInstanceIndex=t.parentInstanceIndex),a.inputs&&(a.inputs.parse(t),a._setupInputs()),t.upVector&&(a.upVector=N.FromArray(t.upVector)),a.setPosition&&(a.position.copyFromFloats(0,0,0),a.setPosition(N.FromArray(t.position))),t.target&&a.setTarget&&a.setTarget(N.FromArray(t.target)),t.cameraRigMode){let e=t.interaxial_distance?{interaxialDistance:t.interaxial_distance}:{};a.setCameraRigMode(t.cameraRigMode,e)}if(t.animations){for(let e=0;e<t.animations.length;e++){let n=t.animations[e],r=et(`BABYLON.Animation`);r&&a.animations.push(r.Parse(n))}Bn.ParseAnimationRanges(a,t,n)}return t.autoAnimate&&n.beginAnimation(a,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.isEnabled!==void 0&&a.setEnabled(t.isEnabled),a}};Y._CreateDefaultParsedCamera=(e,t)=>{throw _(`UniversalCamera`)},Y.PERSPECTIVE_CAMERA=0,Y.ORTHOGRAPHIC_CAMERA=1,Y.FOVMODE_VERTICAL_FIXED=0,Y.FOVMODE_HORIZONTAL_FIXED=1,Y.RIG_MODE_NONE=0,Y.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,Y.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,Y.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,Y.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,Y.RIG_MODE_STEREOSCOPIC_INTERLACED=14,Y.RIG_MODE_VR=20,Y.RIG_MODE_WEBVR=21,Y.RIG_MODE_CUSTOM=22,Y.ForceAttachControlToAlwaysPreventDefault=!1,R([zt(`position`)],Y.prototype,`_position`,void 0),R([zt(`upVector`)],Y.prototype,`_upVector`,void 0),R([z()],Y.prototype,`orthoLeft`,null),R([z()],Y.prototype,`orthoRight`,null),R([z()],Y.prototype,`orthoBottom`,null),R([z()],Y.prototype,`orthoTop`,null),R([z()],Y.prototype,`fov`,void 0),R([z()],Y.prototype,`projectionPlaneTilt`,void 0),R([z()],Y.prototype,`minZ`,void 0),R([z()],Y.prototype,`maxZ`,void 0),R([z()],Y.prototype,`inertia`,void 0),R([z()],Y.prototype,`mode`,null),R([z()],Y.prototype,`layerMask`,void 0),R([z()],Y.prototype,`fovMode`,void 0),R([z()],Y.prototype,`cameraRigMode`,void 0),R([z()],Y.prototype,`interaxialDistance`,void 0),R([z()],Y.prototype,`isStereoscopicSideBySide`,void 0);var Hn=class e{constructor(e,t,n=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=n}clone(){return new e(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(t,n,r=0){let i=e._TmpVector3[0].copyFromFloats(t.x-r,t.y-r,t.z-r),a=e._TmpVector3[1].copyFromFloats(n.x+r,n.y+r,n.z+r),o=0,s=Number.MAX_VALUE,c,l,u,d;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<i.x||this.origin.x>a.x)return!1}else if(c=1/this.direction.x,l=(i.x-this.origin.x)*c,u=(a.x-this.origin.x)*c,u===-1/0&&(u=1/0),l>u&&(d=l,l=u,u=d),o=Math.max(l,o),s=Math.min(u,s),o>s)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<i.y||this.origin.y>a.y)return!1}else if(c=1/this.direction.y,l=(i.y-this.origin.y)*c,u=(a.y-this.origin.y)*c,u===-1/0&&(u=1/0),l>u&&(d=l,l=u,u=d),o=Math.max(l,o),s=Math.min(u,s),o>s)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<i.z||this.origin.z>a.z)return!1}else if(c=1/this.direction.z,l=(i.z-this.origin.z)*c,u=(a.z-this.origin.z)*c,u===-1/0&&(u=1/0),l>u&&(d=l,l=u,u=d),o=Math.max(l,o),s=Math.min(u,s),o>s)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let n=e.center.x-this.origin.x,r=e.center.y-this.origin.y,i=e.center.z-this.origin.z,a=n*n+r*r+i*i,o=e.radius+t,s=o*o;if(a<=s)return!0;let c=n*this.direction.x+r*this.direction.y+i*this.direction.z;return c<0?!1:a-c*c<=s}intersectsTriangle(t,n,r){let i=e._TmpVector3[0],a=e._TmpVector3[1],o=e._TmpVector3[2],s=e._TmpVector3[3],c=e._TmpVector3[4];n.subtractToRef(t,i),r.subtractToRef(t,a),N.CrossToRef(this.direction,a,o);let l=N.Dot(i,o);if(l===0)return null;let u=1/l;this.origin.subtractToRef(t,s);let d=N.Dot(s,o)*u;if(d<0||d>1)return null;N.CrossToRef(s,i,c);let f=N.Dot(this.direction,c)*u;if(f<0||d+f>1)return null;let p=N.Dot(a,c)*u;return p>this.length?null:new Rn(1-d-f,d,p)}intersectsPlane(e){let t,n=N.Dot(e.normal,this.direction);if(Math.abs(n)<9.99999997475243e-7)return null;{let r=N.Dot(e.normal,this.origin);return t=(-e.d-r)/n,t<0?t<-9.99999997475243e-7?null:0:t}}intersectsAxis(e,t=0){switch(e){case`y`:{let e=(this.origin.y-t)/this.direction.y;return e>0?null:new N(this.origin.x+this.direction.x*-e,t,this.origin.z+this.direction.z*-e)}case`x`:{let e=(this.origin.x-t)/this.direction.x;return e>0?null:new N(t,this.origin.y+this.direction.y*-e,this.origin.z+this.direction.z*-e)}case`z`:{let e=(this.origin.z-t)/this.direction.z;return e>0?null:new N(this.origin.x+this.direction.x*-e,this.origin.y+this.direction.y*-e,t)}default:return null}}intersectsMesh(t,n){let r=L.Matrix[0];return t.getWorldMatrix().invertToRef(r),this._tmpRay?e.TransformToRef(this,r,this._tmpRay):this._tmpRay=e.Transform(this,r),t.intersects(this._tmpRay,n)}intersectsMeshes(e,t,n){n?n.length=0:n=[];for(let r=0;r<e.length;r++){let i=this.intersectsMesh(e[r],t);i.hit&&n.push(i)}return n.sort(this._comparePickingInfo),n}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(t,n,r){let i=this.origin,a=L.Vector3[0],o=L.Vector3[1],s=L.Vector3[2],c=L.Vector3[3];n.subtractToRef(t,a),this.direction.scaleToRef(e._Rayl,s),i.addToRef(s,o),t.subtractToRef(i,c);let l=N.Dot(a,a),u=N.Dot(a,s),d=N.Dot(s,s),f=N.Dot(a,c),p=N.Dot(s,c),m=l*d-u*u,h,g=m,_,v=m;m<e._Smallnum?(h=0,g=1,_=p,v=d):(h=u*p-d*f,_=l*p-u*f,h<0?(h=0,_=p,v=d):h>g&&(h=g,_=p+u,v=d)),_<0?(_=0,-f<0?h=0:-f>l?h=g:(h=-f,g=l)):_>v&&(_=v,-f+u<0?h=0:-f+u>l?h=g:(h=-f+u,g=l));let y=Math.abs(h)<e._Smallnum?0:h/g,b=Math.abs(_)<e._Smallnum?0:_/v,x=L.Vector3[4];s.scaleToRef(b,x);let S=L.Vector3[5];a.scaleToRef(y,S),S.addInPlace(c);let C=L.Vector3[6];return S.subtractToRef(x,C),b>0&&b<=this.length&&C.lengthSquared()<r*r?S.length():-1}update(t,n,r,i,a,o,s,c=!1){if(c){e._RayDistant||=e.Zero(),e._RayDistant.unprojectRayToRef(t,n,r,i,F.IdentityReadOnly,o,s);let c=L.Matrix[0];a.invertToRef(c),e.TransformToRef(e._RayDistant,c,this)}else this.unprojectRayToRef(t,n,r,i,a,o,s);return this}static Zero(){return new e(N.Zero(),N.Zero())}static CreateNew(t,n,r,i,a,o,s){return e.Zero().update(t,n,r,i,a,o,s)}static CreateNewFromTo(t,n,r=F.IdentityReadOnly){let i=n.subtract(t),a=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z);return i.normalize(),e.Transform(new e(t,i,a),r)}static Transform(t,n){let r=new e(new N(0,0,0),new N(0,0,0));return e.TransformToRef(t,n,r),r}static TransformToRef(e,t,n){N.TransformCoordinatesToRef(e.origin,t,n.origin),N.TransformNormalToRef(e.direction,t,n.direction),n.length=e.length;let r=n.direction,i=r.length();if(!(i===0||i===1)){let e=1/i;r.x*=e,r.y*=e,r.z*=e,n.length*=i}}unprojectRayToRef(e,t,n,r,i,a,o){var s;let c=L.Matrix[0];i.multiplyToRef(a,c),c.multiplyToRef(o,c),c.invert();let l=L.Vector3[0];l.x=e/n*2-1,l.y=-(t/r*2-1),l.z=(s=b.LastCreatedEngine)!=null&&s.isNDCHalfZRange?0:-1;let u=L.Vector3[1].copyFromFloats(l.x,l.y,.99999999),d=L.Vector3[2],f=L.Vector3[3];N._UnprojectFromInvertedMatrixToRef(l,c,d),N._UnprojectFromInvertedMatrixToRef(u,c,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}};Hn._TmpVector3=dt.BuildArray(6,N.Zero),Hn._RayDistant=Hn.Zero(),Hn._Smallnum=1e-8,Hn._Rayl=1e9,q.prototype.createPickingRay=function(e,t,n,r,i=!1){let a=Hn.Zero();return this.createPickingRayToRef(e,t,n,a,r,i),a},q.prototype.createPickingRayToRef=function(e,t,n,r,i,a=!1,o=!1){let s=this.getEngine();if(!i){if(!this.activeCamera)return this;i=this.activeCamera}let c=i.viewport.toGlobal(s.getRenderWidth(),s.getRenderHeight());return e=e/s.getHardwareScalingLevel()-c.x,t=t/s.getHardwareScalingLevel()-(s.getRenderHeight()-c.y-c.height),r.update(e,t,c.width,c.height,n||F.IdentityReadOnly,a?F.IdentityReadOnly:i.getViewMatrix(),i.getProjectionMatrix(),o),this},q.prototype.createPickingRayInCameraSpace=function(e,t,n){let r=Hn.Zero();return this.createPickingRayInCameraSpaceToRef(e,t,r,n),r},q.prototype.createPickingRayInCameraSpaceToRef=function(e,t,n,r){if(!Jt)return this;let i=this.getEngine();if(!r){if(!this.activeCamera)throw Error(`Active camera not set`);r=this.activeCamera}let a=r.viewport.toGlobal(i.getRenderWidth(),i.getRenderHeight()),o=F.Identity();return e=e/i.getHardwareScalingLevel()-a.x,t=t/i.getHardwareScalingLevel()-(i.getRenderHeight()-a.y-a.height),n.update(e,t,a.width,a.height,o,o,r.getProjectionMatrix()),this},q.prototype._internalPickForMesh=function(e,t,n,r,i,a,o,s){let c=t(r,n.enableDistantPicking),l=n.intersects(c,i,o,a,r,s);return!l||!l.hit||!i&&e!=null&&l.distance>=e.distance?null:l},q.prototype._internalPick=function(e,t,n,r,i){let a=null,o=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),s=this.cameraToUseForPointers||this.activeCamera;for(let c=0;c<this.meshes.length;c++){let l=this.meshes[c];if(t){if(!t(l))continue}else if(!l.isEnabled()||!l.isVisible||!l.isPickable)continue;let u=o&&l.isWorldMatrixCameraDependent(),d=l.computeWorldMatrix(u,s);if(l.hasThinInstances&&l.thinInstanceEnablePicking){let t=this._internalPickForMesh(a,e,l,d,!0,!0,i);if(t){if(r)return t;let o=L.Matrix[1],s=l.thinInstanceGetWorldMatrices();for(let t=0;t<s.length;t++){s[t].multiplyToRef(d,o);let c=this._internalPickForMesh(a,e,l,o,n,r,i,!0);if(c&&(a=c,a.thinInstanceIndex=t,n))return a}}}else{let t=this._internalPickForMesh(a,e,l,d,n,r,i);if(t&&(a=t,n))return a}}return a||new Jt},q.prototype._internalMultiPick=function(e,t,n){if(!Jt)return null;let r=[],i=!!(this.activeCameras&&this.activeCameras.length>1&&this.cameraToUseForPointers!==this.activeCamera),a=this.cameraToUseForPointers||this.activeCamera;for(let o=0;o<this.meshes.length;o++){let s=this.meshes[o];if(t){if(!t(s))continue}else if(!s.isEnabled()||!s.isVisible||!s.isPickable)continue;let c=i&&s.isWorldMatrixCameraDependent(),l=s.computeWorldMatrix(c,a);if(s.hasThinInstances&&s.thinInstanceEnablePicking){if(this._internalPickForMesh(null,e,s,l,!0,!0,n)){let t=L.Matrix[1],i=s.thinInstanceGetWorldMatrices();for(let a=0;a<i.length;a++){i[a].multiplyToRef(l,t);let o=this._internalPickForMesh(null,e,s,t,!1,!1,n,!0);o&&(o.thinInstanceIndex=a,r.push(o))}}}else{let t=this._internalPickForMesh(null,e,s,l,!1,!1,n);t&&r.push(t)}}return r},q.prototype.pickWithBoundingInfo=function(e,t,n,r,i){if(!Jt)return null;let a=this._internalPick(n=>(this._tempPickingRay||=Hn.Zero(),this.createPickingRayToRef(e,t,n,this._tempPickingRay,i||null),this._tempPickingRay),n,r,!0);return a&&(a.ray=this.createPickingRay(e,t,F.Identity(),i||null)),a},Object.defineProperty(q.prototype,`_pickingAvailable`,{get:()=>!0,enumerable:!1,configurable:!1}),q.prototype.pick=function(e,t,n,r,i,a,o=!1){let s=this._internalPick((n,r)=>(this._tempPickingRay||=Hn.Zero(),this.createPickingRayToRef(e,t,n,this._tempPickingRay,i||null,!1,r),this._tempPickingRay),n,r,!1,a);return s&&(s.ray=this.createPickingRay(e,t,F.Identity(),i||null)),s},q.prototype.pickWithRay=function(e,t,n,r){let i=this._internalPick(t=>(this._pickWithRayInverseMatrix||=F.Identity(),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||=Hn.Zero(),Hn.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),t,n,!1,r);return i&&(i.ray=e),i},q.prototype.multiPick=function(e,t,n,r,i){return this._internalMultiPick(n=>this.createPickingRay(e,t,n,r||null),n,i)},q.prototype.multiPickWithRay=function(e,t,n){return this._internalMultiPick(t=>(this._pickWithRayInverseMatrix||=F.Identity(),t.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||=Hn.Zero(),Hn.TransformToRef(e,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),t,n)},Y.prototype.getForwardRay=function(e=100,t,n){return this.getForwardRayToRef(new Hn(N.Zero(),N.Zero(),e),e,t,n)},Y.prototype.getForwardRayToRef=function(e,t=100,n,r){return n||=this.getWorldMatrix(),e.length=t,r?e.origin.copyFrom(r):e.origin.copyFrom(this.position),L.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),N.TransformNormalToRef(L.Vector3[2],n,L.Vector3[3]),N.NormalizeToRef(L.Vector3[3],e.direction),e};function Un(e,t,n){try{let r=e.next();r.done?t(r):r.value?r.value.then(()=>{r.value=void 0,t(r)},n):t(r)}catch(e){n(e)}}function Wn(e=25){let t;return(n,r,i)=>{let a=performance.now();t===void 0||a-t>e?(t=a,setTimeout(()=>{Un(n,r,i)},0)):Un(n,r,i)}}function Gn(e,t,n,r,i){let a=()=>{let o,s=e=>{e.done?n(e.value):o===void 0?o=!0:a()};do o=void 0,!i||!i.aborted?t(e,s,r):r(Error(`Aborted`)),o===void 0&&(o=!1);while(o)};a()}function Kn(e,t){let n;return Gn(e,Un,e=>n=e,e=>{throw e},t),n}function qn(e,t,n){return new Promise((r,i)=>{Gn(e,t,r,i,n)})}function Jn(e,t){return(...n)=>Kn(e(...n),t)}var X=class e{constructor(){this._applyTo=Jn(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||f.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case H.PositionKind:this.positions=e;break;case H.NormalKind:this.normals=e;break;case H.TangentKind:this.tangents=e;break;case H.UVKind:this.uvs=e;break;case H.UV2Kind:this.uvs2=e;break;case H.UV3Kind:this.uvs3=e;break;case H.UV4Kind:this.uvs4=e;break;case H.UV5Kind:this.uvs5=e;break;case H.UV6Kind:this.uvs6=e;break;case H.ColorKind:this.colors=e;break;case H.MatricesIndicesKind:this.matricesIndices=e;break;case H.MatricesWeightsKind:this.matricesWeights=e;break;case H.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case H.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,n){return this.positions&&(e.setVerticesData(H.PositionKind,this.positions,t),n&&(yield)),this.normals&&(e.setVerticesData(H.NormalKind,this.normals,t),n&&(yield)),this.tangents&&(e.setVerticesData(H.TangentKind,this.tangents,t),n&&(yield)),this.uvs&&(e.setVerticesData(H.UVKind,this.uvs,t),n&&(yield)),this.uvs2&&(e.setVerticesData(H.UV2Kind,this.uvs2,t),n&&(yield)),this.uvs3&&(e.setVerticesData(H.UV3Kind,this.uvs3,t),n&&(yield)),this.uvs4&&(e.setVerticesData(H.UV4Kind,this.uvs4,t),n&&(yield)),this.uvs5&&(e.setVerticesData(H.UV5Kind,this.uvs5,t),n&&(yield)),this.uvs6&&(e.setVerticesData(H.UV6Kind,this.uvs6,t),n&&(yield)),this.colors&&(e.setVerticesData(H.ColorKind,this.colors,t),n&&(yield)),this.matricesIndices&&(e.setVerticesData(H.MatricesIndicesKind,this.matricesIndices,t),n&&(yield)),this.matricesWeights&&(e.setVerticesData(H.MatricesWeightsKind,this.matricesWeights,t),n&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(H.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),n&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(H.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),n&&(yield)),this.indices?(e.setIndices(this.indices,null,t),n&&(yield)):e.setIndices([],null),this}_update(e,t,n){return this.positions&&e.updateVerticesData(H.PositionKind,this.positions,t,n),this.normals&&e.updateVerticesData(H.NormalKind,this.normals,t,n),this.tangents&&e.updateVerticesData(H.TangentKind,this.tangents,t,n),this.uvs&&e.updateVerticesData(H.UVKind,this.uvs,t,n),this.uvs2&&e.updateVerticesData(H.UV2Kind,this.uvs2,t,n),this.uvs3&&e.updateVerticesData(H.UV3Kind,this.uvs3,t,n),this.uvs4&&e.updateVerticesData(H.UV4Kind,this.uvs4,t,n),this.uvs5&&e.updateVerticesData(H.UV5Kind,this.uvs5,t,n),this.uvs6&&e.updateVerticesData(H.UV6Kind,this.uvs6,t,n),this.colors&&e.updateVerticesData(H.ColorKind,this.colors,t,n),this.matricesIndices&&e.updateVerticesData(H.MatricesIndicesKind,this.matricesIndices,t,n),this.matricesWeights&&e.updateVerticesData(H.MatricesWeightsKind,this.matricesWeights,t,n),this.matricesIndicesExtra&&e.updateVerticesData(H.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,n),this.matricesWeightsExtra&&e.updateVerticesData(H.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,n),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,n=0,r=e.length){let i=L.Vector3[0],a=L.Vector3[1];for(let o=n;o<n+r;o+=3)N.FromArrayToRef(e,o,i),N.TransformCoordinatesToRef(i,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector3Normals(e,t,n=0,r=e.length){let i=L.Vector3[0],a=L.Vector3[1];for(let o=n;o<n+r;o+=3)N.FromArrayToRef(e,o,i),N.TransformNormalToRef(i,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z}static _TransformVector4Normals(e,t,n=0,r=e.length){let i=L.Vector4[0],a=L.Vector4[1];for(let o=n;o<n+r;o+=4)_t.FromArrayToRef(e,o,i),_t.TransformNormalToRef(i,t,a),e[o]=a.x,e[o+1]=a.y,e[o+2]=a.z,e[o+3]=a.w}static _FlipFaces(e,t=0,n=e.length){for(let r=t;r<t+n;r+=3){let t=e[r+1];e[r+1]=e[r+2],e[r+2]=t}}transform(t){let n=t.determinant()<0;return this.positions&&e._TransformVector3Coordinates(this.positions,t),this.normals&&e._TransformVector3Normals(this.normals,t),this.tangents&&e._TransformVector4Normals(this.tangents,t),n&&this.indices&&e._FlipFaces(this.indices),this}merge(e,t=!1,n=!1){let r=Array.isArray(e)?e.map(e=>({vertexData:e})):[{vertexData:e}];return Kn(this._mergeCoroutine(void 0,r,t,!1,n))}*_mergeCoroutine(t,n,r=!1,i,a){this._validate();let o=n.map(e=>e.vertexData);for(let e of o)if(e._validate(),!this.normals!=!e.normals||!this.tangents!=!e.tangents||!this.uvs!=!e.uvs||!this.uvs2!=!e.uvs2||!this.uvs3!=!e.uvs3||!this.uvs4!=!e.uvs4||!this.uvs5!=!e.uvs5||!this.uvs6!=!e.uvs6||!this.colors!=!e.colors||!this.matricesIndices!=!e.matricesIndices||!this.matricesWeights!=!e.matricesWeights||!this.matricesIndicesExtra!=!e.matricesIndicesExtra||!this.matricesWeightsExtra!=!e.matricesWeightsExtra)throw Error(`Cannot merge vertex data that do not have the same set of attributes`);let s=o.reduce((e,t)=>e+(t.indices?.length??0),this.indices?.length??0),c=a||o.some(e=>e.indices===this.indices)?this.indices?.slice():this.indices;if(s>0){let a=c?.length??0;if(c||=Array(s),c.length!==s){if(Array.isArray(c))c.length=s;else{let e=r||c instanceof Uint32Array?new Uint32Array(s):new Uint16Array(s);e.set(c),c=e}t&&t.determinant()<0&&e._FlipFaces(c,0,a)}let o=this.positions?this.positions.length/3:0;for(let{vertexData:t,transform:r}of n)if(t.indices){for(let e=0;e<t.indices.length;e++)c[a+e]=t.indices[e]+o;r&&r.determinant()<0&&e._FlipFaces(c,a,t.indices.length),o+=t.positions.length/3,a+=t.indices.length,i&&(yield)}}return this.indices=c,this.positions=e._MergeElement(H.PositionKind,this.positions,t,n.map(e=>[e.vertexData.positions,e.transform])),i&&(yield),this.normals=e._MergeElement(H.NormalKind,this.normals,t,n.map(e=>[e.vertexData.normals,e.transform])),i&&(yield),this.tangents=e._MergeElement(H.TangentKind,this.tangents,t,n.map(e=>[e.vertexData.tangents,e.transform])),i&&(yield),this.uvs=e._MergeElement(H.UVKind,this.uvs,t,n.map(e=>[e.vertexData.uvs,e.transform])),i&&(yield),this.uvs2=e._MergeElement(H.UV2Kind,this.uvs2,t,n.map(e=>[e.vertexData.uvs2,e.transform])),i&&(yield),this.uvs3=e._MergeElement(H.UV3Kind,this.uvs3,t,n.map(e=>[e.vertexData.uvs3,e.transform])),i&&(yield),this.uvs4=e._MergeElement(H.UV4Kind,this.uvs4,t,n.map(e=>[e.vertexData.uvs4,e.transform])),i&&(yield),this.uvs5=e._MergeElement(H.UV5Kind,this.uvs5,t,n.map(e=>[e.vertexData.uvs5,e.transform])),i&&(yield),this.uvs6=e._MergeElement(H.UV6Kind,this.uvs6,t,n.map(e=>[e.vertexData.uvs6,e.transform])),i&&(yield),this.colors=e._MergeElement(H.ColorKind,this.colors,t,n.map(e=>[e.vertexData.colors,e.transform])),i&&(yield),this.matricesIndices=e._MergeElement(H.MatricesIndicesKind,this.matricesIndices,t,n.map(e=>[e.vertexData.matricesIndices,e.transform])),i&&(yield),this.matricesWeights=e._MergeElement(H.MatricesWeightsKind,this.matricesWeights,t,n.map(e=>[e.vertexData.matricesWeights,e.transform])),i&&(yield),this.matricesIndicesExtra=e._MergeElement(H.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,n.map(e=>[e.vertexData.matricesIndicesExtra,e.transform])),i&&(yield),this.matricesWeightsExtra=e._MergeElement(H.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,n.map(e=>[e.vertexData.matricesWeightsExtra,e.transform])),this}static _MergeElement(t,n,r,i){let a=i.filter(e=>e[0]!==null&&e[0]!==void 0);if(!n&&a.length==0)return n;if(!n)return this._MergeElement(t,a[0][0],a[0][1],a.slice(1));let o=a.reduce((e,t)=>e+t[0].length,n.length),s=t===H.PositionKind?e._TransformVector3Coordinates:t===H.NormalKind?e._TransformVector3Normals:t===H.TangentKind?e._TransformVector4Normals:()=>{};if(n instanceof Float32Array){let e=new Float32Array(o);e.set(n),r&&s(e,r,0,n.length);let t=n.length;for(let[n,r]of a)e.set(n,t),r&&s(e,r,t,n.length),t+=n.length;return e}else{let e=Array(o);for(let t=0;t<n.length;t++)e[t]=n[t];r&&s(e,r,0,n.length);let t=n.length;for(let[n,r]of a){for(let r=0;r<n.length;r++)e[t+r]=n[r];r&&s(e,r,t,n.length),t+=n.length}return e}}_validate(){if(!this.positions)throw new T(`Positions are required`,w.MeshInvalidPositionsError);let e=(e,t)=>{let n=H.DeduceStride(e);if(t.length%n!==0)throw Error(`The `+e+`s array count must be a multiple of `+n);return t.length/n},t=e(H.PositionKind,this.positions),n=(n,r)=>{let i=e(n,r);if(i!==t)throw Error(`The `+n+`s element count (`+i+`) does not match the positions count (`+t+`)`)};this.normals&&n(H.NormalKind,this.normals),this.tangents&&n(H.TangentKind,this.tangents),this.uvs&&n(H.UVKind,this.uvs),this.uvs2&&n(H.UV2Kind,this.uvs2),this.uvs3&&n(H.UV3Kind,this.uvs3),this.uvs4&&n(H.UV4Kind,this.uvs4),this.uvs5&&n(H.UV5Kind,this.uvs5),this.uvs6&&n(H.UV6Kind,this.uvs6),this.colors&&n(H.ColorKind,this.colors),this.matricesIndices&&n(H.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&n(H.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&n(H.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&n(H.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){let e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(t,n,r){return e._ExtractFrom(t,n,r)}static ExtractFromGeometry(t,n,r){return e._ExtractFrom(t,n,r)}static _ExtractFrom(t,n,r){let i=new e;return t.isVerticesDataPresent(H.PositionKind)&&(i.positions=t.getVerticesData(H.PositionKind,n,r)),t.isVerticesDataPresent(H.NormalKind)&&(i.normals=t.getVerticesData(H.NormalKind,n,r)),t.isVerticesDataPresent(H.TangentKind)&&(i.tangents=t.getVerticesData(H.TangentKind,n,r)),t.isVerticesDataPresent(H.UVKind)&&(i.uvs=t.getVerticesData(H.UVKind,n,r)),t.isVerticesDataPresent(H.UV2Kind)&&(i.uvs2=t.getVerticesData(H.UV2Kind,n,r)),t.isVerticesDataPresent(H.UV3Kind)&&(i.uvs3=t.getVerticesData(H.UV3Kind,n,r)),t.isVerticesDataPresent(H.UV4Kind)&&(i.uvs4=t.getVerticesData(H.UV4Kind,n,r)),t.isVerticesDataPresent(H.UV5Kind)&&(i.uvs5=t.getVerticesData(H.UV5Kind,n,r)),t.isVerticesDataPresent(H.UV6Kind)&&(i.uvs6=t.getVerticesData(H.UV6Kind,n,r)),t.isVerticesDataPresent(H.ColorKind)&&(i.colors=t.getVerticesData(H.ColorKind,n,r)),t.isVerticesDataPresent(H.MatricesIndicesKind)&&(i.matricesIndices=t.getVerticesData(H.MatricesIndicesKind,n,r)),t.isVerticesDataPresent(H.MatricesWeightsKind)&&(i.matricesWeights=t.getVerticesData(H.MatricesWeightsKind,n,r)),t.isVerticesDataPresent(H.MatricesIndicesExtraKind)&&(i.matricesIndicesExtra=t.getVerticesData(H.MatricesIndicesExtraKind,n,r)),t.isVerticesDataPresent(H.MatricesWeightsExtraKind)&&(i.matricesWeightsExtra=t.getVerticesData(H.MatricesWeightsExtraKind,n,r)),i.indices=t.getIndices(n,r),i}static CreateRibbon(e){throw _(`ribbonBuilder`)}static CreateBox(e){throw _(`boxBuilder`)}static CreateTiledBox(e){throw _(`tiledBoxBuilder`)}static CreateTiledPlane(e){throw _(`tiledPlaneBuilder`)}static CreateSphere(e){throw _(`sphereBuilder`)}static CreateCylinder(e){throw _(`cylinderBuilder`)}static CreateTorus(e){throw _(`torusBuilder`)}static CreateLineSystem(e){throw _(`linesBuilder`)}static CreateDashedLines(e){throw _(`linesBuilder`)}static CreateGround(e){throw _(`groundBuilder`)}static CreateTiledGround(e){throw _(`groundBuilder`)}static CreateGroundFromHeightMap(e){throw _(`groundBuilder`)}static CreatePlane(e){throw _(`planeBuilder`)}static CreateDisc(e){throw _(`discBuilder`)}static CreatePolygon(e,t,n,r,i,a,o){throw _(`polygonBuilder`)}static CreateIcoSphere(e){throw _(`icoSphereBuilder`)}static CreatePolyhedron(e){throw _(`polyhedronBuilder`)}static CreateCapsule(e={orientation:N.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw _(`capsuleBuilder`)}static CreateTorusKnot(e){throw _(`torusKnotBuilder`)}static ComputeNormals(e,t,n,r){let i=0,a=0,o=0,s=0,c=0,l=0,u=0,d=0,f=0,p=0,m=0,h=0,g=0,_=0,v=0,y=0,b=0,x=0,S=0,C=0,w=!1,T=!1,E=!1,ee=!1,te=1,D=0,O=null;r&&(w=!!r.facetNormals,T=!!r.facetPositions,E=!!r.facetPartitioning,te=r.useRightHandedSystem===!0?-1:1,D=r.ratio||0,ee=!!r.depthSort,O=r.distanceTo,ee&&O===void 0&&(O=N.Zero()));let ne=0,re=0,ie=0,ae=0;for(E&&r&&r.bbSize&&(ne=r.subDiv.X*D/r.bbSize.x,re=r.subDiv.Y*D/r.bbSize.y,ie=r.subDiv.Z*D/r.bbSize.z,ae=r.subDiv.max*r.subDiv.max,r.facetPartitioning.length=0),i=0;i<e.length;i++)n[i]=0;let oe=t.length/3|0;for(i=0;i<oe;i++){if(h=t[i*3]*3,g=h+1,_=h+2,v=t[i*3+1]*3,y=v+1,b=v+2,x=t[i*3+2]*3,S=x+1,C=x+2,a=e[h]-e[v],o=e[g]-e[y],s=e[_]-e[b],c=e[x]-e[v],l=e[S]-e[y],u=e[C]-e[b],d=te*(o*u-s*l),f=te*(s*c-a*u),p=te*(a*l-o*c),m=Math.sqrt(d*d+f*f+p*p),m=m===0?1:m,d/=m,f/=m,p/=m,w&&r&&(r.facetNormals[i].x=d,r.facetNormals[i].y=f,r.facetNormals[i].z=p),T&&r&&(r.facetPositions[i].x=(e[h]+e[v]+e[x])/3,r.facetPositions[i].y=(e[g]+e[y]+e[S])/3,r.facetPositions[i].z=(e[_]+e[b]+e[C])/3),E&&r){let t=Math.floor((r.facetPositions[i].x-r.bInfo.minimum.x*D)*ne),n=Math.floor((r.facetPositions[i].y-r.bInfo.minimum.y*D)*re),a=Math.floor((r.facetPositions[i].z-r.bInfo.minimum.z*D)*ie),o=Math.floor((e[h]-r.bInfo.minimum.x*D)*ne),s=Math.floor((e[g]-r.bInfo.minimum.y*D)*re),c=Math.floor((e[_]-r.bInfo.minimum.z*D)*ie),l=Math.floor((e[v]-r.bInfo.minimum.x*D)*ne),u=Math.floor((e[y]-r.bInfo.minimum.y*D)*re),d=Math.floor((e[b]-r.bInfo.minimum.z*D)*ie),f=Math.floor((e[x]-r.bInfo.minimum.x*D)*ne),p=Math.floor((e[S]-r.bInfo.minimum.y*D)*re),m=Math.floor((e[C]-r.bInfo.minimum.z*D)*ie),w=o+r.subDiv.max*s+ae*c,T=l+r.subDiv.max*u+ae*d,E=f+r.subDiv.max*p+ae*m,ee=t+r.subDiv.max*n+ae*a;r.facetPartitioning[ee]=r.facetPartitioning[ee]?r.facetPartitioning[ee]:[],r.facetPartitioning[w]=r.facetPartitioning[w]?r.facetPartitioning[w]:[],r.facetPartitioning[T]=r.facetPartitioning[T]?r.facetPartitioning[T]:[],r.facetPartitioning[E]=r.facetPartitioning[E]?r.facetPartitioning[E]:[],r.facetPartitioning[w].push(i),T!=w&&r.facetPartitioning[T].push(i),E==T||E==w||r.facetPartitioning[E].push(i),ee==w||ee==T||ee==E||r.facetPartitioning[ee].push(i)}if(ee&&r&&r.facetPositions){let e=r.depthSortedFacets[i];e.ind=i*3,e.sqDistance=N.DistanceSquared(r.facetPositions[i],O)}n[h]+=d,n[g]+=f,n[_]+=p,n[v]+=d,n[y]+=f,n[b]+=p,n[x]+=d,n[S]+=f,n[C]+=p}for(i=0;i<n.length/3;i++)d=n[i*3],f=n[i*3+1],p=n[i*3+2],m=Math.sqrt(d*d+f*f+p*p),m=m===0?1:m,d/=m,f/=m,p/=m,n[i*3]=d,n[i*3+1]=f,n[i*3+2]=p}static _ComputeSides(t,n,r,i,a,o,s){let c=r.length,l=i.length,u,d;switch(t||=e.DEFAULTSIDE,t){case e.FRONTSIDE:break;case e.BACKSIDE:for(u=0;u<c;u+=3){let e=r[u];r[u]=r[u+2],r[u+2]=e}for(d=0;d<l;d++)i[d]=-i[d];break;case e.DOUBLESIDE:{let e=n.length,t=e/3;for(let t=0;t<e;t++)n[e+t]=n[t];for(u=0;u<c;u+=3)r[u+c]=r[u+2]+t,r[u+1+c]=r[u+1]+t,r[u+2+c]=r[u]+t;for(d=0;d<l;d++)i[l+d]=-i[d];let f=a.length,p=0;for(p=0;p<f;p++)a[p+f]=a[p];for(o||=new _t(0,0,1,1),s||=new _t(0,0,1,1),p=0,u=0;u<f/2;u++)a[p]=o.x+(o.z-o.x)*a[p],a[p+1]=o.y+(o.w-o.y)*a[p+1],a[p+f]=s.x+(s.z-s.x)*a[p+f],a[p+f+1]=s.y+(s.w-s.y)*a[p+f+1],p+=2;break}}}static ImportVertexData(t,n){let r=new e,i=t.positions;i&&r.set(i,H.PositionKind);let a=t.normals;a&&r.set(a,H.NormalKind);let o=t.tangents;o&&r.set(o,H.TangentKind);let s=t.uvs;s&&r.set(s,H.UVKind);let c=t.uv2s;c&&r.set(c,H.UV2Kind);let l=t.uv3s;l&&r.set(l,H.UV3Kind);let u=t.uv4s;u&&r.set(u,H.UV4Kind);let d=t.uv5s;d&&r.set(d,H.UV5Kind);let f=t.uv6s;f&&r.set(f,H.UV6Kind);let p=t.colors;p&&r.set(Tt.CheckColors4(p,i.length/3),H.ColorKind);let m=t.matricesIndices;m&&r.set(m,H.MatricesIndicesKind);let h=t.matricesWeights;h&&r.set(h,H.MatricesWeightsKind);let g=t.indices;g&&(r.indices=g),n.setAllVerticesData(r,t.updatable)}};X.FRONTSIDE=0,X.BACKSIDE=1,X.DOUBLESIDE=2,X.DEFAULTSIDE=0,R([Wt.filter((...[e])=>!Array.isArray(e))],X,`_TransformVector3Coordinates`,null),R([Wt.filter((...[e])=>!Array.isArray(e))],X,`_TransformVector3Normals`,null),R([Wt.filter((...[e])=>!Array.isArray(e))],X,`_TransformVector4Normals`,null),R([Wt.filter((...[e])=>!Array.isArray(e))],X,`_FlipFaces`,null);var Yn=class e{constructor(e,t,n){this.vectors=dt.BuildArray(8,N.Zero),this.center=N.Zero(),this.centerWorld=N.Zero(),this.extendSize=N.Zero(),this.extendSizeWorld=N.Zero(),this.directions=dt.BuildArray(3,N.Zero),this.vectorsWorld=dt.BuildArray(8,N.Zero),this.minimumWorld=N.Zero(),this.maximumWorld=N.Zero(),this.minimum=N.Zero(),this.maximum=N.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,n)}reConstruct(e,t,n){let r=e.x,i=e.y,a=e.z,o=t.x,s=t.y,c=t.z,l=this.vectors;this.minimum.copyFromFloats(r,i,a),this.maximum.copyFromFloats(o,s,c),l[0].copyFromFloats(r,i,a),l[1].copyFromFloats(o,s,c),l[2].copyFromFloats(o,i,a),l[3].copyFromFloats(r,s,a),l[4].copyFromFloats(r,i,c),l[5].copyFromFloats(o,s,a),l[6].copyFromFloats(r,s,c),l[7].copyFromFloats(o,i,c),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=n||F.IdentityReadOnly,this._update(this._worldMatrix)}scale(t){let n=e._TmpVector3,r=this.maximum.subtractToRef(this.minimum,n[0]),i=r.length();r.normalizeFromLength(i);let a=i*t,o=r.scaleInPlace(a*.5),s=this.center.subtractToRef(o,n[1]),c=this.center.addToRef(o,n[2]);return this.reConstruct(s,c,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){let t=this.minimumWorld,n=this.maximumWorld,r=this.directions,i=this.vectorsWorld,a=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),n.copyFrom(this.maximum);for(let e=0;e<8;++e)i[e].copyFrom(a[e]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),n.setAll(-Number.MAX_VALUE);for(let r=0;r<8;++r){let o=i[r];N.TransformCoordinatesToRef(a[r],e,o),t.minimizeInPlace(o),n.maximizeInPlace(o)}n.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),n.addToRef(t,this.centerWorld).scaleInPlace(.5)}N.FromArrayToRef(e.m,0,r[0]),N.FromArrayToRef(e.m,4,r[1]),N.FromArrayToRef(e.m,8,r[2]),this._worldMatrix=e}isInFrustum(t){return e.IsInFrustum(this.vectorsWorld,t)}isCompletelyInFrustum(t){return e.IsCompletelyInFrustum(this.vectorsWorld,t)}intersectsPoint(e){let t=this.minimumWorld,n=this.maximumWorld,r=t.x,i=t.y,a=t.z,o=n.x,s=n.y,c=n.z,l=e.x,u=e.y,d=e.z,f=-ut;return!(o-l<f||f>l-r||s-u<f||f>u-i||c-d<f||f>d-a)}intersectsSphere(t){return e.IntersectsSphere(this.minimumWorld,this.maximumWorld,t.centerWorld,t.radiusWorld)}intersectsMinMax(e,t){let n=this.minimumWorld,r=this.maximumWorld,i=n.x,a=n.y,o=n.z,s=r.x,c=r.y,l=r.z,u=e.x,d=e.y,f=e.z,p=t.x,m=t.y,h=t.z;return!(s<u||i>p||c<d||a>m||l<f||o>h)}dispose(){var e,t;(e=this._drawWrapperFront)==null||e.dispose(),(t=this._drawWrapperBack)==null||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(t,n,r,i){let a=e._TmpVector3[0];return N.ClampToRef(r,t,n,a),N.DistanceSquared(r,a)<=i*i}static IsCompletelyInFrustum(e,t){for(let n=0;n<6;++n){let r=t[n];for(let t=0;t<8;++t)if(r.dotCoordinate(e[t])<0)return!1}return!0}static IsInFrustum(e,t){for(let n=0;n<6;++n){let r=!0,i=t[n];for(let t=0;t<8;++t)if(i.dotCoordinate(e[t])>=0){r=!1;break}if(r)return!1}return!0}};Yn._TmpVector3=dt.BuildArray(3,N.Zero);var Xn=class e{constructor(e,t,n){this.center=N.Zero(),this.centerWorld=N.Zero(),this.minimum=N.Zero(),this.maximum=N.Zero(),this.reConstruct(e,t,n)}reConstruct(e,t,n){this.minimum.copyFrom(e),this.maximum.copyFrom(t);let r=N.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=r*.5,this._update(n||F.IdentityReadOnly)}scale(t){let n=this.radius*t,r=e._TmpVector3,i=r[0].setAll(n),a=this.center.subtractToRef(i,r[1]),o=this.center.addToRef(i,r[2]);return this.reConstruct(a,o,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(t){if(t.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{N.TransformCoordinatesToRef(this.center,t,this.centerWorld);let n=e._TmpVector3[0];N.TransformNormalFromFloatsToRef(1,1,1,t,n),this.radiusWorld=Math.max(Math.abs(n.x),Math.abs(n.y),Math.abs(n.z))*this.radius}}isInFrustum(e){let t=this.centerWorld,n=this.radiusWorld;for(let r=0;r<6;r++)if(e[r].dotCoordinate(t)<=-n)return!1;return!0}isCenterInFrustum(e){let t=this.centerWorld;for(let n=0;n<6;n++)if(e[n].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){let t=N.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){let n=N.DistanceSquared(e.centerWorld,t.centerWorld),r=e.radiusWorld+t.radiusWorld;return!(r*r<n)}static CreateFromCenterAndRadius(t,n,r){this._TmpVector3[0].copyFrom(t),this._TmpVector3[1].copyFromFloats(0,0,n),this._TmpVector3[2].copyFrom(t),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);let i=new e(this._TmpVector3[0],this._TmpVector3[2]);return r?i._worldMatrix=r:i._worldMatrix=F.Identity(),i}};Xn._TmpVector3=dt.BuildArray(3,N.Zero);var Zn={min:0,max:0},Qn={min:0,max:0},$n=(e,t,n)=>{let r=N.Dot(t.centerWorld,e),i=Math.abs(N.Dot(t.directions[0],e))*t.extendSize.x,a=Math.abs(N.Dot(t.directions[1],e))*t.extendSize.y,o=Math.abs(N.Dot(t.directions[2],e))*t.extendSize.z,s=i+a+o;n.min=r-s,n.max=r+s},er=(e,t,n)=>($n(e,t,Zn),$n(e,n,Qn),!(Zn.min>Qn.max||Qn.min>Zn.max)),tr=class e{constructor(e,t,n){this._isLocked=!1,this.boundingBox=new Yn(e,t,n),this.boundingSphere=new Xn(e,t,n)}reConstruct(e,t,n){this.boundingBox.reConstruct(e,t,n),this.boundingSphere.reConstruct(e,t,n)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(t,n){let r=e._TmpVector3[0].copyFrom(t).subtractInPlace(n),i=e._TmpVector3[1].copyFrom(t).addInPlace(n);return this.boundingBox.reConstruct(r,i,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(r,i,this.boundingBox.getWorldMatrix()),this}encapsulate(e){let t=N.Minimize(this.minimum,e),n=N.Maximize(this.maximum,e);return this.reConstruct(t,n,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){let t=L.Matrix[0];this.boundingBox.getWorldMatrix().invertToRef(t);let n=L.Vector3[0];return N.TransformCoordinatesToRef(e.boundingBox.minimumWorld,t,n),this.encapsulate(n),N.TransformCoordinatesToRef(e.boundingBox.maximumWorld,t,n),this.encapsulate(n),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){let t=this.boundingBox;return t.maximumWorld.subtractToRef(t.minimumWorld,e._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!Xn.Intersects(this.boundingSphere,e.boundingSphere)||!Yn.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;let n=this.boundingBox,r=e.boundingBox;return!(!er(n.directions[0],n,r)||!er(n.directions[1],n,r)||!er(n.directions[2],n,r)||!er(r.directions[0],n,r)||!er(r.directions[1],n,r)||!er(r.directions[2],n,r)||!er(N.Cross(n.directions[0],r.directions[0]),n,r)||!er(N.Cross(n.directions[0],r.directions[1]),n,r)||!er(N.Cross(n.directions[0],r.directions[2]),n,r)||!er(N.Cross(n.directions[1],r.directions[0]),n,r)||!er(N.Cross(n.directions[1],r.directions[1]),n,r)||!er(N.Cross(n.directions[1],r.directions[2]),n,r)||!er(N.Cross(n.directions[2],r.directions[0]),n,r)||!er(N.Cross(n.directions[2],r.directions[1]),n,r)||!er(N.Cross(n.directions[2],r.directions[2]),n,r))}};tr._TmpVector3=dt.BuildArray(2,N.Zero);var nr=class{static extractMinAndMaxIndexed(e,t,n,r,i,a){for(let o=n;o<n+r;o++){let n=t[o]*3,r=e[n],s=e[n+1],c=e[n+2];i.minimizeInPlaceFromFloats(r,s,c),a.maximizeInPlaceFromFloats(r,s,c)}}static extractMinAndMax(e,t,n,r,i,a){for(let o=t,s=t*r;o<t+n;o++,s+=r){let t=e[s],n=e[s+1],r=e[s+2];i.minimizeInPlaceFromFloats(t,n,r),a.maximizeInPlaceFromFloats(t,n,r)}}};R([Wt.filter((...[e,t])=>!Array.isArray(e)&&!Array.isArray(t))],nr,`extractMinAndMaxIndexed`,null),R([Wt.filter((...[e])=>!Array.isArray(e))],nr,`extractMinAndMax`,null);function rr(e,t,n,r,i=null){let a=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new N(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return nr.extractMinAndMaxIndexed(e,t,n,r,a,o),i&&(a.x-=a.x*i.x+i.y,a.y-=a.y*i.x+i.y,a.z-=a.z*i.x+i.y,o.x+=o.x*i.x+i.y,o.y+=o.y*i.x+i.y,o.z+=o.z*i.x+i.y),{minimum:a,maximum:o}}function ir(e,t,n,r=null,i){let a=new N(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),o=new N(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return i||=3,nr.extractMinAndMax(e,t,n,i,a,o),r&&(a.x-=a.x*r.x+r.y,a.y-=a.y*r.x+r.y,a.z-=a.z*r.x+r.y,o.x+=o.x*r.x+r.y,o.y+=o.y*r.x+r.y,o.z+=o.z*r.x+r.y),{minimum:a,maximum:o}}var ar=class e{get materialDefines(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:this._getDrawWrapper()?.defines}set materialDefines(e){let t=this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0);t.defines=e}_getDrawWrapper(e,t=!1){e??=this._engine.currentRenderPassId;let n=this._drawWrappers[e];return!n&&t&&(this._drawWrappers[e]=n=new je(this._mesh.getScene().getEngine())),n}_removeDrawWrapper(e,t=!0){var n;t&&((n=this._drawWrappers[e])==null||n.dispose()),this._drawWrappers[e]=void 0}get effect(){return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:this._getDrawWrapper()?.effect??null}get _drawWrapper(){return this._mainDrawWrapperOverride??this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,n,r=!0){let i=this._drawWrapper;i.setEffect(e,t,r),n!==void 0&&(i.materialContext=n),e||(i.defines=null,i.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(let e of this._drawWrappers)e?.dispose();this._drawWrappers=[]}static AddToMesh(t,n,r,i,a,o,s,c=!0){return new e(t,n,r,i,a,o,s,c)}constructor(e,t,n,r,i,a,o,s=!0,c=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=n,this.indexStart=r,this.indexCount=i,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=a,this._renderingMesh=o||a,c&&a.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=a.subMeshes.length-1,s&&(this.refreshBoundingInfo(),a.computeWorldMatrix(!0))}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){return(this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null)||this._renderingMesh}getMaterial(e=!0){let t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId)??this._renderingMesh.material;if(t){if(this._isMultiMaterial(t)){let e=t.getSubMaterial(this.materialIndex);return this._currentMaterial!==e&&(this._currentMaterial=e,this.resetDrawCache()),e}}else return e?this._mesh.getScene().defaultMaterial:null;return t}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||=this._renderingMesh.getVerticesData(H.PositionKind),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;let t=this._renderingMesh.getIndices(),n;if(this.indexStart===0&&this.indexCount===t.length){let e=this._renderingMesh.getBoundingInfo();n={minimum:e.minimum.clone(),maximum:e.maximum.clone()}}else n=rr(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new tr(n.minimum,n.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||=(this.refreshBoundingInfo(),this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){let t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){let t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){let n=[];for(let t=this.indexStart;t<this.indexStart+this.indexCount;t+=3)n.push(e[t],e[t+1],e[t+1],e[t+2],e[t+2],e[t]);this._linesIndexBuffer=t.createIndexBuffer(n),this._linesIndexCount=n.length}return this._linesIndexBuffer}canIntersects(e){let t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,n,r,i){let a=this.getMaterial();if(!a)return null;let o=3,s=!1;switch(a.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,s=!0;break}return a.fillMode===4?n.length?this._intersectLines(e,t,n,this._mesh.intersectionThreshold,r):this._intersectUnIndexedLines(e,t,n,this._mesh.intersectionThreshold,r):!n.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,n,r,i):this._intersectTriangles(e,t,n,o,s,r,i)}_intersectLines(e,t,n,r,i){let a=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){let s=t[n[o]],c=t[n[o+1]],l=e.intersectionSegment(s,c,r);if(!(l<0)&&(i||!a||l<a.distance)&&(a=new Rn(null,null,l),a.faceId=o/2,i))break}return a}_intersectUnIndexedLines(e,t,n,r,i){let a=null;for(let n=this.verticesStart;n<this.verticesStart+this.verticesCount;n+=2){let o=t[n],s=t[n+1],c=e.intersectionSegment(o,s,r);if(!(c<0)&&(i||!a||c<a.distance)&&(a=new Rn(null,null,c),a.faceId=n/2,i))break}return a}_intersectTriangles(e,t,n,r,i,a,o){let s=null,c=-1;for(let l=this.indexStart;l<this.indexStart+this.indexCount-(3-r);l+=r){c++;let r=n[l],u=n[l+1],d=n[l+2];if(i&&d===4294967295){l+=2;continue}let f=t[r],p=t[u],m=t[d];if(!f||!p||!m||o&&!o(f,p,m,e,r,u,d))continue;let h=e.intersectsTriangle(f,p,m);if(h){if(h.distance<0)continue;if((a||!s||h.distance<s.distance)&&(s=h,s.faceId=c,a))break}}return s}_intersectUnIndexedTriangles(e,t,n,r,i){let a=null;for(let n=this.verticesStart;n<this.verticesStart+this.verticesCount;n+=3){let o=t[n],s=t[n+1],c=t[n+2];if(i&&!i(o,s,c,e,-1,-1,-1))continue;let l=e.intersectsTriangle(o,s,c);if(l){if(l.distance<0)continue;if((r||!a||l.distance<a.distance)&&(a=l,a.faceId=n/3,r))break}}return a}_rebuild(){this._linesIndexBuffer&&=null}clone(t,n){let r=new e(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,t,n,!1);if(!this.IsGlobal){let e=this.getBoundingInfo();if(!e)return r;r._boundingInfo=new tr(e.minimum,e.maximum)}return r}dispose(){this._linesIndexBuffer&&=(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),null);let e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return`SubMesh`}static CreateFromIndices(t,n,r,i,a,o=!0){let s=Number.MAX_VALUE,c=-Number.MAX_VALUE,l=(a||i).getIndices();for(let e=n;e<n+r;e++){let t=l[e];t<s&&(s=t),t>c&&(c=t)}return new e(t,s,c-s+1,n,r,i,a,o)}},or=class{};or.UseOpenGLOrientationForUV=!1;var sr=class e{get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(t){let n=new e(e.RandomId(),t.getScene());return n.applyToMesh(t),n}get meshes(){return this._meshes}constructor(e,t,n,r=!1,i=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||b.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=r,n?this.setAllVerticesData(n,r):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),i&&(this.applyToMesh(i),i.computeWorldMatrix(!0)))}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){for(let e in this._vertexArrayObjects&&={},this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,n=!1,r){n&&Array.isArray(t)&&(t=new Float32Array(t));let i=new H(this._engine,t,e,n,this._meshes.length===0,r);this.setVerticesBuffer(i)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,n=!0){let r=e.getKind();this._vertexBuffers[r]&&n&&this._vertexBuffers[r].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[r]=e;let i=this._meshes,a=i.length;if(r===H.PositionKind){let n=e.getData();t==null?n!=null&&(this._totalVertices=n.length/(e.type===H.BYTE?e.byteStride:e.byteStride/4)):this._totalVertices=t,this._updateExtend(n),this._resetPointsArrayCache();for(let e=0;e<a;e++){let t=i[e];t.buildBoundingInfo(this._extend.minimum,this._extend.maximum),t._createGlobalSubMesh(t.isUnIndexed),t.computeWorldMatrix(!0),t.synchronizeInstances()}}this._notifyUpdate(r)}updateVerticesDataDirectly(e,t,n,r=!1){let i=this.getVertexBuffer(e);i&&(i.updateDirectly(t,n,r),this._notifyUpdate(e))}updateVerticesData(e,t,n=!1){let r=this.getVertexBuffer(e);r&&(r.update(t),e===H.PositionKind&&this._updateBoundingInfo(n,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){let e=this._meshes;for(let t of e){t.hasBoundingInfo?t.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):t.buildBoundingInfo(this._extend.minimum,this._extend.maximum);let e=t.subMeshes;for(let t of e)t.refreshBoundingInfo()}}}_bind(e,t,n,r){if(!e)return;t===void 0&&(t=this._indexBuffer);let i=this.getVertexBuffers();if(!i)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!r){this._engine.bindBuffers(i,t,e,n);return}let a=r||this._vertexArrayObjects;a[e.key]||(a[e.key]=this._engine.recordVertexArrayObject(i,t,e,n)),this._engine.bindVertexArrayObject(a[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,n){let r=this.getVertexBuffer(e);return r?r.getFloatData(this._totalVertices,n||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){let t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){let e=[],t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,n=!1){if(this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{let r=e.length!==this._indices.length;if(n||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),r)for(let e of this._meshes)e._createGlobalSubMesh(!0)}}setIndices(e,t=null,n=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=n,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,n)),t!=null&&(this._totalVertices=t);for(let e of this._meshes)e._createGlobalSubMesh(!0),e.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;let n=this._indices;return!t&&(!e||this._meshes.length===1)?n:n.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){let n=this._meshes,r=n.indexOf(e);r!==-1&&(n.splice(r,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,n.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;let t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();let n=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),n.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(H.PositionKind),!e))return;this._extend=ir(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){let t=this._meshes.length;for(let n in this._vertexBuffers)t===1&&this._vertexBuffers[n].create(),n===H.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(let e of this._meshes)e._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){this.delayLoadingFile&&(e.addPendingData(this),e._loadFile(this.delayLoadingFile,n=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(n),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);let r=this._meshes,i=r.length;for(let e=0;e<i;e++)this._applyToMesh(r[e]);t&&t()},void 0,!0))}toLeftHanded(){let e=this.getIndices(!1);if(e!=null&&e.length>0){for(let t=0;t<e.length;t+=3){let n=e[t+0];e[t+0]=e[t+2],e[t+2]=n}this.setIndices(e)}let t=this.getVerticesData(H.PositionKind,!1);if(t!=null&&t.length>0){for(let e=0;e<t.length;e+=3)t[e+2]=-t[e+2];this.setVerticesData(H.PositionKind,t,!1)}let n=this.getVerticesData(H.NormalKind,!1);if(n!=null&&n.length>0){for(let e=0;e<n.length;e+=3)n[e+2]=-n[e+2];this.setVerticesData(H.NormalKind,n,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;let e=this.getVerticesData(H.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,n=this._positionsCache.length;t<e.length;t+=3,++n)this._positionsCache[n]=N.FromArray(e,t);for(let t=0,n=0;t<e.length;t+=3,++n)this._positionsCache[n].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(let e in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e]);this._vertexArrayObjects={};let e=this._meshes,t=e.length;for(let n=0;n<t;n++)e[n]._invalidateInstanceVertexArrayObject()}}dispose(){let e=this._meshes,t=e.length,n;for(n=0;n<t;n++)this.releaseForMesh(e[n]);for(let e in this._meshes.length=0,this._disposeVertexArrayObjects(),this._vertexBuffers)this._vertexBuffers[e].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){let e=this._parentContainer.geometries.indexOf(this);e>-1&&this._parentContainer.geometries.splice(e,1),this._parentContainer=null}this._isDisposed=!0}copy(t){let n=new X;n.indices=[];let r=this.getIndices();if(r)for(let e=0;e<r.length;e++)n.indices.push(r[e]);let i=!1,a=!1,o;for(o in this._vertexBuffers){let e=this.getVerticesData(o);if(e&&(e instanceof Float32Array?n.set(new Float32Array(e),o):n.set(e.slice(0),o),!a)){let e=this.getVertexBuffer(o);e&&(i=e.isUpdatable(),a=!i)}}let s=new e(t,this._scene,n,i);for(o in s.delayLoadState=this.delayLoadState,s.delayLoadingFile=this.delayLoadingFile,s._delayLoadingFunction=this._delayLoadingFunction,this._delayInfo)s._delayInfo=s._delayInfo||[],s._delayInfo.push(o);return s._boundingInfo=new tr(this._extend.minimum,this._extend.maximum),s}serialize(){let e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,j&&j.HasTags(this)&&(e.tags=j.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){for(let e in this._indices=[],this._resetPointsArrayCache(),this._vertexBuffers)Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)&&(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){let e=this.serialize();return this.isVerticesDataPresent(H.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(H.PositionKind)),this.isVertexBufferUpdatable(H.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(H.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(H.NormalKind)),this.isVertexBufferUpdatable(H.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(H.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(H.TangentKind)),this.isVertexBufferUpdatable(H.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(H.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(H.UVKind)),this.isVertexBufferUpdatable(H.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(H.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(H.UV2Kind)),this.isVertexBufferUpdatable(H.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(H.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(H.UV3Kind)),this.isVertexBufferUpdatable(H.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(H.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(H.UV4Kind)),this.isVertexBufferUpdatable(H.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(H.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(H.UV5Kind)),this.isVertexBufferUpdatable(H.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(H.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(H.UV6Kind)),this.isVertexBufferUpdatable(H.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(H.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(H.ColorKind)),this.isVertexBufferUpdatable(H.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(H.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(H.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(H.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(H.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(H.MatricesWeightsKind)),this.isVertexBufferUpdatable(H.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){let n=e._geometry;return n?n.copy(t):null}static RandomId(){return A.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let n=0;n<t.geometries.length;n++)if(t.geometries[n]._loadedUniqueId===e)return t.geometries[n];return null}static _ImportGeometry(t,n){let r=n.getScene(),i=t.geometryUniqueId,a=t.geometryId;if(i||a){let e=i?this._GetGeometryByLoadedUniqueId(i,r):r.getGeometryById(a);e&&e.applyToMesh(n)}else if(t instanceof ArrayBuffer){let e=n._binaryInfo;if(e.positionsAttrDesc&&e.positionsAttrDesc.count>0){let r=new Float32Array(t,e.positionsAttrDesc.offset,e.positionsAttrDesc.count);n.setVerticesData(H.PositionKind,r,!1)}if(e.normalsAttrDesc&&e.normalsAttrDesc.count>0){let r=new Float32Array(t,e.normalsAttrDesc.offset,e.normalsAttrDesc.count);n.setVerticesData(H.NormalKind,r,!1)}if(e.tangetsAttrDesc&&e.tangetsAttrDesc.count>0){let r=new Float32Array(t,e.tangetsAttrDesc.offset,e.tangetsAttrDesc.count);n.setVerticesData(H.TangentKind,r,!1)}if(e.uvsAttrDesc&&e.uvsAttrDesc.count>0){let r=new Float32Array(t,e.uvsAttrDesc.offset,e.uvsAttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UVKind,r,!1)}if(e.uvs2AttrDesc&&e.uvs2AttrDesc.count>0){let r=new Float32Array(t,e.uvs2AttrDesc.offset,e.uvs2AttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UV2Kind,r,!1)}if(e.uvs3AttrDesc&&e.uvs3AttrDesc.count>0){let r=new Float32Array(t,e.uvs3AttrDesc.offset,e.uvs3AttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UV3Kind,r,!1)}if(e.uvs4AttrDesc&&e.uvs4AttrDesc.count>0){let r=new Float32Array(t,e.uvs4AttrDesc.offset,e.uvs4AttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UV4Kind,r,!1)}if(e.uvs5AttrDesc&&e.uvs5AttrDesc.count>0){let r=new Float32Array(t,e.uvs5AttrDesc.offset,e.uvs5AttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UV5Kind,r,!1)}if(e.uvs6AttrDesc&&e.uvs6AttrDesc.count>0){let r=new Float32Array(t,e.uvs6AttrDesc.offset,e.uvs6AttrDesc.count);if(or.UseOpenGLOrientationForUV)for(let e=1;e<r.length;e+=2)r[e]=1-r[e];n.setVerticesData(H.UV6Kind,r,!1)}if(e.colorsAttrDesc&&e.colorsAttrDesc.count>0){let r=new Float32Array(t,e.colorsAttrDesc.offset,e.colorsAttrDesc.count);n.setVerticesData(H.ColorKind,r,!1,e.colorsAttrDesc.stride)}if(e.matricesIndicesAttrDesc&&e.matricesIndicesAttrDesc.count>0){let r=new Int32Array(t,e.matricesIndicesAttrDesc.offset,e.matricesIndicesAttrDesc.count),i=[];for(let e=0;e<r.length;e++){let t=r[e];i.push(t&255),i.push((t&65280)>>8),i.push((t&16711680)>>16),i.push(t>>24&255)}n.setVerticesData(H.MatricesIndicesKind,i,!1)}if(e.matricesIndicesExtraAttrDesc&&e.matricesIndicesExtraAttrDesc.count>0){let r=new Int32Array(t,e.matricesIndicesExtraAttrDesc.offset,e.matricesIndicesExtraAttrDesc.count),i=[];for(let e=0;e<r.length;e++){let t=r[e];i.push(t&255),i.push((t&65280)>>8),i.push((t&16711680)>>16),i.push(t>>24&255)}n.setVerticesData(H.MatricesIndicesExtraKind,i,!1)}if(e.matricesWeightsAttrDesc&&e.matricesWeightsAttrDesc.count>0){let r=new Float32Array(t,e.matricesWeightsAttrDesc.offset,e.matricesWeightsAttrDesc.count);n.setVerticesData(H.MatricesWeightsKind,r,!1)}if(e.indicesAttrDesc&&e.indicesAttrDesc.count>0){let r=new Int32Array(t,e.indicesAttrDesc.offset,e.indicesAttrDesc.count);n.setIndices(r,null)}if(e.subMeshesAttrDesc&&e.subMeshesAttrDesc.count>0){let r=new Int32Array(t,e.subMeshesAttrDesc.offset,e.subMeshesAttrDesc.count*5);n.subMeshes=[];for(let t=0;t<e.subMeshesAttrDesc.count;t++){let e=r[t*5+0],i=r[t*5+1],a=r[t*5+2],o=r[t*5+3],s=r[t*5+4];ar.AddToMesh(e,i,a,o,s,n)}}}else if(t.positions&&t.normals&&t.indices){if(n.setVerticesData(H.PositionKind,t.positions,t.positions._updatable),n.setVerticesData(H.NormalKind,t.normals,t.normals._updatable),t.tangents&&n.setVerticesData(H.TangentKind,t.tangents,t.tangents._updatable),t.uvs&&n.setVerticesData(H.UVKind,t.uvs,t.uvs._updatable),t.uvs2&&n.setVerticesData(H.UV2Kind,t.uvs2,t.uvs2._updatable),t.uvs3&&n.setVerticesData(H.UV3Kind,t.uvs3,t.uvs3._updatable),t.uvs4&&n.setVerticesData(H.UV4Kind,t.uvs4,t.uvs4._updatable),t.uvs5&&n.setVerticesData(H.UV5Kind,t.uvs5,t.uvs5._updatable),t.uvs6&&n.setVerticesData(H.UV6Kind,t.uvs6,t.uvs6._updatable),t.colors&&n.setVerticesData(H.ColorKind,Tt.CheckColors4(t.colors,t.positions.length/3),t.colors._updatable),t.matricesIndices)if(t.matricesIndices._isExpanded)delete t.matricesIndices._isExpanded,n.setVerticesData(H.MatricesIndicesKind,t.matricesIndices,t.matricesIndices._updatable);else{let e=[];for(let n=0;n<t.matricesIndices.length;n++){let r=t.matricesIndices[n];e.push(r&255),e.push((r&65280)>>8),e.push((r&16711680)>>16),e.push(r>>24&255)}n.setVerticesData(H.MatricesIndicesKind,e,t.matricesIndices._updatable)}if(t.matricesIndicesExtra)if(t.matricesIndicesExtra._isExpanded)delete t.matricesIndices._isExpanded,n.setVerticesData(H.MatricesIndicesExtraKind,t.matricesIndicesExtra,t.matricesIndicesExtra._updatable);else{let e=[];for(let n=0;n<t.matricesIndicesExtra.length;n++){let r=t.matricesIndicesExtra[n];e.push(r&255),e.push((r&65280)>>8),e.push((r&16711680)>>16),e.push(r>>24&255)}n.setVerticesData(H.MatricesIndicesExtraKind,e,t.matricesIndicesExtra._updatable)}t.matricesWeights&&(e._CleanMatricesWeights(t,n),n.setVerticesData(H.MatricesWeightsKind,t.matricesWeights,t.matricesWeights._updatable)),t.matricesWeightsExtra&&n.setVerticesData(H.MatricesWeightsExtraKind,t.matricesWeightsExtra,t.matricesWeights._updatable),n.setIndices(t.indices,null)}if(t.subMeshes){n.subMeshes=[];for(let e=0;e<t.subMeshes.length;e++){let r=t.subMeshes[e];ar.AddToMesh(r.materialIndex,r.verticesStart,r.verticesCount,r.indexStart,r.indexCount,n)}}n._shouldGenerateFlatShading&&=(n.convertToFlatShadedMesh(),!1),n.computeWorldMatrix(!0),r.onMeshImportedObservable.notifyObservers(n)}static _CleanMatricesWeights(e,t){if(!Fn.CleanBoneMatrixWeights)return;let n=0;if(e.skeletonId>-1){let r=t.getScene().getLastSkeletonById(e.skeletonId);if(!r)return;n=r.bones.length}else return;let r=t.getVerticesData(H.MatricesIndicesKind),i=t.getVerticesData(H.MatricesIndicesExtraKind),a=e.matricesWeights,o=e.matricesWeightsExtra,s=e.numBoneInfluencer,c=a.length;for(let e=0;e<c;e+=4){let t=0,c=-1;for(let n=0;n<4;n++){let r=a[e+n];t+=r,r<.001&&c<0&&(c=n)}if(o)for(let n=0;n<4;n++){let r=o[e+n];t+=r,r<.001&&c<0&&(c=n+4)}if((c<0||c>s-1)&&(c=s-1),t>.001){let n=1/t;for(let t=0;t<4;t++)a[e+t]*=n;if(o)for(let t=0;t<4;t++)o[e+t]*=n}else c>=4?(o[e+c-4]=1-t,i[e+c-4]=n):(a[e+c]=1-t,r[e+c]=n)}t.setVerticesData(H.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(H.MatricesIndicesExtraKind,i)}static Parse(t,n,r){let i=new e(t.id,n,void 0,t.updatable);return i._loadedUniqueId=t.uniqueId,j&&j.AddTagsTo(i,t.tags),t.delayLoadingFile?(i.delayLoadState=4,i.delayLoadingFile=r+t.delayLoadingFile,i._boundingInfo=new tr(N.FromArray(t.boundingBoxMinimum),N.FromArray(t.boundingBoxMaximum)),i._delayInfo=[],t.hasUVs&&i._delayInfo.push(H.UVKind),t.hasUVs2&&i._delayInfo.push(H.UV2Kind),t.hasUVs3&&i._delayInfo.push(H.UV3Kind),t.hasUVs4&&i._delayInfo.push(H.UV4Kind),t.hasUVs5&&i._delayInfo.push(H.UV5Kind),t.hasUVs6&&i._delayInfo.push(H.UV6Kind),t.hasColors&&i._delayInfo.push(H.ColorKind),t.hasMatricesIndices&&i._delayInfo.push(H.MatricesIndicesKind),t.hasMatricesWeights&&i._delayInfo.push(H.MatricesWeightsKind),i._delayLoadingFunction=X.ImportVertexData):X.ImportVertexData(t,i),n.pushGeometry(i,!0),i}},cr;(function(e){e[e.LOCAL=0]=`LOCAL`,e[e.WORLD=1]=`WORLD`,e[e.BONE=2]=`BONE`})(cr||={});var lr=class{};lr.X=new N(1,0,0),lr.Y=new N(0,1,0),lr.Z=new N(0,0,1);var ur;(function(e){e[e.X=0]=`X`,e[e.Y=1]=`Y`,e[e.Z=2]=`Z`})(ur||={});var Z=class e extends Bn{get billboardMode(){return this._billboardMode}set billboardMode(t){this._billboardMode!==t&&(this._billboardMode=t,this._cache.useBillboardPosition=(this._billboardMode&e.BILLBOARDMODE_USE_POSITION)!==0,this._computeUseBillboardPath())}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e,this._computeUseBillboardPath())}_computeUseBillboardPath(){this._cache.useBillboardPath=this._billboardMode!==e.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}constructor(t,n=null,r=!0){super(t,n),this._forward=new N(0,0,1),this._up=new N(0,1,0),this._right=new N(1,0,0),this._position=N.Zero(),this._rotation=N.Zero(),this._rotationQuaternion=null,this._scaling=N.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=e.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=F.Zero(),this._usePivotMatrix=!1,this._absolutePosition=N.Zero(),this._absoluteScaling=N.Zero(),this._absoluteRotationQuaternion=P.Identity(),this._pivotMatrix=F.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new o,this._nonUniformScaling=!1,r&&this.getScene().addTransformNode(this)}getClassName(){return`TransformNode`}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return N.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return N.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return N.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||=F.Identity(),this._poseMatrix}_isSynchronized(){let t=this._cache;return!(this._billboardMode!==t.billboardMode||this._billboardMode!==e.BILLBOARDMODE_NONE||t.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();let e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1,e.useBillboardPosition=!1,e.useBillboardPath=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=F.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,n){let r=this.clone(`Clone of `+(this.name||this.id),e||this.parent,!0);r&&n&&n(this,r);for(let e of this.getChildTransformNodes(!0))e.instantiateHierarchy(r,t,n);return r}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||P.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,n,r;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],n=arguments[1],r=arguments[2]}else t=e.x,n=e.y,r=e.z;if(this.parent){let e=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),N.TransformCoordinatesFromFloatsToRef(t,n,r,e,this.position)}else this.position.x=t,this.position.y=n,this.position.z=r;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=N.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();let e=L.Matrix[0];return this._localMatrix.invertToRef(e),N.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=N.TransformCoordinates(e,this._localMatrix),this}lookAt(t,n=0,r=0,i=0,a=cr.LOCAL){let o=e._LookAtVectorCache,s=a===cr.LOCAL?this.position:this.getAbsolutePosition();if(t.subtractToRef(s,o),this.setDirection(o,n,r,i),a===cr.WORLD&&this.parent)if(this.rotationQuaternion){let e=L.Matrix[0];this.rotationQuaternion.toRotationMatrix(e);let t=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(t),t.invert(),e.multiplyToRef(t,e),this.rotationQuaternion.fromRotationMatrix(e)}else{let e=L.Quaternion[0];P.FromEulerVectorToRef(this.rotation,e);let t=L.Matrix[0];e.toRotationMatrix(t);let n=L.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(n),n.invert(),t.multiplyToRef(n,t),e.fromRotationMatrix(t),e.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){let t=N.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return N.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,n=0,r=0){let i=-Math.atan2(e.z,e.x)+Math.PI/2,a=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,a);return this.rotationQuaternion?P.RotationYawPitchRollToRef(i+t,o+n,r,this.rotationQuaternion):(this.rotation.x=o+n,this.rotation.y=i+t,this.rotation.z=r),this}setPivotPoint(e,t=cr.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);let n=this.getWorldMatrix();if(t==cr.WORLD){let t=L.Matrix[0];n.invertToRef(t),e=N.TransformCoordinates(e,t)}return this.setPivotMatrix(F.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){let e=N.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){let e=N.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),N.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(let t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(t,n=!1,r=!1){if(!t&&!this.parent)return this;let i=L.Quaternion[0],a=L.Vector3[0],o=L.Vector3[1],s=L.Matrix[1];F.IdentityToRef(s);let c=L.Matrix[0];this.computeWorldMatrix(!0);let l=this.rotationQuaternion;return l||(l=e._TmpRotation,P.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,l)),F.ComposeToRef(this.scaling,l,this.position,c),this.parent&&c.multiplyToRef(this.parent.computeWorldMatrix(!0),c),t&&(t.computeWorldMatrix(!0).invertToRef(s),c.multiplyToRef(s,c)),c.decompose(o,i,a,n?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(i):i.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(o),this.position.copyFrom(a),this.parent=t,r&&this.setPivotMatrix(F.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(t,n,r){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let i;if(!r||r===cr.LOCAL)i=P.RotationAxisToRef(t,n,e._RotationAxisCache),this.rotationQuaternion.multiplyToRef(i,this.rotationQuaternion);else{if(this.parent){let e=L.Matrix[0];this.parent.getWorldMatrix().invertToRef(e),t=N.TransformNormal(t,e)}i=P.RotationAxisToRef(t,n,e._RotationAxisCache),i.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,n){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=P.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));let r=L.Vector3[0],i=L.Vector3[1],a=L.Vector3[2],o=L.Quaternion[0],s=L.Matrix[0],c=L.Matrix[1],l=L.Matrix[2],u=L.Matrix[3];return e.subtractToRef(this.position,r),F.TranslationToRef(r.x,r.y,r.z,s),F.TranslationToRef(-r.x,-r.y,-r.z,c),F.RotationAxisToRef(t,n,l),c.multiplyToRef(l,u),u.multiplyToRef(s,u),u.decompose(i,o,a),this.position.addInPlace(a),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,n){let r=e.scale(t);if(!n||n===cr.LOCAL){let e=this.getPositionExpressedInLocalSpace().add(r);this.setPositionWithLocalVector(e)}else this.setAbsolutePosition(this.getAbsolutePosition().add(r));return this}addRotation(e,t,n){let r;this.rotationQuaternion?r=this.rotationQuaternion:(r=L.Quaternion[1],P.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,r));let i=L.Quaternion[0];return P.RotationYawPitchRollToRef(t,e,n,i),r.multiplyInPlace(i),this.rotationQuaternion||r.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}isWorldMatrixCameraDependent(){return this._infiniteDistance&&!this.parent||this._billboardMode!==e.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard}computeWorldMatrix(t=!1,n=null){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;let r=this.getScene().getRenderId();if(!this._isDirty&&!t&&(this._currentRenderId===r||this.isSynchronized()))return this._currentRenderId=r,this._worldMatrix;n||=this.getScene().activeCamera,this._updateCache();let i=this._cache;i.pivotMatrixUpdated=!1,i.billboardMode=this.billboardMode,i.infiniteDistance=this.infiniteDistance,i.parent=this._parentNode,this._currentRenderId=r,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;let a=this._getEffectiveParent(),o=e._TmpScaling,s=this._position;if(this._infiniteDistance&&!this.parent&&n){let t=n.getWorldMatrix(),r=new N(t.m[12],t.m[13],t.m[14]);s=e._TmpTranslation,s.copyFromFloats(this._position.x+r.x,this._position.y+r.y,this._position.z+r.z)}o.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let c;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,c=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(P.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(c=e._TmpRotation,P.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),this._usePivotMatrix){let e=L.Matrix[1];F.ScalingToRef(o.x,o.y,o.z,e);let t=L.Matrix[0];c.toRotationMatrix(t),this._pivotMatrix.multiplyToRef(e,L.Matrix[4]),L.Matrix[4].multiplyToRef(t,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(s.x,s.y,s.z)}else F.ComposeToRef(o,c,s,this._localMatrix);if(a&&a.getWorldMatrix){if(t&&a.computeWorldMatrix(t),i.useBillboardPath){this._transformToBoneReferal?a.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),L.Matrix[7]):L.Matrix[7].copyFrom(a.getWorldMatrix());let t=L.Vector3[5],n=L.Vector3[6],r=L.Quaternion[0];L.Matrix[7].decompose(n,r,t),F.ScalingToRef(n.x,n.y,n.z,L.Matrix[7]),L.Matrix[7].setTranslation(t),e.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(r,t),this._localMatrix.setTranslation(t)),this._localMatrix.multiplyToRef(L.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(a.getWorldMatrix(),L.Matrix[6]),L.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(a.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(i.useBillboardPath&&n&&this.billboardMode&&!i.useBillboardPosition){let t=L.Vector3[0];if(this._worldMatrix.getTranslationToRef(t),L.Matrix[1].copyFrom(n.getViewMatrix()),L.Matrix[1].setTranslationFromFloats(0,0,0),L.Matrix[1].invertToRef(L.Matrix[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){L.Matrix[0].decompose(void 0,L.Quaternion[0],void 0);let t=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(t),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(t.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(t.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(t.z=0),F.RotationYawPitchRollToRef(t.y,t.x,t.z,L.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}else if(i.useBillboardPath&&n&&i.useBillboardPosition){let t=L.Vector3[0];this._worldMatrix.getTranslationToRef(t);let r=n.globalPosition;this._worldMatrix.invertToRef(L.Matrix[1]);let i=L.Vector3[1];N.TransformCoordinatesToRef(r,L.Matrix[1],i),i.normalize();let a=-Math.atan2(i.z,i.x)+Math.PI/2,o=Math.sqrt(i.x*i.x+i.z*i.z),s=-Math.atan2(i.y,o);if(P.RotationYawPitchRollToRef(a,s,0,L.Quaternion[0]),(this.billboardMode&e.BILLBOARDMODE_ALL)!==e.BILLBOARDMODE_ALL){let t=L.Vector3[1];L.Quaternion[0].toEulerAnglesToRef(t),(this.billboardMode&e.BILLBOARDMODE_X)!==e.BILLBOARDMODE_X&&(t.x=0),(this.billboardMode&e.BILLBOARDMODE_Y)!==e.BILLBOARDMODE_Y&&(t.y=0),(this.billboardMode&e.BILLBOARDMODE_Z)!==e.BILLBOARDMODE_Z&&(t.z=0),F.RotationYawPitchRollToRef(t.y,t.x,t.z,L.Matrix[0])}else F.FromQuaternionToRef(L.Quaternion[0],L.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(L.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(L.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):a&&a._nonUniformScaling?this._updateNonUniformScalingState(a._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||=F.Invert(this._worldMatrix),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){let e=this.getChildren();for(let t=0;t<e.length;++t){let n=e[t];if(n){n.computeWorldMatrix();let e=L.Matrix[0];n._localMatrix.multiplyToRef(this._localMatrix,e);let t=L.Quaternion[0];e.decompose(n.scaling,t,n.position),n.rotationQuaternion?n.rotationQuaternion.copyFrom(t):t.toEulerAnglesToRef(n.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&=P.Identity(),this._worldMatrix=F.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||=this.getScene().activeCamera,N.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||=this.getScene().activeCamera,this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(t,n,r){let i=B.Clone(()=>new e(t,this.getScene()),this);if(i.name=t,i.id=t,n&&(i.parent=n),!r){let e=this.getDescendants(!0);for(let n=0;n<e.length;n++){let r=e[n];r.clone&&r.clone(t+`.`+r.name,i)}}return i}serialize(e){let t=B.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(t,n,r){let i=B.Parse(()=>new e(t.name,n),t,n,r);return t.localMatrix?i.setPreTransformMatrix(F.FromArray(t.localMatrix)):t.pivotMatrix&&i.setPivotMatrix(F.FromArray(t.pivotMatrix)),i.setEnabled(t.isEnabled),i._waitingParsedUniqueId=t.uniqueId,t.parentId!==void 0&&(i._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(i._waitingParentInstanceIndex=t.parentInstanceIndex),i}getChildTransformNodes(t,n){let r=[];return this._getDescendants(r,t,t=>(!n||n(t))&&t instanceof e),r}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){let e=this._parentContainer.transformNodes.indexOf(this);e>-1&&this._parentContainer.transformNodes.splice(e,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){let e=this.getChildTransformNodes(!0);for(let t of e)t.parent=null,t.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,n){let r=null,i=null;t&&(this.rotationQuaternion?(i=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(r=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));let a=this.getHierarchyBoundingVectors(e,n),o=a.max.subtract(a.min),s=Math.max(o.x,o.y,o.z);if(s===0)return this;let c=1/s;return this.scaling.scaleInPlace(c),t&&(this.rotationQuaternion&&i?this.rotationQuaternion.copyFrom(i):this.rotation&&r&&this.rotation.copyFrom(r)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||=(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),!0)}};Z.BILLBOARDMODE_NONE=0,Z.BILLBOARDMODE_X=1,Z.BILLBOARDMODE_Y=2,Z.BILLBOARDMODE_Z=4,Z.BILLBOARDMODE_ALL=7,Z.BILLBOARDMODE_USE_POSITION=128,Z.BillboardUseParentOrientation=!1,Z._TmpRotation=P.Zero(),Z._TmpScaling=N.Zero(),Z._TmpTranslation=N.Zero(),Z._LookAtVectorCache=new N(0,0,0),Z._RotationAxisCache=new P,R([zt(`position`)],Z.prototype,`_position`,void 0),R([zt(`rotation`)],Z.prototype,`_rotation`,void 0),R([Ut(`rotationQuaternion`)],Z.prototype,`_rotationQuaternion`,void 0),R([zt(`scaling`)],Z.prototype,`_scaling`,void 0),R([z(`billboardMode`)],Z.prototype,`_billboardMode`,void 0),R([z()],Z.prototype,`scalingDeterminant`,void 0),R([z(`infiniteDistance`)],Z.prototype,`_infiniteDistance`,void 0),R([z()],Z.prototype,`ignoreNonUniformScaling`,void 0),R([z()],Z.prototype,`reIntegrateRotationIntoRotationQuaternion`,void 0);var dr=class{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new N(0,0,0),this._diffPositionForCollisions=new N(0,0,0),this._collisionResponse=!0}},fr=class{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=N.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}},pr=class{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new fr,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new dr,this._enableDistantPicking=!1,this._rawBoundingInfo=null}},mr=class e extends Z{static get BILLBOARDMODE_NONE(){return Z.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return Z.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return Z.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return Z.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return Z.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return Z.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}get rawBoundingInfo(){return this._internalAbstractMeshDataInfo._rawBoundingInfo}set rawBoundingInfo(e){this._internalAbstractMeshDataInfo._rawBoundingInfo=e}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;let t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){return this._internalAbstractMeshDataInfo._materialForRenderPass?.[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){let t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}constructor(t,n=null){switch(super(t,n,!1),this._internalAbstractMeshDataInfo=new pr,this._waitingMaterialId=null,this.cullingStrategy=e.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new o,this.onCollisionPositionChangeObservable=new o,this.onMaterialChangedObservable=new o,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=wt.Red(),this.outlineWidth=.02,this.overlayColor=wt.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new N(.5,1,.5),this.ellipsoidOffset=new N(0,0,0),this.edgesWidth=1,this.edgesColor=new Tt(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=[],this._unIndexed=!1,this._lightSources=[],this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new o,this._onCollisionPositionChange=(e,t,n=null)=>{t.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>J.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),n&&this.onCollideObservable.notifyObservers(n),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},n=this.getScene(),n.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Kt(this.getScene().getEngine(),void 0,void 0,t,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),n.performancePriority){case jn.Aggressive:this.doNotSyncBoundingInfo=!0;case jn.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}_buildUniformLayout(){this._uniformBuffer.addUniform(`world`,16),this._uniformBuffer.addUniform(`visibility`,1),this._uniformBuffer.create()}transferToEffect(e){let t=this._uniformBuffer;t.updateMatrix(`world`,e),t.updateFloat(`visibility`,this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return`AbstractMesh`}toString(e){let t=`Name: `+this.name+`, isInstance: `+(this.getClassName()===`InstancedMesh`?`NO`:`YES`);t+=`, # of submeshes: `+(this.subMeshes?this.subMeshes.length:0);let n=this._internalAbstractMeshDataInfo._skeleton;return n&&(t+=`, skeleton: `+n.name),e&&(t+=`, billboard mode: `+[`NONE`,`X`,`Y`,null,`Z`,null,null,`ALL`][this.billboardMode],t+=`, freeze wrld mat: `+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?`YES`:`NO`)),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==Z.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),this.subMeshes)for(let e of this.subMeshes)e._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(let e of this.getScene().lights)e.isEnabled()&&e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){let t=e.isEnabled()&&e.canAffectMesh(this),n=this._lightSources.indexOf(e),r=!1;if(n===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;r=!0,this._lightSources.splice(n,1)}this._markSubMeshesAsLightDirty(r)}_unBindEffect(){for(let e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){let n=this._lightSources.indexOf(e);n!==-1&&(this._lightSources.splice(n,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(this.subMeshes)for(let t of this.subMeshes)for(let n=0;n<t._drawWrappers.length;++n){let r=t._drawWrappers[n];!r||!r.defines||!r.defines.markAllAsDirty||e(r.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(this.subMeshes)for(let t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,n,r){return this}updateVerticesData(e,t,n,r){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}getRawBoundingInfo(){return this.rawBoundingInfo??this.getBoundingInfo()}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,n){return this._boundingInfo=new tr(e,t,n),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,n){return super.normalizeToUnitCube(e,t,n)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(H.MatricesIndicesKind)&&this.isVerticesDataPresent(H.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===Z.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,n){return this.position.addInPlace(this.calcMovePOV(e,t,n)),this}calcMovePOV(e,t,n){let r=new F;(this.rotationQuaternion?this.rotationQuaternion:P.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(r);let i=N.Zero(),a=this.definedFacingForward?-1:1;return N.TransformCoordinatesFromFloatsToRef(e*a,t,n*a,r,i),i}rotatePOV(e,t,n){return this.rotation.addInPlace(this.calcRotatePOV(e,t,n)),this}calcRotatePOV(e,t,n){let r=this.definedFacingForward?1:-1;return new N(e*r,t,n*r)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked||this._refreshBoundingInfo(this._getPositionData(e,t),null),this}_refreshBoundingInfo(e,t){if(e){let n=ir(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(n.minimum,n.maximum):this._boundingInfo=new tr(n.minimum,n.maximum)}if(this.subMeshes)for(let t=0;t<this.subMeshes.length;t++)this.subMeshes[t].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,n,r=H.PositionKind){if(n??=this.getVerticesData(r).slice(),n&&t&&this.morphTargetManager){let e=0,t=0;for(let i=0;i<n.length;i++){for(let e=0;e<this.morphTargetManager.numTargets;e++){let t=this.morphTargetManager.getTarget(e),r=t.influence;if(r>0){let e=t.getPositions();e&&(n[i]+=(e[i]-n[i])*r)}}if(e++,r===H.PositionKind&&this._positions&&e===3){e=0;let r=t*3;this._positions[t++].copyFromFloats(n[r],n[r+1],n[r+2])}}}if(n&&e&&this.skeleton){let e=this.getVerticesData(H.MatricesIndicesKind),t=this.getVerticesData(H.MatricesWeightsKind);if(t&&e){let i=this.numBoneInfluencers>4,a=i?this.getVerticesData(H.MatricesIndicesExtraKind):null,o=i?this.getVerticesData(H.MatricesWeightsExtraKind):null,s=this.skeleton.getTransformMatrices(this),c=L.Vector3[0],l=L.Matrix[0],u=L.Matrix[1],d=0;for(let f=0;f<n.length;f+=3,d+=4){l.reset();let p,m;for(p=0;p<4;p++)m=t[d+p],m>0&&(F.FromFloat32ArrayToRefScaled(s,Math.floor(e[d+p]*16),m,u),l.addToSelf(u));if(i)for(p=0;p<4;p++)m=o[d+p],m>0&&(F.FromFloat32ArrayToRefScaled(s,Math.floor(a[d+p]*16),m,u),l.addToSelf(u));r===H.NormalKind?N.TransformNormalFromFloatsToRef(n[f],n[f+1],n[f+2],l,c):N.TransformCoordinatesFromFloatsToRef(n[f],n[f+1],n[f+2],l,c),c.toArray(n,f),r===H.PositionKind&&this._positions&&this._positions[f/3].copyFrom(c)}}}return n}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,H.NormalKind)}getPositionData(e=!1,t=!1,n){return this._getData(e,t,n,H.PositionKind)}_getPositionData(e,t){let n=this.getVerticesData(H.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),n&&(e&&this.skeleton||t&&this.morphTargetManager)){if(n=n.slice(),this._generatePointsArray(),this._positions){let e=this._positions;this._internalAbstractMeshDataInfo._positions=Array(e.length);for(let t=0;t<e.length;t++)this._internalAbstractMeshDataInfo._positions[t]=e[t]?.clone()||new N}return this.getPositionData(e,t,n)}return n}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new tr(N.Zero(),N.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;let t=this.subMeshes.length;for(let n=0;n<t;n++){let r=this.subMeshes[n];(t>1||!r.IsGlobal)&&r.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,n){let r=this.getBoundingInfo(),i=e.getBoundingInfo();if(r.intersects(i,t))return!0;if(n){for(let n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);let t=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=t.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,t.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,n){if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];let n=e.verticesStart,r=e.verticesStart+e.verticesCount;for(let i=n;i<r;i++)e._lastColliderWorldVertices.push(N.TransformCoordinates(this._positions[i],t))}return n._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),e.getMaterial()?.fillMode===7),this}_processCollisionsForSubMeshes(e,t){let n=this._scene.getCollidingSubMeshCandidates(this,e),r=n.length;for(let i=0;i<r;i++){let a=n.data[i];r>1&&!a._checkCollision(e)||this._collideForSubMesh(a,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;let t=L.Matrix[0],n=L.Matrix[1];return F.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,n),this._processCollisionsForSubMeshes(e,n),this}_generatePointsArray(){return!1}intersects(e,t,n,r=!1,i,a=!1){let o=new Jt,s=this.getClassName()===`InstancedLinesMesh`||this.getClassName()===`LinesMesh`?this.intersectionThreshold:0,c=this.getBoundingInfo();if(!this.subMeshes||!a&&(!e.intersectsSphere(c.boundingSphere,s)||!e.intersectsBox(c.boundingBox,s)))return o;if(r)return o.hit=!a,o.pickedMesh=a?null:this,o.distance=a?0:N.Distance(e.origin,c.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let l=null,u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length,f=!1;for(let e=0;e<d;e++){let t=u.data[e].getMaterial();if(t&&(t.fillMode==7||t.fillMode==0||t.fillMode==1||t.fillMode==2||t.fillMode==4)){f=!0;break}}if(!f)return o.hit=!0,o.pickedMesh=this,o.distance=N.Distance(e.origin,c.boundingSphere.center),o.subMeshId=-1,o;for(let r=0;r<d;r++){let i=u.data[r];if(d>1&&!i.canIntersects(e))continue;let a=i.intersects(e,this._positions,this.getIndices(),t,n);if(a&&(t||!l||a.distance<l.distance)&&(l=a,l.subMeshId=r,t))break}if(l){let t=i??this.getWorldMatrix(),n=L.Vector3[0],r=L.Vector3[1];N.TransformCoordinatesToRef(e.origin,t,n),e.direction.scaleToRef(l.distance,r);let a=N.TransformNormal(r,t).addInPlace(n);return o.hit=!0,o.distance=N.Distance(n,a),o.pickedPoint=a,o.pickedMesh=this,o.bu=l.bu||0,o.bv=l.bv||0,o.subMeshFaceId=l.faceId,o.faceId=l.faceId+u.data[l.subMeshId].indexStart/(this.getClassName().indexOf(`LinesMesh`)===-1?3:2),o.subMeshId=l.subMeshId,o}return o}clone(e,t,n){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=[];return this}dispose(e,t=!1){let n;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&=(this._transformMatrixTexture.dispose(),null),n=0;n<this._intersectionsInProgress.length;n++){let e=this._intersectionsInProgress[n],t=e._intersectionsInProgress.indexOf(this);e._intersectionsInProgress.splice(t,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(e=>{let t=e.includedOnlyMeshes.indexOf(this);t!==-1&&e.includedOnlyMeshes.splice(t,1),t=e.excludedMeshes.indexOf(this),t!==-1&&e.excludedMeshes.splice(t,1);let n=e.getShadowGenerators();if(n){let e=n.values();for(let n=e.next();n.done!==!0;n=e.next()){let e=n.value.getShadowMap();e&&e.renderList&&(t=e.renderList.indexOf(this),t!==-1&&e.renderList.splice(t,1))}}}),(this.getClassName()!==`InstancedMesh`||this.getClassName()!==`InstancedLinesMesh`)&&this.releaseSubMeshes();let r=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){let e=this._parentContainer.meshes.indexOf(this);e>-1&&this._parentContainer.meshes.splice(e,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()===`MultiMaterial`?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(n=0;n<this.getScene().particleSystems.length;n++)this.getScene().particleSystems[n].emitter===this&&(this.getScene().particleSystems[n].dispose(),n--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||=[],e.facetPositions||=[],e.facetPartitioning||=[],e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=N.Zero(),e.facetPositions[t]=N.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();let t=this.getVerticesData(H.PositionKind),n=this.getIndices(),r=this.getVerticesData(H.NormalKind),i=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,n instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(n);else if(n instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(n);else{let t=!1;for(let e=0;e<n.length;e++)if(n[e]>65535){t=!0;break}t?e.depthSortedIndices=new Uint32Array(n):e.depthSortedIndices=new Uint16Array(n)}if(e.facetDepthSortFunction=function(e,t){return t.sqDistance-e.sqDistance},!e.facetDepthSortFrom){let t=this.getScene().activeCamera;e.facetDepthSortFrom=t?t.position:N.Zero()}e.depthSortedFacets=[];for(let t=0;t<e.facetNb;t++){let n={ind:t*3,sqDistance:0};e.depthSortedFacets.push(n)}e.invertedMatrix=F.Identity(),e.facetDepthSortOrigin=N.Zero()}e.bbSize.x=i.maximum.x-i.minimum.x>.001?i.maximum.x-i.minimum.x:ut,e.bbSize.y=i.maximum.y-i.minimum.y>.001?i.maximum.y-i.minimum.y:ut,e.bbSize.z=i.maximum.z-i.minimum.z>.001?i.maximum.z-i.minimum.z:ut;let a=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(a=a>e.bbSize.z?a:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/a),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/a),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/a),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=i,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),N.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,r&&X.ComputeNormals(t,n,r,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);let t=e.depthSortedIndices.length/3|0;for(let r=0;r<t;r++){let t=e.depthSortedFacets[r].ind;e.depthSortedIndices[r*3]=n[t],e.depthSortedIndices[r*3+1]=n[t+1],e.depthSortedIndices[r*3+2]=n[t+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){let t=N.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){let n=this.getFacetLocalPositions()[e],r=this.getWorldMatrix();return N.TransformCoordinatesToRef(n,r,t),this}getFacetNormal(e){let t=N.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){let n=this.getFacetLocalNormals()[e];return N.TransformNormalToRef(n,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,n){let r=this.getBoundingInfo(),i=this._internalAbstractMeshDataInfo._facetData,a=Math.floor((e-r.minimum.x*i.partitioningBBoxRatio)*i.subDiv.X*i.partitioningBBoxRatio/i.bbSize.x),o=Math.floor((t-r.minimum.y*i.partitioningBBoxRatio)*i.subDiv.Y*i.partitioningBBoxRatio/i.bbSize.y),s=Math.floor((n-r.minimum.z*i.partitioningBBoxRatio)*i.subDiv.Z*i.partitioningBBoxRatio/i.bbSize.z);return a<0||a>i.subDiv.max||o<0||o>i.subDiv.max||s<0||s>i.subDiv.max?null:i.facetPartitioning[a+i.subDiv.max*o+i.subDiv.max*i.subDiv.max*s]}getClosestFacetAtCoordinates(e,t,n,r,i=!1,a=!0){let o=this.getWorldMatrix(),s=L.Matrix[5];o.invertToRef(s);let c=L.Vector3[8];N.TransformCoordinatesFromFloatsToRef(e,t,n,s,c);let l=this.getClosestFacetAtLocalCoordinates(c.x,c.y,c.z,r,i,a);return r&&N.TransformCoordinatesFromFloatsToRef(r.x,r.y,r.z,o,r),l}getClosestFacetAtLocalCoordinates(e,t,n,r,i=!1,a=!0){let o=null,s=0,c=0,l=0,u=0,d=0,f=0,p=0,m=0,h=this.getFacetLocalPositions(),g=this.getFacetLocalNormals(),_=this.getFacetsAtLocalCoordinates(e,t,n);if(!_)return null;let v=Number.MAX_VALUE,y=v,b,x,S;for(let C=0;C<_.length;C++)b=_[C],x=g[b],S=h[b],u=(e-S.x)*x.x+(t-S.y)*x.y+(n-S.z)*x.z,(!i||i&&a&&u>=0||i&&!a&&u<=0)&&(u=x.x*S.x+x.y*S.y+x.z*S.z,d=-(x.x*e+x.y*t+x.z*n-u)/(x.x*x.x+x.y*x.y+x.z*x.z),f=e+x.x*d,p=t+x.y*d,m=n+x.z*d,s=f-e,c=p-t,l=m-n,y=s*s+c*c+l*l,y<v&&(v=y,o=b,r&&(r.x=f,r.y=p,r.z=m)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){let e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=[],e.facetNormals=[],e.facetPartitioning=[],e.facetParameters=null,e.depthSortedIndices=new Uint32Array),this}updateIndices(e,t,n=!1){return this}createNormals(e){let t=this.getVerticesData(H.PositionKind),n=this.getIndices(),r;return r=this.isVerticesDataPresent(H.NormalKind)?this.getVerticesData(H.NormalKind):[],X.ComputeNormals(t,n,r,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(H.NormalKind,r,e),this}alignWithNormal(e,t){t||=lr.Y;let n=L.Vector3[0],r=L.Vector3[1];return N.CrossToRef(t,e,r),N.CrossToRef(e,r,n),this.rotationQuaternion?P.RotationQuaternionFromAxisToRef(n,e,r,this.rotationQuaternion):N.RotationFromAxisToRef(n,e,r,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw _(`EdgesRenderer`)}enableEdgesRendering(e,t,n){throw _(`EdgesRenderer`)}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}};mr.OCCLUSION_TYPE_NONE=0,mr.OCCLUSION_TYPE_OPTIMISTIC=1,mr.OCCLUSION_TYPE_STRICT=2,mr.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0,mr.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1,mr.CULLINGSTRATEGY_STANDARD=0,mr.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,mr.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,mr.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,$e(`BABYLON.AbstractMesh`,mr);function hr(e){e.indexOf(`vClipPlane`)===-1&&e.push(`vClipPlane`),e.indexOf(`vClipPlane2`)===-1&&e.push(`vClipPlane2`),e.indexOf(`vClipPlane3`)===-1&&e.push(`vClipPlane3`),e.indexOf(`vClipPlane4`)===-1&&e.push(`vClipPlane4`),e.indexOf(`vClipPlane5`)===-1&&e.push(`vClipPlane5`),e.indexOf(`vClipPlane6`)===-1&&e.push(`vClipPlane6`)}function gr(e,t,n){let r=!!(e.clipPlane??t.clipPlane),i=!!(e.clipPlane2??t.clipPlane2),a=!!(e.clipPlane3??t.clipPlane3),o=!!(e.clipPlane4??t.clipPlane4),s=!!(e.clipPlane5??t.clipPlane5),c=!!(e.clipPlane6??t.clipPlane6);r&&n.push(`#define CLIPPLANE`),i&&n.push(`#define CLIPPLANE2`),a&&n.push(`#define CLIPPLANE3`),o&&n.push(`#define CLIPPLANE4`),s&&n.push(`#define CLIPPLANE5`),c&&n.push(`#define CLIPPLANE6`)}function _r(e,t,n){let r=!1,i=!!(e.clipPlane??t.clipPlane),a=!!(e.clipPlane2??t.clipPlane2),o=!!(e.clipPlane3??t.clipPlane3),s=!!(e.clipPlane4??t.clipPlane4),c=!!(e.clipPlane5??t.clipPlane5),l=!!(e.clipPlane6??t.clipPlane6);return n.CLIPPLANE!==i&&(n.CLIPPLANE=i,r=!0),n.CLIPPLANE2!==a&&(n.CLIPPLANE2=a,r=!0),n.CLIPPLANE3!==o&&(n.CLIPPLANE3=o,r=!0),n.CLIPPLANE4!==s&&(n.CLIPPLANE4=s,r=!0),n.CLIPPLANE5!==c&&(n.CLIPPLANE5=c,r=!0),n.CLIPPLANE6!==l&&(n.CLIPPLANE6=l,r=!0),r}function vr(e,t,n){let r=t.clipPlane??n.clipPlane;yr(e,`vClipPlane`,r),r=t.clipPlane2??n.clipPlane2,yr(e,`vClipPlane2`,r),r=t.clipPlane3??n.clipPlane3,yr(e,`vClipPlane3`,r),r=t.clipPlane4??n.clipPlane4,yr(e,`vClipPlane4`,r),r=t.clipPlane5??n.clipPlane5,yr(e,`vClipPlane5`,r),r=t.clipPlane6??n.clipPlane6,yr(e,`vClipPlane6`,r)}function yr(e,t,n){n&&e.setFloat4(t,n.normal.x,n.normal.y,n.normal.z,n.d)}var br=class e{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,`Scene`)}static PrepareDefinesForMergedUV(e,t,n){t._needUVs=!0,t[n]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[n+`DIRECTUV`]=e.coordinatesIndex+1,t[`MAINUV`+(e.coordinatesIndex+1)]=!0):t[n+`DIRECTUV`]=0}static BindTextureMatrix(e,t,n){let r=e.getTextureMatrix();t.updateMatrix(n+`Matrix`,r)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==q.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,n,r,i,a,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=n,o.POINTSIZE=r,o.FOG=i&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=a)}static PrepareDefinesForCamera(e,t){let n=!1;if(e.activeCamera){let r=t.CAMERA_ORTHOGRAPHIC?1:0,i=t.CAMERA_PERSPECTIVE?1:0,a=e.activeCamera.mode===Y.ORTHOGRAPHIC_CAMERA?1:0,o=e.activeCamera.mode===Y.PERSPECTIVE_CAMERA?1:0;(r^a||i^o)&&(t.CAMERA_ORTHOGRAPHIC=a===1,t.CAMERA_PERSPECTIVE=o===1,n=!0)}return n}static PrepareDefinesForFrameBoundValues(t,n,r,i,a,o=null,s=!1){let c=e.PrepareDefinesForCamera(t,i);o!==!1&&(c=_r(r,t,i)),i.DEPTHPREPASS!==!n.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,c=!0),i.INSTANCES!==a&&(i.INSTANCES=a,c=!0),i.THIN_INSTANCES!==s&&(i.THIN_INSTANCES=s,c=!0),c&&i.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;let n=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&n)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=n?!1:void 0;let r=e.getScene().prePassRenderer;r&&r.enabled&&(t.BONES_VELOCITY_ENABLED=r.excludedSkinnedMesh.indexOf(e)===-1)}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0,t.BONETEXTURE!==void 0&&(t.BONETEXTURE=!1)}static PrepareDefinesForMorphTargets(e,t){let n=e.morphTargetManager;n?(t.MORPHTARGETS_UV=n.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=n.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=n.supportsNormals&&t.NORMAL,t.MORPHTARGETS=n.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=n.numInfluencers,t.MORPHTARGETS_TEXTURE=n.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){let n=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(n&&n.isEnabled)}static PrepareDefinesForAttributes(e,t,n,r,i=!1,a=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(H.NormalKind),t._needNormals&&e.isVerticesDataPresent(H.TangentKind)&&(t.TANGENT=!0);for(let n=1;n<=6;++n)t[`UV`+n]=t._needUVs?e.isVerticesDataPresent(`uv${n===1?``:n}`):!1;if(n){let n=e.useVertexColors&&e.isVerticesDataPresent(H.ColorKind);t.VERTEXCOLOR=n,t.VERTEXALPHA=e.hasVertexAlpha&&n&&a}return e.isVerticesDataPresent(H.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),r&&this.PrepareDefinesForBones(e,t),i&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){let n=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=n&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,n){let r=t.ORDER_INDEPENDENT_TRANSPARENCY,i=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&n,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(r!==t.ORDER_INDEPENDENT_TRANSPARENCY||i!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,n){let r=t.PREPASS;if(!t._arePrePassDirty)return;let i=[{type:1,define:`PREPASS_POSITION`,index:`PREPASS_POSITION_INDEX`},{type:2,define:`PREPASS_VELOCITY`,index:`PREPASS_VELOCITY_INDEX`},{type:3,define:`PREPASS_REFLECTIVITY`,index:`PREPASS_REFLECTIVITY_INDEX`},{type:0,define:`PREPASS_IRRADIANCE`,index:`PREPASS_IRRADIANCE_INDEX`},{type:7,define:`PREPASS_ALBEDO_SQRT`,index:`PREPASS_ALBEDO_SQRT_INDEX`},{type:5,define:`PREPASS_DEPTH`,index:`PREPASS_DEPTH_INDEX`},{type:6,define:`PREPASS_NORMAL`,index:`PREPASS_NORMAL_INDEX`}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&n){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let n=0;n<i.length;n++){let r=e.prePassRenderer.getIndex(i[n].type);r===-1?t[i[n].define]=!1:(t[i[n].define]=!0,t[i[n].index]=r)}}else{t.PREPASS=!1;for(let e=0;e<i.length;e++)t[i[e].define]=!1}t.PREPASS!=r&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,n,r,i,a,o){switch(o.needNormals=!0,i[`LIGHT`+r]===void 0&&(o.needRebuild=!0),i[`LIGHT`+r]=!0,i[`SPOTLIGHT`+r]=!1,i[`HEMILIGHT`+r]=!1,i[`POINTLIGHT`+r]=!1,i[`DIRLIGHT`+r]=!1,n.prepareLightSpecificDefines(i,r),i[`LIGHT_FALLOFF_PHYSICAL`+r]=!1,i[`LIGHT_FALLOFF_GLTF`+r]=!1,i[`LIGHT_FALLOFF_STANDARD`+r]=!1,n.falloffType){case An.FALLOFF_GLTF:i[`LIGHT_FALLOFF_GLTF`+r]=!0;break;case An.FALLOFF_PHYSICAL:i[`LIGHT_FALLOFF_PHYSICAL`+r]=!0;break;case An.FALLOFF_STANDARD:i[`LIGHT_FALLOFF_STANDARD`+r]=!0;break}if(a&&!n.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),i[`SHADOW`+r]=!1,i[`SHADOWCSM`+r]=!1,i[`SHADOWCSMDEBUG`+r]=!1,i[`SHADOWCSMNUM_CASCADES`+r]=!1,i[`SHADOWCSMUSESHADOWMAXZ`+r]=!1,i[`SHADOWCSMNOBLEND`+r]=!1,i[`SHADOWCSM_RIGHTHANDED`+r]=!1,i[`SHADOWPCF`+r]=!1,i[`SHADOWPCSS`+r]=!1,i[`SHADOWPOISSON`+r]=!1,i[`SHADOWESM`+r]=!1,i[`SHADOWCLOSEESM`+r]=!1,i[`SHADOWCUBE`+r]=!1,i[`SHADOWLOWQUALITY`+r]=!1,i[`SHADOWMEDIUMQUALITY`+r]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&n.shadowEnabled){let t=n.getShadowGenerator(e.activeCamera)??n.getShadowGenerator();if(t){let e=t.getShadowMap();e&&e.renderList&&e.renderList.length>0&&(o.shadowEnabled=!0,t.prepareDefines(i,r))}}n.lightmapMode==An.LIGHTMAP_DEFAULT?(i[`LIGHTMAPEXCLUDED`+r]=!1,i[`LIGHTMAPNOSPECULAR`+r]=!1):(o.lightmapMode=!0,i[`LIGHTMAPEXCLUDED`+r]=!0,i[`LIGHTMAPNOSPECULAR`+r]=n.lightmapMode==An.LIGHTMAP_SHADOWSONLY)}static PrepareDefinesForLights(e,t,n,r,i=4,a=!1){if(!n._areLightsDirty)return n._needNormals;let o=0,s={needNormals:n._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!a){for(let a of t.lightSources)if(this.PrepareDefinesForLight(e,t,a,o,n,r,s),o++,o===i)break}n.SPECULARTERM=s.specularEnabled,n.SHADOWS=s.shadowEnabled;for(let e=o;e<i;e++)n[`LIGHT`+e]!==void 0&&(n[`LIGHT`+e]=!1,n[`HEMILIGHT`+e]=!1,n[`POINTLIGHT`+e]=!1,n[`DIRLIGHT`+e]=!1,n[`SPOTLIGHT`+e]=!1,n[`SHADOW`+e]=!1,n[`SHADOWCSM`+e]=!1,n[`SHADOWCSMDEBUG`+e]=!1,n[`SHADOWCSMNUM_CASCADES`+e]=!1,n[`SHADOWCSMUSESHADOWMAXZ`+e]=!1,n[`SHADOWCSMNOBLEND`+e]=!1,n[`SHADOWCSM_RIGHTHANDED`+e]=!1,n[`SHADOWPCF`+e]=!1,n[`SHADOWPCSS`+e]=!1,n[`SHADOWPOISSON`+e]=!1,n[`SHADOWESM`+e]=!1,n[`SHADOWCLOSEESM`+e]=!1,n[`SHADOWCUBE`+e]=!1,n[`SHADOWLOWQUALITY`+e]=!1,n[`SHADOWMEDIUMQUALITY`+e]=!1);let c=e.getEngine().getCaps();return n.SHADOWFLOAT===void 0&&(s.needRebuild=!0),n.SHADOWFLOAT=s.shadowEnabled&&(c.textureFloatRender&&c.textureFloatLinearFiltering||c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering),n.LIGHTMAPEXCLUDED=s.lightmapMode,s.needRebuild&&n.rebuild(),s.needNormals}static PrepareUniformsAndSamplersForLight(e,t,n,r,i=null,a=!1){i&&i.push(`Light`+e),!a&&(t.push(`vLightData`+e,`vLightDiffuse`+e,`vLightSpecular`+e,`vLightDirection`+e,`vLightFalloff`+e,`vLightGround`+e,`lightMatrix`+e,`shadowsInfo`+e,`depthValues`+e),n.push(`shadowSampler`+e),n.push(`depthSampler`+e),t.push(`viewFrustumZ`+e,`cascadeBlendFactor`+e,`lightSizeUVCorrection`+e,`depthCorrection`+e,`penumbraDarkness`+e,`frustumLengths`+e),r&&(n.push(`projectionLightSampler`+e),t.push(`textureProjectionMatrix`+e)))}static PrepareUniformsAndSamplersList(e,t,n,r=4){let i,a=null;if(e.uniformsNames){let o=e;i=o.uniformsNames,a=o.uniformBuffersNames,t=o.samplers,n=o.defines,r=o.maxSimultaneousLights||0}else i=e,t||=[];for(let e=0;e<r&&n[`LIGHT`+e];e++)this.PrepareUniformsAndSamplersForLight(e,i,t,n[`PROJECTEDLIGHTTEXTURE`+e],a);n.NUM_MORPH_INFLUENCERS&&i.push(`morphTargetInfluences`),n.BAKED_VERTEX_ANIMATION_TEXTURE&&(i.push(`bakedVertexAnimationSettings`),i.push(`bakedVertexAnimationTextureSizeInverted`),i.push(`bakedVertexAnimationTime`),t.push(`bakedVertexAnimationTexture`))}static HandleFallbacksForShadows(e,t,n=4,r=0){let i=0;for(let a=0;a<n&&e[`LIGHT`+a];a++)a>0&&(i=r+a,t.addFallback(i,`LIGHT`+a)),e.SHADOWS||(e[`SHADOW`+a]&&t.addFallback(r,`SHADOW`+a),e[`SHADOWPCF`+a]&&t.addFallback(r,`SHADOWPCF`+a),e[`SHADOWPCSS`+a]&&t.addFallback(r,`SHADOWPCSS`+a),e[`SHADOWPOISSON`+a]&&t.addFallback(r,`SHADOWPOISSON`+a),e[`SHADOWESM`+a]&&t.addFallback(r,`SHADOWESM`+a),e[`SHADOWCLOSEESM`+a]&&t.addFallback(r,`SHADOWCLOSEESM`+a));return i++}static PrepareAttributesForMorphTargetsInfluencers(e,t,n){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=n,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,n){let r=n.NUM_MORPH_INFLUENCERS;if(r>0&&b.LastCreatedEngine){let i=b.LastCreatedEngine.getCaps().maxVertexAttribs,a=t.morphTargetManager;if(a!=null&&a.isUsingTextureForTargets)return;let o=a&&a.supportsNormals&&n.NORMAL,s=a&&a.supportsTangents&&n.TANGENT,c=a&&a.supportsUVs&&n.UV1;for(let n=0;n<r;n++)e.push(H.PositionKind+n),o&&e.push(H.NormalKind+n),s&&e.push(H.TangentKind+n),c&&e.push(H.UVKind+`_`+n),e.length>i&&f.Error(`Cannot add more vertex attributes for mesh `+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,n){n.BAKED_VERTEX_ANIMATION_TEXTURE&&n.INSTANCES&&e.push(`bakedVertexAnimationSettingsInstanced`)}static PrepareAttributesForBones(e,t,n,r){n.NUM_BONE_INFLUENCERS>0&&(r.addCPUSkinningFallback(0,t),e.push(H.MatricesIndicesKind),e.push(H.MatricesWeightsKind),n.NUM_BONE_INFLUENCERS>4&&(e.push(H.MatricesIndicesExtraKind),e.push(H.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(H.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push(`world0`),e.push(`world1`),e.push(`world2`),e.push(`world3`),t&&(e.push(`previousWorld0`),e.push(`previousWorld1`),e.push(`previousWorld2`),e.push(`previousWorld3`))}static BindLightProperties(e,t,n){e.transferToEffect(t,n+``)}static BindLight(e,t,n,r,i,a=!0){e._bindLight(t,n,r,i,a)}static BindLights(e,t,n,r,i=4){let a=Math.min(t.lightSources.length,i);for(let i=0;i<a;i++){let a=t.lightSources[i];this.BindLight(a,i,e,n,typeof r==`boolean`?r:r.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,n,r=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==q.FOGMODE_NONE&&(n.setFloat4(`vFogInfos`,e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),r?(e.fogColor.toLinearSpaceToRef(this._TempFogColor,e.getEngine().useExactSrgbConversions),n.setColor3(`vFogColor`,this._TempFogColor)):n.setColor3(`vFogColor`,e.fogColor))}static BindBonesParameters(t,n,r){if(!(!n||!t)&&(t.computeBonesUsingShaders&&n._bonesComputationForcedToCPU&&(t.computeBonesUsingShaders=!1),t.useBones&&t.computeBonesUsingShaders&&t.skeleton)){let i=t.skeleton;if(i.isUsingTextureForMatrices&&n.getUniformIndex(`boneTextureWidth`)>-1){let e=i.getTransformMatrixTexture(t);n.setTexture(`boneSampler`,e),n.setFloat(`boneTextureWidth`,4*(i.bones.length+1))}else{let a=i.getTransformMatrices(t);a&&(n.setMatrices(`mBones`,a),r&&t.getScene().prePassRenderer&&t.getScene().prePassRenderer.getIndex(2)&&(r.previousBones[t.uniqueId]||(r.previousBones[t.uniqueId]=a.slice()),n.setMatrices(`mPreviousBones`,r.previousBones[t.uniqueId]),e._CopyBonesTransformationMatrices(a,r.previousBones[t.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){let n=e.morphTargetManager;!e||!n||t.setFloatArray(`morphTargetInfluences`,n.influences)}static BindLogDepth(e,t,n){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf(`LOGARITHMICDEPTH`)>=0){let e=n.activeCamera;e.mode===Y.ORTHOGRAPHIC_CAMERA&&f.Error(`Logarithmic depth is not compatible with orthographic cameras!`,20),t.setFloat(`logarithmicDepthConstant`,2/(Math.log(e.maxZ+1)/Math.LN2))}}};br._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0},br._TempFogColor=wt.Black();var xr=class{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return`MaterialStencilState`}copyTo(e){B.Clone(()=>e,this)}serialize(){return B.Serialize(this)}parse(e,t,n){B.Parse(()=>this,e,t,n)}};R([z()],xr.prototype,`func`,null),R([z()],xr.prototype,`funcRef`,null),R([z()],xr.prototype,`funcMask`,null),R([z()],xr.prototype,`opStencilFail`,null),R([z()],xr.prototype,`opDepthFail`,null),R([z()],xr.prototype,`opStencilDepthPass`,null),R([z()],xr.prototype,`mask`,null),R([z()],xr.prototype,`enabled`,null);var Sr;(function(e){e[e.Created=1]=`Created`,e[e.Disposed=2]=`Disposed`,e[e.GetDefineNames=4]=`GetDefineNames`,e[e.PrepareUniformBuffer=8]=`PrepareUniformBuffer`,e[e.IsReadyForSubMesh=16]=`IsReadyForSubMesh`,e[e.PrepareDefines=32]=`PrepareDefines`,e[e.BindForSubMesh=64]=`BindForSubMesh`,e[e.PrepareEffect=128]=`PrepareEffect`,e[e.GetAnimatables=256]=`GetAnimatables`,e[e.GetActiveTextures=512]=`GetActiveTextures`,e[e.HasTexture=1024]=`HasTexture`,e[e.FillRenderTargetTextures=2048]=`FillRenderTargetTextures`,e[e.HasRenderTargetTextures=4096]=`HasRenderTargetTextures`,e[e.HardBindForSubMesh=8192]=`HardBindForSubMesh`})(Sr||={});var Q=class e{get canRenderToMRT(){return!1}set alpha(t){if(this._alpha===t)return;let n=this._alpha;this._alpha=t,(n===1||t===1)&&this.markAsDirty(e.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(t){this._backFaceCulling!==t&&(this._backFaceCulling=t,this.markAsDirty(e.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(t){this._cullBackFaces!==t&&(this._cullBackFaces=t,this.markAsDirty(e.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||=new o,this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||=new o,this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||=new o,this._onEffectCreatedObservable}set alphaMode(t){this._alphaMode!==t&&(this._alphaMode=t,this.markAsDirty(e.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(t){this._fogEnabled!==t&&(this._fogEnabled=t,this.markAsDirty(e.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case e.WireFrameFillMode:case e.LineListDrawMode:case e.LineLoopDrawMode:case e.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(t){this.fillMode=t?e.WireFrameFillMode:e.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case e.PointFillMode:case e.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(t){this.fillMode=t?e.PointFillMode:e.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(t){this._fillMode!==t&&(this._fillMode=t,this.markAsDirty(e.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}constructor(t,n,r){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state=``,this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new o,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new xr,this._useUBO=!1,this._fillMode=e.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=t;let i=n||b.LastCreatedScene;i&&(this._scene=i,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=t||A.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new je(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=e.ClockWiseSideOrientation:this.sideOrientation=e.CounterClockWiseSideOrientation,this._uniformBuffer=new Kt(this._scene.getEngine(),void 0,void 0,t),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,r||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),e.OnEventObservable.notifyObservers(this,Sr.Created))}toString(e){return`Name: `+this.name}getClassName(){return`Material`}get _isMaterial(){return!0}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,n){let r=t.materialDefines;return r?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(t){this._transparencyMode!==t&&(this._transparencyMode=t,this._forceAlphaTest=t===e.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===e.MATERIAL_OPAQUE||this._transparencyMode===e.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(t=!1){let n=this.getScene().meshes;for(let e of n)if(e.subMeshes)for(let n of e.subMeshes)n.getMaterial()===this&&n.effect&&(n.effect._wasPreviouslyReady=!1,n.effect._wasPreviouslyUsingInstances=null,n.effect._forceRebindOnNextCall=t);t&&this.markAsDirty(e.AllDirtyFlag)}_preBind(t,n=null){let r=this._scene.getEngine(),i=(n??this.sideOrientation)===e.ClockWiseSideOrientation;return r.enableEffect(t||this._getDrawWrapper()),r.setState(this.backFaceCulling,this.zOffset,!1,i,this._scene._mirroredCameraPosition?!this.cullBackFaces:this.cullBackFaces,this.stencil,this.zOffsetUnits),i}bind(e,t){}buildUniformLayout(){let e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Sr.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,n){let r=n.effect;r&&(this._eventInfo.subMesh=n,this._callbackPluginEventBindForSubMesh(this._eventInfo),r._forceRebindOnNextCall=!1)}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix(`view`,this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix(`viewProjection`,this.getScene().getTransformMatrix()),e.setMatrix(`projection`,this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,br.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){let e=this._scene.getEngine();this._cachedDepthWriteState=e.getDepthWrite(),e.setDepthWrite(!1)}if(this.disableColorWrite){let e=this._scene.getEngine();this._cachedColorWriteState=e.getColorWrite(),e.setColorWrite(!1)}if(this.depthFunction!==0){let e=this._scene.getEngine();this._cachedDepthFunctionState=e.getDepthFunction()||0,e.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Sr.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Sr.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Sr.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){let e=[];for(let t in this.meshMap){let n=this.meshMap[t];n&&e.push(n)}return e}else return this._scene.meshes.filter(e=>e.material===this)}forceCompilation(e,t,n,r){let i={clipPlane:!1,useInstances:!1,...n},a=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;let s=()=>{if(!this._scene||!this._scene.getEngine())return;let n=a.clipPlane;if(i.clipPlane&&(a.clipPlane=new Dn(0,0,0,1)),this._storeEffectOnSubMeshes){let n=!0,a=null;if(e.subMeshes){let t=new ar(0,0,0,0,0,e,void 0,!1,!1);t.materialDefines&&(t.materialDefines._renderId=-1),this.isReadyForSubMesh(e,t,i.useInstances)||(t.effect&&t.effect.getCompilationError()&&t.effect.allFallbacksProcessed()?a=t.effect.getCompilationError():(n=!1,setTimeout(s,16)))}n&&(this.allowShaderHotSwapping=o,a&&r&&r(a),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(s,16);i.clipPlane&&(a.clipPlane=n)};s()}forceCompilationAsync(e,t){return new Promise((n,r)=>{this.forceCompilation(e,()=>{n()},t,e=>{r(e)})})}markAsDirty(t){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(e._DirtyCallbackArray.length=0,t&e.TextureDirtyFlag&&e._DirtyCallbackArray.push(e._TextureDirtyCallBack),t&e.LightDirtyFlag&&e._DirtyCallbackArray.push(e._LightsDirtyCallBack),t&e.FresnelDirtyFlag&&e._DirtyCallbackArray.push(e._FresnelDirtyCallBack),t&e.AttributesDirtyFlag&&e._DirtyCallbackArray.push(e._AttributeDirtyCallBack),t&e.MiscDirtyFlag&&e._DirtyCallbackArray.push(e._MiscDirtyCallBack),t&e.PrePassDirtyFlag&&e._DirtyCallbackArray.push(e._PrePassDirtyCallBack),e._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(e._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){let e=this.getScene().meshes;for(let t of e)if(t.subMeshes)for(let e of t.subMeshes)e.getMaterial()===this&&e.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let t=this.getScene().meshes;for(let n of t)if(n.subMeshes){for(let t of n.subMeshes)if(t.getMaterial(!1)===this)for(let n of t._drawWrappers)!n||!n.defines||!n.defines.markAllAsDirty||this._materialContext===n.materialContext&&e(n.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;let e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(e._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(e._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(e._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(e._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(e._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(e._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(e._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(e._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(e._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(e._TextureAndMiscDirtyCallBack)}_checkScenePerformancePriority(){if(this._scene.performancePriority!==jn.BackwardCompatible){this.checkReadyOnlyOnce=!0;let e=this._scene.onScenePerformancePriorityChangedObservable.addOnce(()=>{this.checkReadyOnlyOnce=!1});this.onDisposeObservable.add(()=>{this._scene.onScenePerformancePriorityChangedObservable.remove(e)})}}setPrePassRenderer(e){return!1}dispose(e,t,n){let r=this.getScene();if(r.stopAnimation(this),r.freeProcessedMaterials(),r.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Sr.Disposed,this._eventInfo),this._parentContainer){let e=this._parentContainer.materials.indexOf(this);e>-1&&this._parentContainer.materials.splice(e,1),this._parentContainer=null}if(n!==!0)if(this.meshMap)for(let t in this.meshMap){let n=this.meshMap[t];n&&(n.material=null,this.releaseVertexArrayObject(n,e))}else{let t=r.meshes;for(let n of t)n.material===this&&!n.sourceMesh&&(n.material=null,this.releaseVertexArrayObject(n,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear(),this._eventInfo&&={}}releaseVertexArrayObject(e,t){if(e.geometry){let n=e.geometry;if(this._storeEffectOnSubMeshes)for(let r of e.subMeshes)n._releaseVertexArrayObject(r.effect),t&&r.effect&&r.effect.dispose();else n._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){let e=B.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,t,n){if(!e.customType)e.customType=`BABYLON.StandardMaterial`;else if(e.customType===`BABYLON.PBRMaterial`&&e.overloadedAlbedo&&(e.customType=`BABYLON.LegacyPBRMaterial`,!BABYLON.LegacyPBRMaterial))return f.Error(`Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library.`),null;let r=A.Instantiate(e.customType).Parse(e,t,n);return r._loadedUniqueId=e.uniqueId,r}};Q.TriangleFillMode=0,Q.WireFrameFillMode=1,Q.PointFillMode=2,Q.PointListDrawMode=3,Q.LineListDrawMode=4,Q.LineLoopDrawMode=5,Q.LineStripDrawMode=6,Q.TriangleStripDrawMode=7,Q.TriangleFanDrawMode=8,Q.ClockWiseSideOrientation=0,Q.CounterClockWiseSideOrientation=1,Q.TextureDirtyFlag=1,Q.LightDirtyFlag=2,Q.FresnelDirtyFlag=4,Q.AttributesDirtyFlag=8,Q.MiscDirtyFlag=16,Q.PrePassDirtyFlag=32,Q.AllDirtyFlag=63,Q.MATERIAL_OPAQUE=0,Q.MATERIAL_ALPHATEST=1,Q.MATERIAL_ALPHABLEND=2,Q.MATERIAL_ALPHATESTANDBLEND=3,Q.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0,Q.MATERIAL_NORMALBLENDMETHOD_RNM=1,Q.OnEventObservable=new o,b.OnEnginesDisposedObservable.addOnce(()=>{Q.OnEventObservable.clear()}),Q._AllDirtyCallBack=e=>e.markAllAsDirty(),Q._ImageProcessingDirtyCallBack=e=>e.markAsImageProcessingDirty(),Q._TextureDirtyCallBack=e=>e.markAsTexturesDirty(),Q._FresnelDirtyCallBack=e=>e.markAsFresnelDirty(),Q._MiscDirtyCallBack=e=>e.markAsMiscDirty(),Q._PrePassDirtyCallBack=e=>e.markAsPrePassDirty(),Q._LightsDirtyCallBack=e=>e.markAsLightDirty(),Q._AttributeDirtyCallBack=e=>e.markAsAttributesDirty(),Q._FresnelAndMiscDirtyCallBack=e=>{Q._FresnelDirtyCallBack(e),Q._MiscDirtyCallBack(e)},Q._TextureAndMiscDirtyCallBack=e=>{Q._TextureDirtyCallBack(e),Q._MiscDirtyCallBack(e)},Q._DirtyCallbackArray=[],Q._RunDirtyCallBacks=e=>{for(let t of Q._DirtyCallbackArray)t(e)},R([z()],Q.prototype,`id`,void 0),R([z()],Q.prototype,`uniqueId`,void 0),R([z()],Q.prototype,`name`,void 0),R([z()],Q.prototype,`metadata`,void 0),R([z()],Q.prototype,`checkReadyOnEveryCall`,void 0),R([z()],Q.prototype,`checkReadyOnlyOnce`,void 0),R([z()],Q.prototype,`state`,void 0),R([z(`alpha`)],Q.prototype,`_alpha`,void 0),R([z(`backFaceCulling`)],Q.prototype,`_backFaceCulling`,void 0),R([z(`cullBackFaces`)],Q.prototype,`_cullBackFaces`,void 0),R([z()],Q.prototype,`sideOrientation`,void 0),R([z(`alphaMode`)],Q.prototype,`_alphaMode`,void 0),R([z()],Q.prototype,`_needDepthPrePass`,void 0),R([z()],Q.prototype,`disableDepthWrite`,void 0),R([z()],Q.prototype,`disableColorWrite`,void 0),R([z()],Q.prototype,`forceDepthWrite`,void 0),R([z()],Q.prototype,`depthFunction`,void 0),R([z()],Q.prototype,`separateCullingPass`,void 0),R([z(`fogEnabled`)],Q.prototype,`_fogEnabled`,void 0),R([z()],Q.prototype,`pointSize`,void 0),R([z()],Q.prototype,`zOffset`,void 0),R([z()],Q.prototype,`zOffsetUnits`,void 0),R([z()],Q.prototype,`pointsCloud`,null),R([z()],Q.prototype,`fillMode`,null),R([z()],Q.prototype,`transparencyMode`,null);var Cr=class e extends Q{get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=[],this._storeEffectOnSubMeshes=!0}_hookArray(e){let t=e.push;e.push=(...n)=>{let r=t.apply(e,n);return this._markAllSubMeshesAsTexturesDirty(),r};let n=e.splice;e.splice=(t,r)=>{let i=n.apply(e,[t,r]);return this._markAllSubMeshesAsTexturesDirty(),i}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let n=0;n<this.subMaterials.length;n++)if((t=this.subMaterials[n])!=null&&t.hasTexture(e))return!0;return!1}getClassName(){return`MultiMaterial`}isReadyForSubMesh(e,t,n){for(let r=0;r<this.subMaterials.length;r++){let i=this.subMaterials[r];if(i){if(i._storeEffectOnSubMeshes){if(!i.isReadyForSubMesh(e,t,n))return!1;continue}if(!i.isReady(e))return!1}}return!0}clone(t,n){let r=new e(t,this.getScene());for(let e=0;e<this.subMaterials.length;e++){let i=null,a=this.subMaterials[e];i=n&&a?a.clone(t+`-`+a.name):this.subMaterials[e],r.subMaterials.push(i)}return r}serialize(){let e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,j&&(e.tags=j.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){let n=this.subMaterials[t];n?(e.materialsUniqueIds.push(n.uniqueId),e.materials.push(n.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,n){let r=this.getScene();if(!r)return;if(n)for(let n=0;n<this.subMaterials.length;n++){let r=this.subMaterials[n];r&&r.dispose(e,t)}let i=r.multiMaterials.indexOf(this);i>=0&&r.multiMaterials.splice(i,1),super.dispose(e,t)}static ParseMultiMaterial(t,n){let r=new e(t.name,n);return r.id=t.id,r._loadedUniqueId=t.uniqueId,j&&j.AddTagsTo(r,t.tags),t.materialsUniqueIds?r._waitingSubMaterialsUniqueIds=t.materialsUniqueIds:t.materials.forEach(e=>r.subMaterials.push(n.getLastMaterialById(e))),r}};$e(`BABYLON.MultiMaterial`,Cr);var wr=class{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}},Tr=class{constructor(){this.visibleInstances={},this.batchCache=new Er,this.batchCacheReplacementModeInFrozenMode=new Er,this.instancesBufferSize=512*4}},Er=class{constructor(){this.mustReturn=!1,this.visibleInstances=[],this.renderSelf=[],this.hardwareInstancedRendering=[]}},Dr=class{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=512,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}},Or=class{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=[],this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0,this._overrideRenderingFillMode=null}},$=class e extends mr{static _GetDefaultSideOrientation(t){return t||e.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e,this._sortLODLevels()}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(H.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(H.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new o),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new o),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new o),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new o),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new o),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){return(this._thinInstanceDataStorage.instancesCount??0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get overrideRenderingFillMode(){return this._internalMeshDataInfo._overrideRenderingFillMode}set overrideRenderingFillMode(e){this._internalMeshDataInfo._overrideRenderingFillMode=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}get forceWorldMatrixInstancedBufferUpdate(){return this._instanceDataStorage.forceMatrixUpdates}set forceWorldMatrixInstancedBufferUpdate(e){this._instanceDataStorage.forceMatrixUpdates=e}constructor(t,n=null,r=null,i=null,a,s=!0){if(super(t,n),this._internalMeshDataInfo=new Or,this.delayLoadState=0,this.instances=[],this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new Tr,this._thinInstanceDataStorage=new Dr,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=e.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,n=this.getScene(),this._onBeforeDraw=(e,t,n)=>{e&&n&&(this._uniformBuffer?this.transferToEffect(t):n.bindOnlyWorldMatrix(t))},i){if(i._geometry&&i._geometry.applyToMesh(this),h.DeepCopy(i,this,`name.material.skeleton.instances.parent.uniqueId.source.metadata.morphTargetManager.hasInstances.worldMatrixInstancedBuffer.previousWorldMatrixInstancedBuffer.hasLODLevels.geometry.isBlocked.areNormalsFrozen.facetNb.isFacetDataEnabled.lightSources.useBones.isAnInstance.collider.edgesRenderer.forward.up.right.absolutePosition.absoluteScaling.absoluteRotationQuaternion.isWorldMatrixFrozen.nonUniformScaling.behaviors.worldMatrixFromCache.hasThinInstances.cloneMeshMap.hasBoundingInfo`.split(`.`),[`_poseMatrix`]),this._internalMeshDataInfo._source=i,n.useClonedMeshMap&&(i._internalMeshDataInfo.meshMap||(i._internalMeshDataInfo.meshMap={}),i._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=i._originalBuilderSideOrientation,this._creationDataStorage=i._creationDataStorage,i._ranges){let e=i._ranges;for(let t in e)Object.prototype.hasOwnProperty.call(e,t)&&e[t]&&this.createAnimationRange(t,e[t].from,e[t].to)}if(i.metadata&&i.metadata.clone?this.metadata=i.metadata.clone():this.metadata=i.metadata,this._internalMetadata=i._internalMetadata,j&&j.HasTags(i)&&j.AddTagsTo(this,j.GetTags(i,!0)),this.setEnabled(i.isEnabled(!1)),this.parent=i.parent,this.setPivotMatrix(i.getPivotMatrix()),this.id=t+`.`+i.id,this.material=i.material,!a){let e=i.getDescendants(!0);for(let n=0;n<e.length;n++){let r=e[n];r.clone&&r.clone(t+`.`+r.name,this)}}if(i.morphTargetManager&&(this.morphTargetManager=i.morphTargetManager),n.getPhysicsEngine){let e=n.getPhysicsEngine();if(s&&e)if(e.getPluginVersion()===1){let t=e.getImpostorForPhysicsObject(i);t&&(this.physicsImpostor=t.clone(this))}else e.getPluginVersion()===2&&i.physicsBody&&i.physicsBody.clone(this)}for(let e=0;e<n.particleSystems.length;e++){let t=n.particleSystems[e];t.emitter===i&&t.clone(t.name,this)}this.skeleton=i.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}r!==null&&(this.parent=r),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=e=>{e.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new o(this._internalMeshDataInfo._onMeshReadyObserverAdded),i&&i.onClonedObservable.notifyObservers(this)}instantiateHierarchy(e=null,t,n){let r=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone(`Clone of `+(this.name||this.id),e||this.parent,!0):this.createInstance(`instance of `+(this.name||this.id));r.parent=e||this.parent,r.position=this.position.clone(),r.scaling=this.scaling.clone(),this.rotationQuaternion?r.rotationQuaternion=this.rotationQuaternion.clone():r.rotation=this.rotation.clone(),n&&n(this,r);for(let e of this.getChildTransformNodes(!0))e.getClassName()===`InstancedMesh`&&r.getClassName()===`Mesh`&&e.sourceMesh===this?e.instantiateHierarchy(r,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:r},n):e.instantiateHierarchy(r,t,n);return r}getClassName(){return`Mesh`}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=`, n vertices: `+this.getTotalVertices(),t+=`, parent: `+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:`NONE`),this.animations)for(let n=0;n<this.animations.length;n++)t+=`, animation[0]: `+this.animations[n].toString(e);if(e)if(this._geometry){let e=this.getIndices(),n=this.getVerticesData(H.PositionKind);n&&e&&(t+=`, flat shading: `+(n.length/3===e.length?`YES`:`NO`))}else t+=`, flat shading: UNKNOWN`;return t}_unBindEffect(){super._unBindEffect();for(let e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){let e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,n)=>t.distanceOrScreenCoverage<n.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>n.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return f.Warn(`You cannot use a mesh as LOD level twice`),this;let n=new wr(e,t);return this._internalMeshDataInfo._LODLevels.push(n),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){let t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++){let r=t._LODLevels[n];if(r.distanceOrScreenCoverage===e)return r.mesh}return null}removeLODLevel(e){let t=this._internalMeshDataInfo;for(let n=0;n<t._LODLevels.length;n++)t._LODLevels[n].mesh===e&&(t._LODLevels.splice(n,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){let n=this._internalMeshDataInfo;if(!n._LODLevels||n._LODLevels.length===0)return this;let r=t||this.getBoundingInfo().boundingSphere,i=e.mode===Y.ORTHOGRAPHIC_CAMERA?e.minZ:r.centerWorld.subtract(e.globalPosition).length(),a=i,o=1;if(n._useLODScreenCoverage){let t=e.screenArea,n=r.radiusWorld*e.minZ/i;n=n*n*Math.PI,a=n/t,o=-1}if(o*n._LODLevels[n._LODLevels.length-1].distanceOrScreenCoverage>o*a)return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this;for(let e=0;e<n._LODLevels.length;e++){let t=n._LODLevels[e];if(o*t.distanceOrScreenCoverage<o*a){if(t.mesh){if(t.mesh.delayLoadState===4)return t.mesh._checkDelayState(),this;if(t.mesh.delayLoadState===2)return this;t.mesh._preActivate(),t.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,t.mesh),t.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(a,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,n,r){var i;if(!this._geometry)return null;let a=r||(i=this._userInstancedBuffersStorage?.vertexBuffers[e])==null?void 0:i.getFloatData(this.instances.length+1,n||t&&this._geometry.meshes.length!==1);return a||=this._geometry.getVerticesData(e,t,n),a}getVertexBuffer(e,t){var n;return this._geometry?(t||(n=this._userInstancedBuffersStorage)==null?void 0:n.vertexBuffers[e])??this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e,t){return this._geometry?!t&&this._userInstancedBuffersStorage?.vertexBuffers[e]!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e,t){if(!this._geometry)return this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1;if(!t){let t=this._userInstancedBuffersStorage?.vertexBuffers[e];if(t)return t.isUpdatable()}return this._geometry.isVertexBufferUpdatable(e)}getVerticesDataKinds(e){if(!this._geometry){let e=[];return this._delayInfo&&this._delayInfo.forEach(function(t){e.push(t)}),e}let t=this._geometry.getVerticesDataKinds();if(!e&&this._userInstancedBuffersStorage)for(let e in this._userInstancedBuffersStorage.vertexBuffers)t.indexOf(e)===-1&&t.push(e);return t}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var n,r;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;let i=this.getEngine(),a=this.getScene(),o=t||i.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();let s=this.material||a.defaultMaterial;if(s){if(s._storeEffectOnSubMeshes)for(let e of this.subMeshes){let t=e.getMaterial();if(t){if(t._storeEffectOnSubMeshes){if(!t.isReadyForSubMesh(this,e,o))return!1}else if(!t.isReady(this,o))return!1}}else if(!s.isReady(this,o))return!1}let c=i.currentRenderPassId;for(let e of this.lightSources){let t=e.getShadowGenerators();if(!t)continue;let a=t.values();for(let e=a.next();e.done!==!0;e=a.next()){let t=e.value;if(t&&(!((n=t.getShadowMap())!=null&&n.renderList)||(r=t.getShadowMap())!=null&&r.renderList&&(t.getShadowMap()?.renderList)?.indexOf(this)!==-1)){t.getShadowMap()&&(i.currentRenderPassId=t.getShadowMap().renderPassId);for(let e of this.subMeshes)if(!t.isReady(e,o,e.getMaterial()?.needAlphaBlendingForMesh(this)??!1))return i.currentRenderPassId=c,!1;i.currentRenderPassId=c}}}for(let e of this._internalMeshDataInfo._LODLevels)if(e.mesh&&!e.mesh.isReady(o))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){let e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=[]),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),n),this}_createGlobalSubMesh(e){let t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){let n=this.getIndices();if(!n)return null;let r=n.length,i=!1;if(e)i=!0;else for(let e of this.subMeshes){if(e.indexStart+e.indexCount>r){i=!0;break}if(e.verticesStart+e.verticesCount>t){i=!0;break}}if(!i)return this.subMeshes[0]}return this.releaseSubMeshes(),new ar(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;let t=this.getTotalIndices(),n=t/e|0,r=0;for(;n%3!=0;)n++;this.releaseSubMeshes();for(let i=0;i<e&&!(r>=t);i++)ar.CreateFromIndices(0,r,i===e-1?t-r:n,this),r+=n;this.synchronizeInstances()}setVerticesData(e,t,n=!1,r){if(this._geometry)this._geometry.setVerticesData(e,t,n,r);else{let r=new X;r.set(t,e);let i=this.getScene();new sr(sr.RandomId(),i,r,n,this)}return this}removeVerticesData(e){this._geometry&&this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){let n=this.getVertexBuffer(e);!n||n.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||=sr.CreateGeometryForMesh(this),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,n,r){return this._geometry&&(r?(this.makeGeometryUnique(),this.updateVerticesData(e,t,n,!1)):this._geometry.updateVerticesData(e,t,n)),this}updateMeshPositions(e,t=!0){let n=this.getVerticesData(H.PositionKind);if(!n)return this;if(e(n),this.updateVerticesData(H.PositionKind,n,!1,!1),t){let e=this.getIndices(),t=this.getVerticesData(H.NormalKind);if(!t)return this;X.ComputeNormals(n,e,t),this.updateVerticesData(H.NormalKind,t,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry||this._geometry.meshes.length===1)return this;let e=this._geometry,t=this._geometry.copy(sr.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,n=!1){if(this._geometry)this._geometry.setIndices(e,t,n);else{let t=new X;t.indices=e;let r=this.getScene();new sr(sr.RandomId(),r,t,n,this)}return this}updateIndices(e,t,n=!1){return this._geometry&&this._geometry.updateIndices(e,t,n),this}toLeftHanded(){return this._geometry&&this._geometry.toLeftHanded(),this}_bind(e,t,n,r=!0){if(!this._geometry)return this;let i=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let a;if(this._unIndexed)a=null;else switch(this._getRenderingFillMode(n)){case Q.PointFillMode:a=null;break;case Q.WireFrameFillMode:a=e._getLinesIndexBuffer(this.getIndices(),i);break;default:case Q.TriangleFillMode:a=this._geometry.getIndexBuffer();break}return!r||!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,a):this._geometry._bind(t,a,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,n){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);let r=this.getScene().getEngine();return this._unIndexed||t==Q.PointFillMode?r.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||n):t==Q.WireFrameFillMode?r.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||n):r.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||n),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}let n=this.getScene(),r=n._isInIntermediateRendering(),i=r?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,a=this._instanceDataStorage.batchCache;if(a.mustReturn=!1,a.renderSelf[e]=t||!i&&this.isEnabled()&&this.isVisible,a.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){let t=this._instanceDataStorage.visibleInstances,i=n.getRenderId(),o=r?t.intermediateDefaultRenderId:t.defaultRenderId;a.visibleInstances[e]=t[i],!a.visibleInstances[e]&&o&&(a.visibleInstances[e]=t[o])}return a.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&a.visibleInstances[e]!==null&&a.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=a,a}_renderWithInstances(t,n,r,i,a){var o;let s=r.visibleInstances[t._id],c=s?s.length:0,l=this._instanceDataStorage,u=l.instancesBufferSize,d=l.instancesBuffer,f=l.instancesPreviousBuffer,p=(c+1)*16*4;for(;l.instancesBufferSize<p;)l.instancesBufferSize*=2;(!l.instancesData||u!=l.instancesBufferSize)&&(l.instancesData=new Float32Array(l.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousData||u!=l.instancesBufferSize)&&(l.instancesPreviousData=new Float32Array(l.instancesBufferSize/4));let m=0,h=0,g=r.renderSelf[t._id],_=!d||u!==l.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!l.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!l.isFrozen||_)){let n=this.getWorldMatrix();if(g&&(this._scene.needsPreviousWorldMatrices&&(l.masterMeshPreviousWorldMatrix?(l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,m),l.masterMeshPreviousWorldMatrix.copyFrom(n)):(l.masterMeshPreviousWorldMatrix=n.clone(),l.masterMeshPreviousWorldMatrix.copyToArray(l.instancesPreviousData,m))),n.copyToArray(l.instancesData,m),m+=16,h++),s){if(e.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&(o=t.getMaterial())!=null&&o.needAlphaBlendingForMesh(t.getRenderingMesh())){let e=this._scene.activeCamera.globalPosition;for(let t=0;t<s.length;t++){let n=s[t];n._distanceToCamera=N.Distance(n.getBoundingInfo().boundingSphere.centerWorld,e)}s.sort((e,t)=>e._distanceToCamera>t._distanceToCamera?-1:e._distanceToCamera<t._distanceToCamera?1:0)}for(let e=0;e<s.length;e++){let t=s[e],n=t.getWorldMatrix();n.copyToArray(l.instancesData,m),this._scene.needsPreviousWorldMatrices&&(t._previousWorldMatrix?(t._previousWorldMatrix.copyToArray(l.instancesPreviousData,m),t._previousWorldMatrix.copyFrom(n)):(t._previousWorldMatrix=n.clone(),t._previousWorldMatrix.copyToArray(l.instancesPreviousData,m))),m+=16,h++}}}else h=(g?1:0)+c;return _?(d&&d.dispose(),f&&f.dispose(),d=new qt(a,l.instancesData,!0,16,!1,!0),l.instancesBuffer=d,this._userInstancedBuffersStorage||={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0},this._userInstancedBuffersStorage.vertexBuffers.world0=d.createVertexBuffer(`world0`,0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=d.createVertexBuffer(`world1`,4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=d.createVertexBuffer(`world2`,8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=d.createVertexBuffer(`world3`,12,4),this._scene.needsPreviousWorldMatrices&&(f=new qt(a,l.instancesPreviousData,!0,16,!1,!0),l.instancesPreviousBuffer=f,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=f.createVertexBuffer(`previousWorld0`,0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=f.createVertexBuffer(`previousWorld1`,4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=f.createVertexBuffer(`previousWorld2`,8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=f.createVertexBuffer(`previousWorld3`,12,4)),this._invalidateInstanceVertexArrayObject()):(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&(d.updateDirectly(l.instancesData,0,h),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&f.updateDirectly(l.instancesPreviousData,0,h)),this._processInstancedBuffers(s,g),this.getScene()._activeIndices.addCount(t.indexCount*h,!1),a._currentDrawContext&&(a._currentDrawContext.useInstancing=!0),this._bind(t,i,n),this._draw(t,n,h),this._scene.needsPreviousWorldMatrices&&!_&&this._instanceDataStorage.manualUpdate&&(!this._instanceDataStorage.isFrozen||this._instanceDataStorage.forceMatrixUpdates)&&!this._instanceDataStorage.previousManualUpdate&&f.updateDirectly(l.instancesData,0,h),a.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,n,r){let i=this._thinInstanceDataStorage?.instancesCount??0;this.getScene()._activeIndices.addCount(e.indexCount*i,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,n,t),this._draw(e,t,i),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,i):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer(`previousWorld`,this._thinInstanceDataStorage.matrixData,!1)),r.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,n,r,i,a,o,s){let c=this.getScene(),l=c.getEngine();if(r=this._getRenderingFillMode(r),a&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,r,n,l),this;if(a)this._renderWithInstances(t,r,i,n,l);else{l._currentDrawContext&&(l._currentDrawContext.useInstancing=!1);let n=0;i.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),s),n++,this._draw(t,r,this._instanceDataStorage.overridenInstanceCount));let a=i.visibleInstances[t._id];if(a){let e=a.length;n+=e;for(let n=0;n<e;n++){let e=a[n].getWorldMatrix();o&&o(!0,e,s),this._draw(t,r)}}c._activeIndices.addCount(t.indexCount*n,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(let t in this._userInstancedBuffersStorage.vertexBuffers){let n=this._userInstancedBuffersStorage.vertexBuffers[t];n&&(e&&n.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,n){var r,i;let a=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;let o=this._getInstancesRenderList(e._id,!!n);if(o.mustReturn||!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;let s=a.getEngine(),c=0,l=null;this.ignoreCameraMaxZ&&a.activeCamera&&!a._isInIntermediateRendering()&&(c=a.activeCamera.maxZ,l=a.activeCamera,a.activeCamera.maxZ=0,a.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);let u=e.getRenderingMesh(),d=o.hardwareInstancedRendering[e._id]||u.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,f=this._instanceDataStorage,p=e.getMaterial();if(!p)return l&&(l.maxZ=c,a.updateTransformMatrix(!0)),this;if(!f.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==p){if(p._storeEffectOnSubMeshes){if(!p.isReadyForSubMesh(this,e,d))return l&&(l.maxZ=c,a.updateTransformMatrix(!0)),this}else if(!p.isReady(this,d))return l&&(l.maxZ=c,a.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=p}else if(p._storeEffectOnSubMeshes&&!((r=e.effect)!=null&&r._wasPreviouslyReady)||!p._storeEffectOnSubMeshes&&!((i=p.getEffect())!=null&&i._wasPreviouslyReady))return l&&(l.maxZ=c,a.updateTransformMatrix(!0)),this;t&&s.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let m;m=this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?e._drawWrapper:this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();let h=m?.effect??null;for(let t of a._beforeRenderingMeshStage)t.action(this,e,o,h);if(!m||!h)return l&&(l.maxZ=c,a.updateTransformMatrix(!0)),this;let g=n||this,_;if(!f.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){let e=g._getWorldMatrixDeterminant();_=this.overrideMaterialSideOrientation,_??=this._internalMeshDataInfo._effectiveMaterial.sideOrientation,e<0&&(_=_===Q.ClockWiseSideOrientation?Q.CounterClockWiseSideOrientation:Q.ClockWiseSideOrientation),f.sideOrientation=_}else _=f.sideOrientation;let v=this._internalMeshDataInfo._effectiveMaterial._preBind(m,_);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&s.setDepthWrite(!0);let y=this._internalMeshDataInfo._effectiveMaterial,b=y.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),d||this._bind(e,h,b,!1);let x=g.getWorldMatrix();y._storeEffectOnSubMeshes?y.bindForSubMesh(x,this,e):y.bind(x,this),!y.backFaceCulling&&y.separateCullingPass&&(s.setState(!0,y.zOffset,!1,!v,y.cullBackFaces,y.stencil,y.zOffsetUnits),this._processRendering(this,e,h,b,o,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),s.setState(!0,y.zOffset,!1,v,y.cullBackFaces,y.stencil,y.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,h,b,o,d,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(let t of a._afterRenderingMeshStage)t.action(this,e,o,h);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),l&&(l.maxZ=c,a.updateTransformMatrix(!0)),a.performancePriority===jn.Aggressive&&!f.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(H.MatricesWeightsKind)&&(this.isVerticesDataPresent(H.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){let e=this.getVerticesData(H.MatricesWeightsKind),t=e.length;for(let n=0;n<t;n+=4){let t=e[n]+e[n+1]+e[n+2]+e[n+3];if(t===0)e[n]=1;else{let r=1/t;e[n]*=r,e[n+1]*=r,e[n+2]*=r,e[n+3]*=r}}this.setVerticesData(H.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){let e=this.getVerticesData(H.MatricesWeightsExtraKind),t=this.getVerticesData(H.MatricesWeightsKind),n=t.length;for(let r=0;r<n;r+=4){let n=t[r]+t[r+1]+t[r+2]+t[r+3];if(n+=e[r]+e[r+1]+e[r+2]+e[r+3],n===0)t[r]=1;else{let i=1/n;t[r]*=i,t[r+1]*=i,t[r+2]*=i,t[r+3]*=i,e[r]*=i,e[r+1]*=i,e[r+2]*=i,e[r+3]*=i}}this.setVerticesData(H.MatricesWeightsKind,t),this.setVerticesData(H.MatricesWeightsKind,e)}validateSkinning(){let e=this.getVerticesData(H.MatricesWeightsExtraKind),t=this.getVerticesData(H.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:`not skinned`};let n=t.length,r=0,i=0,a=0,o=0,s=e===null?4:8,c=[];for(let e=0;e<=s;e++)c[e]=0;for(let l=0;l<n;l+=4){let n=t[l],u=n,d=u===0?0:1;for(let i=1;i<s;i++){let a=i<4?t[l+i]:e[l+i-4];a>n&&r++,a!==0&&d++,u+=a,n=a}if(c[d]++,d>a&&(a=d),u===0)i++;else{let n=1/u,r=0;for(let i=0;i<s;i++)i<4?r+=Math.abs(t[l+i]-t[l+i]*n):r+=Math.abs(e[l+i-4]-e[l+i-4]*n);r>.001&&o++}}let l=this.skeleton.bones.length,u=this.getVerticesData(H.MatricesIndicesKind),d=this.getVerticesData(H.MatricesIndicesExtraKind),f=0;for(let e=0;e<n;e+=4)for(let t=0;t<s;t++){let n=t<4?u[e+t]:d[e+t-4];(n>=l||n<0)&&f++}let p=`Number of Weights = `+n/4+`
Maximum influences = `+a+`
Missing Weights = `+i+`
Not Sorted = `+r+`
Not Normalized = `+o+`
WeightCounts = [`+c+`]
Number of bones = `+l+`
Bad Bone Indices = `+f;return{skinned:!0,valid:i===0&&o===0&&f===0,report:p}}_checkDelayState(){let e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);let t=this.delayLoadingFile.indexOf(`.babylonbinarymeshdata`)!==-1;return A.LoadFile(this.delayLoadingFile,t=>{t instanceof ArrayBuffer?this._delayLoadingFunction(t,this):this._delayLoadingFunction(JSON.parse(t),this),this.instances.forEach(e=>{e.refreshBoundingInfo(),e._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){let t=this.getScene().materials,n;for(n=t.length-1;n>-1;n--)if(t[n].id===e)return this.material=t[n],this;let r=this.getScene().multiMaterials;for(n=r.length-1;n>-1;n--)if(r[n].id===e)return this.material=r[n],this;return this}getAnimatables(){let e=[];return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(H.PositionKind))return this;let t=this.subMeshes.splice(0);this._resetPointsArrayCache();let n=this.getVerticesData(H.PositionKind),r=N.Zero(),i;for(i=0;i<n.length;i+=3)N.TransformCoordinatesFromFloatsToRef(n[i],n[i+1],n[i+2],e,r).toArray(n,i);if(this.setVerticesData(H.PositionKind,n,this.getVertexBuffer(H.PositionKind).isUpdatable()),this.isVerticesDataPresent(H.NormalKind)){for(n=this.getVerticesData(H.NormalKind),i=0;i<n.length;i+=3)N.TransformNormalFromFloatsToRef(n[i],n[i+1],n[i+2],e,r).normalize().toArray(n,i);this.setVerticesData(H.NormalKind,n,this.getVertexBuffer(H.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(t=``,n=null,r,i=!0){return new e(t,this.getScene(),n,this,r,i)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);let n=this._internalMeshDataInfo;if(n._onBeforeDrawObservable&&n._onBeforeDrawObservable.clear(),n._onBeforeBindObservable&&n._onBeforeBindObservable.clear(),n._onBeforeRenderObservable&&n._onBeforeRenderObservable.clear(),n._onAfterRenderObservable&&n._onAfterRenderObservable.clear(),n._onBetweenPassObservable&&n._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(n.meshMap)for(let e in n.meshMap){let t=n.meshMap[e];t&&(t._internalMeshDataInfo._source=null,n.meshMap[e]=void 0)}n._source&&n._source._internalMeshDataInfo.meshMap&&(n._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{let e=this.getScene().meshes;for(let t of e){let e=t;e._internalMeshDataInfo&&e._internalMeshDataInfo._source&&e._internalMeshDataInfo._source===this&&(e._internalMeshDataInfo._source=null)}}n._source=null,this._instanceDataStorage.visibleInstances={},this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,n,r,i,a,o=!1){let s=this.getScene();return A.LoadImage(e,e=>{let s=e.width,c=e.height,l=this.getEngine().createCanvas(s,c).getContext(`2d`);l.drawImage(e,0,0);let u=l.getImageData(0,0,s,c).data;this.applyDisplacementMapFromBuffer(u,s,c,t,n,i,a,o),r&&r(this)},()=>{},s.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,n,r,i,a,o,s=!1){if(!this.isVerticesDataPresent(H.PositionKind)||!this.isVerticesDataPresent(H.NormalKind)||!this.isVerticesDataPresent(H.UVKind))return f.Warn(`Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing`),this;let c=this.getVerticesData(H.PositionKind,!0,!0),l=this.getVerticesData(H.NormalKind),u=this.getVerticesData(H.UVKind),d=N.Zero(),p=N.Zero(),m=gt.Zero();a||=gt.Zero(),o||=new gt(1,1);for(let s=0;s<c.length;s+=3){N.FromArrayToRef(c,s,d),N.FromArrayToRef(l,s,p),gt.FromArrayToRef(u,s/3*2,m);let f=((Math.abs(m.x*o.x+a.x%1)*(t-1)%t|0)+(Math.abs(m.y*o.y+a.y%1)*(n-1)%n|0)*t)*4,h=e[f]/255,g=e[f+1]/255,_=e[f+2]/255,v=h*.3+g*.59+_*.11;p.normalize(),p.scaleInPlace(r+(i-r)*v),d=d.add(p),d.toArray(c,s)}return X.ComputeNormals(c,this.getIndices(),l),s?(this.setVerticesData(H.PositionKind,c),this.setVerticesData(H.NormalKind,l),this.setVerticesData(H.UVKind,u)):(this.updateVerticesData(H.PositionKind,c),this.updateVerticesData(H.NormalKind,l)),this}convertToFlatShadedMesh(){let e=this.getVerticesDataKinds(),t={},n={},r={},i=!1,a,o;for(a=0;a<e.length;a++){o=e[a];let s=this.getVertexBuffer(o),c=s.getData();if(!((c instanceof Array||c instanceof Float32Array)&&c.length===0)){if(o===H.NormalKind){i=s.isUpdatable(),e.splice(a,1),a--;continue}t[o]=s,n[o]=this.getVerticesData(o),r[o]=[]}}let s=this.subMeshes.slice(0),c=this.getIndices(),l=this.getTotalIndices(),u;for(u=0;u<l;u++){let i=c[u];for(a=0;a<e.length;a++){if(o=e[a],!t[o])continue;let s=t[o].getStrideSize();for(let e=0;e<s;e++)r[o].push(n[o][i*s+e])}}let d=[],f=r[H.PositionKind],p=this.getScene().useRightHandedSystem,m;for(m=p?this.overrideMaterialSideOrientation===1:this.overrideMaterialSideOrientation===0,u=0;u<l;u+=3){c[u]=u,c[u+1]=u+1,c[u+2]=u+2;let e=N.FromArray(f,u*3),t=N.FromArray(f,(u+1)*3),n=N.FromArray(f,(u+2)*3),r=e.subtract(t),i=n.subtract(t),a=N.Normalize(N.Cross(r,i));m&&a.scaleInPlace(-1);for(let e=0;e<3;e++)d.push(a.x),d.push(a.y),d.push(a.z)}for(this.setIndices(c),this.setVerticesData(H.NormalKind,d,i),a=0;a<e.length;a++)o=e[a],r[o]&&this.setVerticesData(o,r[o],t[o].isUpdatable());this.releaseSubMeshes();for(let e=0;e<s.length;e++){let t=s[e];ar.AddToMesh(t.materialIndex,t.indexStart,t.indexCount,t.indexStart,t.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){let e=this.getVerticesDataKinds(),t={},n={},r={},i,a;for(i=0;i<e.length;i++)a=e[i],t[a]=this.getVertexBuffer(a),n[a]=t[a].getData(),r[a]=[];let o=this.subMeshes.slice(0),s=this.getIndices(),c=this.getTotalIndices(),l;for(l=0;l<c;l++){let o=s[l];for(i=0;i<e.length;i++){a=e[i];let s=t[a].getStrideSize();for(let e=0;e<s;e++)r[a].push(n[a][o*s+e])}}for(l=0;l<c;l+=3)s[l]=l,s[l+1]=l+1,s[l+2]=l+2;for(this.setIndices(s),i=0;i<e.length;i++)a=e[i],this.setVerticesData(a,r[a],t[a].isUpdatable(),t[a].getStrideSize());this.releaseSubMeshes();for(let e=0;e<o.length;e++){let t=o[e];ar.AddToMesh(t.materialIndex,t.indexStart,t.indexCount,t.indexStart,t.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){let t=X.ExtractFromMesh(this),n;if(e&&this.isVerticesDataPresent(H.NormalKind)&&t.normals)for(n=0;n<t.normals.length;n++)t.normals[n]*=-1;if(t.indices){let e;for(n=0;n<t.indices.length;n+=3)e=t.indices[n+1],t.indices[n+1]=t.indices[n+2],t.indices[n+2]=e}return t.applyToMesh(this,this.isVertexBufferUpdatable(H.PositionKind)),this}increaseVertices(e=1){let t=X.ExtractFromMesh(this),n=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,r=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,i=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,a=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!n||!r)f.Warn(`Couldn't increase number of vertices : VertexData must contain at least indices and positions`);else{t.indices=n,t.positions=r,i&&(t.uvs=i),a&&(t.normals=a);let o=e+1,s=[];for(let e=0;e<o+1;e++)s[e]=[];let c,l,u=new N(0,0,0),d=new N(0,0,0),f=new gt(0,0),p=[],m=[],h=[],g,_=r.length,v;i&&(v=i.length);let y;a&&(y=a.length);for(let e=0;e<n.length;e+=3){m[0]=n[e],m[1]=n[e+1],m[2]=n[e+2];for(let e=0;e<3;e++)if(c=m[e],l=m[(e+1)%3],h[c]===void 0&&h[l]===void 0?(h[c]=[],h[l]=[]):(h[c]===void 0&&(h[c]=[]),h[l]===void 0&&(h[l]=[])),h[c][l]===void 0&&h[l][c]===void 0){h[c][l]=[],u.x=(r[3*l]-r[3*c])/o,u.y=(r[3*l+1]-r[3*c+1])/o,u.z=(r[3*l+2]-r[3*c+2])/o,a&&(d.x=(a[3*l]-a[3*c])/o,d.y=(a[3*l+1]-a[3*c+1])/o,d.z=(a[3*l+2]-a[3*c+2])/o),i&&(f.x=(i[2*l]-i[2*c])/o,f.y=(i[2*l+1]-i[2*c+1])/o),h[c][l].push(c);for(let e=1;e<o;e++)h[c][l].push(r.length/3),r[_++]=r[3*c]+e*u.x,r[_++]=r[3*c+1]+e*u.y,r[_++]=r[3*c+2]+e*u.z,a&&(a[y++]=a[3*c]+e*d.x,a[y++]=a[3*c+1]+e*d.y,a[y++]=a[3*c+2]+e*d.z),i&&(i[v++]=i[2*c]+e*f.x,i[v++]=i[2*c+1]+e*f.y);h[c][l].push(l),h[l][c]=[],g=h[c][l].length;for(let e=0;e<g;e++)h[l][c][e]=h[c][l][g-1-e]}s[0][0]=n[e],s[1][0]=h[n[e]][n[e+1]][1],s[1][1]=h[n[e]][n[e+2]][1];for(let t=2;t<o;t++){s[t][0]=h[n[e]][n[e+1]][t],s[t][t]=h[n[e]][n[e+2]][t],u.x=(r[3*s[t][t]]-r[3*s[t][0]])/t,u.y=(r[3*s[t][t]+1]-r[3*s[t][0]+1])/t,u.z=(r[3*s[t][t]+2]-r[3*s[t][0]+2])/t,a&&(d.x=(a[3*s[t][t]]-a[3*s[t][0]])/t,d.y=(a[3*s[t][t]+1]-a[3*s[t][0]+1])/t,d.z=(a[3*s[t][t]+2]-a[3*s[t][0]+2])/t),i&&(f.x=(i[2*s[t][t]]-i[2*s[t][0]])/t,f.y=(i[2*s[t][t]+1]-i[2*s[t][0]+1])/t);for(let e=1;e<t;e++)s[t][e]=r.length/3,r[_++]=r[3*s[t][0]]+e*u.x,r[_++]=r[3*s[t][0]+1]+e*u.y,r[_++]=r[3*s[t][0]+2]+e*u.z,a&&(a[y++]=a[3*s[t][0]]+e*d.x,a[y++]=a[3*s[t][0]+1]+e*d.y,a[y++]=a[3*s[t][0]+2]+e*d.z),i&&(i[v++]=i[2*s[t][0]]+e*f.x,i[v++]=i[2*s[t][0]+1]+e*f.y)}s[o]=h[n[e+1]][n[e+2]],p.push(s[0][0],s[1][0],s[1][1]);for(let e=1;e<o;e++){let t;for(t=0;t<e;t++)p.push(s[e][t],s[e+1][t],s[e+1][t+1]),p.push(s[e][t],s[e+1][t+1],s[e][t+1]);p.push(s[e][t],s[e+1][t],s[e+1][t+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(H.PositionKind))}}forceSharedVertices(){let e=X.ExtractFromMesh(this),t=e.uvs,n=e.indices,r=e.positions,i=e.colors,a=e.matricesIndices,o=e.matricesWeights,s=e.matricesIndicesExtra,c=e.matricesWeightsExtra;if(n===void 0||r===void 0||n===null||r===null)f.Warn(`VertexData contains empty entries`);else{let l=[],u=[],d=[],f=[],p=[],m=[],h=[],g=[],_=[],v=0,y={},b,x;for(let e=0;e<n.length;e+=3){x=[n[e],n[e+1],n[e+2]],_=[];for(let e=0;e<3;e++){_[e]=``;for(let t=0;t<3;t++)Math.abs(r[3*x[e]+t])<1e-8&&(r[3*x[e]+t]=0),_[e]+=r[3*x[e]+t]+`|`}if(!(_[0]==_[1]||_[0]==_[2]||_[1]==_[2]))for(let e=0;e<3;e++){if(b=y[_[e]],b===void 0){y[_[e]]=v,b=v++;for(let t=0;t<3;t++)l.push(r[3*x[e]+t]);if(i!=null)for(let t=0;t<4;t++)f.push(i[4*x[e]+t]);if(t!=null)for(let n=0;n<2;n++)d.push(t[2*x[e]+n]);if(a!=null)for(let t=0;t<4;t++)p.push(a[4*x[e]+t]);if(o!=null)for(let t=0;t<4;t++)m.push(o[4*x[e]+t]);if(s!=null)for(let t=0;t<4;t++)h.push(s[4*x[e]+t]);if(c!=null)for(let t=0;t<4;t++)g.push(c[4*x[e]+t])}u.push(b)}}let S=[];X.ComputeNormals(l,u,S),e.positions=l,e.indices=u,e.normals=S,t!=null&&(e.uvs=d),i!=null&&(e.colors=f),a!=null&&(e.matricesIndices=p),o!=null&&(e.matricesWeights=m),s!=null&&(e.matricesIndicesExtra=h),o!=null&&(e.matricesWeightsExtra=g),e.applyToMesh(this,this.isVertexBufferUpdatable(H.PositionKind))}}static _instancedMeshFactory(e,t){throw _(`InstancedMesh`)}static _PhysicsImpostorParser(e,t,n){throw _(`PhysicsImpostor`)}createInstance(t){return e._instancedMeshFactory(t,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){let t=this.getIndices(),n=this.getVerticesData(H.PositionKind);if(!n||!t)return this;let r=[];for(let e=0;e<n.length;e+=3)r.push(N.FromArray(n,e));let i=[];return rt.SyncAsyncForLoop(r.length,40,e=>{let t=r.length-1-e,n=r[t];for(let e=0;e<t;++e){let a=r[e];if(n.equals(a)){i[t]=e;break}}},()=>{for(let e=0;e<t.length;++e)t[e]=i[t[e]]||t[e];let n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),j&&j.HasTags(this)&&(e.tags=j.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;let t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let t=0;t<this.subMeshes.length;t++){let n=this.subMeshes[t];e.subMeshes.push({materialIndex:n.materialIndex,verticesStart:n.verticesStart,verticesCount:n.verticesCount,indexStart:n.indexStart,indexCount:n.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(U.NAME_PHYSICSENGINE)){let t=this.getPhysicsImpostor();t&&(e.physicsMass=t.getParam(`mass`),e.physicsFriction=t.getParam(`friction`),e.physicsRestitution=t.getParam(`mass`),e.physicsImpostor=t.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let t=0;t<this.instances.length;t++){let n=this.instances[t];if(n.doNotSerialize)continue;let r={name:n.name,id:n.id,isEnabled:n.isEnabled(!1),isVisible:n.isVisible,isPickable:n.isPickable,checkCollisions:n.checkCollisions,position:n.position.asArray(),scaling:n.scaling.asArray()};if(n.parent&&n.parent._serializeAsParent(r),n.rotationQuaternion?r.rotationQuaternion=n.rotationQuaternion.asArray():n.rotation&&(r.rotation=n.rotation.asArray()),this.getScene()._getComponent(U.NAME_PHYSICSENGINE)){let e=n.getPhysicsImpostor();e&&(r.physicsMass=e.getParam(`mass`),r.physicsFriction=e.getParam(`friction`),r.physicsRestitution=e.getParam(`mass`),r.physicsImpostor=e.type)}n.metadata&&(r.metadata=n.metadata),n.actionManager&&(r.actions=n.actionManager.serialize(n.name)),e.instances.push(r),B.AppendSerializedAnimations(n,r),r.ranges=n.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){let t={data:{},sizes:{},strides:{}};for(let e in this._userThinInstanceBuffersStorage.data)t.data[e]=Array.from(this._userThinInstanceBuffersStorage.data[e]),t.sizes[e]=this._userThinInstanceBuffersStorage.sizes[e],t.strides[e]=this._userThinInstanceBuffersStorage.strides[e];e.thinInstances.userThinInstance=t}return B.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();let e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){f.Error(`Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count.`),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){let n=e.getActiveTarget(t),r=n.getPositions();if(!r){f.Error(`Invalid morph target. Target must have positions.`);return}this.geometry.setVerticesData(H.PositionKind+t,r,!1,3);let i=n.getNormals();i&&this.geometry.setVerticesData(H.NormalKind+t,i,!1,3);let a=n.getTangents();a&&this.geometry.setVerticesData(H.TangentKind+t,a,!1,3);let o=n.getUVs();o&&this.geometry.setVerticesData(H.UVKind+`_`+t,o,!1,2)}}else{let e=0;for(;this.geometry.isVerticesDataPresent(H.PositionKind+e);)this.geometry.removeVerticesData(H.PositionKind+e),this.geometry.isVerticesDataPresent(H.NormalKind+e)&&this.geometry.removeVerticesData(H.NormalKind+e),this.geometry.isVerticesDataPresent(H.TangentKind+e)&&this.geometry.removeVerticesData(H.TangentKind+e),this.geometry.isVerticesDataPresent(H.UVKind+e)&&this.geometry.removeVerticesData(H.UVKind+`_`+e),e++}}static Parse(t,n,r){let i;if(i=t.type&&t.type===`LinesMesh`?e._LinesMeshParser(t,n):t.type&&t.type===`GroundMesh`?e._GroundMeshParser(t,n):t.type&&t.type===`GoldbergMesh`?e._GoldbergMeshParser(t,n):new e(t.name,n),i.id=t.id,i._waitingParsedUniqueId=t.uniqueId,j&&j.AddTagsTo(i,t.tags),i.position=N.FromArray(t.position),t.metadata!==void 0&&(i.metadata=t.metadata),t.rotationQuaternion?i.rotationQuaternion=P.FromArray(t.rotationQuaternion):t.rotation&&(i.rotation=N.FromArray(t.rotation)),i.scaling=N.FromArray(t.scaling),t.localMatrix?i.setPreTransformMatrix(F.FromArray(t.localMatrix)):t.pivotMatrix&&i.setPivotMatrix(F.FromArray(t.pivotMatrix)),i.setEnabled(t.isEnabled),i.isVisible=t.isVisible,i.infiniteDistance=t.infiniteDistance,i.showBoundingBox=t.showBoundingBox,i.showSubMeshesBoundingBox=t.showSubMeshesBoundingBox,t.applyFog!==void 0&&(i.applyFog=t.applyFog),t.pickable!==void 0&&(i.isPickable=t.pickable),t.alphaIndex!==void 0&&(i.alphaIndex=t.alphaIndex),i.receiveShadows=t.receiveShadows,t.billboardMode!==void 0&&(i.billboardMode=t.billboardMode),t.visibility!==void 0&&(i.visibility=t.visibility),i.checkCollisions=t.checkCollisions,i.overrideMaterialSideOrientation=t.overrideMaterialSideOrientation,t.isBlocker!==void 0&&(i.isBlocker=t.isBlocker),i._shouldGenerateFlatShading=t.useFlatShading,t.freezeWorldMatrix&&(i._waitingData.freezeWorldMatrix=t.freezeWorldMatrix),t.parentId!==void 0&&(i._waitingParentId=t.parentId),t.parentInstanceIndex!==void 0&&(i._waitingParentInstanceIndex=t.parentInstanceIndex),t.actions!==void 0&&(i._waitingData.actions=t.actions),t.overlayAlpha!==void 0&&(i.overlayAlpha=t.overlayAlpha),t.overlayColor!==void 0&&(i.overlayColor=wt.FromArray(t.overlayColor)),t.renderOverlay!==void 0&&(i.renderOverlay=t.renderOverlay),i.isUnIndexed=!!t.isUnIndexed,i.hasVertexAlpha=t.hasVertexAlpha,t.delayLoadingFile?(i.delayLoadState=4,i.delayLoadingFile=r+t.delayLoadingFile,i.buildBoundingInfo(N.FromArray(t.boundingBoxMinimum),N.FromArray(t.boundingBoxMaximum)),t._binaryInfo&&(i._binaryInfo=t._binaryInfo),i._delayInfo=[],t.hasUVs&&i._delayInfo.push(H.UVKind),t.hasUVs2&&i._delayInfo.push(H.UV2Kind),t.hasUVs3&&i._delayInfo.push(H.UV3Kind),t.hasUVs4&&i._delayInfo.push(H.UV4Kind),t.hasUVs5&&i._delayInfo.push(H.UV5Kind),t.hasUVs6&&i._delayInfo.push(H.UV6Kind),t.hasColors&&i._delayInfo.push(H.ColorKind),t.hasMatricesIndices&&i._delayInfo.push(H.MatricesIndicesKind),t.hasMatricesWeights&&i._delayInfo.push(H.MatricesWeightsKind),i._delayLoadingFunction=sr._ImportGeometry,Fn.ForceFullSceneLoadingForIncremental&&i._checkDelayState()):sr._ImportGeometry(t,i),t.materialUniqueId?i._waitingMaterialId=t.materialUniqueId:t.materialId&&(i._waitingMaterialId=t.materialId),t.morphTargetManagerId>-1&&(i.morphTargetManager=n.getMorphTargetManagerById(t.morphTargetManagerId)),t.skeletonId!==void 0&&t.skeletonId!==null&&(i.skeleton=n.getLastSkeletonById(t.skeletonId),t.numBoneInfluencers&&(i.numBoneInfluencers=t.numBoneInfluencers)),t.animations){for(let e=0;e<t.animations.length;e++){let n=t.animations[e],r=et(`BABYLON.Animation`);r&&i.animations.push(r.Parse(n))}Bn.ParseAnimationRanges(i,t,n)}if(t.autoAnimate&&n.beginAnimation(i,t.autoAnimateFrom,t.autoAnimateTo,t.autoAnimateLoop,t.autoAnimateSpeed||1),t.layerMask&&!isNaN(t.layerMask)?i.layerMask=Math.abs(parseInt(t.layerMask)):i.layerMask=268435455,t.physicsImpostor&&e._PhysicsImpostorParser(n,i,t),t.lodMeshIds&&(i._waitingData.lods={ids:t.lodMeshIds,distances:t.lodDistances?t.lodDistances:null,coverages:t.lodCoverages?t.lodCoverages:null}),t.instances)for(let r=0;r<t.instances.length;r++){let a=t.instances[r],o=i.createInstance(a.name);if(a.id&&(o.id=a.id),j&&(a.tags?j.AddTagsTo(o,a.tags):j.AddTagsTo(o,t.tags)),o.position=N.FromArray(a.position),a.metadata!==void 0&&(o.metadata=a.metadata),a.parentId!==void 0&&(o._waitingParentId=a.parentId),a.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=a.parentInstanceIndex),a.isEnabled!==void 0&&a.isEnabled!==null&&o.setEnabled(a.isEnabled),a.isVisible!==void 0&&a.isVisible!==null&&(o.isVisible=a.isVisible),a.isPickable!==void 0&&a.isPickable!==null&&(o.isPickable=a.isPickable),a.rotationQuaternion?o.rotationQuaternion=P.FromArray(a.rotationQuaternion):a.rotation&&(o.rotation=N.FromArray(a.rotation)),o.scaling=N.FromArray(a.scaling),a.checkCollisions!=null&&a.checkCollisions!=null&&(o.checkCollisions=a.checkCollisions),a.pickable!=null&&a.pickable!=null&&(o.isPickable=a.pickable),a.showBoundingBox!=null&&a.showBoundingBox!=null&&(o.showBoundingBox=a.showBoundingBox),a.showSubMeshesBoundingBox!=null&&a.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=a.showSubMeshesBoundingBox),a.alphaIndex!=null&&a.showSubMeshesBoundingBox!=null&&(o.alphaIndex=a.alphaIndex),a.physicsImpostor&&e._PhysicsImpostorParser(n,o,a),a.actions!==void 0&&(o._waitingData.actions=a.actions),a.animations){for(let e=0;e<a.animations.length;e++){let t=a.animations[e],n=et(`BABYLON.Animation`);n&&o.animations.push(n.Parse(t))}Bn.ParseAnimationRanges(o,a,n),a.autoAnimate&&n.beginAnimation(o,a.autoAnimateFrom,a.autoAnimateTo,a.autoAnimateLoop,a.autoAnimateSpeed||1)}}if(t.thinInstances){let e=t.thinInstances;if(i.thinInstanceEnablePicking=!!e.enablePicking,e.matrixData?(i.thinInstanceSetBuffer(`matrix`,new Float32Array(e.matrixData),16,!1),i._thinInstanceDataStorage.matrixBufferSize=e.matrixBufferSize,i._thinInstanceDataStorage.instancesCount=e.instancesCount):i._thinInstanceDataStorage.matrixBufferSize=e.matrixBufferSize,t.thinInstances.userThinInstance){let e=t.thinInstances.userThinInstance;for(let t in e.data)i.thinInstanceSetBuffer(t,new Float32Array(e.data[t]),e.strides[t],!1),i._userThinInstanceBuffersStorage.sizes[t]=e.sizes[t]}}return i}setPositionsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourcePositions){let t=this.getVerticesData(H.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(H.PositionKind)||this.setVerticesData(H.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){let e=this._internalMeshDataInfo;if(!e._sourceNormals){let t=this.getVerticesData(H.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(H.NormalKind)||this.setVerticesData(H.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry||this.geometry._softwareSkinningFrameId==this.getScene().getFrameId()||(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(H.PositionKind))||!this.isVerticesDataPresent(H.MatricesIndicesKind)||!this.isVerticesDataPresent(H.MatricesWeightsKind))return this;let t=this.isVerticesDataPresent(H.NormalKind),n=this._internalMeshDataInfo;if(!n._sourcePositions){let e=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=e}t&&!n._sourceNormals&&this.setNormalsForCPUSkinning();let r=this.getVerticesData(H.PositionKind);if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r));let i=this.getVerticesData(H.NormalKind);if(t){if(!i)return this;i instanceof Float32Array||(i=new Float32Array(i))}let a=this.getVerticesData(H.MatricesIndicesKind),o=this.getVerticesData(H.MatricesWeightsKind);if(!o||!a)return this;let s=this.numBoneInfluencers>4,c=s?this.getVerticesData(H.MatricesIndicesExtraKind):null,l=s?this.getVerticesData(H.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=N.Zero(),f=new F,p=new F,m=0,h;for(let e=0;e<r.length;e+=3,m+=4){let g;for(h=0;h<4;h++)g=o[m+h],g>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(a[m+h]*16),g,p),f.addToSelf(p));if(s)for(h=0;h<4;h++)g=l[m+h],g>0&&(F.FromFloat32ArrayToRefScaled(u,Math.floor(c[m+h]*16),g,p),f.addToSelf(p));N.TransformCoordinatesFromFloatsToRef(n._sourcePositions[e],n._sourcePositions[e+1],n._sourcePositions[e+2],f,d),d.toArray(r,e),t&&(N.TransformNormalFromFloatsToRef(n._sourceNormals[e],n._sourceNormals[e+1],n._sourceNormals[e+2],f,d),d.toArray(i,e)),f.reset()}return this.updateVerticesData(H.PositionKind,r),t&&this.updateVerticesData(H.NormalKind,i),this}static MinMax(e){let t=null,n=null;return e.forEach(function(e){let r=e.getBoundingInfo().boundingBox;!t||!n?(t=r.minimumWorld,n=r.maximumWorld):(t.minimizeInPlace(r.minimumWorld),n.maximizeInPlace(r.maximumWorld))}),!t||!n?{min:N.Zero(),max:N.Zero()}:{min:t,max:n}}static Center(t){let n=t instanceof Array?e.MinMax(t):t;return N.Center(n.min,n.max)}static MergeMeshes(t,n=!0,r,i,a,o){return Kn(e._MergeMeshesCoroutine(t,n,r,i,a,o,!1))}static MergeMeshesAsync(t,n=!0,r,i,a,o){return qn(e._MergeMeshesCoroutine(t,n,r,i,a,o,!0),Wn())}static*_MergeMeshesCoroutine(t,n=!0,r,i,a,o,s){if(t=t.filter(Boolean),t.length===0)return null;let c;if(!r){let e=0;for(c=0;c<t.length;c++)if(e+=t[c].getTotalVertices(),e>=65536)return f.Warn(`Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices`),null}o&&(a=!1);let l=[],u=[],d=[],p=t[0].overrideMaterialSideOrientation;for(c=0;c<t.length;c++){let e=t[c];if(e.isAnInstance)return f.Warn(`Cannot merge instance meshes.`),null;if(p!==e.overrideMaterialSideOrientation)return f.Warn(`Cannot merge meshes with different overrideMaterialSideOrientation values.`),null;if(a&&d.push(e.getTotalIndices()),o)if(e.material){let t=e.material;if(t instanceof Cr){for(let e=0;e<t.subMaterials.length;e++)l.indexOf(t.subMaterials[e])<0&&l.push(t.subMaterials[e]);for(let n=0;n<e.subMeshes.length;n++)u.push(l.indexOf(t.subMaterials[e.subMeshes[n].materialIndex])),d.push(e.subMeshes[n].indexCount)}else{l.indexOf(t)<0&&l.push(t);for(let n=0;n<e.subMeshes.length;n++)u.push(l.indexOf(t)),d.push(e.subMeshes[n].indexCount)}}else for(let t=0;t<e.subMeshes.length;t++)u.push(0),d.push(e.subMeshes[t].indexCount)}let m=t[0],h=e=>{let t=e.computeWorldMatrix(!0);return{vertexData:X.ExtractFromMesh(e,!1,!1),transform:t}},{vertexData:g,transform:_}=h(m);s&&(yield);let v=Array(t.length-1);for(let e=1;e<t.length;e++)v[e-1]=h(t[e]),s&&(yield);let y=g._mergeCoroutine(_,v,r,s,!n),b=y.next();for(;!b.done;)s&&(yield),b=y.next();let x=b.value;i||=new e(m.name+`_merged`,m.getScene());let S=x._applyToCoroutine(i,void 0,s),C=S.next();for(;!C.done;)s&&(yield),C=S.next();if(i.checkCollisions=m.checkCollisions,i.overrideMaterialSideOrientation=m.overrideMaterialSideOrientation,n)for(c=0;c<t.length;c++)t[c].dispose();if(a||o){i.releaseSubMeshes(),c=0;let e=0;for(;c<d.length;)ar.CreateFromIndices(0,e,d[c],i,void 0,!1),e+=d[c],c++;for(let e of i.subMeshes)e.refreshBoundingInfo();i.computeWorldMatrix(!0)}if(o){let e=new Cr(m.name+`_merged`,m.getScene());e.subMaterials=l;for(let e=0;e<i.subMeshes.length;e++)i.subMeshes[e].materialIndex=u[e];i.material=e}else i.material=m.material;return i}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){let t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){let e=this.instances[this.instances.length-1];this.instances[t]=e,e._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===Q.CounterClockWiseSideOrientation}_getRenderingFillMode(e){let t=this.getScene();return t.forcePointsCloud?Q.PointFillMode:t.forceWireframe?Q.WireFrameFillMode:this.overrideRenderingFillMode??e}};$.FRONTSIDE=X.FRONTSIDE,$.BACKSIDE=X.BACKSIDE,$.DOUBLESIDE=X.DOUBLESIDE,$.DEFAULTSIDE=X.DEFAULTSIDE,$.NO_CAP=0,$.CAP_START=1,$.CAP_END=2,$.CAP_ALL=3,$.NO_FLIP=0,$.FLIP_TILE=1,$.ROTATE_TILE=2,$.FLIP_ROW=3,$.ROTATE_ROW=4,$.FLIP_N_ROTATE_TILE=5,$.FLIP_N_ROTATE_ROW=6,$.CENTER=0,$.LEFT=1,$.RIGHT=2,$.TOP=3,$.BOTTOM=4,$.INSTANCEDMESH_SORT_TRANSPARENT=!1,$._GroundMeshParser=(e,t)=>{throw _(`GroundMesh`)},$._GoldbergMeshParser=(e,t)=>{throw _(`GoldbergMesh`)},$._LinesMeshParser=(e,t)=>{throw _(`LinesMesh`)},$e(`BABYLON.Mesh`,$),$.prototype.setMaterialByID=function(e){return this.setMaterialById(e)},$.CreateDisc=$.CreateDisc||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateBox=$.CreateBox||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateSphere=$.CreateSphere||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateCylinder=$.CreateCylinder||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateTorusKnot=$.CreateTorusKnot||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateTorus=$.CreateTorus||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreatePlane=$.CreatePlane||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateGround=$.CreateGround||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateTiledGround=$.CreateTiledGround||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateGroundFromHeightMap=$.CreateGroundFromHeightMap||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateTube=$.CreateTube||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreatePolyhedron=$.CreatePolyhedron||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateIcoSphere=$.CreateIcoSphere||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateDecal=$.CreateDecal||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.CreateCapsule=$.CreateCapsule||(()=>{throw Error(`Import MeshBuilder to populate this function`)}),$.ExtendToGoldberg=$.ExtendToGoldberg||(()=>{throw Error(`Import MeshBuilder to populate this function`)});var kr=function(e,t,n){for(var r in t)if(e.name===t[r])return n.push(e.id),!0;return e.parentId&&n.indexOf(e.parentId)!==-1?(n.push(e.id),!0):!1},Ar=function(e,t){return e+` of `+(t?t.file+` from `+t.name+` version: `+t.version+`, exporter version: `+t.exporter_version:`unknown`)};Ln.RegisterPlugin({name:`babylon.js`,extensions:`.json`,canDirectLoad:function(e){return e.indexOf(`json`),!0},importMesh:function(e,t,n,r,i,a,o,s){var c=`importMesh has failed JSON parse`;try{var l=JSON.parse(n);l.physicsEnabled=!1,l?.meshes.map(e=>delete e.physicsImpostor),c=``;var u=Ln.loggingLevel===Ln.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;var d=[];if(l.meshes!==void 0&&l.meshes!==null){var p,m;for(p=0,m=l.meshes.length;p<m;p++){var h=l.meshes[p];if(e===null||kr(h,e,d)){e!==null&&delete e[e.indexOf(h.name)];var g=$.Parse(h,t,r);i.push(g),c+=`
	Mesh `+g.toString(u)}}var _;for(p=0,m=t.meshes.length;p<m;p++)_=t.meshes[p],_._waitingParentId&&=(_.parent=t.getLastEntryByID(_._waitingParentId),null),_.computeWorldMatrix(!0)}return!0}catch(e){var v=Ar(`importMesh`,l?l.producer:`Unknown`)+c;if(s)s(v,e);else throw f.Log(v),e}finally{c!==null&&Ln.loggingLevel!==Ln.NO_LOGGING&&f.Log(Ar(`importMesh`,l?l.producer:`Unknown`)+(Ln.loggingLevel===Ln.MINIMAL_LOGGING?``:c))}return!1},load:function(e,t,n,r){var i=`importScene has failed JSON parse`;try{var a=JSON.parse(t);return i=``,a.clearColor!==void 0&&a.clearColor!==null&&(e.clearColor=Color4.FromArray(a.clearColor)),!!loadAssetContainer(e,t,n,r,!0)}catch(e){var o=Ar(`importScene`,a?a.producer:`Unknown`)+i;if(r)r(o,e);else throw f.Log(o),e}finally{i!==null&&Ln.loggingLevel!==Ln.NO_LOGGING&&f.Log(Ar(`importScene`,a?a.producer:`Unknown`)+(Ln.loggingLevel===Ln.MINIMAL_LOGGING?``:i))}return!1},loadAssetContainer:function(e,t,n,r){return loadAssetContainer(e,t,n,r)}}),$._instancedMeshFactory=(e,t)=>{let n=new jr(e,t);if(t.instancedBuffers)for(let e in n.instancedBuffers={},t.instancedBuffers)n.instancedBuffers[e]=t.instancedBuffers[e];return n};var jr=class extends mr{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(let e of t.getAnimationRanges())e!=null&&this.createAnimationRange(e.name,e.from,e.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return`InstancedMesh`}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}set receiveShadows(e){this._sourceMesh?.receiveShadows!==e&&A.Warn(`Setting receiveShadows on an instanced mesh has no effect`)}get material(){return this._sourceMesh.material}set material(e){this._sourceMesh?.material!==e&&A.Warn(`Setting material on an instanced mesh has no effect`)}get visibility(){return this._sourceMesh.visibility}set visibility(e){this._sourceMesh?.visibility!==e&&A.Warn(`Setting visibility on an instanced mesh has no effect`)}get skeleton(){return this._sourceMesh.skeleton}set skeleton(e){this._sourceMesh?.skeleton!==e&&A.Warn(`Setting skeleton on an instanced mesh has no effect`)}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||f.Warn(`Note - setting renderingGroupId of an instanced mesh has no effect on the scene`)}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t,n){return this._sourceMesh.getVerticesData(e,t,n)}setVerticesData(e,t,n,r){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,n,r),this.sourceMesh}updateVerticesData(e,t,n,r){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,n,r),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;let n=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),n),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||f.Warn(`Instances should only be created for meshes with geometry.`),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==Z.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||=new F;let e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,L.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(L.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;let t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{let t=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,t.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,n,r){let i=(r||this._sourceMesh).createInstance(e);if(h.DeepCopy(this,i,`name.subMeshes.uniqueId.parent.lightSources.receiveShadows.material.visibility.skeleton.sourceMesh.isAnInstance.facetNb.isFacetDataEnabled.isBlocked.useBones.hasInstances.collider.edgesRenderer.forward.up.right.absolutePosition.absoluteScaling.absoluteRotationQuaternion.isWorldMatrixFrozen.nonUniformScaling.behaviors.worldMatrixFromCache.hasThinInstances.hasBoundingInfo`.split(`.`),[]),this.refreshBoundingInfo(),t&&(i.parent=t),!n)for(let e=0;e<this.getScene().meshes.length;e++){let t=this.getScene().meshes[e];t.parent===this&&t.clone(t.name,i)}return i.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(i),i}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,n){let r=this.clone(`Clone of `+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);r&&n&&n(this,r);for(let e of this.getChildTransformNodes(!0))e.instantiateHierarchy(r,t,n);return r}};$.prototype.registerInstancedBuffer=function(e,t){var n;if((n=this._userInstancedBuffersStorage?.vertexBuffers[e])==null||n.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(let e of this.instances)e.instancedBuffers={};this._userInstancedBuffersStorage||={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}}this.instancedBuffers[e]=null,this._userInstancedBuffersStorage.strides[e]=t,this._userInstancedBuffersStorage.sizes[e]=t*32,this._userInstancedBuffersStorage.data[e]=new Float32Array(this._userInstancedBuffersStorage.sizes[e]),this._userInstancedBuffersStorage.vertexBuffers[e]=new H(this.getEngine(),this._userInstancedBuffersStorage.data[e],e,!0,!1,t,!0);for(let t of this.instances)t.instancedBuffers[e]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()},$.prototype._processInstancedBuffers=function(e,t){let n=e?e.length:0;for(let r in this.instancedBuffers){let i=this._userInstancedBuffersStorage.sizes[r],a=this._userInstancedBuffersStorage.strides[r],o=(n+1)*a;for(;i<o;)i*=2;this._userInstancedBuffersStorage.data[r].length!=i&&(this._userInstancedBuffersStorage.data[r]=new Float32Array(i),this._userInstancedBuffersStorage.sizes[r]=i,this._userInstancedBuffersStorage.vertexBuffers[r]&&(this._userInstancedBuffersStorage.vertexBuffers[r].dispose(),this._userInstancedBuffersStorage.vertexBuffers[r]=null));let s=this._userInstancedBuffersStorage.data[r],c=0;if(t){let e=this.instancedBuffers[r];e.toArray?e.toArray(s,c):e.copyToArray?e.copyToArray(s,c):s[c]=e,c+=a}for(let t=0;t<n;t++){let n=e[t].instancedBuffers[r];n.toArray?n.toArray(s,c):n.copyToArray?n.copyToArray(s,c):s[c]=n,c+=a}this._userInstancedBuffersStorage.vertexBuffers[r]?this._userInstancedBuffersStorage.vertexBuffers[r].updateDirectly(s,0):(this._userInstancedBuffersStorage.vertexBuffers[r]=new H(this.getEngine(),this._userInstancedBuffersStorage.data[r],r,!0,!1,a,!0),this._invalidateInstanceVertexArrayObject())}},$.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(let e in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[e]);this._userInstancedBuffersStorage.vertexArrayObjects={}}},$.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(let e in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[e]&&this._userInstancedBuffersStorage.vertexBuffers[e].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};var Mr={assetPath:``,enableShadows:!1,groupId:null,id:null,lights:[],rollId:null,scene:null},Nr=class t{constructor(e,t){r(this,`value`,0),r(this,`asleep`,!1),this.config={...Mr,...e},this.id=this.config.id===void 0?Date.now():this.config.id,this.sides=this.config.sides,this.dieType=this.config.dieType,this.comboKey=`${this.config.theme}_${this.config.dieType}`,this.scene=t,this.createInstance()}createInstance(){let e=`${this.config.meshName}_${this.dieType}_${this.config.theme}${this.config.colorSuffix}`,t=`${e}-instance-${this.id}`,n=this.scene.getMeshByName(e),r=n.createInstance(t);if(this.config.colorSuffix.length>0){let e=wt.FromHexString(this.config.themeColor);r.instancedBuffers.customColor=e}r.metadata=n.metadata,r.position.y=-100,r.scaling=new N(r.scaling.x*this.config.scale,r.scaling.y*this.config.scale,r.scaling.z*this.config.scale),this.config.enableShadows&&this.config.lights.directional.shadowGenerator.addShadowCaster(r),this.mesh=r}static async loadDie(e,t){let{sides:n,theme:r=`default`,meshName:i,colorSuffix:a}=e;e.dieType||=Number.isInteger(n)?`d${n}`:n;let o=i+`_`+e.dieType,s=o+`_`+r+a,c=t.getMeshByName(s);return c||=t.getMeshByName(o).clone(s),c.material||(c.material=t.getMaterialByName(r+a),a.length>0&&c.registerInstancedBuffer(`customColor`,3)),e}static async loadModels(t,n){let{meshFilePath:r,meshName:i,scale:a,d4FaceDown:o=!0}=t,s=!1,c=!1,l=await fetch(`${r}`).then(e=>{if(e.ok){let t=e.headers.get(`content-type`);if(t&&t.indexOf(`application/json`)!==-1||e.type&&e.type===`basic`)return e.json();throw Error(`Incorrect contentType: ${t}. Expected "application/json" or "basic"`)}else throw Error(`Unable to load 3D mesh file: '${r}'. Request rejected with status ${e.status}: ${e.statusText}`)}).catch(e=>console.error(e));if(l)return Ln.ImportMeshAsync(null,null,`data:`+JSON.stringify(l),n).then(t=>{if(t.meshes.forEach(e=>{e.name===`__root__`&&e.dispose(),e.name.includes(`collider`)&&(e.scaling=new N(e.scaling.x*.9,e.scaling.y*.9,e.scaling.z*.9)),s||=e.name===`d100`,c||=e.name===`d10`,e.setEnabled(!1),e.freezeNormals(),e.freezeWorldMatrix(),e.isPickable=!1,e.doNotSyncBoundingInfo=!0,e.name=i+`_`+e.name,e.metadata={baseScale:e.scaling}}),!s&&c&&(n.getMeshByName(i+`_d10`).clone(i+`_d100`),n.getMeshByName(i+`_d10_collider`).clone(i+`_d100_collider`),l.colliderFaceMap&&(l.colliderFaceMap.d100=e(l.colliderFaceMap.d10),Object.values(l.colliderFaceMap.d100).forEach((e,t)=>{l.colliderFaceMap.d100[t]=e*(e===10?0:10)}))),!l.colliderFaceMap)throw Error(`'colliderFaceMap' data not found in ${r}. Without the colliderFaceMap data dice values can not be resolved.`);n.themeData[i]={},n.themeData[i].colliderFaceMap=l.colliderFaceMap,n.themeData[i].d4FaceDown=o}).catch(e=>console.error(e)),l.meshes.filter(e=>e.name.includes(`collider`))}updateConfig(e){this.config={...this.config,...e}}static setVector3(e,n,r){return t.vector3.set(e,n,r)}static getVector3(){return t.vector3}static async getRollResult(e,n){return e.mesh?await((r=e)=>new Promise((i,a)=>{let o=e.config.parentMesh||e.config.meshName,s=n.themeData[o].colliderFaceMap,c=n.themeData[o].d4FaceDown;if(!s[r.dieType])throw Error(`No colliderFaceMap data for ${r.dieType}`);let l=n.getMeshByName(`${o}_${r.dieType}_collider`).createInstance(`${o}_${r.dieType}-hitbox-${r.id}`);l.isPickable=!0,l.isVisible=!0,l.setEnabled(!0),l.position=r.mesh.position,l.rotationQuaternion=r.mesh.rotationQuaternion;let u=t.setVector3(0,1,0);r.dieType===`d4`&&c&&(u=t.setVector3(0,-1,0)),t.ray.direction=u,t.ray.origin=e.mesh.position;let d=n.pickWithRay(t.ray);return l.dispose(),r.value=s[r.dieType][d.faceId],r.value===void 0&&(console.error(`colliderFaceMap Error: No value found for ${r.dieType} mesh face ${d.faceId}`),r.value=0),i(r.value)}).catch(e=>console.error(e)))():e.value}};r(Nr,`ray`,new Hn(N.Zero(),N.Zero(),1)),r(Nr,`vector3`,N.Zero());var Pr=Nr;export{Sr as $,or as A,H as B,Kt as C,je as D,J as E,it as F,ge as G,lr as H,P as I,Pr as J,B as K,_ as L,$t as M,$ as N,q as O,hr as P,An as Q,nt as R,gr as S,Lt as T,_t as U,V,$e as W,vr as X,A as Y,gt as Z,b as _,_e as a,k as at,Bt as b,L as c,Ft as ct,R as d,o as dt,Pe as et,Pt as f,It as ft,Ce as g,Q as h,z as i,tr as it,f as j,F as k,de as l,Et as lt,zt as m,Z as mt,mt as n,N as nt,Rt as o,Ht as ot,Xt as p,ut as pt,et as q,tt as r,X as rt,br as s,wt as st,Dn as t,Vn as tt,Se as u,E as ut,U as v,Tt as w,Bn as x,yt as y,Y as z};